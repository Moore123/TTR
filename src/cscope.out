cscope 15 /usr/local/src/TTR.gridfs/src               0000340123
	@GetttRc.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<°rög.h
>

4 
	~<m©h.h
>

6 
	~<sys/ty≥s.h
>

7 
	~<sys/°©.h
>

8 
	~<uni°d.h
>

9 
	~<îr‹.h
>

10 
	~<î∫o.h
>

11 
	~<dúít.h
>

13 
	~"R.h
"

14 
	~"Rdeföes.h
"

15 
	~"Röã∫Æs.h
"

17 
	~"R_ext/Arôh.h
"

18 
	~"R_ext/Eº‹.h
"

19 
	~"Rvîsi⁄.h
"

21 
	~<m©h.h
>

22 
	~<°dlib.h
>

23 
	~<˘y≥.h
>

24 
	~<°rög.h
>

25 
	~<°d¨g.h
>

27 
	~"comm⁄.h
"

29 
ProfôSèãM
 
	gP·StM
[] = {

30 {
BeTí
, 
BeC⁄t
, "√ø10π…", 
P·Ba£
}

32 {
BeC⁄t
, BeC⁄t, " ", 
P·NŸhög
}

34 {
BeC⁄tPri˚
, 
BeC⁄t
 | 
BeNum
, "≈‰π…º€", 
P·PeiguP
}

36 {
BeC⁄t
, 
BeC⁄tPri˚
 | 
BeNum
, "≈‰π…", 
P·Peigu
}

38 {
BeC⁄t
, 
BeNum
, "ÀÕ", 
P·H⁄gGu
}

40 {
BeC⁄t
, 
BeNum
, "∫Ï¿˚", 
P·H⁄gli
}

42 {
BeC⁄t
, 
BeNum
, "≈…œ¢", 
P·H⁄gli
}

44 {
BeC⁄t
, 
BeNum
, "◊™‘ˆ", 
P·H⁄gGu
}

46 {
BeC⁄t
, 
BeNum
, "‘ˆ∑¢", 
P·NŸhög
}

48 {
BeNum
, 
BeC⁄t
, "‘™", 
P·NŸhög
}

50 {
BeNum
, 
BeC⁄t
, "π…", 
P·NŸhög
}

52 {
BeC⁄t
, BeC⁄t, " ", 
P·NŸhög
}

54 {
BeC⁄t
, BeC⁄t, "£ª", 
P·NŸhög
}

56 {
BeNum
, 
BeC⁄t
, "π…◊∑ÀÕπ…∆±", 
P·NŸhög
}

59 
	sComps_Profô
 {

60 
TProfô
 *
	mTPHód
;

61 
TProfô
 *
	mTPTaû
;

63 } 
	tCProfô
;

65 
	sGLOBALPARAM
 {

68 *
	mFûe
;

69 *
	mProfôFûe
;

70 *
	mRefFûe
;

72 
	m°¨td©e
;

73 
	mídd©e
;

74 
	mnDays
;

75 
	mCou¡N
;

77 
	mt›N
;

79 
	mty≥
;

81 } 
	tGlobÆP¨am
;

83 
GlobÆP¨am
 *
	gGP
;

85 
	sDAYCHAINS
 {

86 
dzh
 
	mohlcVÆ
;

87 
DAYCHAINS
 *
	m¥ev
, *
	m√xt
;

89 } 
	tDayChaös
;

91 
size_t
 
	$X‰ód
(*
PTR
, 
size_t
 
size
, size_à
nmemb
, 
FILE
 * 
fh™dÀ
)

94 
sL⁄g
 = ();

95 
ªtvÆ
 = 0;

96 
dzh
 *
±r
 = (dzh *Ë
PTR
;

98 i‡(
sL⁄g
 == 4)

99  
	`‰ód
(
±r
, 
size
, 
nmemb
, 
fh™dÀ
);

100 
sL⁄g
 == 8) {

101 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
d©e
, 4, 1, 
fh™dÀ
);

103 i‡(
ªtvÆ
 <= 0)

105 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
›í
, 4, 1, 
fh™dÀ
);

106 i‡(
ªtvÆ
 <= 0)

108 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
high
, 4, 1, 
fh™dÀ
);

109 i‡(
ªtvÆ
 <= 0)

111 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
low
, 4, 1, 
fh™dÀ
);

112 i‡(
ªtvÆ
 <= 0)

114 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
ídp
, 4, 1, 
fh™dÀ
);

115 i‡(
ªtvÆ
 <= 0)

117 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
vﬁumn
, 4, 1, 
fh™dÀ
);

118 i‡(
ªtvÆ
 <= 0)

120 
ªtvÆ
 +
	`‰ód
((*)&
±r
->
amou¡
, 4, 1, 
fh™dÀ
);

121 i‡(
ªtvÆ
 <= 0)

123 
ªtvÆ
 +
	`f£ek
(
fh™dÀ
, 0x4, 
SEEK_CUR
);

127  (
ªtvÆ
);

129 
	}
}

131 
	$isFöishedRód
(
dzh
 * 
ªc
, 
GlobÆP¨am
 * 
gp
)

133 
ªtvÆ
 = 
TRUE
;

135 i‡(
gp
->
ty≥
 & 
OPT_SETEND
) {

137 i‡(
ªc
->
d©e
 < 
gp
->
ídd©e
) {

139 
ªtvÆ
 = 
FALSE
;

142 } i‡(
gp
->
ty≥
 & 
OPT_DATES
) {

143 i‡(
gp
->
Cou¡N
-- > 0)

144 
ªtvÆ
 = 
FALSE
;

148  (
ªtvÆ
);

150 
	}
}

152 
C⁄fO±
 
	gO±Së
[] = {

153 {"Fûes", 0, 
OPT_FILES
}

155 {"Profô", 0, 
OPT_PROFIT
}

157 {"Re„ªn˚", 0, 
OPT_REFERENCE
}

160 {"SèπD©e", 0, 
OPT_SETSTART
}

162 {"EndD©e", 0, 
OPT_SETEND
}

164 {"D©esN", 0, 
OPT_DATES
}

171 {
NULL
, -1, -1}

174 
	$RódögP¨amSë
(
SEXP
 
li°C⁄f
, 
GlobÆP¨am
 * 
gp
)

177 
i
 = 0, 
n
 = 0;

178 
SEXP
 
≤ame
, 
vÆues
;

179 
found
 = 
FALSE
;

181 
ªtvÆ
 = 0;

183 
≤ame
 = 
	`gëAârib
(
li°C⁄f
, 
R_NamesSymbﬁ
);

186 i‡(
n
 >
	`LENGTH
(
li°C⁄f
))

188 
vÆues
 = 
	`VECTOR_ELT
(
li°C⁄f
, 
n
);

189 
found
 = 
FALSE
;

190 
i
 = 0;

192 (
O±Së
[
i
].
SëSåög
 !
NULL
Ë&& (
found
 !
TRUE
)) {

194 i‡(
	`°∫cmp
(
O±Së
[
i
].
SëSåög
, 
	`CHAR
(
	`STRING_ELT
(
≤ame
, 
n
)), 
	`°æí
(CHAR(STRING_ELT(pname,Ç)))) != 0) {

195 
i
++;

199 
found
 = 
TRUE
;

201 
O±Së
[
i
].
›t
) {

203 
OPT_FILES
:

204 
gp
->
ty≥
 |
OPT_FILES
;

205 
gp
->
Fûe
 = 
	`CÆloc
(
	`°æí
(
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0))) + 1, );

206 
	`•rötf
(
gp
->
Fûe
, "%s", 
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0)));

209 
OPT_PROFIT
:

210 
gp
->
ty≥
 |
OPT_PROFIT
;

211 
gp
->
ProfôFûe
 = 
	`CÆloc
(
	`°æí
(
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0))) + 1, );

212 
	`•rötf
(
gp
->
ProfôFûe
, "%s", 
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0)));

215 
OPT_REFERENCE
:

216 
gp
->
RefFûe
 = 
	`CÆloc
(
	`°æí
(
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0))) + 1, );

217 
	`•rötf
(
gp
->
RefFûe
, "%s", 
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0)));

218 
gp
->
ty≥
 |
OPT_REFERENCE
;

221 
OPT_SETSTART
:

222 
gp
->
ty≥
 |
OPT_SETSTART
;

223 
gp
->
°¨td©e
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°C⁄f
, 
n
))[0];

226 
OPT_SETEND
:

227 
gp
->
ty≥
 |
OPT_SETEND
;

228 
gp
->
ídd©e
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°C⁄f
, 
n
))[0];

231 
OPT_DATES
:

232 
gp
->
ty≥
 |
OPT_DATES
;

233 
gp
->
nDays
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°C⁄f
, 
n
))[0];

236 
OPT_RATE
:

237 
OPT_AMOUNT
:

241 
ªtvÆ
++;

247 
n
++;

250  (
ªtvÆ
);

252 
	}
}

254 
	$ReLoˇãFûe
(
FILE
 * 
Â
, 
GlobÆP¨am
 * 
gp
)

256 
ªtvÆ
 = 0;

258 
dzh
 *
dbuff
;

260 
dbuff
 = 
	`CÆloc
(1, 
dzh
);

262 i‡((
gp
->
ty≥
 & 
OPT_SETSTART
Ë|| (gp->ty≥ & 
OPT_SETEND
)) {

264 i‡(
gp
->
ty≥
 & 
OPT_SETSTART
) {

265 
	`X‰ód
(
dbuff
, 0x20, 1, 
Â
) > 0) {

267 i‡(
dbuff
->
d©e
 >
gp
->
°¨td©e
) {

268 
	`f£ek
(
Â
, (-1LË* 0x20, 
SEEK_CUR
);

272 } i‡((
gp
->
ty≥
 & 
OPT_SETEND
Ë&& (gp->ty≥ & 
OPT_DATES
)) {

273 
	`X‰ód
(
dbuff
, 0x20, 1, 
Â
) > 0) {

274 i‡(
dbuff
->
d©e
 >
gp
->
ídd©e
) {

275 
	`f£ek
(
Â
, (-1LË* (
gp
->
nDays
Ë* 0x20, 
SEEK_CUR
);

281 } i‡(
gp
->
ty≥
 & 
OPT_DATES
) {

283 
	`f£ek
(
Â
, ()(0L - ((
gp
->
nDays
Ë* 0x20)), 
SEEK_END
);

285 
gp
->
Cou¡N
 = gp->
nDays
;

289 
	`‰ì
(
dbuff
);

290  (
ªtvÆ
);

292 
	}
}

294 
	$AssignTP
(
TProfô
 * 
TP
, 
assign
, 
tmpvÆue
)

297 
ªtvÆ
 = 0;

299 
assign
) {

300 
P·H⁄gGu
:

301 
TP
->
ty≥
 |
P·H⁄gGu
;

302 
TP
->
div
 +
tmpvÆue
;

306 
P·Peigu
:

307 
TP
->
ba£
 = 
P·Ba£Mít
;

308 
TP
->
ty≥
 |
P·Peigu
;

309 
TP
->
øã
 = 
tmpvÆue
;

312 
P·PeiguP
:

313 
TP
->
ty≥
 |
P·PeiguP
;

314 
TP
->
¥i˚
 = 
tmpvÆue
;

317 
P·H⁄gli
:

318 
TP
->
ty≥
 |
P·H⁄gli
;

319 
TP
->
sub
 = 
tmpvÆue
;

322 
P·Ba£
:

323 
TP
->
ba£
 = 
P·Ba£Mít
;

324 
TP
->
div
 = 0.0;

325 
TP
->
sub
 = 0.0;

326 
TP
->
¥i˚
 = 0.0;

327 
TP
->
øã
 = 0.0;

328 
TP
->
ty≥
 = 
P·NŸhög
;

332 
P·NŸhög
:

339  (
ªtvÆ
);

341 
	}
}

343 
	$P¨£Profô
(
TProfô
 * 
TP
, *
¥ofô°r
, 
Dump_D©a
 * 
ddmp
)

346 
CuºítSèã
;

348 
cch¨
 = 0;

350 
i
, 
j
, 
ªtvÆ
 = 0;

351 
tmpvÆue
 = 0.0;

352 *
ãmpbuff
;

354 
CuºítSèã
 = 
BeInô
;

356 
TP
->
d©e
 = 
ddmp
->date;

358 
TP
->
div
 = 0.0;

360 
cch¨
 = 0;

362 (
CuºítSèã
 !
BeEnd
Ë&& (
cch¨
 < 
	`°æí
(
¥ofô°r
))) {

364 
j
 = 0; j < 
	`DIM
(
P·StM
); j++) {

366 i‡(
	`°∫cmp
(
P·StM
[
j
].
sm«me
, 
¥ofô°r
 + 
cch¨
, 
	`°æí
(PftStM[j].smname)) == 0) {

368 
cch¨
 +
	`°æí
(
P·StM
[
j
].
sm«me
);

369 
CuºítSèã
 = 
P·StM
[
j
].
√xt°©e
;

371 i‡(
P·StM
[
j
].
√xt°©e
 & 
BeNum
) {

373 
i
 = 0;

374 
	`isdigô
(*(
¥ofô°r
 + 
cch¨
 + 
i
)) || *(profitstr + cchar + i) == '.') {

375 
i
++;

378 
ãmpbuff
 = 
	`CÆloc
(
i
 + 1, );

379 
	`mem˝y
(
ãmpbuff
, 
¥ofô°r
 + 
cch¨
, 
i
);

380 
	`ssˇnf
(
ãmpbuff
, "%f", &
tmpvÆue
);

381 
cch¨
 +
i
;

383 
	`AssignTP
(
TP
, 
P·StM
[
j
].
smassign
, 
tmpvÆue
);

385 
tmpvÆue
 = 0.0;

389 i‡(
P·StM
[
j
].
smassign
 & 
P·Ba£
) {

390 
	`AssignTP
(
TP
, 
P·StM
[
j
].
smassign
, 
tmpvÆue
);

392 
j
 = 0;

397 i‡(
j
 =
	`DIM
(
P·StM
)) {

398 
cch¨
++;

402  (
ªtvÆ
);

403 
	}
}

405 
	$GëProfôSh¨e
(c⁄° *
ödex«me
, 
CProfô
 * 
CP
)

408 *
descbuf„r
;

410 
Dump_D©a
 
PP4∑ø
;

412 
FILE
 *
Â
;

413 
i
, 
ii
, 
ªtvÆ
 = 0;

414 
yór
, 
m⁄th
, 
d©e
;

416 
TProfô
 *
TProfôHód
, *
TProfôPå
, *
TProfôTemp
;

418 i‡((
Â
 = 
	`f›í
(
ödex«me
, "r")Ë=
NULL
) {

419 
ªtvÆ
 = -1;

420  
ªtvÆ
;

423 i‡((
descbuf„r
 = 
	`CÆloc
(
MAX_STR_LEN
, )Ë=
NULL
) {

425 
ªtvÆ
 = -1;

426  (
ªtvÆ
);

429 
TProfôPå
 = 
TProfôHód
 = 
CP
->
TPHód
;

431 
TProfôTemp
 = 
NULL
;

434 
	`mem£t
(
descbuf„r
, 0x0, 
MAX_STR_LEN
);

436 i‡(
	`fgës
(
descbuf„r
, 
MAX_STR_LEN
, 
Â
Ë!
NULL
) {

438 
i
 = 0; i < 
MAX_STR_LEN
; i++) {

439 
ii
 = 
i
;

440 
	`ISDIGIT
(*(
descbuf„r
 + 
ii
)) || *(descbuffer + ii) == '-') {

441 
ii
++;

444 i‡((
ii
 - 
i
) == 10) {

445 
	`ssˇnf
(
descbuf„r
 + 
i
, "%4d-%2d-%2d", &
yór
, &
m⁄th
, &
d©e
);

446 
PP4∑ø
.
d©e
 = 
yór
 * 10000 + 
m⁄th
 * 100 + date;

448 
ªtvÆ
 = 
TRUE
;

451 
ªtvÆ
 = 
FAIL
;

458 
ªtvÆ
 = 
FAIL
;

462 
	`mem£t
(
descbuf„r
, 0x0, 
MAX_STR_LEN
);

464 i‡(
	`fgës
(
descbuf„r
, 
MAX_STR_LEN
, 
Â
Ë=
NULL
) {

465 
ªtvÆ
 = 
FAIL
;

469 i‡(
TProfôTemp
 =
NULL
) {

470 
	`P¨£Profô
(
TProfôPå
, 
descbuf„r
, &
PP4∑ø
);

471 
TProfôTemp
 = 
TProfôPå
;

473 
TProfôTemp
 = 
	`CÆloc
(1, 
TProfô
);

474 
	`P¨£Profô
(
TProfôTemp
, 
descbuf„r
, &
PP4∑ø
);

476 i‡((
TProfôTemp
->
ty≥
 & (0xf)) != 0) {

477 
TProfôTemp
->
¥ev
 = 
TProfôPå
;

478 
TProfôTemp
->
√xt
 = 
TProfôPå
->next;

479 
TProfôPå
->
√xt
->
¥ev
 = 
TProfôTemp
;

480 
TProfôPå
->
√xt
 = 
TProfôTemp
;

481 
TProfôPå
 = TProfôPå->
√xt
;

486 } 
ªtvÆ
 =
TRUE
);

488 
	`f˛o£
(
Â
);

489 
	`‰ì
(
descbuf„r
);

491  
ªtvÆ
;

493 
	}
}

495 
	$‰ìProfô
(
CProfô
 * 
thód
)

497 
TProfô
 *
çå
;

499 
çå
 = 
thód
->
TPHód
->
√xt
;

501 
çå
->
√xt
 !
thód
->
TPHód
) {

502 
çå
 =Å±r->
√xt
;

503 
	`‰ì
(
çå
->
¥ev
);

506 
	`‰ì
(
thód
->
TPHód
);

507 
	`‰ì
(
thód
);

511 
	}
}

513 
	$ReCÆcPri˚4
(
CProfô
 * 
CP
, *
xr°
, 
xmax
)

516 
i
, 
jmax
;

517 
ªtvÆ
 = 0;

519 
jmax
 = 
xmax
;

521 
TProfô
 *
TProfôHód
, *
TProfôTaû
, *
TProfôPå
;

523 
TProfôHód
 = 
CP
->
TPHód
;

524 
TProfôPå
 = 
TProfôTaû
 = 
CP
->
TPHód
;

528 i‡(()
xr°
[
jmax
 - 1] < ()
TProfôPå
->
d©e
) {

530 
i
 = 
jmax
 - 1;

534 i‡((
TProfôPå
->
ty≥
 & 
P·H⁄gli
) != 0) {

536 
xr°
[
xmax
 * 2 + 
i
] = 
	`round
(xr°[xmax * 2 + i] - ((
TProfôPå
->
sub
) * 10));

537 
xr°
[
xmax
 * 3 + 
i
] = 
	`round
(xr°[xmax * 3 + i] - ((
TProfôPå
->
sub
) * 10));

538 
xr°
[
xmax
 * 4 + 
i
] = 
	`round
(xr°[xmax * 4 + i] - ((
TProfôPå
->
sub
) * 10));

539 
xr°
[
xmax
 + 
i
] = 
	`round
(xr°[xmax + i] - ((
TProfôPå
->
sub
) * 10));

542 i‡((
TProfôPå
->
ty≥
 & 
P·H⁄gGu
) != 0) {

544 
xr°
[
xmax
 * 2 + 
i
] = 
	`round
(xr°[xmax * 2 + i] / ((
TProfôPå
->
div
 + 
P·Ba£Mít
) / PftBaseMent));

545 
xr°
[
xmax
 * 3 + 
i
] = 
	`round
(xr°[xmax * 3 + i] / ((
TProfôPå
->
div
 + 
P·Ba£Mít
) / PftBaseMent));

546 
xr°
[
xmax
 * 4 + 
i
] = 
	`round
(xr°[xmax * 4 + i] / ((
TProfôPå
->
div
 + 
P·Ba£Mít
) / PftBaseMent));

547 
xr°
[
xmax
 + 
i
] = 
	`round
(xr°[xmax + i] / ((
TProfôPå
->
div
 + 
P·Ba£Mít
) / PftBaseMent));

550 i‡((
TProfôPå
->
ty≥
 & 
P·Peigu
) != 0) {

552 
xr°
[
xmax
 * 2 + 
i
] =

553 
	`round
((
xr°
[
xmax
 * 2 + 
i
] + (
TProfôPå
->
¥i˚
Ë* (TProfôPå->
øã
) * 10) / (TProfitPtr->rate +

554 
P·Ba£Mít
));

555 
xr°
[
xmax
 * 3 + 
i
] =

556 
	`round
((
xr°
[
xmax
 * 3 + 
i
] + (
TProfôPå
->
¥i˚
Ë* (TProfôPå->
øã
)) * 10 / (TProfitPtr->rate +

557 
P·Ba£Mít
));

558 
xr°
[
xmax
 * 4 + 
i
] =

559 
	`round
((
xr°
[
xmax
 * 4 + 
i
] + (
TProfôPå
->
¥i˚
Ë* (TProfôPå->
øã
)) * 10 / (TProfitPtr->rate +

560 
P·Ba£Mít
));

561 
xr°
[
xmax
 + 
i
] =

562 
	`round
((
xr°
[
xmax
 + 
i
] + (
TProfôPå
->
¥i˚
Ë* (TProfôPå->
øã
) * 10) / (TProfitPtr->rate +

563 
P·Ba£Mít
));

566 
i
--;

568 } 
i
 >= 0);

570 
TProfôPå
 = TProfôPå->
√xt
;

573 
jmax
--;

575 } 
jmax
 > 0);

577  (
ªtvÆ
);

579 
	}
}

581 
	$‰ìDchaös
(
DayChaös
 * 
thód
)

583 
DayChaös
 *
çå
;

585 
çå
 = 
thód
;

587 
çå
->
√xt
 !
NULL
) {

588 
çå
 =Å±r->
√xt
;

589 
	`‰ì
(
çå
->
¥ev
);

592 
	`‰ì
(
çå
);

596 
	}
}

598 
	$‰ìGP
(
GlobÆP¨am
 * 
gp
)

600 i‡(
gp
->
ty≥
 & 
OPT_FILES
)

601 
	`‰ì
(
gp
->
Fûe
);

603 i‡(
gp
->
ty≥
 & 
OPT_PROFIT
)

604 
	`‰ì
(
gp
->
ProfôFûe
);

606 i‡(
gp
->
ty≥
 & 
OPT_REFERENCE
)

607 
	`‰ì
(
gp
->
RefFûe
);

609 
	`‰ì
(
gp
);

611 
	}
}

613 
SEXP
 
	$gënday
(
FILE
 * 
fh™dÀ
, *
FlﬂtPå
, 
GlobÆP¨am
 * 
gp
)

616 
i
 = 0;

618 
dzh
 *
ªc‹dî
 = 
NULL
;

620 
DayChaös
 *
DHód
, *
DPå
;

621 
SEXP
 
ªsu…
;

623 
DHód
 = 
DPå
 = 
	`CÆloc
(1, 
DayChaös
);

625 
DHód
->
√xt
 = 
NULL
;

626 
DHód
->
¥ev
 = 
NULL
;

627 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

629 
	`X‰ód
(
ªc‹dî
, 0x20, 1, 
fh™dÀ
) > 0) {

631 
	`mem˝y
(&
DPå
->
ohlcVÆ
, 
ªc‹dî
, (
dzh
));

633 
i
++;

635 i‡(
	`isFöishedRód
(
ªc‹dî
, 
gp
Ë=
TRUE
) {

639 
DPå
->
√xt
 = 
	`CÆloc
(1, 
DayChaös
);

640 
DPå
->
√xt
->
¥ev
 = DPtr;

641 
DPå
 = DPå->
√xt
;

642 
DPå
->
√xt
 = 
NULL
;

646 
gp
->
Cou¡N
 = gp->
nDays
 = 
i
;

648 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(
gp
->
Cou¡N
 * 
CNUM
));

649 
FlﬂtPå
 = 
	`NUMERIC_POINTER
(
ªsu…
);

651 
i
 = 0; i < 
gp
->
Cou¡N
; i++)

652 
FlﬂtPå
[
i
] = 0.0;

654 
DPå
 = 
DHód
;

656 
i
 = 0;

658 (
DPå
 !
NULL
Ë&& (
i
 < 
gp
->
nDays
)) {

661 
FlﬂtPå
[
i
] = 
DPå
->
ohlcVÆ
.
d©e
;

663 
FlﬂtPå
[
gp
->
nDays
 + 
i
] = 
DPå
->
ohlcVÆ
.
›í
;

665 
FlﬂtPå
[
gp
->
nDays
 * 2 + 
i
] = 
DPå
->
ohlcVÆ
.
high
;

667 
FlﬂtPå
[
gp
->
nDays
 * 3 + 
i
] = 
DPå
->
ohlcVÆ
.
low
;

669 
FlﬂtPå
[
gp
->
nDays
 * 4 + 
i
] = 
DPå
->
ohlcVÆ
.
ídp
;

671 
FlﬂtPå
[
gp
->
nDays
 * 5 + 
i
] = ()((
DPå
->
ohlcVÆ
.
vﬁumn
));

673 
FlﬂtPå
[
gp
->
nDays
 * 6 + 
i
] = (
DPå
->
ohlcVÆ
.
amou¡
);

674 
i
++;

675 i‡(
	`isFöishedRód
(&
DPå
->
ohlcVÆ
, 
gp
Ë=
TRUE
)

677 
DPå
 = DPå->
√xt
;

680 
	`‰ì
(
ªc‹dî
);

681 
	`‰ìDchaös
(
DHód
);

683  (
ªsu…
);

685 
	}
}

700 
SEXP
 
	$£À˘_ârc
(
SEXP
 
Li°C⁄f
)

703 
FILE
 *
fh™dÀ
;

705 
CProfô
 *
CP
;

707 
°©
 
dzh_f°©
, 
tmp_f°©
;

709 
i
, 
p
 = 0;

711 
SEXP
 
ªsu…
, 
dim
;

713 *
xr°
;

715 
GlobÆP¨am
 *
gp
;

717 
gp
 = 
	`CÆloc
(1, 
GlobÆP¨am
);

718 
gp
->
nDays
 = gp->
°¨td©e
 = gp->
ídd©e
 = gp->
ty≥
 = gp->
t›N
 = gp->
Cou¡N
 = 0;

720 
gp
->
ProfôFûe
 = gp->
RefFûe
 = gp->
Fûe
 = 
NULL
;

722 
	`RódögP¨amSë
(
Li°C⁄f
, 
gp
);

725 i‡(
	`°©
(
gp
->
Fûe
, &
dzh_f°©
) != 0) {

726 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(1));

727 
p
++;

728 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

729 
xr°
[0] = 
NA_REAL
;

733 i‡((
dzh_f°©
.
°_size
 % 0x20) != 0) {

734 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(1));

735 
p
++;

736 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

737 
xr°
[0] = 
NA_REAL
;

741 i‡((
fh™dÀ
 = 
	`f›í
(
gp
->
Fûe
, "rb")Ë!
NULL
) {

742 
	`ReLoˇãFûe
(
fh™dÀ
, 
gp
);

743 
ªsu…
 = 
	`gënday
(
fh™dÀ
, 
xr°
, 
gp
);

744 
p
++;

745 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

747 
i
 = 0;

749 i‡((
gp
->
ty≥
 & 
OPT_PROFIT
Ë&& (
	`°©
(gp->
ProfôFûe
, &
tmp_f°©
) == 0)) {

751 
CP
 = 
	`CÆloc
(1, 
CProfô
);

752 
CP
->
TPHód
 = 
	`CÆloc
(1, 
TProfô
);

753 
CP
->
TPTaû
 = CP->
TPHód
;

754 
CP
->
TPHód
->
¥ev
 = CP->TPHead;

755 
CP
->
TPHód
->
√xt
 = CP->TPHead;

757 
	`GëProfôSh¨e
(
gp
->
ProfôFûe
, 
CP
);

759 
	`ReCÆcPri˚4
(
CP
, 
xr°
, 
gp
->
nDays
);

761 
	`‰ìProfô
(
CP
);

764 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

765 
p
++;

766 
	`INTEGER
(
dim
)[0] = 
gp
->
nDays
;

767 
	`INTEGER
(
dim
)[1] = 
CNUM
;

768 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

770 
	`f˛o£
(
fh™dÀ
);

777 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

779 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

780 
p
++;

781 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
CNUM
));

782 
p
++;

784 
	`SET_VECTOR_ELT
(
d«mes
, 0, 
	`mkCh¨
("Date"));

785 
	`SET_VECTOR_ELT
(
d«mes
, 1, 
	`mkCh¨
("Open"));

786 
	`SET_VECTOR_ELT
(
d«mes
, 2, 
	`mkCh¨
("High"));

787 
	`SET_VECTOR_ELT
(
d«mes
, 3, 
	`mkCh¨
("Low"));

788 
	`SET_VECTOR_ELT
(
d«mes
, 4, 
	`mkCh¨
("Close"));

789 
	`SET_VECTOR_ELT
(
d«mes
, 5, 
	`mkCh¨
("Volume"));

790 
	`SET_VECTOR_ELT
(
d«mes
, 6, 
	`mkCh¨
("Amount"));

792 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
d«mes
);

793 
∫ames
 = 
R_NûVÆue
;

794 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
∫ames
);

795 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

797 
	`UNPROTECT
(
p
);

798 
	`‰ìGP
(
gp
);

799  (
ªsu…
);

801 
	}
}

803 
	$gëNday
(
FILE
 * 
fh™dÀ
, *
FlﬂtPå
, 
xmax
)

806 
i
, 
ªtvÆ
 = 0;

808 
dzh
 *
ªc‹dî
 = 
NULL
;

810 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

812 
i
 = 0;

814 (
	`X‰ód
(
ªc‹dî
, 0x20, 1, 
fh™dÀ
Ë> 0Ë&& (
i
 < 
xmax
)) {

817 
FlﬂtPå
[
i
] = 
ªc‹dî
->
d©e
;

819 
FlﬂtPå
[
xmax
 + 
i
] = 
ªc‹dî
->
›í
;

821 
FlﬂtPå
[
xmax
 * 2 + 
i
] = 
ªc‹dî
->
high
;

823 
FlﬂtPå
[
xmax
 * 3 + 
i
] = 
ªc‹dî
->
low
;

825 
FlﬂtPå
[
xmax
 * 4 + 
i
] = 
ªc‹dî
->
ídp
;

827 
FlﬂtPå
[
xmax
 * 5 + 
i
] = ()((
ªc‹dî
->
vﬁumn
));

829 
FlﬂtPå
[
xmax
 * 6 + 
i
] = (
ªc‹dî
->
amou¡
);

830 
i
++;

833 
	`‰ì
(
ªc‹dî
);

835  (
ªtvÆ
);

837 
	}
}

839 
SEXP
 
	$gë_ârc
(
SEXP
 
c_fûes
, SEXP 
days
, SEXP 
˛o£
)

842 
FILE
 *
fh™dÀ
;

844 
dzh
 *
ªc‹dî
 = 
NULL
;

846 
CProfô
 *
CP
;

848 *
¥f_«me
, *
°k_«me
;

850 
°©
 
dzh_f°©
, 
tmp_f°©
;

852 
i
, 
xmax
, 
p
 = 0;

854 
	`PROTECT
(
days
 = 
	`AS_NUMERIC
(days));

855 
p
++;

856 
	`PROTECT
(
˛o£
 = 
	`AS_NUMERIC
(close));

857 
p
++;

859 
SEXP
 
ªsu…
, 
dim
;

861 *
xdays
, *
xr°
;

864 i‡(
	`°©
(
	`CHAR
(
	`STRING_ELT
(
c_fûes
, 0)), &
dzh_f°©
) != 0) {

865 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(1));

866 
p
++;

867 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

868 
xr°
[0] = 
NA_REAL
;

872 i‡((
dzh_f°©
.
°_size
 % 0x20) != 0) {

873 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(1));

874 
p
++;

875 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

876 
xr°
[0] = 
NA_REAL
;

880 
xdays
 = 
	`NUMERIC_POINTER
(
days
);

881 
xmax
 =

882 (
xdays
[0] ==

883 0Ë? (
dzh_f°©
.
°_size
 / 0x20Ë: ((
xdays
[0] <

884 
dzh_f°©
.
°_size
 / 0x20Ë? (
xdays
[0]) : (dzh_fstat.st_size / 0x20));

886 
	`PROTECT
(
ªsu…
 = 
	`NEW_NUMERIC
(
xmax
 * 
CNUM
));

887 
p
++;

888 
xr°
 = 
	`NUMERIC_POINTER
(
ªsu…
);

890 
i
 = 0; i < 
xmax
; i++)

891 
xr°
[
i
] = 0.0;

893 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

895 i‡(
	`LENGTH
(
c_fûes
) > 1) {

896 
¥f_«me
 = 
	`CÆloc
(
STRING_LEN
, );

897 
°k_«me
 = 
	`CÆloc
(
MIN_STR_LEN
, );

898 
	`°∫˝y
(
°k_«me
, 
	`CHAR
(
	`STRING_ELT
(
c_fûes
, 0)Ë+ 
	`°æí
(CHAR(STRING_ELT(c_files, 0))) - 12, 8);

900 
	`¢¥ötf
(
¥f_«me
, 
STRING_LEN
, "%s%s", 
	`CHAR
(
	`STRING_ELT
(
c_fûes
, 1)), 
°k_«me
);

902 
	`‰ì
(
°k_«me
);

904 i‡(
	`°©
(
¥f_«me
, &
tmp_f°©
) == 0) {

905 
CP
 = 
	`CÆloc
(1, 
CProfô
);

906 
CP
->
TPHód
 = 
	`CÆloc
(1, 
TProfô
);

907 
CP
->
TPTaû
 = CP->
TPHód
;

908 
CP
->
TPHód
->
¥ev
 = CP->TPHead;

909 
CP
->
TPHód
->
√xt
 = CP->TPHead;

910 
	`GëProfôSh¨e
(
¥f_«me
, 
CP
);

915 i‡((
fh™dÀ
 = 
	`f›í
(
	`CHAR
(
	`STRING_ELT
(
c_fûes
, 0)), "rb")Ë!
NULL
) {

916 
	`f£ek
(
fh™dÀ
, 0L - (
xmax
 * 0x20), 
SEEK_END
);

917 
i
 = 0;

919 
	`gëNday
(
fh™dÀ
, 
xr°
, 
xmax
);

921 i‡(
	`°©
(
¥f_«me
, &
tmp_f°©
) == 0) {

923 
	`ReCÆcPri˚4
(
CP
, 
xr°
, 
xmax
);

924 
	`‰ìProfô
(
CP
);

927 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

928 
p
++;

929 
	`INTEGER
(
dim
)[0] = 
xmax
;

930 
	`INTEGER
(
dim
)[1] = 
CNUM
;

931 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

935 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

937 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

938 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
CNUM
));

940 
	`SET_VECTOR_ELT
(
d«mes
, 0, 
	`mkCh¨
("Date"));

941 
	`SET_VECTOR_ELT
(
d«mes
, 1, 
	`mkCh¨
("Open"));

942 
	`SET_VECTOR_ELT
(
d«mes
, 2, 
	`mkCh¨
("High"));

943 
	`SET_VECTOR_ELT
(
d«mes
, 3, 
	`mkCh¨
("Low"));

944 
	`SET_VECTOR_ELT
(
d«mes
, 4, 
	`mkCh¨
("Close"));

945 
	`SET_VECTOR_ELT
(
d«mes
, 5, 
	`mkCh¨
("Volume"));

946 
	`SET_VECTOR_ELT
(
d«mes
, 6, 
	`mkCh¨
("Amount"));

948 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
d«mes
);

949 
∫ames
 = 
R_NûVÆue
;

950 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
∫ames
);

951 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

952 
	`UNPROTECT
(2);

954 
	`Fªe
(
ªc‹dî
);

955 i‡(
	`LENGTH
(
c_fûes
) > 1) {

956 
	`‰ì
(
¥f_«me
);

958 
	`f˛o£
(
fh™dÀ
);

964 
	`UNPROTECT
(
p
);

965  (
ªsu…
);

967 
	}
}

969 
	$GëC⁄ã¡sFromFûe0
(*
∑th
, c⁄° *
m°r
, *
ªt°r
)

972 
i
, 
ªtv
 = 0;

974 
FILE
 *
Â
;

976 *
buff
, *
p
;

978 
buff
 = 
	`CÆloc
(
MAX_STR_LEN
, );

980 i‡((
Â
 = 
	`f›í
(
∑th
, "rb")Ë=
NULL
) {

981 
ªtv
 = -1;

984 
	`fgës
(
buff
, ((Ë* 
MAX_STR_LEN
), 
Â
Ë!
NULL
) {

986 i‡((
p
 = 
	`°r°r
(
buff
, 
m°r
)Ë!
NULL
) {

987 
i
 = 0;

989 
p
 > 0 && *p != '>') {

990 i‡(
	`isdigô
(*
p
) || (*p == '-') || (*p == '.'))

991 ++
i
;

992 i‡((*
p
 == '-') && (*(p + 1) == '-')) {

993 
ªtv
 = -1;

996 --
p
;

999 i‡(
i
 > 0) {

1000 
	`mem˝y
(
ªt°r
, 
p
 + 1, 
i
 - 1);

1003 
ªtv
 = -1;

1012 
	`f˛o£
(
Â
);

1013 
	`‰ì
(
buff
);

1015  (
ªtv
);

1016 
	}
}

1018 
	$GëC⁄ã¡sFromFûe
(*
∑th
, c⁄° *
m°r
, *
ªt°r
)

1021 
i
, 
ªtv
 = 0;

1023 
FILE
 *
Â
;

1025 *
buff
, *
p
;

1027 
buff
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1029 i‡((
Â
 = 
	`f›í
(
∑th
, "rb")Ë=
NULL
) {

1030 
ªtv
 = -1;

1033 
	`fgës
(
buff
, ((Ë* 
MAX_STR_LEN
), 
Â
Ë!
NULL
) {

1035 i‡((
p
 = 
	`°r°r
(
buff
, 
m°r
)Ë!
NULL
) {

1036 
i
 = 0;

1038 
	`fgës
(
buff
, ((Ë* 
MAX_STR_LEN
), 
Â
);

1039 
i
 = 
	`°æí
(
buff
);

1041 i‡(
i
 > 0) {

1042 
	`mem˝y
(
ªt°r
, 
buff
, 
i
);

1045 
ªtv
 = -1;

1054 
	`f˛o£
(
Â
);

1055 
	`‰ì
(
buff
);

1057  (
ªtv
);

1058 
	}
}

1061 
SEXP
 
	$gëFûe
(
SEXP
 
fName
, SEXP 
r°rög
)

1064 
SEXP
 
ªsu…
;

1065 
m¶í
, 
i
, 
p
 = 0;

1066 *
buff
, *
vbuf
, *
fuŒ∑th
;

1068 
m¶í
 = 
	`LENGTH
(
r°rög
);

1070 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
m¶í
 + 1));

1071 
p
++;

1073 
buff
 = 
	`CÆloc
(
STRING_LEN
, );

1074 
vbuf
 = 
	`CÆloc
(
STRING_LEN
, );

1075 
fuŒ∑th
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1077 
	`¢¥ötf
(
fuŒ∑th
, 
MAX_STR_LEN
, "%s", 
	`CHAR
(
	`STRING_ELT
(
fName
, 0)));

1078 
i
 = 
	`°æí
(
fuŒ∑th
);

1079 
i
 > 0) {

1080 i‡(
fuŒ∑th
[
i
] == '/')

1082 
i
--;

1084 
	`¢¥ötf
(
vbuf
, 8, "%s", 
fuŒ∑th
 + 
i
);

1086 
	`SET_VECTOR_ELT
(
ªsu…
, 0, 
	`SˇœrSåög
(
	`mkCh¨
(
vbuf
)));

1088 
i
 = 0; i < 
m¶í
; i++) {

1090 
	`mem£t
(
vbuf
, 0x0, (Ë* 
STRING_LEN
);

1092 i‡(
	`GëC⁄ã¡sFromFûe
(
fuŒ∑th
, 
	`CHAR
(
	`STRING_ELT
(
r°rög
, 
i
)), 
vbuf
) == 0) {

1094 
	`SET_VECTOR_ELT
(
ªsu…
, 
i
 + 1, 
	`SˇœrRól
(
	`°πod
(
vbuf
, 
NULL
)));

1098 
	`SET_VECTOR_ELT
(
ªsu…
, 
i
 + 1, 
	`SˇœrRól
(
NA_REAL
));

1104 
	`‰ì
(
fuŒ∑th
);

1105 
	`‰ì
(
vbuf
);

1106 
	`‰ì
(
buff
);

1108 
	`UNPROTECT
(
p
);

1110  (
ªsu…
);

1112 
	}
}

1114 
SEXP
 
	$gëAŒ
(
SEXP
 
≤ame
, SEXP 
m°rög
, SEXP 
li°days
)

1117 
dúít
 **
xdú
;

1118 
°©
 
x°©
;

1120 
m¶í
, 
xmax
, 
i
, 
n
, 
p
 = 0;

1122 
SEXP
 
ªsu…
, 
dim
;

1124 *
buf
, *
fuŒ∑th
;

1126 *
vbuf
;

1128 i‡(
	`°©
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
x°©
) == 0) {

1130 i‡((
x°©
.
°_mode
 & 
S_IFMT
Ë=
S_IFREG
) {

1132  (
	`gëFûe
(
≤ame
, 
m°rög
));

1137 
n
 = 
	`sˇndú
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
xdú
, 
NULL
, 
Æphas‹t
);

1138 
xmax
 = 
n
 - 2;

1140 
m¶í
 = 
	`LENGTH
(
m°rög
);

1141 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
xmax
 * (
m¶í
 + 1)));

1142 
p
++;

1143 
buf
 = 
	`CÆloc
(16, );

1144 
vbuf
 = 
	`CÆloc
(
STRING_LEN
, );

1145 
fuŒ∑th
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1147 
n
--) {

1149 
	`mem£t
(
buf
, 0x0, () * 11);

1150 
	`mem£t
(
vbuf
, 0x0, (Ë* 
STRING_LEN
);

1151 
	`mem£t
(
fuŒ∑th
, 0x0, (Ë* 
MAX_STR_LEN
);

1153 i‡((
	`°rcmp
(
xdú
[
n
]->
d_«me
, ".") == 0) || (strcmp(xdir[n]->d_name, "..") == 0))

1156 ()
	`¢¥ötf
(
buf
, 10, "%s", 
xdú
[
n
]->
d_«me
);

1157 
	`¢¥ötf
(
fuŒ∑th
, 
MAX_STR_LEN
, "%s/%s", 
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), 
xdú
[
n
]->
d_«me
);

1159 
	`SET_VECTOR_ELT
(
ªsu…
, 
n
 - 2, 
	`SˇœrSåög
(
	`mkCh¨
(
buf
)));

1161 
i
 = 0; i < 
m¶í
; i++) {

1163 
	`mem£t
(
vbuf
, 0x0, (Ë* 
STRING_LEN
);

1165 i‡(
	`GëC⁄ã¡sFromFûe
(
fuŒ∑th
, 
	`CHAR
(
	`STRING_ELT
(
m°rög
, 
i
)), 
vbuf
) == 0) {

1167 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
	`°πod
(
vbuf
, 
NULL
)));

1171 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
NA_REAL
));

1177 
	`‰ì
(
xdú
[
n
]);

1181 
	`‰ì
(
fuŒ∑th
);

1182 
	`‰ì
(
buf
);

1183 
	`‰ì
(
vbuf
);

1184 
	`‰ì
(
xdú
);

1186 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

1187 
p
++;

1188 
	`INTEGER
(
dim
)[0] = 
xmax
;

1189 
	`INTEGER
(
dim
)[1] = 
m¶í
 + 1;

1190 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

1192 
	`UNPROTECT
(
p
);

1193  (
ªsu…
);

1195 
	}
}

1197 
SEXP
 
	$gëLa°Fûe
(
SEXP
 
∑th«me
, SEXP 
li°days
)

1200 
FILE
 *
fh™dÀ
;

1202 *
xli°
, *
xr°
;

1204 
dzh
 *
ªc‹dî
;

1206 
i
, 
j
, 
li°Àn
, 
xmax
, 
p
 = 0;

1207 
°©
 
dzh_f°©
;

1209 
SEXP
 
ªsu…
;

1210 *
vbuf
, *
fuŒ∑th
;

1212 
li°Àn
 = 
	`LENGTH
(
li°days
);

1214 
xli°
 = 
	`NUMERIC_POINTER
(
li°days
);

1216 
xmax
 = 
xli°
[
li°Àn
 - 1];

1218 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
li°Àn
 + 1));

1219 
p
++;

1221 
fuŒ∑th
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1222 
vbuf
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1223 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

1225 
	`¢¥ötf
(
fuŒ∑th
, 
MAX_STR_LEN
, "%s", 
	`CHAR
(
	`STRING_ELT
(
∑th«me
, 0)));

1227 
i
 = 
	`°æí
(
fuŒ∑th
);

1228 
i
 > 0) {

1229 i‡(
fuŒ∑th
[
i
] == '/')

1231 
i
--;

1233 
	`¢¥ötf
(
vbuf
, 8, "%s", 
fuŒ∑th
 + 
i
);

1235 
	`SET_VECTOR_ELT
(
ªsu…
, 0, 
	`SˇœrSåög
(
	`mkCh¨
(
vbuf
)));

1237 
xr°
 = 
	`CÆloc
(
li°Àn
, );

1239 i‡(
	`°©
(
	`CHAR
(
	`STRING_ELT
(
∑th«me
, 0)), &
dzh_f°©
) == 0) {

1241 
i
 = 0; i < 
li°Àn
; i++) {

1242 i‡(()(
dzh_f°©
.
°_size
 / 0x20Ë< 
xli°
[
i
])

1243 
xli°
[
i
] = 
NA_REAL
;

1246 i‡((
fh™dÀ
 = 
	`f›í
(
	`CHAR
(
	`STRING_ELT
(
∑th«me
, 0)), "rb")Ë!
NULL
) {

1247 
	`f£ek
(
fh™dÀ
, 0L - ((
xmax
 + 1Ë* 0x20), 
SEEK_END
);

1248 
i
 = 0;

1250 (
	`X‰ód
(
ªc‹dî
, 0x20, 1, 
fh™dÀ
Ë> 0Ë&& (
i
 < 
xmax
)) {

1252 
j
 = 0; j < 
li°Àn
 - 1; j++) {

1253 i‡(
j
 > (
xmax
 - 
i
 + 1)) {

1254 
xr°
[
j
] +
ªc‹dî
->
amou¡
;

1257 
i
++;

1260 
i
 = 0; i < 
li°Àn
; i++) {

1261 i‡(
xli°
[
i
] > 0) {

1262 
xr°
[
i
] /
xli°
[i];

1263 
	`SET_VECTOR_ELT
(
ªsu…
, 
i
 + 1, 
	`SˇœrRól
(
xr°
[i]));

1265 
	`SET_VECTOR_ELT
(
ªsu…
, 
i
 + 1, 
	`SˇœrRól
(
NA_REAL
));

1268 
	`f˛o£
(
fh™dÀ
);

1274 
	`‰ì
(
ªc‹dî
);

1275 
	`‰ì
(
fuŒ∑th
);

1276 
	`‰ì
(
vbuf
);

1277 
	`‰ì
(
xr°
);

1279 
	`UNPROTECT
(
p
);

1281  (
ªsu…
);

1282 
	}
}

1284 
SEXP
 
	$gëLa°AŒV
(
SEXP
 
≤ame
, SEXP 
li°days
)

1287 
dúít
 **
xdú
;

1288 
°©
 
x°©
;

1290 
m¶í
, 
xmax
, 
dmax
, 
i
, 
j
, 
n
, 
p
 = 0;

1292 
SEXP
 
ªsu…
, 
dim
;

1294 *
g°r
, *
fuŒ∑th
;

1296 *
du∂i°
, *
xli°
, *
xr°
;

1298 
FILE
 *
fh™dÀ
;

1299 
dzh
 *
ªc‹dî
 = 
NULL
;

1300 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

1302 i‡(
	`°©
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
x°©
) == 0) {

1304 i‡((
x°©
.
°_mode
 & 
S_IFMT
Ë=
S_IFREG
) {

1306  (
	`gëLa°Fûe
(
≤ame
, 
li°days
));

1311 
n
 = 
	`sˇndú
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
xdú
, 
NULL
, 
Æphas‹t
);

1312 
xmax
 = 
n
 - 2;

1314 
m¶í
 = 
	`LENGTH
(
li°days
);

1316 
xli°
 = 
	`NUMERIC_POINTER
(
li°days
);

1317 
dmax
 = 
xli°
[
m¶í
 - 1];

1319 
du∂i°
 = 
	`CÆloc
(
m¶í
, );

1321 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
xmax
 * (
m¶í
 + 1)));

1322 
p
++;

1324 
g°r
 = 
	`CÆloc
(16, );

1326 
fuŒ∑th
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1327 
xr°
 = 
	`CÆloc
(
m¶í
, );

1329 
n
--) {

1331 
	`mem£t
(
g°r
, 0x0, () * 16);

1332 
	`mem£t
(
fuŒ∑th
, 0x0, (Ë* 
MAX_STR_LEN
);

1333 
	`mem£t
(
xr°
, 0x0, (Ë* 
m¶í
);

1334 
i
 = 0; i < 
m¶í
; i++)

1335 
du∂i°
[
i
] = 
xli°
[i];

1337 i‡((
	`°rcmp
(
xdú
[
n
]->
d_«me
, ".") == 0) || (strcmp(xdir[n]->d_name, "..") == 0))

1340 ()
	`¢¥ötf
(
g°r
, 9, "%s", 
xdú
[
n
]->
d_«me
);

1341 
	`¢¥ötf
(
fuŒ∑th
, 
MAX_STR_LEN
, "%s/%s", 
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), 
xdú
[
n
]->
d_«me
);

1343 
	`SET_VECTOR_ELT
(
ªsu…
, 
n
 - 2, 
	`SˇœrSåög
(
	`mkCh¨
(
g°r
)));

1345 i‡(
	`°©
(
fuŒ∑th
, &
x°©
) == 0) {

1347 
i
 = 0; i < 
m¶í
; i++) {

1348 i‡(()(
x°©
.
°_size
 / 0x20Ë< 
du∂i°
[
i
])

1349 
du∂i°
[
i
] = 0;

1352 i‡((
fh™dÀ
 = 
	`f›í
(
fuŒ∑th
, "rb")Ë!
NULL
) {

1353 
	`f£ek
(
fh™dÀ
, 0L - ((
dmax
 + 1Ë* 0x20), 
SEEK_END
);

1354 
i
 = 0;

1356 (
	`X‰ód
(
ªc‹dî
, 0x20, 1, 
fh™dÀ
Ë> 0Ë&& (
i
 <
dmax
)) {

1358 
j
 = 0; j < 
m¶í
; j++) {

1359 i‡(
xli°
[
j
] > (
dmax
 - 
i
)) {

1360 
xr°
[
j
] +()
ªc‹dî
->
amou¡
;

1363 
i
++;

1367 
i
 = 0; i < 
m¶í
; i++) {

1368 i‡(
du∂i°
[
i
] > 0) {

1369 
xr°
[
i
] /
du∂i°
[i];

1370 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
xr°
[i]));

1372 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
NA_REAL
));

1374 
	`f˛o£
(
fh™dÀ
);

1379 
	`‰ì
(
xdú
[
n
]);

1383 
	`‰ì
(
fuŒ∑th
);

1384 
	`‰ì
(
ªc‹dî
);

1385 
	`‰ì
(
g°r
);

1386 
	`‰ì
(
xr°
);

1387 
	`‰ì
(
du∂i°
);

1388 
	`‰ì
(
xdú
);

1390 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

1391 
p
++;

1392 
	`INTEGER
(
dim
)[0] = 
xmax
;

1393 
	`INTEGER
(
dim
)[1] = 
m¶í
 + 1;

1394 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

1396 
	`UNPROTECT
(
p
);

1397  (
ªsu…
);

1399 
	}
}

1401 
SEXP
 
	$gëLa°AŒ
(
SEXP
 
≤ame
, SEXP 
li°days
)

1404 
dúít
 **
xdú
;

1405 
°©
 
x°©
;

1407 
m¶í
, 
xmax
, 
dmax
, 
i
, 
j
, 
n
, 
p
 = 0;

1409 
SEXP
 
ªsu…
, 
dim
;

1411 *
g°r
, *
fuŒ∑th
;

1413 *
du∂i°
, *
xli°
, *
xr°
;

1415 
FILE
 *
fh™dÀ
;

1416 
dzh
 *
ªc‹dî
 = 
NULL
;

1417 
ªc‹dî
 = 
	`CÆloc
(1, 
dzh
);

1419 i‡(
	`°©
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
x°©
) == 0) {

1421 i‡((
x°©
.
°_mode
 & 
S_IFMT
Ë=
S_IFREG
) {

1423  (
	`gëLa°Fûe
(
≤ame
, 
li°days
));

1428 
n
 = 
	`sˇndú
(
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), &
xdú
, 
NULL
, 
Æphas‹t
);

1429 
xmax
 = 
n
 - 2;

1431 
m¶í
 = 
	`LENGTH
(
li°days
);

1433 
xli°
 = 
	`NUMERIC_POINTER
(
li°days
);

1434 
dmax
 = 
xli°
[
m¶í
 - 1];

1436 
du∂i°
 = 
	`CÆloc
(
m¶í
, );

1438 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
xmax
 * (
m¶í
 + 1)));

1439 
p
++;

1441 
g°r
 = 
	`CÆloc
(16, );

1443 
fuŒ∑th
 = 
	`CÆloc
(
MAX_STR_LEN
, );

1444 
xr°
 = 
	`CÆloc
(
m¶í
, );

1446 
n
--) {

1448 
	`mem£t
(
g°r
, 0x0, () * 16);

1449 
	`mem£t
(
fuŒ∑th
, 0x0, (Ë* 
MAX_STR_LEN
);

1450 
	`mem£t
(
xr°
, 0x0, (Ë* 
m¶í
);

1451 
i
 = 0; i < 
m¶í
; i++)

1452 
du∂i°
[
i
] = 
xli°
[i];

1454 i‡((
	`°rcmp
(
xdú
[
n
]->
d_«me
, ".") == 0) || (strcmp(xdir[n]->d_name, "..") == 0))

1457 ()
	`¢¥ötf
(
g°r
, 9, "%s", 
xdú
[
n
]->
d_«me
);

1458 
	`¢¥ötf
(
fuŒ∑th
, 
MAX_STR_LEN
, "%s/%s", 
	`CHAR
(
	`STRING_ELT
(
≤ame
, 0)), 
xdú
[
n
]->
d_«me
);

1460 
	`SET_VECTOR_ELT
(
ªsu…
, 
n
 - 2, 
	`SˇœrSåög
(
	`mkCh¨
(
g°r
)));

1462 i‡(
	`°©
(
fuŒ∑th
, &
x°©
) == 0) {

1464 
i
 = 0; i < 
m¶í
; i++) {

1465 i‡(()(
x°©
.
°_size
 / 0x20Ë< 
du∂i°
[
i
])

1466 
du∂i°
[
i
] = 0;

1469 i‡((
fh™dÀ
 = 
	`f›í
(
fuŒ∑th
, "rb")Ë!
NULL
) {

1470 
	`f£ek
(
fh™dÀ
, 0L - ((
dmax
 + 1Ë* 0x20), 
SEEK_END
);

1471 
i
 = 0;

1473 (
	`X‰ód
(
ªc‹dî
, 0x20, 1, 
fh™dÀ
Ë> 0Ë&& (
i
 <
dmax
)) {

1475 
j
 = 0; j < 
m¶í
; j++) {

1476 i‡(
xli°
[
j
] > (
dmax
 - 
i
)) {

1477 
xr°
[
j
] +()
ªc‹dî
->
vﬁumn
;

1480 
i
++;

1484 
i
 = 0; i < 
m¶í
; i++) {

1485 i‡(
du∂i°
[
i
] > 0) {

1486 
xr°
[
i
] /
du∂i°
[i];

1487 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
xr°
[i]));

1489 
	`SET_VECTOR_ELT
(
ªsu…
, 
xmax
 * (
i
 + 1Ë+ 
n
 - 2, 
	`SˇœrRól
(
NA_REAL
));

1491 
	`f˛o£
(
fh™dÀ
);

1496 
	`‰ì
(
xdú
[
n
]);

1500 
	`‰ì
(
fuŒ∑th
);

1501 
	`‰ì
(
ªc‹dî
);

1502 
	`‰ì
(
g°r
);

1503 
	`‰ì
(
xr°
);

1504 
	`‰ì
(
du∂i°
);

1505 
	`‰ì
(
xdú
);

1507 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

1508 
p
++;

1509 
	`INTEGER
(
dim
)[0] = 
xmax
;

1510 
	`INTEGER
(
dim
)[1] = 
m¶í
 + 1;

1511 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

1513 
	`UNPROTECT
(
p
);

1514  (
ªsu…
);

1516 
	}
}

1518 
SEXP
 
	$c⁄vﬁve2
(
SEXP
 
ab
)

1521 
GlobÆP¨am
 *
gp
;

1522 
SEXP
 
abc
;

1524 
gp
 = 
	`CÆloc
(1, 
GlobÆP¨am
);

1525 
	`RódögP¨amSë
(
ab
, 
gp
);

1526  (
abc
);

1527 
	}
}

1529 
SEXP
 
	$c⁄vﬁve22
(
SEXP
 
a
, SEXP 
b
)

1531 
i
, 
j
, 
«
, 
nb
, 
«b
, 
p
 = 0;

1532 *
xa
, *
xb
, *
xab
;

1533 
SEXP
 
ab
;

1534 
	`PROTECT
(
a
 = 
	`AS_NUMERIC
(a));

1535 
p
++;

1536 
	`PROTECT
(
b
 = 
	`AS_NUMERIC
(b));

1537 
p
++;

1538 
«
 = 
	`LENGTH
(
a
);

1539 
nb
 = 
	`LENGTH
(
b
);

1540 
«b
 = 
«
 + 
nb
 - 1;

1541 
	`PROTECT
(
ab
 = 
	`NEW_NUMERIC
(
«b
));

1542 
p
++;

1544 
xa
 = 
	`NUMERIC_POINTER
(
a
);

1545 
xb
 = 
	`NUMERIC_POINTER
(
b
);

1546 
xab
 = 
	`NUMERIC_POINTER
(
ab
);

1548 
i
 = 0; i < 
«b
; i++)

1549 
xab
[
i
] = 0.0;

1550 
i
 = 0; i < 
«
; i++)

1551 
j
 = 0; j < 
nb
; j++)

1552 
xab
[
i
 + 
j
] +
xa
[i] * 
xb
[j];

1553 
	`w¨nög
("programming byÜyxmoo@msn.com");

1555 
	`UNPROTECT
(
p
);

1556  (
ab
);

1558 
	}
}

	@HftTrans.c

1 
	~"M⁄goQuîy.h
"

2 
	~"Rm⁄go.h
"

4 
	#BRIEFs
 9

	)

6 
	$£tBrõfDimName
(
SEXP
 
ªsu…
)

8 
ªtvÆ
 = 0;

9 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

10 
p
;

12 
p
 = 0;

14 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

15 
p
++;

16 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
BRIEFs
));

17 
p
++;

19 
	`SET_VECTOR_ELT
(
d«mes
, 0, 
	`mkCh¨
("bid"));

20 
	`SET_VECTOR_ELT
(
d«mes
, 1, 
	`mkCh¨
("ask"));

21 
	`SET_VECTOR_ELT
(
d«mes
, 2, 
	`mkCh¨
("bin"));

22 
	`SET_VECTOR_ELT
(
d«mes
, 3, 
	`mkCh¨
("bprc"));

23 
	`SET_VECTOR_ELT
(
d«mes
, 4, 
	`mkCh¨
("sout"));

24 
	`SET_VECTOR_ELT
(
d«mes
, 5, 
	`mkCh¨
("sprc"));

25 
	`SET_VECTOR_ELT
(
d«mes
, 6, 
	`mkCh¨
("biv"));

26 
	`SET_VECTOR_ELT
(
d«mes
, 7, 
	`mkCh¨
("akv"));

27 
	`SET_VECTOR_ELT
(
d«mes
, 8, 
	`mkCh¨
("masq"));

29 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
d«mes
);

30 
∫ames
 = 
R_NûVÆue
;

31 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
∫ames
);

33 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

35 
	`UNPROTECT
(
p
);

37  (
ªtvÆ
);

39 
	}
}

41 
	$£tTønsDimName
(
SEXP
 
ªsu…
)

43 
ªtvÆ
 = 0;

44 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

45 
p
;

47 
p
 = 0;

49 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

50 
p
++;

51 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
CONVERSLEN
));

52 
p
++;

54 
	`SET_VECTOR_ELT
(
d«mes
, 0, 
	`mkCh¨
("t"));

55 
	`SET_VECTOR_ELT
(
d«mes
, 1, 
	`mkCh¨
("hi"));

56 
	`SET_VECTOR_ELT
(
d«mes
, 2, 
	`mkCh¨
("lo"));

57 
	`SET_VECTOR_ELT
(
d«mes
, 3, 
	`mkCh¨
("avp"));

58 
	`SET_VECTOR_ELT
(
d«mes
, 4, 
	`mkCh¨
("tp"));

59 
	`SET_VECTOR_ELT
(
d«mes
, 5, 
	`mkCh¨
("tam"));

60 
	`SET_VECTOR_ELT
(
d«mes
, 6, 
	`mkCh¨
("bidp"));

61 
	`SET_VECTOR_ELT
(
d«mes
, 7, 
	`mkCh¨
("askp"));

62 
	`SET_VECTOR_ELT
(
d«mes
, 8, 
	`mkCh¨
("bid"));

63 
	`SET_VECTOR_ELT
(
d«mes
, 9, 
	`mkCh¨
("ask"));

64 
	`SET_VECTOR_ELT
(
d«mes
, 10, 
	`mkCh¨
("biInc"));

65 
	`SET_VECTOR_ELT
(
d«mes
, 11, 
	`mkCh¨
("biDec"));

66 
	`SET_VECTOR_ELT
(
d«mes
, 12, 
	`mkCh¨
("askInc"));

67 
	`SET_VECTOR_ELT
(
d«mes
, 13, 
	`mkCh¨
("askDec"));

68 
	`SET_VECTOR_ELT
(
d«mes
, 14, 
	`mkCh¨
("passBi"));

69 
	`SET_VECTOR_ELT
(
d«mes
, 15, 
	`mkCh¨
("actBi"));

70 
	`SET_VECTOR_ELT
(
d«mes
, 16, 
	`mkCh¨
("passAsk"));

71 
	`SET_VECTOR_ELT
(
d«mes
, 17, 
	`mkCh¨
("actAsk"));

72 
	`SET_VECTOR_ELT
(
d«mes
, 18, 
	`mkCh¨
("ff"));

73 
	`SET_VECTOR_ELT
(
d«mes
, 19, 
	`mkCh¨
("vtype"));

75 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
d«mes
);

76 
∫ames
 = 
R_NûVÆue
;

77 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
∫ames
);

78 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

80 
	`UNPROTECT
(
p
);

82  (
ªtvÆ
);

84 
	}
}

86 
	$brõfDiff
(*
d°
, 
å™sO±i⁄s
 * 
td°
)

88 
i
, 
j
, 
k
, 
ªtvÆ
 = 0;

89 
avPri˚
, 
amDiff
, 
vDiff
, 
up_thªs
, 
dn_thªs
, *
ds1
, *
ds2
;

93 
timevÆ
 
timî
;

94 
	`tic
(&
timî
);

96 
k
 = 0; k < 
td°
->
dims
[1] - 1; k++) {

98 
ds1
 = ((*)
td°
->
d©a_±r
Ë+ (td°->
dims
[0] * 
k
);

99 
ds2
 = 
ds1
 + 
td°
->
dims
[0];

101 
j
 = 
k
;

103 
i
 = 0; i <= 8; i += 2) {

104 *(
d°
 + 
j
Ë+*(
ds1
 + 
O1V
 + 
i
Ë* *(ds1 + 
O1P
 + i);

105 *(
d°
 + 
td°
->
dims
[1] + 
j
Ë+*(
ds1
 + 
B1V
 + 
i
Ë* *(ds1 + 
B1P
 + i);

108 
amDiff
 = *(
ds1
 + 
AM
Ë- *(ds1 + AM + 
td°
->
dims
[0]);

109 
vDiff
 = *(
ds1
 + 
VL
Ë- *(ds1 + VL + 
td°
->
dims
[0]);

110 
avPri˚
 = 
amDiff
 / 
vDiff
;

114 *(
d°
 + 
td°
->
dims
[1] * 3 + 
j
Ë
ds1
[
O1P
];

115 *(
d°
 + 
td°
->
dims
[1] * 5 + 
j
Ë
ds1
[
B1P
];

117 
up_thªs
 = 
	`round
((
ds1
[
YC
]) * 110) / 100;

118 
dn_thªs
 = 
	`round
((
ds1
[
YC
]) * 90) / 100;

120 i‡((
avPri˚
 >
ds2
[
B1P
]Ë&& (avPri˚ <ds2[
O1P
])) {

122 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

123 (
amDiff
 - 
vDiff
 * 
ds1
[
B1P
]Ë/ 
	`round
((ds1[
O1P
] - ds1[B1P]) * 100) * ds1[O1P] * 100;

125 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
) =

126 (
amDiff
 - 
vDiff
 * 
ds1
[
O1P
]Ë/ 
	`round
((ds1[
B1P
] - ds1[O1P]) * 100) * ds1[B1P] * 100;

131 i‡(
avPri˚
 < 
ds2
[
B5P
]) {

132 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

136 i‡(
avPri˚
 < 
ds2
[
B4P
]) {

137 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

138 
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
] + ds2[
B4V
] * ds2[
B4P
];

139 i‡(
vDiff
 - 
ds2
[
B4V
] - ds2[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

143 i‡(
avPri˚
 < 
ds2
[
B3P
]) {

144 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

145 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

149 i‡(
avPri˚
 < 
ds2
[
B2P
]) {

150 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
];

151 i‡(
vDiff
 - 
ds2
[
B2V
] - ds2[
B1V
] < 0)

155 i‡(
avPri˚
 < 
ds2
[
B1P
]) {

157 i‡(
vDiff
 > *(
ds1
 + 
B1V
 + 
td°
->
dims
[0])) {

158 *(
d°
 + 
td°
->
dims
[1] * 8 + 
j
Ë
amDiff
 - *(
ds1
 + 
B1V
 +Åd°->dims[0]Ë* *(ds1 + 
B1P
 +Ådst->dims[0]);

159 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë*(
ds1
 + 
B1V
 +Åd°->dims[0]Ë* *(ds1 + 
B1P
 +Ådst->dims[0]);

162 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

171 i‡(
avPri˚
 > 
ds2
[
O5P
]) {

172 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

176 i‡(
avPri˚
 > 
ds2
[
O4P
]) {

177 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

178 
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
] + ds2[
B4V
] * ds2[
B4P
];

179 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

183 i‡(
avPri˚
 > 
ds2
[
O3P
]) {

184 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

185 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

189 i‡(
avPri˚
 > 
ds2
[
O2P
]) {

190 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

191 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

195 i‡(
avPri˚
 > 
ds2
[
O1P
]) {

197 i‡(
vDiff
 > *(
ds1
 + 
O1V
 + 
td°
->
dims
[0])) {

198 *(
d°
 + 
td°
->
dims
[1] * 8 + 
j
Ë
amDiff
 - *(
ds1
 + 
O1V
 +Åd°->dims[0]Ë* *(ds1 + 
O1P
 +Ådst->dims[0]);

199 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë*(
ds1
 + 
O1V
 +Åd°->dims[0]Ë* *(ds1 + 
O1P
 +Ådst->dims[0]);

201 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë
amDiff
;

210 
	`toc
(&
timî
);

212  (
ªtvÆ
);

213 
	}
}

215 
	$dïTønsDiff
(*
d°
, 
å™sO±i⁄s
 * 
td°
)

217 
i
, 
j
, 
k
, 
ªtvÆ
 = 0;

218 
avPri˚
, 
amDiff
, 
vDiff
, 
up_thªs
, 
dn_thªs
, *
ds1
, *
ds2
;

222 
timevÆ
 
timî
;

223 
	`tic
(&
timî
);

225 
k
 = 0; k < 
td°
->
dims
[1] - 1; k++) {

227 
ds1
 = ((*)
td°
->
d©a_±r
Ë+ (td°->
dims
[0] * 
k
);

229 
j
 = 
k
;

231 
i
 = 0; i <= 8; i += 2) {

232 *(
d°
 + 
j
Ë+*(
ds1
 + 
O1V
 + 
i
Ë* *(ds1 + 
O1P
 + i);

233 *(
d°
 + 
td°
->
dims
[1] + 
j
Ë+*(
ds1
 + 
B1V
 + 
i
Ë* *(ds1 + 
B1P
 + i);

236 
amDiff
 = *(
ds1
 + 
AM
Ë- *(ds1 + AM + 
td°
->
dims
[0]);

237 
vDiff
 = *(
ds1
 + 
VL
Ë- *(ds1 + VL + 
td°
->
dims
[0]);

238 
avPri˚
 = 
amDiff
 / 
vDiff
;

242 *(
d°
 + 
td°
->
dims
[1] * 3 + 
j
Ë
ds1
[
O1P
];

243 *(
d°
 + 
td°
->
dims
[1] * 5 + 
j
Ë
ds1
[
B1P
];

245 
up_thªs
 = 
	`round
((
ds1
[
YC
]) * 110) / 100;

246 
dn_thªs
 = 
	`round
((
ds1
[
YC
]) * 90) / 100;

250 i‡(
avPri˚
 =
up_thªs
) {

252 i‡(
vDiff
 >
td°
->
gaöt
)

253 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë
amDiff
;

255 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

261 i‡(
avPri˚
 =
dn_thªs
) {

263 i‡(
vDiff
 >
td°
->
gaöt
)

264 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

266 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë
amDiff
;

272 
™y
 
Ÿhî
 
pú˚
, 
gaöt
 
ovî
 
bid
 
is
 
masq
}

274 
™y
 
Ÿhî
 
pú˚
, 
gaöt
 
blow
 
ask
 
is
 
masq
}

275 
£tdown
 
™d
 ;

278 i‡((
avPri˚
 >
ds1
[
B1P
]Ë&& (avPri˚ <ds1[
O1P
])) {

280 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

281 (
amDiff
 - 
vDiff
 * 
ds1
[
B1P
]Ë/ 
	`round
((ds1[
O1P
] - ds1[B1P]) * 100) * ds1[O1P] * 100;

283 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
) =

284 (
amDiff
 - 
vDiff
 * 
ds1
[
O1P
]Ë/ 
	`round
((ds1[
B1P
] - ds1[O1P]) * 100) * ds1[B1P] * 100;

287 
ds2
 = 
ds1
 + 
td°
->
dims
[0];

291 i‡(
avPri˚
 < 
ds2
[
B5P
]) {

292 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

296 i‡(
avPri˚
 < 
ds2
[
B4P
]) {

297 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

298 
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
] + ds2[
B4V
] * ds2[
B4P
];

299 i‡(
vDiff
 - 
ds2
[
B4V
] - ds2[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

303 i‡(
avPri˚
 < 
ds2
[
B3P
]) {

304 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

305 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

309 i‡(
avPri˚
 < 
ds2
[
B2P
]) {

310 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
];

311 i‡(
vDiff
 - 
ds2
[
B2V
] - ds2[
B1V
] < 0)

315 i‡(
avPri˚
 < 
ds1
[
B1P
]) {

317 i‡(
vDiff
 > *(
ds1
 + 
B1V
 + 
td°
->
dims
[0])) {

318 *(
d°
 + 
td°
->
dims
[1] * 8 + 
j
Ë
amDiff
 - *(
ds1
 + 
B1V
 +Åd°->dims[0]Ë* *(ds1 + 
B1P
 +Ådst->dims[0]);

319 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë*(
ds1
 + 
B1V
 +Åd°->dims[0]Ë* *(ds1 + 
B1P
 +Ådst->dims[0]);

322 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

331 i‡(
avPri˚
 > 
ds2
[
O5P
]) {

332 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
amDiff
;

336 i‡(
avPri˚
 > 
ds2
[
O4P
]) {

337 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
) =

338 
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
] + ds2[
B4V
] * ds2[
B4P
];

339 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

343 i‡(
avPri˚
 > 
ds2
[
O3P
]) {

344 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

345 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

349 i‡(
avPri˚
 > 
ds2
[
O2P
]) {

350 *(
d°
 + 
td°
->
dims
[1] * 2 + 
j
Ë
ds2
[
B1V
] * ds2[
B1P
] + ds2[
B2V
] * ds2[
B2P
] + ds2[
B3V
] * ds2[
B3P
];

351 i‡(
vDiff
 - 
ds2
[
B3V
] - ds2[
B2V
] - ds2[
B1V
] < 0)

355 i‡(
avPri˚
 > 
ds1
[
O1P
]) {

357 i‡(
vDiff
 > *(
ds1
 + 
O1V
 + 
td°
->
dims
[0])) {

358 *(
d°
 + 
td°
->
dims
[1] * 8 + 
j
Ë
amDiff
 - *(
ds1
 + 
O1V
 +Åd°->dims[0]Ë* *(ds1 + 
O1P
 +Ådst->dims[0]);

359 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë*(
ds1
 + 
O1V
 +Åd°->dims[0]Ë* *(ds1 + 
O1P
 +Ådst->dims[0]);

361 *(
d°
 + 
td°
->
dims
[1] * 4 + 
j
Ë
amDiff
;

370 
	`toc
(&
timî
);

372  (
ªtvÆ
);

373 
	}
}

375 
SEXP
 
	$R_h·Tøns
(
SEXP
 
öôLi°
)

378 
SEXP
 
ªsu…
, 
ñmt
;

379 
i
, 
˙t
, 
p
 = 0, *
ddims
;

381 *
x±r
, *
xmids
;

383 *
•å
, *
v±r
;

384 
å™sO±i⁄s
 *
å›t
;

386 
qV
 *
sd©a
=
NULL
;

387 
TickRaw
 *
tickøw
;

389 
å›t
 = 
	`CÆloc
(1, 
å™sO±i⁄s
);

390 
å›t
->
dims
 = 
	`CÆloc
(2, );

391 
å›t
->
dims
[0] = 0;

392 
å›t
->
dims
[1] = 0;

393 
å›t
->
mëhods
 = 0;

394 
å›t
->
tims
 = 
	`CÆloc
(2, );

395 
å›t
->
tims
[0] = 1;

396 
å›t
->
tims
[1] = 1;

398 
ªsu…
 = 
	`gëAârib
(
öôLi°
, 
R_NamesSymbﬁ
);

399 
v±r
 = 
NULL
;

401 
i
 = 0; i < 
	`LENGTH
(
ªsu…
); i++) {

403 
•å
 = 
	`°rdup
(
	`CHAR
(
	`STRING_ELT
(
ªsu…
, 
i
)));

404 
ñmt
 = 
	`VECTOR_ELT
(
öôLi°
, 
i
);

406 i‡(
	`°rcmp
(
•å
, "data") == 0) {

407 
ddims
 = 
	`INTEGER
(
	`GET_DIM
(
ñmt
));

408 
x±r
 = 
å›t
->
d©a_±r
 = 
	`NUMERIC_POINTER
(
ñmt
);

410 
å›t
->
dims
[0] = 
ddims
[0];

411 
å›t
->
dims
[1] = 
ddims
[1];

413 
sd©a
 = 
	`CÆloc
(1, 
qV
);

414 
sd©a
->
nRows
 = 
ddims
[0];

415 
sd©a
->
nCﬁs
 = 
ddims
[1];

416 
sd©a
->
v
 = 
	`REAL
(
ñmt
);

420 i‡(
	`°rcmp
(
•å
, "method") == 0) {

421 
v±r
 = 
	`°rdup
(
	`CHAR
(
	`STRING_ELT
(
ñmt
, 0)));

423 i‡(
	`°rcmp
(
v±r
, "brief") == 0)

424 
å›t
->
mëhods
 = 
METHOD_BRIEF
;

425 i‡(
	`°rcmp
(
v±r
, "detail") == 0)

426 
å›t
->
mëhods
 = 
METHOD_DEPTRANS
;

427 i‡(
	`°rcmp
(
v±r
, "tick") == 0)

428 
å›t
->
mëhods
 = 
METHOD_TICKTR
;

430 
	`‰ì
(
v±r
);

433 i‡(
	`°rcmp
(
•å
, "tims") == 0) {

435 
å›t
->
tims
[0] = 
	`REAL
(
ñmt
)[0];

436 
å›t
->
tims
[1] = 
	`REAL
(
ñmt
)[1];

441 i‡(
	`°rcmp
(
•å
, "big") == 0) {

442 
å›t
->
gaöt
 = 
	`REAL
(
ñmt
)[0];

443 
	`ndebug
("gaöàf‹ hugêbid-ask %ld \n", ()
å›t
->
gaöt
);

447 
	`‰ì
(
•å
);

451 i‡–
sd©a
 !
NULL
)

452 
å›t
->
mëhods
) {

454 
METHOD_BRIEF
:

456 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
å›t
->
dims
[1] * 
BRIEFs
));

458 
	`£tDim
(
ªsu…
, 
å›t
->
dims
[1], 
BRIEFs
);

459 
	`£tBrõfDimName
(
ªsu…
);

460 
xmids
 = 
	`NUMERIC_POINTER
(
ªsu…
);

461 
i
 = 0; i < 
å›t
->
dims
[1] * 
BRIEFs
; i++)

462 
xmids
[
i
] = 0.0f;

463 
	`brõfDiff
(
xmids
, 
å›t
);

464 
	`UNPROTECT
(1);

468 
METHOD_DEPTRANS
:

470 
p
 = 0;

471 
tickøw
 = 
	`tick2dëaû
(
sd©a
, 0);

473 i‡(
tickøw
 !
NULL
) {

474 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
tickøw
->
nRows
 *Åickøw->
nCﬁs
));

475 
p
++;

476 
˙t
 = 0; c¡ < 
tickøw
->
nRows
 *Åickøw->
nCﬁs
; cnt++)

477 
	`REAL
(
ªsu…
)[
˙t
] = 
tickøw
->
v
[cnt];

478 
	`£tDim
(
ªsu…
, 
tickøw
->
nCﬁs
,Åickøw->
nRows
);

479 
	`£tTønsDimName
(
ªsu…
);

481 
	`‰ì
(
tickøw
->
v
);

482 
	`‰ì
(
tickøw
);

484 
	`UNPROTECT
(
p
);

490 
METHOD_TICKTR
:

491 
p
 = 0;

492 
tickøw
 = 
	`tick2øw
(
sd©a
, 0);

494 i‡(
tickøw
 !
NULL
) {

495 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
tickøw
->
nRows
 *Åickøw->
nCﬁs
));

496 
p
++;

497 
˙t
 = 0; c¡ < 
tickøw
->
nRows
 *Åickøw->
nCﬁs
; cnt++)

498 
	`REAL
(
ªsu…
)[
˙t
] = 
tickøw
->
v
[cnt];

499 
	`£tDim
(
ªsu…
, 
tickøw
->
nCﬁs
,Åickøw->
nRows
);

500 
	`£tTønsDimName
(
ªsu…
);

502 
	`‰ì
(
tickøw
->
v
);

503 
	`‰ì
(
tickøw
);

505 
	`UNPROTECT
(
p
);

510 
	`ndebug
("methods is unknown!\n");

514 i‡(
å›t
->
dims
 !
NULL
)

515 
	`‰ì
(
å›t
->
dims
);

516 
	`‰ì
(
å›t
);

517  (
ªsu…
);

518 
	}
}

521 
SEXP
 
	$R_h·Tøns2
(
SEXP
 
öôLi°
)

524 
SEXP
 
ªsu…
, 
ñmt
;

525 
i
, 
n
, 
found
, 
p
 = 0, *
ddims
;

526 *
xr°
;

527 
x
, 
y
;;

529 *
•å
;

530 
qV
 *
sd©a
;

531 
TickRaw
 *
tickøw
;

533 
ªsu…
 = 
	`gëAârib
(
öôLi°
, 
R_NamesSymbﬁ
);

535 
i
 = 0; i < 
	`LENGTH
(
ªsu…
); i++) {

537 
•å
 = 
	`°rdup
(
	`CHAR
(
	`STRING_ELT
(
ªsu…
, 
i
)));

539 
ñmt
 = 
	`VECTOR_ELT
(
öôLi°
, 
i
);

540 i‡(
	`°rcmp
(
•å
, "data") == 0) {

541 
ddims
 = 
	`INTEGER
(
	`GET_DIM
(
ñmt
));

543 
sd©a
 = 
	`CÆloc
(1, 
qV
);

544 
sd©a
->
nRows
 = 
ddims
[0];

545 
sd©a
->
nCﬁs
 = 
ddims
[1];

546 
sd©a
->
v
 = 
	`REAL
(
ñmt
);

549 i‡(
	`°rcmp
(
•å
, "method") == 0) {

550 
	`ndebug
("mëhod†i†%s\n", 
	`CHAR
(
	`asCh¨
(
ñmt
)));

552 i‡(
	`°rcmp
(
•å
, "dims") == 0) {

554 
x
 = 
	`REAL
(
ñmt
)[0];

555 
y
 = 
	`REAL
(
ñmt
)[1];

557 
	`ndebug
("dim†f‹ ouçuà%d %d \n", ()
x
, ()
y
);

562 
p
 = 0;

563 
tickøw
 = 
	`tick2øw
(
sd©a
, 0);

565 i‡(
tickøw
 !
NULL
) {

566 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
tickøw
->
nRows
 *Åickøw->
nCﬁs
));

567 
p
++;

568 
n
 = 0;Ç < 
tickøw
->
nRows
 *Åickøw->
nCﬁs
;Ç++)

569 
	`REAL
(
ªsu…
)[
n
] = 
tickøw
->
v
[n];

570 
	`£tDim
(
ªsu…
, 
tickøw
->
nCﬁs
,Åickøw->
nRows
);

571 
	`£tTønsDimName
(
ªsu…
);

573 
	`‰ì
(
tickøw
->
v
);

574 
	`‰ì
(
tickøw
);

576 
	`UNPROTECT
(
p
);

580  (
ªsu…
);

582 
	}
}

	@MongoQuery.c

1 
	~"Rm⁄go.h
"

2 
	~"M⁄goQuîy.h
"

3 
	~<°rög.h
>

5 
	#is•a˚
(
q
Ë((q==' ')||(q=='\t'))

	)

7 
	#DROPDATABASE
 "d©aba£"

	)

8 
	#DROPCOLLECTION
 "cﬁÀ˘i⁄"

	)

10 
MgPx_comm™d
 
	gCMD
[] = {

12 {"£À˘", "£À˘ comm™d", 
NULL
, 
£À˘_cmd
, 0} ,

15 {"zñe˘", "£À˘Åønsf‹mÅÿzù gridfs", 
NULL
, 
zñe˘_cmd
, 0},

18 {"xñe˘", "£À˘ from zùed gridfs", 
NULL
, 
xñe˘_cmd
, 0},

21 {"dñëe", "dñëêcomm™d", 
NULL
, 
dñëe_cmd
, 0} ,

22 {"ö£π", "ö£π comm™d", 
NULL
, 
ö£π_cmd
, 0} ,

23 {"dr›", "dr› comm™d", 
NULL
, 
dr›_cmd
, 0} ,

24 {
NULL
, NULL, NULL, NULL, 0}

27 
	$‰ìVdLi°
(
qVdms
 * 
li°
)

30 
ªtvÆ
;

31 
qVdms
 *
qVCur
, *
qVPå
;

33 
ªtvÆ
 = 0;

34 
qVCur
 = 
li°
;

36 
qVCur
 !
NULL
) {

37 
qVPå
 = 
qVCur
;

38 
qVCur
 = qVCur->
√xt
;

39 i‡(
qVPå
->
dm
 !
NULL
)

40 
	`‰ì
(
qVPå
->
dm
);

41 
	`‰ì
(
qVPå
);

44  (
ªtvÆ
);

46 
	}
}

48 
	$‰ìQvLi°
(
qV
 * 
li°
)

51 
ªtvÆ
;

52 
qV
 *
qVCur
, *
qVPå
;

54 
ªtvÆ
 = 0;

55 
qVCur
 = 
li°
;

57 
qVCur
 !
NULL
) {

58 
qVPå
 = 
qVCur
;

59 
qVCur
 = qVCur->
√xt
;

61 i‡(
qVPå
->
v
 !
NULL
)

62 
	`‰ì
(
qVPå
->
v
);

63 
	`‰ì
(
qVPå
);

67  (
ªtvÆ
);

69 
	}
}

71 
	$mybs⁄_dump_øw
(
m⁄goP¨am
 * 
gp
, 
dïth
)

74 
bs⁄_ôî©‹
 
i
;

76 
bs⁄_ty≥
 
t
;

78 c⁄° *
key
;

79 *
°rBuf
;

81 
˙t
, 
‹dî
;

83 
qVdms
 *
vDhód
, *
vDcuº
;

84 *
dfBuff
;

86 
˙t
 = 
‹dî
 = 0;

87 
vDhód
 = 
vDcuº
 = 
NULL
;

89 
dfBuff
 = 
	`CÆloc
(256, );

90 
	`mem£t
(
dfBuff
, 0x0, () * 256);

92 
	`bs⁄_ôî©‹_öô
(&
i
, 
	`m⁄go_curs‹_bs⁄
(
gp
->
curs‹
));

94 
	`bs⁄_ôî©‹_√xt
(&
i
)) {

96 
t
 = 
	`bs⁄_ôî©‹_ty≥
(&
i
);

98 i‡(
t
 == 0)

101 
key
 = 
	`bs⁄_ôî©‹_key
(&
i
);

103 i‡((
gp
->
£tSètus
 & 
£tCﬁs
) == 0) {

105 i‡(
vDhód
 =
NULL
) {

106 
vDhód
 = 
vDcuº
 = 
	`CÆloc
(1, 
qVdms
);

108 
vDcuº
->
√xt
 = 
NULL
;

110 
vDcuº
->
√xt
 = 
	`CÆloc
(1, 
qVdms
);

111 
vDcuº
 = vDcuº->
√xt
;

112 
vDcuº
->
√xt
 = 
NULL
;

114 
vDcuº
->
dm
 = 
	`°rdup
(
key
);

115 
˙t
++;

118 
‹dî
) {

120 
dfBuff
[
‹dî
] = ()
gp
->
nRows
;

124 
°rBuf
 = 
	`°rdup
((*)
	`bs⁄_ôî©‹_°rög
(&
i
));

125 
dfBuff
[
‹dî
] = 
	`©ﬁl
(
°rBuf
 + 2);

129 
dfBuff
[
‹dî
] = 
	`bs⁄_ôî©‹_doubÀ
(&
i
);

133 
‹dî
++;

136 i‡(
‹dî
 != 0) {

138 i‡((
gp
->
£tSètus
 & 
£tCﬁs
) == 0) {

139 
gp
->
£tSètus
 |
£tCﬁs
;

140 
gp
->
qVli°
 = gp->
qVcuº
 = 
	`CÆloc
(1, 
qV
);

141 
gp
->
qVcuº
->
√xt
 = 
NULL
;

142 
gp
->
qVcuº
->
v
 = 
NULL
;

144 
	`PROTECT
(
gp
->
CﬁNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
˙t
));

145 
gp
->
nCﬁs
 = 
˙t
;

146 
vDcuº
 = 
vDhód
;

148 
˙t
 = 0;

149 
vDcuº
 !
NULL
) {

150 
	`SET_VECTOR_ELT
(
gp
->
CﬁNames
, 
˙t
, 
	`mkCh¨
(
vDcuº
->
dm
));

151 
vDcuº
 = vDcuº->
√xt
;

152 
˙t
++;

155 
	`‰ìVdLi°
(
vDhód
);

156 
	`UNPROTECT
(1);

159 
gp
->
qVcuº
->
√xt
 = 
	`CÆloc
(1, 
qV
);

160 
gp
->
qVcuº
 = gp->qVcuº->
√xt
;

161 
gp
->
qVcuº
->
√xt
 = 
NULL
;

162 
gp
->
qVcuº
->
v
 = 
NULL
;

165 i‡(
gp
->
nCﬁs
 != 0) {

166 
gp
->
qVcuº
->
v
 = 
	`CÆloc
(gp->
nCﬁs
, );

167 
	`mem˝y
(
gp
->
qVcuº
->
v
, 
dfBuff
, (Ë* gp->
nCﬁs
);

172 
	`‰ì
(
dfBuff
);

173  (
˙t
);

174 
	}
}

176 
	$dumpM⁄goFound
(
m⁄goP¨am
 * 
gp
)

179 
ªtvÆ
 = 0;

181 
ãmp
 = 1;

183 
	`m⁄go_curs‹_√xt
(
gp
->
curs‹
Ë=
MONGO_OK
) {

185 
gp
->
nRows
 = 
ãmp
;

187 i‡(
ªtvÆ
 = 
	`mybs⁄_dump_øw
(
gp
, 0) < 0)

190 i‡((
gp
->
qs
->
limôs
 !0Ë&& (
ãmp
 >= gp->qs->limits))

193 
ãmp
++;

196 
	`m⁄go_curs‹_de°roy
(
gp
->
curs‹
);

198  (
ªtvÆ
);

199 
	}
}

201 
	$quîyRu¬ög
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

204 
i
, 
nCh¨
;

211 
bs⁄
 
bbuf
;

213 *
tokPå
;

214 *
nsSrc
, *
nsDe°
, *
°mp
;

216 
gp
->
°rVÆue
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

218 
gp
->
qs
->
limôs
 = 0;

220 
i
 = 1;

221 
i
 < 
¨gs
->
¨gc
) {

223 i‡((
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "all", 3) == 0)

224 || 
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "*", 1) == 0) {

226 
	`bs⁄_öô
(&
bbuf
);

227 
gp
->
£tSètus
 &(
£tC⁄n
 | 
£tDB
 | 
£tGridfs
 | 
£tNoBQ
 | 
£tREMOVE
);

228 
gp
->
£tSètus
 |
£tBs⁄Inôed
;

229 
gp
->
nCﬁs
 = 0;

230 
gp
->
qVli°
 = gp->
qVcuº
 = 
NULL
;

232 } i‡(
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "from", 4) == 0) {

233 
i
++;

234 
gp
->
ns
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

235 
	`•rötf
(
gp
->
ns
, "%s.%s", gp->
M⁄goDB
, 
¨gs
->
¨gv
[
i
]);

237 i‡((
gp
->
£tSètus
 & 
£tGridfs
) != 0)

238 
	`•rötf
(
gp
->
gridFûeName
, "%s/%s", gp->
M⁄goDB
, 
¨gs
->
¨gv
[
i
]);

240 
gp
->
£tSètus
 |
£tCﬁÀ˘i⁄
;

242 } i‡(
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "where", 5) == 0) {

243 
i
++;

244 
nCh¨
 = 0;

245 
°mp
 = 
¨gs
->
¨gv
[
i
];

246 i‡((
tokPå
 = 
	`°r°r
(
°mp
, ">=")Ë!
NULL
) {

247 
nCh¨
 = 2;

248 } i‡((
tokPå
 = 
	`°r°r
(
°mp
, "<=")Ë!
NULL
) {

249 
nCh¨
 = 2;

250 } i‡((
tokPå
 = 
	`°r°r
(
°mp
, "!=")Ë!
NULL
) {

251 
nCh¨
 = 2;

252 } i‡((
tokPå
 = 
	`°r°r
(
°mp
, "=")Ë!
NULL
) {

253 
nCh¨
 = 1;

255 
nsSrc
 = 
	`°∫dup
(
¨gs
->
¨gv
[
i
], 
tokPå
 - 
°mp
);

256 
nsDe°
 = 
	`°rdup
(
tokPå
 + 
nCh¨
);

258 i‡((
gp
->
£tSètus
 & 
£tGridfs
) != 0)

259 
	`•rötf
(
gp
->
gridFûeName
 + 
	`°æí
(gp->gridFûeName), "_%s.lz4", 
nsDe°
);

261 i‡(((
gp
->
£tSètus
 & 
£tBs⁄Inôed
) ^ setBsonInited) == 0) {

262 
	`bs⁄_≠≥nd_°rög
(&
bbuf
, 
nsSrc
, 
nsDe°
);

265 
	`‰ì
(
nsSrc
);

266 
	`‰ì
(
nsDe°
);

269 } i‡(
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "limit", 5) == 0) {

270 
i
++;

271 
gp
->
qs
->
limôs
 = 
	`©oi
(
¨gs
->
¨gv
[
i
]);

273 } i‡(
	`°∫cmp
(
¨gs
->
¨gv
[
i
], "skip", 4) == 0) {

274 
i
++;

275 
gp
->
qs
->
skù
 = 
	`©oi
(
¨gs
->
¨gv
[
i
]);

278 
i
++;

281 ((
gp
->
£tSètus
 & 
MASKSET
Ë^ (
£tC⁄n
 | 
£tDB
 | 
£tCﬁÀ˘i⁄
 | 
£tBs⁄Inôed
)) == 0) {

283 i‡((
gp
->
£tSètus
 & 
£tNoBQ
) != 0)

286 
	`bs⁄_föish
(&
bbuf
);

288 i‡((
gp
->
£tSètus
 & 
£tREMOVE
) != 0) {

289 
	`m⁄go_ªmove
(
gp
->
c⁄n
, gp->
ns
, &
bbuf
, 
NULL
);

291 i‡((
gp
->
curs‹
 = 
	`m⁄go_föd
(gp->
c⁄n
, gp->
ns
, &
bbuf
, 
NULL
, gp->
qs
->
limôs
, gp->qs->
skù
, 0)) != NULL)

292 
	`dumpM⁄goFound
(
gp
);

298 
	`‰ì
(
gp
->
°rVÆue
);

299 
gp
->
°rVÆue
 = 
NULL
;

301 i‡((
gp
->
£tSètus
 & 
£tCﬁÀ˘i⁄
) != 0)

302 
	`‰ì
(
gp
->
ns
);

304  (
i
);

305 
	}
}

307 
	$£À˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

309 
ªtvÆ
;

310 *
x±r
;

311 
SEXP
 
dims
, 
dimNames
, 
∫ames
;

313 
ªtvÆ
 = 
	`quîyRu¬ög
(
¨gs
, 
gp
);

315 i‡(
gp
->
nCﬁs
 == 0) {

316 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
EMPTYROWS
));

317 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

318 
	`mem£t
(
x±r
, 
NA_REAL
, (Ë* 
EMPTYROWS
);

319 
gp
->
nCﬁs
 = 
EMPTYROWS
;

320 
gp
->
nRows
 = 1;

321 
	`£tDim
(
gp
->
ªsu…
, gp->
nCﬁs
, gp->
nRows
);

322 
	`UNPROTECT
(1);

323 
	`‰ìQvLi°
(
gp
->
qVli°
);

325 } i‡((
gp
->
£tSètus
 & 
£tCﬁs
) != 0) {

327 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, gp->
nCﬁs
 * gp->
nRows
));

328 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

329 
gp
->
qVcuº
 = gp->
qVli°
;

331 
gp
->
qVcuº
 !
NULL
) {

332 
	`mem˝y
(
x±r
, 
gp
->
qVcuº
->
v
, (Ë* gp->
nCﬁs
);

333 
x±r
 = x±∏+ 
gp
->
nCﬁs
;

334 
gp
->
qVcuº
 = gp->qVcuº->
√xt
;

337 
	`PROTECT
(
dims
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

338 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

339 
	`INTEGER
(
dims
)[0] = 
gp
->
nCﬁs
;

340 
	`INTEGER
(
dims
)[1] = 
gp
->
nRows
;

342 
	`£tAârib
(
gp
->
ªsu…
, 
R_DimSymbﬁ
, 
dims
);

344 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
gp
->
CﬁNames
);

345 
∫ames
 = 
R_NûVÆue
;

346 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
∫ames
);

348 
	`£tAârib
(
gp
->
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

350 
	`UNPROTECT
(3);

354  (
ªtvÆ
);

356 
	}
}

358 
	$ö£π_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

361 
i
;

362 
	`ndebug
("ö£πÑu¬ög %d\n", 
gp
->
nSîvî
);

363 
i
 = 0;

364 
i
++ < 
¨gs
->
¨gc
)

365 
	`ndebug
("%†\n", 
¨gs
->
¨gv
[
i
 - 1]);

367  (
i
);

368 
	}
}

370 
	$dr›_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

373 
i
;

374 
bs⁄
 
b
;

375 *
ns
;

381 
i
 = 0;

383 
gp
->
°rVÆue
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

384 i‡(
	`°∫cmp
(
¨gs
->
¨gv
[1], 
DROPDATABASE
, 8) == 0) {

385 i‡((
i
 = 
	`m⁄go_cmd_dr›_db
(
gp
->
c⁄n
, 
¨gs
->
¨gv
[2])) == 0)

386 
	`•rötf
(
gp
->
°rVÆue
, "dr› d©aba£ %†suc˚s†ªtu∫ %d\n", 
¨gs
->
¨gv
[2], 
i
);

388 
	`•rötf
(
gp
->
°rVÆue
, "dr› d©aba£ %†ÁûedÑëu∫ %d\n", 
¨gs
->
¨gv
[2], 
i
);

391 i‡(
	`°∫cmp
(
¨gs
->
¨gv
[1], 
DROPCOLLECTION
, 10) == 0) {

392 
ns
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

393 
	`•rötf
(
ns
, "%s.%s", 
gp
->
M⁄goDB
, 
¨gs
->
¨gv
[2]);

394 i‡(((
i
 = 
	`m⁄go_cmd_dr›_cﬁÀ˘i⁄
(
gp
->
c⁄n
, gp->
M⁄goDB
, 
¨gs
->
¨gv
[2], 
NULL
)) == 0)

395 && 
	`m⁄go_föd_⁄e
(
gp
->
c⁄n
, 
ns
, 
	`bs⁄_sh¨ed_em±y
(), bs⁄_sh¨ed_em±y(), 
NULL
)) {

396 
	`•rötf
(
gp
->
°rVÆue
, "dr› cﬁÀ˘i⁄ %s.%†ÁûedÑëu∫ %d\n", gp->
M⁄goDB
, 
¨gs
->
¨gv
[2], 
i
);

399 
	`•rötf
(
gp
->
°rVÆue
, "dr› cﬁÀ˘i⁄ %s.%†suc˚s†ªtu∫ %d\n", gp->
M⁄goDB
, 
¨gs
->
¨gv
[2], 
i
);

400 
	`‰ì
(
ns
);

403 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
STRSXP
, 1));

404 
	`SET_STRING_ELT
(
gp
->
ªsu…
, 0, 
	`mkCh¨
(gp->
°rVÆue
));

405 
	`UNPROTECT
(1);

406 
	`‰ì
(
gp
->
°rVÆue
);

407 
gp
->
°rVÆue
 = 
NULL
;

409  (
i
);

410 
	}
}

412 
	$dñëe_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

415 
ªtvÆ
 = 0;

417 
gp
->
£tSètus
 |
£tREMOVE
;

419 
ªtvÆ
 = 
	`quîyRu¬ög
(
¨gs
, 
gp
);

421 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
STRSXP
, 1));

422 
gp
->
°rVÆue
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

423 
	`•rötf
(
gp
->
°rVÆue
, "done");

424 
	`SET_STRING_ELT
(
gp
->
ªsu…
, 0, 
	`mkCh¨
(gp->
°rVÆue
));

425 
	`UNPROTECT
(1);

427 
	`‰ì
(
gp
->
°rVÆue
);

428 
gp
->
°rVÆue
 = 
NULL
;

430  (
ªtvÆ
);

431 
	}
}

433 
	$upd©e_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

436 
i
;

437 
	`ndebug
("dr›Ñu¬ög %d\n", 
gp
->
nSîvî
);

438 
i
 = 0;

439 
i
++ < 
¨gs
->
¨gc
)

440 
	`ndebug
("%†\n", 
¨gs
->
¨gv
[
i
 - 1]);

441  (
i
);

442 
	}
}

444 
ölöe
 *
	$föd•a˚
(*
§c
)

447 *
t1
;

448 *
t2
;

450 
t1
 = 
	`°rchr
(
§c
, ' ');

451 
t2
 = 
	`°rchr
(
§c
, '\t');

452 i‡(
t1
 && 
t2
) {

453 i‡(
t1
 < 
t2
)

454 
t2
 = 
NULL
;

456 
t1
 = 
NULL
;

459 i‡(
t1
)

460  
t1
;

461  
t2
;

462 
	}
}

464 
	$¨gcou¡
(c⁄° *
°rög
)

467 
 
;

468 
˙t
;

469 
i
;

471 
˙t
 = 1;

472 
 
 = 
	`°æí
(
°rög
);

473 
i
 = 0;

475 
i
 < 
 
) {

476 i‡(
	`is•a˚
(
°rög
[
i
])) {

477 
	`is•a˚
(
°rög
[
i
]))

478 ++
i
;

479 i‡(
°rög
[
i
])

480 ++
˙t
;

482 ++
i
;

485  
˙t
;

486 
	}
}

488 
MgPx_¨gli°
 *
	$√w_¨gs
()

491 
MgPx_¨gli°
 *
ªs
;

493 
ªs
 = 
	`CÆloc
(1, 
MgPx_¨gli°
);

494 
ªs
->
¨gc
 = 0;

495 
ªs
->
¨gv
 = 
NULL
;

496  (
ªs
);

497 
	}
}

499 
	$add_¨gs
(
MgPx_¨gli°
 * 
¨g
, c⁄° *
ñm
)

502 i‡(
¨g
->
¨gc
) {

503 
¨g
->
¨gv
 = (**)
	`ªÆloc
◊rg->¨gv, (¨g->
¨gc
 + 1) * (*));

504 
¨g
->
¨gv
[¨g->
¨gc
++] = 
	`°rdup
(
ñm
);

506 
¨g
->
¨gc
 = 1;

507 
¨g
->
¨gv
 = (**)
	`mÆloc
((*));

508 
¨g
->
¨gv
[0] = 
	`°rdup
(
ñm
);

510 
	}
}

512 
MgPx_¨gli°
 *
	$make_¨gs
(c⁄° *
°rög
)

515 
MgPx_¨gli°
 *
ªsu…
;

516 *
rightbound
;

517 *
w‹d
;

518 *
¸§
;

519 
cou¡
;

520 
pos
;

522 
ªsu…
 = 
	`CÆloc
(1, 
MgPx_¨gli°
);

523 
cou¡
 = 
	`¨gcou¡
(
°rög
);

524 
ªsu…
->
¨gc
 = 
cou¡
;

526 
ªsu…
->
¨gv
 = (**)
	`mÆloc
(
cou¡
 * (*));

528 
¸§
 = (*)
°rög
;

529 
pos
 = 0;

531 (
rightbound
 = 
	`föd•a˚
(
¸§
))) {

532 
w‹d
 = 
	`CÆloc
((
rightbound
 - 
¸§
 + 3), );

533 
	`mem˝y
(
w‹d
, 
¸§
, 
rightbound
 - crsr);

534 
w‹d
[
rightbound
 - 
¸§
] = 0;

535 
ªsu…
->
¨gv
[
pos
++] = 
w‹d
;

536 
¸§
 = 
rightbound
;

537 
	`is•a˚
(*
¸§
))

538 ++
¸§
;

540 i‡(*
¸§
) {

541 
w‹d
 = 
	`°rdup
(
¸§
);

542 
ªsu…
->
¨gv
[
pos
++] = 
w‹d
;

545  
ªsu…
;

546 
	}
}

548 
	$de°roy_¨gs
(
MgPx_¨gli°
 * 
l°
)

551 
i
;

552 
i
 = 0; i < 
l°
->
¨gc
; ++i)

553 
	`‰ì
(
l°
->
¨gv
[
i
]);

555 
	`‰ì
(
l°
->
¨gv
);

556 
	`‰ì
(
l°
);

557 
	}
}

559 
SEXP
 
	$R_M⁄goQuîy
(
SEXP
 
£xpObj
, SEXP 
öôLi°
)

562 
i
, 
found
;

564 
m⁄goP¨am
 *
gp
;

565 
MgPx_¨gli°
 *
¨gs
;

566 
MgPx_comm™d
 *
xcmd
;

567 *
•å
;

568 *
x±r
;

570 
gp
 = 
	`gëGPRObje˘
(
£xpObj
);

571 i‡(
gp
->
qs
 !
NULL
) {

572 i‡(
gp
->
qs
->
key
 !
NULL
)

573 
	`‰ì
(
gp
->
qs
->
key
);

574 
	`‰ì
(
gp
->
qs
);

577 
gp
->
qs
 = 
	`CÆloc
(1, 
quîySåög
);

582 
•å
 = 
	`°rdup
(
	`CHAR
(
	`STRING_ELT
(
öôLi°
, 0)));

584 
¨gs
 = 
	`make_¨gs
(
•å
);

586 
found
 = -1;

587 
gp
->
£tSètus
 &(
£tC⁄n
 | 
£tDB
);

589 
i
 = 0; 
CMD
[i].
«me
 !
NULL
; i++) {

591 i‡(
	`°∫cmp
(
¨gs
->
¨gv
[0], 
CMD
[
i
].
«me
, 
	`°æí
(CMD[i].name)) == 0) {

592 
found
 = 
i
;

593 
xcmd
 = &
CMD
[
i
];

596 i‡(
CMD
[
i
].
«me
 =
NULL
)

600 
	`‰ì
(
•å
);

604 i‡(
found
 != -1) {

606 i‡(
xcmd
->
func
) {

607 (
found
 = (*
xcmd
->
func
Ë(
¨gs
, 
gp
));

612 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
EMPTYROWS
));

613 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

614 
	`mem£t
(
x±r
, 
NA_REAL
, (Ë* 
EMPTYROWS
);

615 
	`UNPROTECT
(1);

623 
	`de°roy_¨gs
(
¨gs
);

625  (
gp
->
ªsu…
);

627 
	}
}

	@MongoQuery.h

1 
	~"Rm⁄go.h
"

3 
	#EMPTYROWS
 33

	)

7 
	m¨gc
;

8 **
	m¨gv
;

9 } 
	tMgPx_¨gli°
;

11 
	sMgPx_Comm™d
 {

12 c⁄° *
	m«me
;

13 c⁄° *
	mhñp
;

14 
MgPx_Comm™d
 *
	mchûdªn
;

15 (* 
	mfunc
)(
	mMgPx_¨gli°
 *,
	mm⁄goP¨am
 *);

16 
	m¥ivûege
;

17 } 
	tMgPx_comm™d
;

19 
MgPx_comm™d
 
CMD
[];

21 
£tDim
(
SEXP
 , 
nCﬁ
, 
nRow
);

23 
£À˘_cmd
 (
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

24 
dñëe_cmd
 (
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

26 
zñe˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

27 
xñe˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

29 
quîyRu¬ög
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

30 
d£À˘_cmd
 (
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

31 
z2gridfs
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

32 
ö£π_cmd
 (
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

33 
dr›_cmd
 (
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
);

34 
mybs⁄_dump_øw
 (
m⁄goP¨am
 *,
dïth
);

35 
‰ìQvLi°
 (
qV
 *);

	@Rmongo.c

19 
	~"Rm⁄go.h
"

21 
	eM⁄goO±
 {

22 
	mdefmHo°
 = 0,

23 
	mdefmP‹t
,

24 
	mde‚Sîvî
,

25 
	mdefSîvî
,

26 
	mdefP‹t
,

27 
	mdefQuîy
,

28 
	mdefQuîyO√
,

29 
	mdefDB
,

30 
	mdefDoC⁄√˘
,

31 
	mdefOthî
,

32 
	mdefNuŒ


33 } 
	tm⁄goO±
;

35 
	sSîvîLi°
 {

36 *
	m›tName
;

37 
m⁄goO±
 
	m›Ty≥
;

38 *
	m›î©i⁄
;

39 } 
	t£rvîLi°
;

41 
£rvîLi°
 
	g§vO±
[] = {

42 {"m⁄goHo°=%s", 
defmHo°
, 
NULL
},

43 {"mHo°=%s", 
defmHo°
, 
NULL
},

44 {"m⁄goP‹t=%d", 
defmP‹t
, 
NULL
},

45 {"mP‹t=%d", 
defmP‹t
, 
NULL
},

46 {"Sîvî%d=%s", 
defSîvî
, 
NULL
},

47 {"P‹t%d=%d", 
defP‹t
, 
NULL
},

48 {"nSîvîs=%d", 
de‚Sîvî
, 
NULL
},

49 {"D©aBa£=%d", 
defDB
, 
NULL
},

50 {"DB=%d", 
defDB
, 
NULL
},

51 {"DoC⁄√˘=%u", 
defDoC⁄√˘
, 
NULL
},

52 {"doC⁄√˘=%u", 
defDoC⁄√˘
, 
NULL
},

53 {
NULL
, 
defNuŒ
, NULL}

56 
	#lSLí
 8

	)

57 
	#lSîvî
 6

	)

58 
	#lP‹t
 4

	)

60 
R_föÆizeGP
(
SEXP
);

62 
	$dige°2hex
(
dige°
[16], 
hex_dige°
[33])

64 c⁄° 
hex
[16] = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };

65 
i
;

66 
i
 = 0; i < 16; i++) {

67 
hex_dige°
[2 * 
i
] = 
hex
[(
dige°
[i] & 0xf0) >> 4];

68 
hex_dige°
[2 * 
i
 + 1] = 
hex
[
dige°
[i] & 0x0f];

70 
hex_dige°
[32] = '\0';

71 
	}
}

73 
	$‰ìSîvîLi°
(
m⁄goSîvî
 * 
li°
)

75 
ªtvÆ
;

76 
m⁄goSîvî
 *
SîvîCur
, *
SîvîPå
;

78 
ªtvÆ
 = 0;

79 
SîvîCur
 = 
li°
;

80 
SîvîCur
 !
NULL
) {

81 
SîvîPå
 = 
SîvîCur
;

82 
SîvîCur
 = SîvîCur->
√xt
;

84 i‡(
SîvîPå
->
M⁄goSîvî
 !
NULL
)

85 
	`‰ì
(
SîvîPå
->
M⁄goSîvî
);

86 
	`‰ì
(
SîvîPå
);

90  (
ªtvÆ
);

92 
	}
}

94 
	$ösSîvî
(
m⁄goSîvî
 * 
hd
, 
id
, *
s
)

96 
ªtvÆ
;

97 
ªtvÆ
 = 0;

99 
m⁄goSîvî
 *
£rvîPå
;

100 
£rvîPå
 = 
hd
;

102 
£rvîPå
 !
NULL
) {

103 i‡(
£rvîPå
->
id
 == id) {

104 
£rvîPå
->
M⁄goSîvî
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

105 
	`¢¥ötf
(
£rvîPå
->
M⁄goSîvî
, 
STR_BUFF_LEN
, "%s", 
s
);

109 
£rvîPå
 = sîvîPå->
√xt
;

112  (
ªtvÆ
);

113 
	}
}

115 
	$ösP‹t
(
m⁄goSîvî
 * 
hd
, 
id
, 
p‹t
)

117 
ªtvÆ
;

118 
ªtvÆ
 = 0;

120 
m⁄goSîvî
 *
£rvîPå
;

121 
£rvîPå
 = 
hd
;

123 
£rvîPå
 !
NULL
) {

124 i‡(
£rvîPå
->
id
 == id) {

125 
£rvîPå
->
M⁄g›‹t
 = 
p‹t
;

128 
£rvîPå
 = sîvîPå->
√xt
;

131  (
ªtvÆ
);

133 
	}
}

135 
	$doC⁄√˘
(
m⁄goP¨am
 * 
mp
)

137 
ªtvÆ
;

138 
ªtvÆ
 = 0;

140 
m⁄goSîvî
 *
£rvîPå
;

142 
£rvîPå
 = 
mp
->
Sîvîs
;

144 
mp
->
c⁄n
 = 
	`CÆloc
(1, 
m⁄go
);

146 i‡(
mp
->
nSîvî
 >= 2) {

148 
	`m⁄go_ª∂£t_öô
(
mp
->
c⁄n
, "replset-my-app");

149 
£rvîPå
->
√xt
 !
NULL
) {

150 i‡((
£rvîPå
->
M⁄goSîvî
 !
NULL
Ë&& (£rvîPå->
M⁄g›‹t
 != 0))

151 
	`m⁄go_ª∂£t_add_£ed
(
mp
->
c⁄n
, 
£rvîPå
->
M⁄goSîvî
, sîvîPå->
M⁄g›‹t
);

152 
£rvîPå
 = sîvîPå->
√xt
;

155 
mp
->
°©us
 = 
	`m⁄go_ª∂£t_c⁄√˘
–mp->
c⁄n
 );

157 } i‡(
mp
->
nSîvî
 == 1) {

159 
mp
->
°©us
 = 
	`m⁄go_c⁄√˘
(mp->
c⁄n
, mp->
Sîvîs
->
M⁄goSîvî
, mp->Sîvîs->
M⁄g›‹t
);

163 i‡(
mp
->
°©us
 =
MONGO_OK
)

164 
mp
->
£tSètus
 |
£tC⁄n
;

166  (
ªtvÆ
);

168 
	}
}

170 
	$Pro˚ssP¨a
(
m⁄goP¨am
 * 
mp
, 
SEXP
 
li°
)

173 
SEXP
 
≤ame
, 
vÆues
;

174 
ªtvÆ
, 
i
, 
n
, 
j
, 
sId
, 
sP‹t
;

175 *
sIp
;

176 *
Õå
;

178 
m⁄goSîvî
 *
SîvîCur
, *
SîvîPå
;

179 
found
;

181 
ªtvÆ
 = 0;

183 
≤ame
 = 
	`gëAârib
(
li°
, 
R_NamesSymbﬁ
);

184 
i
 = 
n
 = 0;

188 i‡(
n
 >
	`LENGTH
(
li°
))

190 
vÆues
 = 
	`VECTOR_ELT
(
li°
, 
n
);

192 
found
 = 
FALSE
;

193 
i
 = 0;

195 
Õå
 =
	`°rdup
–
	`CHAR
(
	`STRING_ELT
(
≤ame
, 
n
)) );

197 (
§vO±
[
i
].
›tName
 !
NULL
Ë&& (
found
 !
TRUE
)) {

199 i‡(
§vO±
[
i
].
›Ty≥
 =
defSîvî
) {

201 i‡(
	`°∫cmp
(
§vO±
[
i
].
›tName
, 
Õå
, 
lSîvî
) == 0) {

202 
sIp
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

203 
	`¢¥ötf
(
sIp
, 
STR_BUFF_LEN
, "%s", 
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0)));

204 
	`ssˇnf
(
Õå
, "Sîvî%d=", &
sId
);

205 
	`ösSîvî
(
mp
->
Sîvîs
, 
sId
, 
sIp
);

206 
	`‰ì
(
sIp
);

207 
i
++;

211 } i‡(
§vO±
[
i
].
›Ty≥
 =
defP‹t
) {

212 i‡(
	`°∫cmp
(
§vO±
[
i
].
›tName
, 
Õå
, 
lP‹t
) == 0) {

213 
sP‹t
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°
, 
n
))[0];

214 
	`ssˇnf
(
Õå
, "P‹t%d=", &
sId
);

215 
	`ösP‹t
(
mp
->
Sîvîs
, 
sId
, 
sP‹t
);

216 
i
++;

221 i‡(
	`°∫cmp
(
§vO±
[
i
].
›tName
, 
Õå
, 
	`°æí
(lptr)) != 0) {

222 
i
++;

226 
found
 = 
TRUE
;

228 
§vO±
[
i
].
›Ty≥
) {

230 
de‚Sîvî
:

232 
mp
->
nSîvî
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°
, 
n
))[0];

234 
j
 = 0;

235 
SîvîPå
 = 
mp
->
Sîvîs
;

237 i‡(
mp
->
Sîvîs
 !
NULL
) {

239 
SîvîPå
->
√xt
 !
NULL
) {

240 
SîvîPå
 = SîvîPå->
√xt
;

244 
j
 < 
mp
->
nSîvî
) {

246 
SîvîCur
 = 
	`CÆloc
(1, 
m⁄goSîvî
);

247 i‡(
mp
->
Sîvîs
 =
NULL
) {

248 
mp
->
Sîvîs
 = 
SîvîCur
;

249 
SîvîPå
 = 
mp
->
Sîvîs
;

251 
SîvîPå
->
√xt
 = 
SîvîCur
;

252 
SîvîPå
 = SîvîPå->
√xt
;

254 
SîvîCur
->
M⁄goSîvî
 = 
NULL
;

255 
SîvîCur
->
M⁄g›‹t
 = 0;

256 
SîvîCur
->
√xt
 = 
NULL
;

257 
SîvîCur
->
id
 = 
j
 + 1;

258 
j
++;

262 
defmHo°
:

263 
mp
->
nSîvî
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°
, 
n
))[0];

266 
defmP‹t
:

267 
mp
->
nSîvî
 = ()
	`REAL
(
	`VECTOR_ELT
(
li°
, 
n
))[0];

270 
defDB
:

271 
mp
->
M⁄goDB
 = 
	`°rdup
(
	`CHAR
(
	`STRING_ELT
(
vÆues
, 0)));

272 
mp
->
£tSètus
 |
£tDB
;

276 
defDoC⁄√˘
:

277 i‡(
	`LOGICAL
(
	`VECTOR_ELT
(
li°
, 
n
))[0] =
TRUE
)

278 
	`doC⁄√˘
(
mp
);

281 
defOthî
:

282 
defNuŒ
:

287 
	`‰ì
(
Õå
);

288 
n
++;

291  (
ªtvÆ
);

293 
	}
}

295 
SEXP
 
	$makeGPRObje˘
(
m⁄goP¨am
 * 
obj
, 
addFöÆizî
)

297 
SEXP
 
™s
, 
kœss
, 
ªf
;

298 
p
;

300 
p
 = 0;

302 i‡(!
obj
) {

303 
PROBLEM
 "NULL M™goApòI¡îÁ˚ h™dÀ beögÑëu∫ed\n" 
ERROR
;

305 
	`PROTECT
(
kœss
 = 
	`MAKE_CLASS
("MongoHandle"));

306 
p
++;

307 
	`PROTECT
(
™s
 = 
	`NEW
(
kœss
));

308 
p
++;

309 
	`PROTECT
(
ªf
 = 
	`R_MakeExã∫ÆPå
((*)
obj
, 
	`Rf_ö°Æl
("M⁄goH™dÀ"), 
R_NûVÆue
));

310 
p
++;

312 i‡(
addFöÆizî
 =
TRUE
)

313 
	`R_Regi°îCFöÆizîEx
(
ªf
, 
R_föÆizeGP
, (
Rboﬁón
Ë
TRUE
);

314 
™s
 = 
	`SET_SLOT
◊ns, 
	`Rf_ö°Æl
("ªf"), 
ªf
);

316 
	`UNPROTECT
(
p
);

318  (
™s
);

319 
	}
}

321 
	$R_föÆizeGP
(
SEXP
 
Rgp
)

324 
m⁄goP¨am
 *
gp
;

326 
gp
 = 
	`gëGPRObje˘
(
Rgp
);

328 i‡(
gp
) {

330 i‡(
gp
->
M⁄goDB
 !
NULL
)

331 
	`‰ì
(
gp
->
M⁄goDB
);

332 i‡(
gp
->
°rVÆue
 !
NULL
)

333 
	`‰ì
(
gp
->
°rVÆue
);

335 i‡(
gp
->
°©us
 =
MONGO_OK
 ) {

336 
	`m⁄go_disc⁄√˘
(
gp
->
c⁄n
);

337 
	`m⁄go_de°roy
(
gp
->
c⁄n
);

338 
gp
->
°©us
 = 
MONGO_ERROR
;

339 
	`‰ì
(
gp
->
qs
);

341 
	`‰ìSîvîLi°
(
gp
->
Sîvîs
);

344 
	}
}

346 
m⁄goP¨am
 *
	$gëGPRObje˘
(
SEXP
 
obj
)

349 
m⁄goP¨am
 *
ªtv
;

350 
SEXP
 
ªf
;

352 i‡(
	`TYPEOF
(
obj
Ë!
EXTPTRSXP
) {

353 
ªf
 = 
	`GET_SLOT
(
obj
, 
	`Rf_ö°Æl
("ref"));

355 
ªf
 = 
obj
;

357 
ªtv
 = (
m⁄goP¨am
 *Ë
	`R_Exã∫ÆPåAddr
(
ªf
);

358 i‡(!
ªtv
) {

359 
PROBLEM
 "SèÀ m⁄goP¨am h™dÀ beögÖas£dÅÿ" 
ERROR
;

362 i‡(
	`R_Exã∫ÆPåTag
(
ªf
Ë!
	`Rf_ö°Æl
("MongoHandle")) {

363 
PROBLEM
 "Exã∫ÆÖoöã∏wôh wr⁄gÅagÖas£dÅÿgp. Wa†%s", 
	`CHAR
(
	`PRINTNAME
(
	`R_Exã∫ÆPåTag
(
ªf
))Ë
ERROR
;

366  (
ªtv
);

367 
	}
}

369 
SEXP
 
	$R_öôM⁄go
(
SEXP
 
öôLi°
)

372 
SEXP
 
ªtv
;

374 
m⁄goP¨am
 *
gp
;

376 
gp
 = 
	`CÆloc
(1, 
m⁄goP¨am
);

377 
gp
->
nSîvî
 = 1;

378 
gp
->
qs
 = 
	`CÆloc
(1, 
quîySåög
);

379 
gp
->
qs
->
skù
 = gp->qs->
limôs
 = 0;

380 
gp
->
Sîvîs
 = 
NULL
;

381 
gp
->
£tSètus
 = 0L;

382 
gp
->
M⁄goDB
 = 
NULL
;

383 
gp
->
°rVÆue
 = 
NULL
;

385 
	`Pro˚ssP¨a
(
gp
, 
öôLi°
);

387 
ªtv
 = 
	`makeGPRObje˘
(
gp
, 
TRUE
);

389  (
ªtv
);

390 
	}
}

	@Rmongo.h

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<sys/time.h
>

4 
	~<√tdb.h
>

5 
	~<î∫o.h
>

6 
	~<sy¶og.h
>

7 
	~<sig«l.h
>

8 
	~<£m≠h‹e.h
>

10 
	~<uni°d.h
>

11 
	~<°d¨g.h
>

13 
	~<°dboﬁ.h
>

14 
	~<cuæ/cuæ.h
>

15 
	~<uni°d.h
>

16 
	~<°rög.h
>

17 
	~"R.h
"

18 
	~"Rdeföes.h
"

19 
	~"Röã∫Æs.h
"

21 
	~"R_ext/Arôh.h
"

22 
	~"R_ext/Eº‹.h
"

23 
	~"Rvîsi⁄.h
"

24 
	~<dúít.h
>

26 
	~"cfg.h
"

27 
	~"bs⁄.h
"

28 
	~"gridfs.h
"

29 
	~"m⁄go.h
"

31 #i‚de‡
__MONGO_CFG_H


32 
	#__MONGO_CFG_H


	)

34 
	#£tC⁄n
 1

	)

35 
	#£tDB
 1<<1

	)

36 
	#£tCﬁÀ˘i⁄
 1<<2

	)

37 
	#£tBs⁄Inôed
 1<<3

	)

38 
	#£tCﬁs
 1<<4

	)

39 
	#£tV
 1<<5

	)

40 
	#£tGridfs
 1<<6

	)

41 
	#£tNoBQ
 1<<7

	)

42 
	#£tREMOVE
 1<<8

	)

43 
	#£tgfs
 1<<9

	)

44 
	#£tgfûe
 1<<10

	)

48 
	mID
 = 0,

49 
	mSTK
,

50 
	mTO
,

51 
	mYC
,

52 
	mNW
,

53 
	mHI
,

54 
	mLO
,

55 
	mNWB
,

56 
	mNWO
,

57 
	mVL
=9,

58 
	mAM
=10,

59 
	mB1V
,

60 
	mB1P
,

61 
	mB2V
,

62 
	mB2P
,

63 
	mB3V
,

64 
	mB3P
,

65 
	mB4V
,

66 
	mB4P
,

67 
	mB5V
,

68 
	mB5P
=20,

69 
	mO1V
=21,

70 
	mO1P
,

71 
	mO2V
,

72 
	mO2P
,

73 
	mO3V
,

74 
	mO3P
,

75 
	mO4V
,

76 
	mO4P
,

77 
	mO5V
,

78 
	mO5P
,

79 
	mD
,

80 
	mT
 } 
	tEÀmíts
;

83 
	mEÀTime
 = 0,

84 
	mEÀHigh
,

85 
	mEÀLow
,

86 
	mEÀAvîagePri˚
,

87 
	mEÀTickPri˚
,

88 
	mEÀTickAm
=5,

89 
	mEÀBidPri˚
,

90 
	mEÀAskPri˚
,

91 
	mEÀBid
,

92 
	mEÀAsk
,

93 
	mEÀBidInc
=10,

94 
	mEÀBidDec
,

95 
	mEÀAskInc
,

96 
	mEÀAskDec
,

97 
	mEÀPassBid
,

98 
	mEÀA˘Bid
=15,

99 
	mEÀPassAsk
,

100 
	mEÀA˘Ask
,

102 
	mEÀFœtFögî
,

103 
	mEÀTy≥


104 } 
	tTødeEÀmíts
;

106 
	eTøde_Sèã
 {

107 
	mT_bÆ™˚
 = 0,

108 
	mT_ri£
,

109 
	mT_ri£1
,

110 
	mT_ri£2
,

111 
	mT_down
,

112 
	mT_down1
,

113 
	mT_down2
,

114 
	mT_ri£_limô
,

115 
	mT_down_limô
,

116 
	mT_Ê©
,

117 
	mT_Ê©1
,

118 
	mT_un£t


119 } 
	tTRADE_STATE
;

122 
	#MASKSET
 0xF

	)

124 
	#CHUNKSIZE
 (8<<20)

	)

126 
	#METHOD_BRIEF
 1

	)

127 
	#METHOD_DEPTRANS
 2

	)

128 
	#METHOD_TICKTR
 3

	)

130 
	#CONVERSLEN
 20

	)

131 
	#MINIVOLVAR
 199

	)

132 
	#EMPTYCOLS
 33

	)

133 
	#MINITICK
 60

	)

135 
	#HUGEAM
 100000

	)

137 
	#MöiHódSize
 (()*3)

	)

139 
ndebug
(*
fmt
,...);

140 
tic
(
timevÆ
 *);

141 
toc
(
timevÆ
 *);

143 
time2num
(*);

144 
«me2num
(*);

145 
dige°2hex
(*, *);

147 
	sM⁄goSîvîs
 {

148 *
	mM⁄goSîvî
;

149 
	mM⁄g›‹t
;

150 
	mid
;

151 
M⁄goSîvîs
 *
	m√xt
;

152 } 
	tm⁄goSîvî
;

154 
	sQuîySåög
 {

155 *
	mkey
;

156 *
	m›t
;

157 
	mv
;

158 
	mskù
;

159 
	mlimôs
;

161 } 
	tquîySåög
;

163 
	sQuîyVÆueCﬁs
 {

164 *
	mdm
;

165 
QuîyVÆueCﬁs
 *
	m√xt
;

166 } 
	tqVdms
;

168 
	sQuîyVÆue
{

169 
	mnCﬁs
,
	mnRows
;

170 *
	mv
;

171 
QuîyVÆue
 *
	m√xt
;

172 } 
	tqV
;

174 
qV
 
	tTickRaw
;

176 
	sM⁄goP¨am
 {

177 
m⁄go
 *
	mc⁄n
;

178 
MONGO_EXPORT
 
	m°©us
;

179 
m⁄goSîvî
 *
	mSîvîs
;

180 *
	mM⁄goDB
;

181 *
	mgridFûeName
;

182 
	mnSîvî
;

184 
u_öt32_t
 
	m£tSètus
;

186 
quîySåög
 *
	mqs
;

187 
m⁄go_curs‹
 *
	mcurs‹
;

189 *
	m°rVÆue
;

190 *
	mns
;

192 
qV
 *
	mqVli°
,*
	mqVcuº
;

193 
SEXP
 
	mCﬁNames
;

194 
	mnCﬁs
,
	mnRows
;

196 
	md©e
;

198 
SEXP
 
	mªsu…
;

200 
timevÆ
 
	mtimî
;

202 } 
	tm⁄goP¨am
;

204 
	sTønsO±i⁄s
 {

205 
u_öt32_t
 
	mmëhods
;

206 
	mgaöt
;

207 
u_öt32_t
 *
	mdims
;

208 
u_öt32_t
 *
	mtims
;

209 *
	md©a_±r
;

210 *
	mout_±r
;

211 } 
	tå™sO±i⁄s
;

213 
m⁄goP¨am
 *
gëGPRObje˘
(
SEXP
);

214 
TickRaw
 *
tick2øw
(
qV
 *, );

215 
TickRaw
 *
tick2dëaû
(
qV
 *, );

216 
diffTime
(, );

217 
Ti°øde
();

218 
£tDim
(
SEXP
 , , );

	@adjRatios.c

21 
	~<R.h
>

22 
	~<Röã∫Æs.h
>

24 
SEXP
 
	$adjR©ios
(
SEXP
 
•lô
, SEXP 
div
, SEXP 
˛o£
)

28 *
ªÆ_˛o£
 = 
	`REAL
(
˛o£
);

29 *
ªÆ_•lô
 = 
	`REAL
(
•lô
);

30 *
ªÆ_div
 = 
	`REAL
(
div
);

33 
i
, 
P
 = 0;

35 
N
 = 
	`Àngth
(
˛o£
);

38 
SEXP
 
ªsu…
;

39 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

40 
P
++;

41 
SEXP
 
s_øtio
;

42 
	`PROTECT
(
s_øtio
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
N
));

43 
P
++;

44 
SEXP
 
d_øtio
;

45 
	`PROTECT
(
d_øtio
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
N
));

46 
P
++;

49 *
rs_øtio
 = 
	`REAL
(
s_øtio
);

50 *
rd_øtio
 = 
	`REAL
(
d_øtio
);

51 
rs_øtio
[
N
 - 1] = 1;

52 
rd_øtio
[
N
 - 1] = 1;

55 
i
 = 
N
 - 1; i > 0; i--) {

57 i‡(
	`ISNA
(
ªÆ_•lô
[
i
])) {

58 
rs_øtio
[
i
 - 1] =Ñs_ratio[i];

61 
rs_øtio
[
i
 - 1] =Ñs_øtio[i] * 
ªÆ_•lô
[i];

64 i‡(
	`ISNA
(
ªÆ_div
[
i
])) {

65 
rd_øtio
[
i
 - 1] =Ñd_ratio[i];

68 
rd_øtio
[
i
 - 1] =Ñd_øtio[i] * (1.0 - 
ªÆ_div
[i] / 
ªÆ_˛o£
[i - 1]);

73 
	`SET_VECTOR_ELT
(
ªsu…
, 0, 
s_øtio
);

74 
	`SET_VECTOR_ELT
(
ªsu…
, 1, 
d_øtio
);

77 
	`UNPROTECT
(
P
);

78  (
ªsu…
);

79 
	}
}

	@bcon.c

18 
	~<°dio.h
>

19 
	~<°dlib.h
>

20 
	~<limôs.h
>

21 
	~<as£π.h
>

22 
	~"bc⁄.h
"

24 #i‚de‡
NOT_REACHED


25 
	#NOT_REACHED
 0

	)

28 
	#ARRAY_INDEX_BUFFER_SIZE
 9

	)

30 *
	gbc⁄_îr°r
[] = {

37 
bc⁄_îr‹_t
 
bs⁄_≠≥nd_bc⁄_¨øy
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
);

40 
bc⁄_tokí_t
 
bc⁄_tokí
(*
s
);

42 
bc⁄_tokí_t
 
	$bc⁄_tokí
(*
s
) {

43 i‡(
s
 =0Ë 
Tokí_EOD
;

44 
s
[0]) {

45 ':': i‡(
s
[1] != '\0' && s[2] != '\0' && s[3] != '\0' && s[4] == '\0' &&

46 
s
[3] == ':' && (s[1] == '_' || s[1] == 'P' || s[1] == 'R'))

47  
Tokí_Ty≥•ec
; ;

48 '{': i‡(
s
[1] ='\0'Ë 
Tokí_O≥nBø˚
; ;

49 '}': i‡(
s
[1] ='\0'Ë 
Tokí_Clo£Bø˚
; ;

50 '[': i‡(
s
[1] ='\0'Ë 
Tokí_O≥nBøckë
; ;

51 ']': i‡(
s
[1] ='\0'Ë 
Tokí_Clo£Bøckë
; ;

52 '.': i‡(
s
[1] ='\0'Ë 
Tokí_End
; ;

54  
Tokí_DeÁu…
;

55 
	}
}

57 
bc⁄_îr‹_t
 
	$bs⁄_bc⁄_key_vÆue
(
bs⁄
 *
b
, c⁄° *
key
, c⁄° *
ty≥•ec
, c⁄° 
bc⁄
 
bci
) {

58 
bc⁄_îr‹_t
 
ªt
 = 
BCON_OK
;

59 
bs⁄_oid_t
 
oid
;

60 
±y≥
 = 
ty≥•ec
 ?Åypespec[1] : '_';

61 
uty≥
 = 
ty≥•ec
 ?Åypespec[2] : '_';

62 
±y≥
) {

64 
uty≥
) {

66 's': 
	`bs⁄_≠≥nd_°rög
–
b
, 
key
, 
bci
.
s
 ); ;

67 'f': 
	`bs⁄_≠≥nd_doubÀ
–
b
, 
key
, 
bci
.
f
 ); ;

69 
	`bs⁄_≠≥nd_°¨t_obje˘
–
b
, 
key
 );

70 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄
–
b
, 
bci
.
D
 );

71 
	`bs⁄_≠≥nd_föish_obje˘
–
b
 );

74 
	`bs⁄_≠≥nd_°¨t_¨øy
–
b
, 
key
 );

75 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄_¨øy
–
b
, 
bci
.
A
 );

76 
	`bs⁄_≠≥nd_föish_¨øy
–
b
 );

78 'o': i‡(*
bci
.
o
 ='\0'Ë
	`bs⁄_oid_gí
–&
oid
 ); 
	`bs⁄_oid_‰om_°rög
–&oid, bci.ÿ); 
	`bs⁄_≠≥nd_oid
–
b
, 
key
, &oid ); ;

79 'b': 
	`bs⁄_≠≥nd_boﬁ
–
b
, 
key
, 
bci
.b ); ;

80 't': 
	`bs⁄_≠≥nd_time_t
–
b
, 
key
, 
bci
.
t
 ); ;

81 'v': 
	`bs⁄_≠≥nd_nuŒ
–
b
, 
key
 ); ;

82 'x': 
	`bs⁄_≠≥nd_symbﬁ
–
b
, 
key
, 
bci
.
x
 ); ;

83 'i': 
	`bs⁄_≠≥nd_öt
–
b
, 
key
, 
bci
.
i
 ); ;

84 'l': 
	`bs⁄_≠≥nd_l⁄g
–
b
, 
key
, 
bci
.
l
 ); ;

85 : 
	`¥ötf
("\≈ty≥:'%c' uty≥:'%c'\n", 
±y≥
, 
uty≥
); 
	`as£π
(
NOT_REACHED
); ;

89 
uty≥
) {

90 'f': 
	`bs⁄_≠≥nd_doubÀ
–
b
, 
key
, *
bci
.
Rf
 ); ;

91 's': 
	`bs⁄_≠≥nd_°rög
–
b
, 
key
, 
bci
.
Rs
 ); ;

93 
	`bs⁄_≠≥nd_°¨t_obje˘
–
b
, 
key
 );

94 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄
–
b
, 
bci
.
RD
 );

95 
	`bs⁄_≠≥nd_föish_obje˘
–
b
 );

98 
	`bs⁄_≠≥nd_°¨t_¨øy
–
b
, 
key
 );

99 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄_¨øy
–
b
, 
bci
.
RA
 );

100 
	`bs⁄_≠≥nd_föish_¨øy
–
b
 );

102 'o': i‡(*
bci
.
o
 ='\0'Ë
	`bs⁄_oid_gí
–&
oid
 ); 
	`bs⁄_oid_‰om_°rög
–&oid, bci.ÿ); 
	`bs⁄_≠≥nd_oid
–
b
, 
key
, &oid ); ;

103 'b': 
	`bs⁄_≠≥nd_boﬁ
–
b
, 
key
, *
bci
.
Rb
 ); ;

104 't': 
	`bs⁄_≠≥nd_time_t
–
b
, 
key
, *
bci
.
Rt
 ); ;

105 'x': 
	`bs⁄_≠≥nd_symbﬁ
–
b
, 
key
, 
bci
.
Rx
 ); ;

106 'i': 
	`bs⁄_≠≥nd_öt
–
b
, 
key
, *
bci
.
Ri
 ); ;

107 'l': 
	`bs⁄_≠≥nd_l⁄g
–
b
, 
key
, *
bci
.
Rl
 ); ;

108 : 
	`¥ötf
("\≈ty≥:'%c' uty≥:'%c'\n", 
±y≥
, 
uty≥
); 
	`as£π
(
NOT_REACHED
); ;

112 i‡(*
bci
.
Pv
 != 0) {

113 
uty≥
) {

114 'f': 
	`bs⁄_≠≥nd_doubÀ
–
b
, 
key
, **
bci
.
Pf
 ); ;

115 's': 
	`bs⁄_≠≥nd_°rög
–
b
, 
key
, *
bci
.
Ps
 ); ;

117 
	`bs⁄_≠≥nd_°¨t_obje˘
–
b
, 
key
 );

118 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄
–
b
, *
bci
.
PD
 );

119 
	`bs⁄_≠≥nd_föish_obje˘
–
b
 );

122 
	`bs⁄_≠≥nd_°¨t_¨øy
–
b
, 
key
 );

123 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄_¨øy
–
b
, *
bci
.
PA
 );

124 
	`bs⁄_≠≥nd_föish_¨øy
–
b
 );

126 'o': i‡(**
bci
.
Po
 ='\0'Ë
	`bs⁄_oid_gí
–&
oid
 );

127 
	`bs⁄_oid_‰om_°rög
–&
oid
, *
bci
.
Po
 );

128 
	`bs⁄_≠≥nd_oid
–
b
, 
key
, &
oid
 );

130 'b': 
	`bs⁄_≠≥nd_boﬁ
–
b
, 
key
, **
bci
.
Pb
 ); ;

131 't': 
	`bs⁄_≠≥nd_time_t
–
b
, 
key
, **
bci
.
Pt
 ); ;

132 'x': i‡(*
bci
.
Px
 !0Ë
	`bs⁄_≠≥nd_symbﬁ
–
b
, 
key
, *bci.Px ); ;

133 'i': 
	`bs⁄_≠≥nd_öt
–
b
, 
key
, **
bci
.
Pi
 ); ;

134 'l': 
	`bs⁄_≠≥nd_l⁄g
–
b
, 
key
, **
bci
.
Pl
 ); ;

135 : 
	`¥ötf
("\≈ty≥:'%c' uty≥:'%c'\n", 
±y≥
, 
uty≥
); 
	`as£π
(
NOT_REACHED
); ;

140 
	`¥ötf
("\≈ty≥:'%c' uty≥:'%c'\n", 
±y≥
, 
uty≥
); 
	`as£π
(
NOT_REACHED
);

143  
ªt
;

144 
	}
}

146 
	ebc⁄_°©e_t
 {

147 
	mSèã_EÀmít
, 
	mSèã_DocS≥cVÆue
, 
	mSèã_DocVÆue
,

148 
	mSèã_AºayS≥cVÆue
, 
	mSèã_AºayVÆue


149 } 
	tbc⁄_°©e_t
;

151 
	#DOC_STACK_SIZE
 1024

	)

152 
	#ARRAY_INDEX_STACK_SIZE
 1024

	)

154 
	#DOC_PUSH_STATE
(
ªtu∫_°©e
Ë–
doc_°ack
[
doc_°ack_poöãr
++] = (ªtu∫_°©eË)

	)

155 
	#DOC_POP_STATE
 ( 
°©e
 = 
doc_°ack
[--
doc_°ack_poöãr
] )

	)

156 
	#ARRAY_PUSH_RESET_INDEX_STATE
(
ªtu∫_°©e
Ë–
¨øy_ödex_°ack
[
¨øy_ödex_°ack_poöãr
++] = 
¨øy_ödex
,áºay_ödex = 0, 
	`DOC_PUSH_STATE
‘ëu∫_°©eË)

	)

157 
	#ARRAY_POP_INDEX_STATE
 ( 
¨øy_ödex
 = 
¨øy_ödex_°ack
[--
¨øy_ödex_°ack_poöãr
], 
DOC_POP_STATE
 )

	)

159 
	#ARRAY_KEY_STRING
(
l
Ë(
	`bs⁄_num°r
(
¨øy_ödex_buf„r
, ()÷)),áºay_ödex_buf„r)

	)

164 
bc⁄_îr‹_t
 
	$bs⁄_≠≥nd_bc⁄_wôh_°©e
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
, 
bc⁄_°©e_t
 
°¨t_°©e
) {

165 
bc⁄_îr‹_t
 
ªt
 = 
BCON_OK
;

166 
bc⁄_°©e_t
 
°©e
 = 
°¨t_°©e
;

167 *
key
 = 0;

168 *
ty≥•ec
 = 0;

169 
doc_°ack
[
DOC_STACK_SIZE
];

170 
size_t
 
doc_°ack_poöãr
 = 0;

171 
size_t
 
¨øy_ödex
 = 0;

172 
size_t
 
¨øy_ödex_°ack
[
ARRAY_INDEX_STACK_SIZE
];

173 
size_t
 
¨øy_ödex_°ack_poöãr
 = 0;

174 
¨øy_ödex_buf„r
[
ARRAY_INDEX_BUFFER_SIZE
];

175 
íd_of_d©a
;

176 c⁄° 
bc⁄
 *
b˝
;

177 
íd_of_d©a
 = 0, 
b˝
 = 
bc
; 
ªt
 =
BCON_OK
 && !end_of_data; bcp++) {

178 
bc⁄
 
bci
 = *
b˝
;

179 *
s
 = 
bci
.s;

180 
°©e
) {

181 
Sèã_EÀmít
:

182 
	`bc⁄_tokí
(
s
)) {

183 
Tokí_Clo£Bø˚
:

184 
	`bs⁄_≠≥nd_föish_obje˘
–
b
 );

185 
DOC_POP_STATE
;

187 
Tokí_End
:

188 
íd_of_d©a
 = 1;

191 
key
 = 
s
;

192 
°©e
 = 
Sèã_DocS≥cVÆue
;

196 
Sèã_DocS≥cVÆue
:

197 
	`bc⁄_tokí
(
s
)) {

198 
Tokí_Ty≥•ec
:

199 
ty≥•ec
 = 
s
;

200 
°©e
 = 
Sèã_DocVÆue
;

202 
Tokí_O≥nBø˚
:

203 
	`bs⁄_≠≥nd_°¨t_obje˘
–
b
, 
key
 );

204 
	`DOC_PUSH_STATE
(
Sèã_EÀmít
);

205 
°©e
 = 
Sèã_EÀmít
;

207 
Tokí_O≥nBøckë
:

208 
	`bs⁄_≠≥nd_°¨t_¨øy
–
b
, 
key
 );

209 
	`ARRAY_PUSH_RESET_INDEX_STATE
(
Sèã_EÀmít
);

210 
°©e
 = 
Sèã_AºayS≥cVÆue
;

212 
Tokí_End
:

213 
íd_of_d©a
 = 1;

216 
ªt
 = 
	`bs⁄_bc⁄_key_vÆue
(
b
, 
key
, 
ty≥•ec
, 
bci
);

217 
°©e
 = 
Sèã_EÀmít
;

221 
Sèã_DocVÆue
:

222 
ªt
 = 
	`bs⁄_bc⁄_key_vÆue
(
b
, 
key
, 
ty≥•ec
, 
bci
);

223 
°©e
 = 
Sèã_EÀmít
;

224 
ty≥•ec
 = 0;

226 
Sèã_AºayS≥cVÆue
:

227 
	`bc⁄_tokí
(
s
)) {

228 
Tokí_Ty≥•ec
:

229 
ty≥•ec
 = 
s
;

230 
°©e
 = 
Sèã_AºayVÆue
;

232 
Tokí_O≥nBø˚
:

233 
key
 = 
	`ARRAY_KEY_STRING
(
¨øy_ödex
++);

234 
	`bs⁄_≠≥nd_°¨t_obje˘
–
b
, 
key
 );

235 
	`DOC_PUSH_STATE
(
Sèã_AºayS≥cVÆue
);

236 
°©e
 = 
Sèã_EÀmít
;

238 
Tokí_O≥nBøckë
:

239 
key
 = 
	`ARRAY_KEY_STRING
(
¨øy_ödex
++);

240 
	`bs⁄_≠≥nd_°¨t_¨øy
–
b
, 
key
 );

241 
	`ARRAY_PUSH_RESET_INDEX_STATE
(
Sèã_AºayS≥cVÆue
);

244 
Tokí_Clo£Bøckë
:

245 
	`bs⁄_≠≥nd_föish_¨øy
–
b
 );

246 
ARRAY_POP_INDEX_STATE
;

248 
Tokí_End
:

249 
íd_of_d©a
 = 1;

252 
key
 = 
	`ARRAY_KEY_STRING
(
¨øy_ödex
++);

253 
ªt
 = 
	`bs⁄_bc⁄_key_vÆue
(
b
, 
key
, 
ty≥•ec
, 
bci
);

258 
Sèã_AºayVÆue
:

259 
key
 = 
	`ARRAY_KEY_STRING
(
¨øy_ödex
++);

260 
ªt
 = 
	`bs⁄_bc⁄_key_vÆue
(
b
, 
key
, 
ty≥•ec
, 
bci
);

261 
°©e
 = 
Sèã_AºayS≥cVÆue
;

262 
ty≥•ec
 = 0;

264 : 
	`as£π
(
NOT_REACHED
); ;

267  
°©e
 =
°¨t_°©e
 ? 
BCON_OK
 : 
BCON_DOCUMENT_INCOMPLETE
;

268 
	}
}

270 
bc⁄_îr‹_t
 
	$bs⁄_≠≥nd_bc⁄
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
) {

271  
	`bs⁄_≠≥nd_bc⁄_wôh_°©e
(
b
, 
bc
, 
Sèã_EÀmít
);

272 
	}
}

274 
bc⁄_îr‹_t
 
	$bs⁄_≠≥nd_bc⁄_¨øy
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
) {

275  
	`bs⁄_≠≥nd_bc⁄_wôh_°©e
(
b
, 
bc
, 
Sèã_AºayS≥cVÆue
);

276 
	}
}

284 
bc⁄_îr‹_t
 
	$bs⁄_‰om_bc⁄
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
) {

285 
bc⁄_îr‹_t
 
ªt
 = 
BSON_OK
;

286 
	`bs⁄_öô
–
b
 );

287 
ªt
 = 
	`bs⁄_≠≥nd_bc⁄_wôh_°©e
–
b
, 
bc
, 
Sèã_EÀmít
 );

288 i‡(
ªt
 !
BCON_OK
) Ñet;

289 
ªt
 = 
	`bs⁄_föish
–
b
 );

290  ( 
ªt
 =
BSON_OK
 ? 
BCON_OK
 : 
BCON_BSON_ERROR
 );

291 
	}
}

293 
	$bc⁄_¥öt
(c⁄° 
bc⁄
 *
bc
) {

294 *
ty≥•ec
 = 0;

295 *
dñim
 = "";

296 
íd_of_d©a
;

297 
bc⁄
 *
b˝
;

298 
	`putch¨
('{');

299 
íd_of_d©a
 = 0, 
b˝
 = (
bc⁄
*)
bc
; !end_of_data; bcp++) {

300 
bc⁄
 
bci
 = *
b˝
;

301 *
ty≥•ec_√xt
 = 0;

302 i‡(
ty≥•ec
) {

303 
ty≥•ec
[1]) {

305 
ty≥•ec
[2]) {

306 'f': 
	`¥ötf
("%s%f", 
dñim
, 
bci
.
f
); ;

307 's': 
	`¥ötf
("%s\"%s\"", 
dñim
, 
bci
.
s
); ;

308 'D': 
	`¥ötf
("%sPD(0x%lx,..)", 
dñim
, ()
bci
.
D
); ;

309 'A': 
	`¥ötf
("%sPA(0x%lx,....)", 
dñim
, ()
bci
.
A
); ;

310 'o': 
	`¥ötf
("%s\"%s\"", 
dñim
, 
bci
.
o
); ;

311 'b': 
	`¥ötf
("%s%d", 
dñim
, 
bci
.
b
); ;

312 't': 
	`¥ötf
("%s%ld", 
dñim
, ()
bci
.
t
); ;

313 'v': 
	`¥ötf
("%s\"%s\"", 
dñim
, 
bci
.
v
); ;

314 'x': 
	`¥ötf
("%s\"%s\"", 
dñim
, 
bci
.
x
); ;

315 'i': 
	`¥ötf
("%s%d", 
dñim
, 
bci
.
i
); ;

316 'l': 
	`¥ötf
("%s%ld", 
dñim
, 
bci
.
l
); ;

317 : 
	`¥ötf
("\¡y≥•ec:\"%s\"\n", 
ty≥•ec
); 
	`as£π
(
NOT_REACHED
); ;

321 
ty≥•ec
[2]) {

322 'f': 
	`¥ötf
("%sRf(0x%lx,%f)", 
dñim
, ()
bci
.
Rf
, *bci.Rf); ;

323 's': 
	`¥ötf
("%sRs(0x%lx,\"%s\")", 
dñim
, ()
bci
.
Rs
, bci.Rs); ;

324 'D': 
	`¥ötf
("%sRD(0x%lx,..)", 
dñim
, ()
bci
.
RD
); ;

325 'A': 
	`¥ötf
("%sRA(0x%lx,....)", 
dñim
, ()
bci
.
RA
); ;

326 'o': 
	`¥ötf
("%sRo(0x%lx,\"%s\")", 
dñim
, ()
bci
.
Ro
, bci.Ro); ;

327 'b': 
	`¥ötf
("%sRb(0x%lx,%d)", 
dñim
, ()
bci
.
Rb
, *bci.Rb); ;

328 't': 
	`¥ötf
("%sRt(0x%lx,%ld)", 
dñim
, ()
bci
.
Rt
, ()*bci.Rt); ;

329 'x': 
	`¥ötf
("%sRx(0x%lx,\"%s\")", 
dñim
, ()
bci
.
Rx
, bci.Rx); ;

330 'i': 
	`¥ötf
("%sRi(0x%lx,%d)", 
dñim
, ()
bci
.
Ri
, *bci.Ri); ;

331 'l': 
	`¥ötf
("%sRl(0x%lx,%ld)", 
dñim
, ()
bci
.
Rl
, *bci.Rl); ;

332 : 
	`¥ötf
("\¡y≥•ec:\"%s\"\n", 
ty≥•ec
); 
	`as£π
(
NOT_REACHED
); ;

336 
ty≥•ec
[2]) {

337 'f': 
	`¥ötf
("%sPf(0x%lx,0x%lx,%f)", 
dñim
, ()
bci
.
Pf
, ()(bci.Pf ? *bci.Pf : 0), bci.Pf && *bci.Pf ? **bci.Pf : 0.0); ;

338 's': 
	`¥ötf
("%sPs(0x%lx,0x%lx,\"%s\")", 
dñim
, ()
bci
.
Ps
, ()(bci.Ps ? *bci.Ps : 0), bci.Ps && *bci.Ps ? *bci.Ps : ""); ;

339 'D': 
	`¥ötf
("%sPD(0x%lx,0x%lx,..)", 
dñim
, ()
bci
.
PD
, ()(bci.PD ? *bci.PD : 0)); ;

340 'A': 
	`¥ötf
("%sPA(0x%lx,0x%lx,....)", 
dñim
, ()
bci
.
PA
, ()(bci.PA ? *bci.PA : 0)); ;

341 'o': 
	`¥ötf
("%sPo(0x%lx,0x%lx,\"%s\")", 
dñim
, ()
bci
.
Po
, ()(bci.Po ? *bci.Po : 0), bci.Po && *bci.Po ? *bci.Po : ""); ;

342 'b': 
	`¥ötf
("%sPb(0x%lx,0x%lx,%d)", 
dñim
, ()
bci
.
Pb
, ()(bci.Pb ? *bci.Pb : 0), bci.Pb && *bci.Pb ? **bci.Pb : 0); ;

343 't': 
	`¥ötf
("%sPt(0x%lx,0x%lx,%ld)", 
dñim
, ()
bci
.
Pt
, ()(bci.Pt ? *bci.Pt : 0), bci.Pt && *bci.Pt ? ()**bci.Pt : 0); ;

344 'x': 
	`¥ötf
("%sPx(0x%lx,0x%lx,\"%s\")", 
dñim
, ()
bci
.
Px
, ()(bci.Px ? *bci.Px : 0), bci.Px && *bci.Px ? *bci.Px : ""); ;

345 'i': 
	`¥ötf
("%sPi(0x%lx,0x%lx,%d)", 
dñim
, ()
bci
.
Pi
, ()(bci.Pi ? *bci.Pi : 0), bci.Pi && *bci.Pi ? **bci.Pi : 0); ;

346 'l': 
	`¥ötf
("%sPl(0x%lx,0x%lx,%ld)", 
dñim
, ()
bci
.
Pl
, ()(bci.Pl ? *bci.Pl : 0), bci.Pl && *bci.Pl ? **bci.Pl : 0); ;

348 : 
	`¥ötf
("\¡y≥•ec:\"%s\"\n", 
ty≥•ec
); 
	`as£π
(
NOT_REACHED
); ;

352 
	`¥ötf
("\¡y≥•ec:\"%s\"\n", 
ty≥•ec
); 
	`as£π
(
NOT_REACHED
);

357 *
s
 = 
bci
.s;

358 
s
[0]) {

360 
íd_of_d©a
 = (
s
[1] == '\0');

363 
ty≥•ec_√xt
 = 
	`bc⁄_tokí
(
s
Ë=
Tokí_Ty≥•ec
 ? s : 0;

366 
	`¥ötf
("%s\"%s\"", 
dñim
, 
s
);

368 
ty≥•ec
 = 
ty≥•ec_√xt
;

369 
dñim
 = ",";

371 
	`putch¨
('}');

372 
	}
}

	@bcon.h

21 #i‚de‡
BCON_H_


22 
	#BCON_H_


	)

24 
	~"bs⁄.h
"

26 #i‚de‡
DOXYGEN_SHOULD_SKIP_THIS


28 
	gMONGO_EXTERN_C_START


32 
	ubc⁄
 {

33 *
	ms
;

34 *
	mRs
;

35 **
	mPs
;

36 
	mf
;

37 *
	mRf
;

38 **
	mPf
;

39 
bc⁄
 *
	mD
;

40 
bc⁄
 *
	mRD
;

41 
bc⁄
 **
	mPD
;

42 
bc⁄
 *
	mA
;

43 
bc⁄
 *
	mRA
;

44 
bc⁄
 **
	mPA
;

45 *
	mo
;

46 *
	mRo
;

47 **
	mPo
;

48 
bs⁄_boﬁ_t
 
	mb
;

50 
bs⁄_boﬁ_t
 *
	mRb
;

51 
bs⁄_boﬁ_t
 **
	mPb
;

52 
time_t
 
	mt
;

53 
time_t
 *
	mRt
;

54 
time_t
 **
	mPt
;

55 *
	mv
;

56 *
	mx
;

57 *
	mRx
;

58 **
	mPx
;

59 
	mi
;

60 *
	mRi
;

61 **
	mPi
;

62 
	ml
;

63 *
	mRl
;

64 **
	mPl
;

65 **
	mPv
;

77 } 
	tbc⁄
;

80 
	#BEND
 "."

	)

83 
	#BTF
 ":_f:"

	)

85 
	#BTS
 ":_s:"

	)

87 
	#BTD
 ":_D:"

	)

89 
	#BTA
 ":_A:"

	)

91 
	#BTO
 ":_o:"

	)

93 
	#BTB
 ":_b:"

	)

95 
	#BTT
 ":_t:"

	)

97 
	#BTN
 ":_v:"

	)

99 
	#BTX
 ":_x:"

	)

101 
	#BTI
 ":_i:"

	)

103 
	#BTL
 ":_l:"

	)

106 
	#BTRF
 ":Rf:"

	)

108 
	#BTRS
 ":Rs:"

	)

110 
	#BTRD
 ":RD:"

	)

112 
	#BTRA
 ":RA:"

	)

114 
	#BTRO
 ":Ro:"

	)

116 
	#BTRB
 ":Rb:"

	)

118 
	#BTRT
 ":Rt:"

	)

120 
	#BTRX
 ":Rx:"

	)

122 
	#BTRI
 ":Ri:"

	)

124 
	#BTRL
 ":Rl:"

	)

127 
	#BTPF
 ":Pf:"

	)

129 
	#BTPS
 ":Ps:"

	)

131 
	#BTPD
 ":PD:"

	)

133 
	#BTPA
 ":PA:"

	)

135 
	#BTPO
 ":Po:"

	)

137 
	#BTPB
 ":Pb:"

	)

139 
	#BTPT
 ":Pt:"

	)

141 
	#BTPX
 ":Px:"

	)

143 
	#BTPI
 ":Pi:"

	)

145 
	#BTPL
 ":Pl:"

	)

148 
	#BF
(
v
Ë
BTF
, { .
f
 = (vË}

	)

150 
	#BS
(
v
Ë
BTS
, { .
s
 = (vË}

	)

152 
	#BD
(
v
Ë
BTD
, { .
D
 = (vË}

	)

154 
	#BA
(
v
Ë
BTA
, { .
A
 = (vË}

	)

156 
	#BO
(
v
Ë
BTO
, { .
o
 = (vË}

	)

158 
	#BB
(
v
Ë
BTB
, { .
b
 = (vË}

	)

160 
	#BT
(
v
Ë
BTT
, { .
t
 = (vË}

	)

162 
	#BNULL
 
BTN
, { .
v
 = (""Ë}

	)

164 
	#BX
(
v
Ë
BTX
, { .
x
 = (vË}

	)

166 
	#BI
(
v
Ë
BTI
, { .
i
 = (vË}

	)

168 
	#BL
(
v
Ë
BTL
, { .
l
 = (vË}

	)

171 
	#BRF
(
v
Ë
BTRF
, { .
Rf
 = (vË}

	)

173 
	#BRS
(
v
Ë
BTRS
, { .
Rs
 = (vË}

	)

175 
	#BRD
(
v
Ë
BTRD
, { .
RD
 = (vË}

	)

177 
	#BRA
(
v
Ë
BTRA
, { .
RA
 = (vË}

	)

179 
	#BRO
(
v
Ë
BTRO
, { .
Ro
 = (vË}

	)

181 
	#BRB
(
v
Ë
BTRB
, { .
Rb
 = (vË}

	)

183 
	#BRT
(
v
Ë
BTRT
, { .
Rt
 = (vË}

	)

185 
	#BRX
(
v
Ë
BTRX
, { .
Rx
 = (vË}

	)

187 
	#BRI
(
v
Ë
BTRI
, { .
Ri
 = (vË}

	)

189 
	#BRL
(
v
Ë
BTRL
, { .
Rl
 = (vË}

	)

192 
	#BPF
(
v
Ë
BTPF
, { .
Pf
 = (vË}

	)

194 
	#BPS
(
v
Ë
BTPS
, { .
Ps
 = ((**)vË}

	)

196 
	#BPD
(
v
Ë
BTPD
, { .
PD
 = ((
bc⁄
 **)vË}

	)

198 
	#BPA
(
v
Ë
BTPA
, { .
PA
 = ((
bc⁄
 **)vË}

	)

200 
	#BPO
(
v
Ë
BTPO
, { .
Po
 = ((**)vË}

	)

202 
	#BPB
(
v
Ë
BTPB
, { .
Pb
 = (vË}

	)

204 
	#BPT
(
v
Ë
BTPT
, { .
Pt
 = (vË}

	)

206 
	#BPX
(
v
Ë
BTPX
, { .
Px
 = ((**)vË}

	)

208 
	#BPI
(
v
Ë
BTPI
, { .
Pi
 = (vË}

	)

210 
	#BPL
(
v
Ë
BTPL
, { .
Pl
 = (vË}

	)

218 
	ebc⁄_îr‹_t
 {

219 
	mBCON_OK
 = 0,

220 
	mBCON_ERROR
,

221 
	mBCON_DOCUMENT_INCOMPLETE
,

222 
	mBCON_BSON_ERROR


223 } 
	tbc⁄_îr‹_t
;

225 *
bc⁄_îr°r
[];

233 
MONGO_EXPORT
 
bc⁄_îr‹_t
 
bs⁄_≠≥nd_bc⁄
(
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
);

241 
MONGO_EXPORT
 
bc⁄_îr‹_t
 
bs⁄_‰om_bc⁄
–
bs⁄
 *
b
, c⁄° 
bc⁄
 *
bc
 );

248 
MONGO_EXPORT
 
bc⁄_¥öt
–c⁄° 
bc⁄
 *
bc
 );

250 #i‚de‡
DOXYGEN_SHOULD_SKIP_THIS


252 
MONGO_EXTERN_C_END


254 
	ebc⁄_tokí_t
 {

255 
	mTokí_DeÁu…
, 
	mTokí_End
, 
	mTokí_Ty≥•ec
,

256 
	mTokí_O≥nBø˚
, 
	mTokí_Clo£Bø˚
, 
	mTokí_O≥nBøckë
, 
	mTokí_Clo£Bøckë
,

257 
	mTokí_EOD


258 } 
	tbc⁄_tokí_t
;

	@bson.c

18 #i‡
_MSC_VER
 && ! 
_CRT_SECURE_NO_WARNINGS


19 
	#_CRT_SECURE_NO_WARNINGS


	)

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<°dio.h
>

25 
	~<time.h
>

26 
	~<limôs.h
>

28 
	~"bs⁄.h
"

29 
	~"ícodög.h
"

31 c⁄° 
	göôülBuf„rSize
 = 128;

34 c⁄° 
	gzîo
 = 0;

37 
	gbs⁄_sh¨ed_em±y_d©a
[] = {5,0,0,0,0};

40 *–*
	gbs⁄_mÆloc_func
 )–
	gsize_t
 ) = 
mÆloc
;

41 *–*
	gbs⁄_ªÆloc_func
 )–*, 
	gsize_t
 ) = 
ªÆloc
;

42 –*
bs⁄_‰ì_func
 )–* ) = 
‰ì
;

43 #ifde‡
R_SAFETY_NET


44 
bs⁄_¥ötf_func
 
bs⁄_¥ötf
;

46 
bs⁄_¥ötf_func
 
bs⁄_¥ötf
 = 
¥ötf
;

48 
bs⁄_Ârötf_func
 
bs⁄_Ârötf
 = 
Ârötf
;

49 
bs⁄_•rötf_func
 
bs⁄_•rötf
 = 
•rötf
;

51 
	`_bs⁄_îΩrötf
( const *, ... );

52 
bs⁄_¥ötf_func
 
bs⁄_îΩrötf
 = 
_bs⁄_îΩrötf
;

54 
	`_bs⁄_zîo
–
bs⁄
 *
b
 );

55 
size_t
 
	`_bs⁄_posôi⁄
–c⁄° 
bs⁄
 *
b
 );

58 –*
oid_fuzz_func
 )–Ë
NULL
;

59 –*
oid_öc_func
 )–Ë
NULL
;

65 
MONGO_EXPORT
 
bs⁄
* 
	$bs⁄_Æloc
( ) {

66  ( 
bs⁄
* )
	`bs⁄_mÆloc
( ( bson ) );

67 
	}
}

69 
MONGO_EXPORT
 
	$bs⁄_dóŒoc
–
bs⁄
* 
b
 ) {

70 
	`bs⁄_‰ì
–
b
 );

71 
	}
}

74 
	$bs⁄_föished_d©a_size
–c⁄° *
d©a
 ) {

75 
i
;

76 
	`bs⁄_lôée_ídün32
–&
i
, 
d©a
 );

77  
i
;

78 
	}
}

80 
	$bs⁄_öô_föished_d©a
–
bs⁄
 *
b
, *
d©a
, 
bs⁄_boﬁ_t
 
ownsD©a
 ) {

81 
	`_bs⁄_zîo
–
b
 );

82 
b
->
d©a
 = data;

83 
b
->
d©aSize
 = 
	`bs⁄_föished_d©a_size
–
d©a
 );

84 
b
->
ownsD©a
 = ownsData;

85 
b
->
föished
 = 1;

86  
BSON_OK
;

87 
	}
}

89 
	$bs⁄_öô_föished_d©a_wôh_c›y
–
bs⁄
 *
b
, c⁄° *
d©a
 ) {

90 
d©aSize
 = 
	`bs⁄_föished_d©a_size
–
d©a
 );

91 i‡–
	`bs⁄_öô_size
–
b
, 
d©aSize
 ) =
BSON_ERROR
 )  BSON_ERROR;

92 
	`mem˝y
–
b
->
d©a
, d©a, 
d©aSize
 );

93 
b
->
föished
 = 1;

94  
BSON_OK
;

95 
	}
}

97 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$bs⁄_öô_em±y
–
bs⁄
 *
obj
 ) {

98 
	`bs⁄_öô_föished_d©a
–
obj
, 
bs⁄_sh¨ed_em±y_d©a
, 0 );

99  
BSON_OK
;

100 
	}
}

102 
MONGO_EXPORT
 c⁄° 
bs⁄
 *
	$bs⁄_sh¨ed_em±y
( ) {

103 c⁄° 
bs⁄
 
sh¨ed_em±y
 = { 
bs⁄_sh¨ed_em±y_d©a
, bson_shared_empty_data, 128, 1, 0,0,0,0,0, {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0} };

104  &
sh¨ed_em±y
;

105 
	}
}

107 
MONGO_EXPORT
 
	$bs⁄_c›y
–
bs⁄
 *
out
, c⁄° bs⁄ *
ö
 ) {

108 i‡–!
out
 || !
ö
 )  
BSON_ERROR
;

109 i‡–!
ö
->
föished
 )  
BSON_ERROR
;

110  
	`bs⁄_öô_föished_d©a_wôh_c›y
–
out
, 
ö
->
d©a
 );

111 
	}
}

113 
MONGO_EXPORT
 
	$bs⁄_size
–c⁄° 
bs⁄
 *
b
 ) {

114 
i
;

115 i‡–! 
b
 || ! b->
d©a
 )

117 
	`bs⁄_lôée_ídün32
–&
i
, 
b
->
d©a
 );

118  
i
;

119 
	}
}

121 
size_t
 
	$_bs⁄_posôi⁄
–c⁄° 
bs⁄
 *
b
 ) {

122  
b
->
cur
 - b->
d©a
;

123 
	}
}

125 
MONGO_EXPORT
 
size_t
 
	$bs⁄_buf„r_size
–c⁄° 
bs⁄
 *
b
 ) {

126  
	`_bs⁄_posôi⁄
(
b
) + 1;

127 
	}
}

130 
MONGO_EXPORT
 c⁄° *
	$bs⁄_d©a
–c⁄° 
bs⁄
 *
b
 ) {

131  (c⁄° *)
b
->
d©a
;

132 
	}
}

134 
	$hexbyã
–
hex
 ) {

135 i‡(
hex
 >= '0' && hex <= '9')

136  (
hex
 - '0');

137 i‡(
hex
 >= 'A' && hex <= 'F')

138  (
hex
 - 'A' + 10);

139 i‡(
hex
 >= 'a' && hex <= 'f')

140  (
hex
 - 'a' + 10);

143 
	}
}

145 
MONGO_EXPORT
 
	$bs⁄_oid_‰om_°rög
–
bs⁄_oid_t
 *
oid
, c⁄° *
°r
 ) {

146 
i
;

147  
i
=0; i<12; i++ ) {

148 
oid
->
byãs
[
i
] = ( 
	`hexbyã
–
°r
[2*i] ) << 4 ) | hexbyte( str[2*i + 1] );

150 
	}
}

152 
MONGO_EXPORT
 
	$bs⁄_oid_to_°rög
–c⁄° 
bs⁄_oid_t
 *
oid
, *
°r
 ) {

153 c⁄° 
hex
[16] = {'0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f'};

154 
i
;

155  
i
=0; i<12; i++ ) {

156 
°r
[2*
i
] = 
hex
[–
oid
->
byãs
[i] & 0xf0 ) >> 4];

157 
°r
[2*
i
 + 1] = 
hex
[ 
oid
->
byãs
[i] & 0x0f ];

159 
°r
[24] = '\0';

160 
	}
}

162 
MONGO_EXPORT
 
bs⁄_£t_oid_fuzz
––*
func
 )( ) ) {

163 
oid_fuzz_func
 = 
func
;

164 
	}
}

166 
MONGO_EXPORT
 
bs⁄_£t_oid_öc
––*
func
 )( ) ) {

167 
oid_öc_func
 = 
func
;

168 
	}
}

170 
MONGO_EXPORT
 
	$bs⁄_oid_gí
–
bs⁄_oid_t
 *
oid
 ) {

171 
ö¸
 = 0;

172 
fuzz
 = 0;

173 
i
;

174 
time_t
 
t
 = 
	`time
–
NULL
 );

176 if–
oid_öc_func
 )

177 
i
 = 
	`oid_öc_func
();

179 
i
 = 
ö¸
++;

181 i‡–!
fuzz
 ) {

182 i‡–
oid_fuzz_func
 )

183 
fuzz
 = 
	`oid_fuzz_func
();

185 
	`§™d
––)
t
 );

186 
fuzz
 = 
	`ønd
();

190 
	`bs⁄_big_ídün32
–&
oid
->
öts
[0], &
t
 );

191 
oid
->
öts
[1] = 
fuzz
;

192 
	`bs⁄_big_ídün32
–&
oid
->
öts
[2], &
i
 );

193 
	}
}

195 
MONGO_EXPORT
 
time_t
 
	$bs⁄_oid_gíî©ed_time
–
bs⁄_oid_t
 *
oid
 ) {

196 
time_t
 
out
;

197 
	`bs⁄_big_ídün32
–&
out
, &
oid
->
öts
[0] );

199  
out
;

200 
	}
}

202 
MONGO_EXPORT
 
	$bs⁄_¥öt
–c⁄° 
bs⁄
 *
b
 ) {

203 
	`bs⁄_¥öt_øw
–
b
->
d©a
 , 0 );

204 
	}
}

206 
MONGO_EXPORT
 
	$bs⁄_¥öt_øw
–c⁄° *
d©a
 , 
dïth
 ) {

207 
bs⁄_ôî©‹
 
i
;

208 c⁄° *
key
;

209 
ãmp
;

210 
bs⁄_time°amp_t
 
ts
;

211 
oidhex
[25];

212 
bs⁄
 
sc›e
;

213 
	`bs⁄_ôî©‹_‰om_buf„r
–&
i
, 
d©a
 );

215  
	`bs⁄_ôî©‹_√xt
–&
i
 ) ) {

216 
bs⁄_ty≥
 
t
 = 
	`bs⁄_ôî©‹_ty≥
–&
i
 );

217 i‡–
t
 == 0 )

219 
key
 = 
	`bs⁄_ôî©‹_key
–&
i
 );

221  
ãmp
=0;Åemp<=
dïth
;Åemp++ )

222 
	`bs⁄_¥ötf
( "\t" );

223 
	`bs⁄_¥ötf
–"%†: %d \à" , 
key
 , 
t
 );

224  
t
 ) {

225 
BSON_DOUBLE
:

226 
	`bs⁄_¥ötf
–"%f" , 
	`bs⁄_ôî©‹_doubÀ
–&
i
 ) );

228 
BSON_STRING
:

229 
	`bs⁄_¥ötf
–"%s" , 
	`bs⁄_ôî©‹_°rög
–&
i
 ) );

231 
BSON_SYMBOL
:

232 
	`bs⁄_¥ötf
–"SYMBOL: %s" , 
	`bs⁄_ôî©‹_°rög
–&
i
 ) );

234 
BSON_OID
:

235 
	`bs⁄_oid_to_°rög
–
	`bs⁄_ôî©‹_oid
–&
i
 ), 
oidhex
 );

236 
	`bs⁄_¥ötf
–"%s" , 
oidhex
 );

238 
BSON_BOOL
:

239 
	`bs⁄_¥ötf
–"%s" , 
	`bs⁄_ôî©‹_boﬁ
–&
i
 ) ? "true" : "false" );

241 
BSON_DATE
:

242 
	`bs⁄_¥ötf
–"%ld" , ( )
	`bs⁄_ôî©‹_d©e
–&
i
 ) );

244 
BSON_BINDATA
:

245 
	`bs⁄_¥ötf
( "BSON_BINDATA" );

247 
BSON_UNDEFINED
:

248 
	`bs⁄_¥ötf
( "BSON_UNDEFINED" );

250 
BSON_NULL
:

251 
	`bs⁄_¥ötf
( "BSON_NULL" );

253 
BSON_REGEX
:

254 
	`bs⁄_¥ötf
–"BSON_REGEX: %s", 
	`bs⁄_ôî©‹_ªgex
–&
i
 ) );

256 
BSON_CODE
:

257 
	`bs⁄_¥ötf
–"BSON_CODE: %s", 
	`bs⁄_ôî©‹_code
–&
i
 ) );

259 
BSON_CODEWSCOPE
:

260 
	`bs⁄_¥ötf
–"BSON_CODE_W_SCOPE: %s", 
	`bs⁄_ôî©‹_code
–&
i
 ) );

261 
	`bs⁄_ôî©‹_code_sc›e_öô
–&
i
, &
sc›e
, 0 );

262 
	`bs⁄_¥ötf
( "\n\t SCOPE: " );

263 
	`bs⁄_¥öt
–&
sc›e
 );

264 
	`bs⁄_de°roy
–&
sc›e
 );

266 
BSON_INT
:

267 
	`bs⁄_¥ötf
–"%d" , 
	`bs⁄_ôî©‹_öt
–&
i
 ) );

269 
BSON_LONG
:

270 
	`bs⁄_¥ötf
–"%Œd" , ( 
uöt64_t
 )
	`bs⁄_ôî©‹_l⁄g
–&
i
 ) );

272 
BSON_TIMESTAMP
:

273 
ts
 = 
	`bs⁄_ôî©‹_time°amp
–&
i
 );

274 
	`bs⁄_¥ötf
–"i: %d,Å: %d", 
ts
.
i
,Ås.
t
 );

276 
BSON_OBJECT
:

277 
BSON_ARRAY
:

278 
	`bs⁄_¥ötf
( "\n" );

279 
	`bs⁄_¥öt_øw
–
	`bs⁄_ôî©‹_vÆue
–&
i
 ) , 
dïth
 + 1 );

282 
	`bs⁄_îΩrötf
–"ˇn'à¥öàty≥ : %d\n" , 
t
 );

284 
	`bs⁄_¥ötf
( "\n" );

286 
	}
}

292 
MONGO_EXPORT
 
bs⁄_ôî©‹
* 
	$bs⁄_ôî©‹_Æloc
( ) {

293  ( 
bs⁄_ôî©‹
* )
	`bs⁄_mÆloc
( ( bson_iterator ) );

294 
	}
}

296 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_dóŒoc
–
bs⁄_ôî©‹
* 
i
 ) {

297 
	`bs⁄_‰ì
–
i
 );

298 
	}
}

300 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_öô
–
bs⁄_ôî©‹
 *
i
, c⁄° 
bs⁄
 *
b
 ) {

301 
i
->
cur
 = 
b
->
d©a
 + 4;

302 
i
->
fú°
 = 1;

303 
	}
}

305 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_‰om_buf„r
–
bs⁄_ôî©‹
 *
i
, c⁄° *
buf„r
 ) {

306 
i
->
cur
 = 
buf„r
 + 4;

307 
i
->
fú°
 = 1;

308 
	}
}

310 
MONGO_EXPORT
 
bs⁄_ty≥
 
	$bs⁄_föd
–
bs⁄_ôî©‹
 *
ô
, c⁄° 
bs⁄
 *
obj
, c⁄° *
«me
 ) {

311 
	`bs⁄_ôî©‹_öô
–
ô
, (
bs⁄
 *)
obj
 );

312  
	`bs⁄_ôî©‹_√xt
–
ô
 ) ) {

313 i‡–
	`°rcmp
–
«me
, 
	`bs⁄_ôî©‹_key
–
ô
 ) ) == 0 )

316  
	`bs⁄_ôî©‹_ty≥
–
ô
 );

317 
	}
}

319 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$bs⁄_ôî©‹_m‹e
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

320  *–
i
->
cur
 );

321 
	}
}

323 
MONGO_EXPORT
 
bs⁄_ty≥
 
	$bs⁄_ôî©‹_√xt
–
bs⁄_ôî©‹
 *
i
 ) {

324 
size_t
 
ds
;

326 i‡–
i
->
fú°
 ) {

327 
i
->
fú°
 = 0;

328  ( 
bs⁄_ty≥
 )–*
i
->
cur
 );

331  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

332 
BSON_EOO
:

333  
BSON_EOO
;

334 
BSON_UNDEFINED
:

335 
BSON_NULL
:

336 
ds
 = 0;

338 
BSON_BOOL
:

339 
ds
 = 1;

341 
BSON_INT
:

342 
ds
 = 4;

344 
BSON_LONG
:

345 
BSON_DOUBLE
:

346 
BSON_TIMESTAMP
:

347 
BSON_DATE
:

348 
ds
 = 8;

350 
BSON_OID
:

351 
ds
 = 12;

353 
BSON_STRING
:

354 
BSON_SYMBOL
:

355 
BSON_CODE
:

356 
ds
 = 4 + 
	`bs⁄_ôî©‹_öt_øw
–
i
 );

358 
BSON_BINDATA
:

359 
ds
 = 5 + 
	`bs⁄_ôî©‹_öt_øw
–
i
 );

361 
BSON_OBJECT
:

362 
BSON_ARRAY
:

363 
BSON_CODEWSCOPE
:

364 
ds
 = 
	`bs⁄_ôî©‹_öt_øw
–
i
 );

366 
BSON_DBREF
:

367 
ds
 = 4+12 + 
	`bs⁄_ôî©‹_öt_øw
–
i
 );

369 
BSON_REGEX
: {

370 c⁄° *
s
 = 
	`bs⁄_ôî©‹_vÆue
–
i
 );

371 c⁄° *
p
 = 
s
;

372 
p
 +
	`°æí
(Ö )+1;

373 
p
 +
	`°æí
(Ö )+1;

374 
ds
 = 
p
-
s
;

379 
msg
[] = "unknownÅype: 000000000000";

380 
	`bs⁄_num°r
–
msg
+14, ( )–
i
->
cur
[0] ) );

381 
	`bs⁄_Áèl_msg
–0, 
msg
 );

386 
i
->
cur
 +1 + 
	`°æí
–i->cu∏+ 1 ) + 1 + 
ds
;

388  ( 
bs⁄_ty≥
 )–*
i
->
cur
 );

389 
	}
}

391 
MONGO_EXPORT
 
bs⁄_ty≥
 
	$bs⁄_ôî©‹_ty≥
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

392  ( 
bs⁄_ty≥
 )
i
->
cur
[0];

393 
	}
}

395 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_key
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

396  
i
->
cur
 + 1;

397 
	}
}

399 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_vÆue
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

400 c⁄° *
t
 = 
i
->
cur
 + 1;

401 
t
 +
	`°æí
(Å ) + 1;

402  
t
;

403 
	}
}

407 
	$bs⁄_ôî©‹_öt_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

408 
out
;

409 
	`bs⁄_lôée_ídün32
–&
out
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) );

410  
out
;

411 
	}
}

413 
	$bs⁄_ôî©‹_doubÀ_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

414 
out
;

415 
	`bs⁄_lôée_ídün64
–&
out
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) );

416  
out
;

417 
	}
}

419 
öt64_t
 
	$bs⁄_ôî©‹_l⁄g_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

420 
öt64_t
 
out
;

421 
	`bs⁄_lôée_ídün64
–&
out
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) );

422  
out
;

423 
	}
}

425 
bs⁄_boﬁ_t
 
	$bs⁄_ôî©‹_boﬁ_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

426  
	`bs⁄_ôî©‹_vÆue
–
i
 )[0];

427 
	}
}

429 
MONGO_EXPORT
 
bs⁄_oid_t
 *
	$bs⁄_ôî©‹_oid
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

430  ( 
bs⁄_oid_t
 * )
	`bs⁄_ôî©‹_vÆue
–
i
 );

431 
	}
}

433 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_öt
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

434  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

435 
BSON_INT
:

436  
	`bs⁄_ôî©‹_öt_øw
–
i
 );

437 
BSON_LONG
:

438  ( )
	`bs⁄_ôî©‹_l⁄g_øw
–
i
 );

439 
BSON_DOUBLE
:

440  ( )
	`bs⁄_ôî©‹_doubÀ_øw
–
i
 );

444 
	}
}

446 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_doubÀ
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

447  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

448 
BSON_INT
:

449  
	`bs⁄_ôî©‹_öt_øw
–
i
 );

450 
BSON_LONG
:

451  ( )
	`bs⁄_ôî©‹_l⁄g_øw
–
i
 );

452 
BSON_DOUBLE
:

453  
	`bs⁄_ôî©‹_doubÀ_øw
–
i
 );

457 
	}
}

459 
MONGO_EXPORT
 
öt64_t
 
	$bs⁄_ôî©‹_l⁄g
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

460  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

461 
BSON_INT
:

462  
	`bs⁄_ôî©‹_öt_øw
–
i
 );

463 
BSON_LONG
:

464  
	`bs⁄_ôî©‹_l⁄g_øw
–
i
 );

465 
BSON_DOUBLE
:

466  ( 
öt64_t
)
	`bs⁄_ôî©‹_doubÀ_øw
–
i
 );

470 
	}
}

472 
MONGO_EXPORT
 
bs⁄_time°amp_t
 
	$bs⁄_ôî©‹_time°amp
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

473 
bs⁄_time°amp_t
 
ts
;

474 
	`bs⁄_lôée_ídün32
–&–
ts
.
i
 ), 
	`bs⁄_ôî©‹_vÆue
( i ) );

475 
	`bs⁄_lôée_ídün32
–&–
ts
.
t
 ), 
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 4 );

476  
ts
;

477 
	}
}

480 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_time°amp_time
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

481 
time
;

482 
	`bs⁄_lôée_ídün32
–&
time
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 4 );

483  
time
;

484 
	}
}

487 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_time°amp_ö¸emít
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

488 
ö¸emít
;

489 
	`bs⁄_lôée_ídün32
–&
ö¸emít
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) );

490  
ö¸emít
;

491 
	}
}

494 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$bs⁄_ôî©‹_boﬁ
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

495  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

496 
BSON_BOOL
:

497  
	`bs⁄_ôî©‹_boﬁ_øw
–
i
 );

498 
BSON_INT
:

499  
	`bs⁄_ôî©‹_öt_øw
–
i
 ) != 0;

500 
BSON_LONG
:

501  
	`bs⁄_ôî©‹_l⁄g_øw
–
i
 ) != 0;

502 
BSON_DOUBLE
:

503  
	`bs⁄_ôî©‹_doubÀ_øw
–
i
 ) != 0;

504 
BSON_EOO
:

505 
BSON_NULL
:

510 
	}
}

512 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_°rög
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

513  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

514 
BSON_STRING
:

515 
BSON_SYMBOL
:

516  
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 4;

520 
	}
}

522 
	$bs⁄_ôî©‹_°rög_Àn
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

523  
	`bs⁄_ôî©‹_öt_øw
–
i
 );

524 
	}
}

526 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_code
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

527  
	`bs⁄_ôî©‹_ty≥
–
i
 ) ) {

528 
BSON_STRING
:

529 
BSON_CODE
:

530  
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 4;

531 
BSON_CODEWSCOPE
:

532  
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 8;

534  
NULL
;

536 
	}
}

538 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_code_sc›e_öô
–c⁄° 
bs⁄_ôî©‹
 *
i
, 
bs⁄
 *
sc›e
, 
bs⁄_boﬁ_t
 
c›yD©a
 ) {

539 i‡–
	`bs⁄_ôî©‹_ty≥
–
i
 ) =
BSON_CODEWSCOPE
 ) {

540 
codeLí
 = 
	`bs⁄_föished_d©a_size
–
	`bs⁄_ôî©‹_vÆue
–
i
 )+4 );

541 c⁄° * 
sc›eD©a
 = 
	`bs⁄_ôî©‹_vÆue
–
i
 )+8+
codeLí
;

542 if–
c›yD©a
 )

543 
	`bs⁄_öô_föished_d©a_wôh_c›y
–
sc›e
, 
sc›eD©a
 );

545 
	`bs⁄_öô_föished_d©a
–
sc›e
, (*)
sc›eD©a
, 0 );

548 
	`bs⁄_öô_em±y
–
sc›e
 );

550 
	}
}

552 
MONGO_EXPORT
 
bs⁄_d©e_t
 
	$bs⁄_ôî©‹_d©e
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

553  
	`bs⁄_ôî©‹_l⁄g_øw
–
i
 );

554 
	}
}

556 
MONGO_EXPORT
 
time_t
 
	$bs⁄_ôî©‹_time_t
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

557  
	`bs⁄_ôî©‹_d©e
–
i
 ) / 1000;

558 
	}
}

560 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_bö_Àn
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

561  ( 
	`bs⁄_ôî©‹_bö_ty≥
–
i
 ) =
BSON_BIN_BINARY_OLD
 )

562 ? 
	`bs⁄_ôî©‹_öt_øw
–
i
 ) - 4

563 : 
	`bs⁄_ôî©‹_öt_øw
–
i
 );

564 
	}
}

566 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_bö_ty≥
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

567  
	`bs⁄_ôî©‹_vÆue
–
i
 )[4];

568 
	}
}

570 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_bö_d©a
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

571  ( 
	`bs⁄_ôî©‹_bö_ty≥
–
i
 ) =
BSON_BIN_BINARY_OLD
 )

572 ? 
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 9

573 : 
	`bs⁄_ôî©‹_vÆue
–
i
 ) + 5;

574 
	}
}

576 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_ªgex
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

577  
	`bs⁄_ôî©‹_vÆue
–
i
 );

578 
	}
}

580 
MONGO_EXPORT
 c⁄° *
	$bs⁄_ôî©‹_ªgex_›ts
–c⁄° 
bs⁄_ôî©‹
 *
i
 ) {

581 c⁄° *
p
 = 
	`bs⁄_ôî©‹_vÆue
–
i
 );

582  
p
 + 
	`°æí
(Ö ) + 1;

584 
	}
}

586 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_subobje˘_öô
–c⁄° 
bs⁄_ôî©‹
 *
i
, 
bs⁄
 *
sub
, 
bs⁄_boﬁ_t
 
c›yD©a
 ) {

587 c⁄° *
d©a
 = 
	`bs⁄_ôî©‹_vÆue
–
i
 );

588 if–
c›yD©a
 )

589 
	`bs⁄_öô_föished_d©a_wôh_c›y
–
sub
, 
d©a
 );

591 
	`bs⁄_öô_föished_d©a
–
sub
, (*)
d©a
, 0 );

592 
	}
}

594 
MONGO_EXPORT
 
	$bs⁄_ôî©‹_subôî©‹
–c⁄° 
bs⁄_ôî©‹
 *
i
, bs⁄_ôî©‹ *
sub
 ) {

595 
	`bs⁄_ôî©‹_‰om_buf„r
–
sub
, 
	`bs⁄_ôî©‹_vÆue
–
i
 ) );

596 
	}
}

602 
	$_bs⁄_zîo
–
bs⁄
 *
b
 ) {

603 
	`mem£t
–
b
, 0, –
bs⁄
 ) );

604 
	}
}

606 
MONGO_EXPORT
 
	$bs⁄_öô
–
bs⁄
 *
b
 ) {

607  
	`bs⁄_öô_size
–
b
, 
öôülBuf„rSize
 );

608 
	}
}

610 
MONGO_EXPORT
 
	$bs⁄_öô_zîo
–
bs⁄
 *
b
 ) {

611 
ªtvÆ
 = -1;

612 
ªtvÆ
 = 
	`bs⁄_öô
–
b
 );

613 
	`_bs⁄_zîo
(
b
);

615 
	}
}

618 
	$bs⁄_öô_size
–
bs⁄
 *
b
, 
size
 ) {

619 
	`_bs⁄_zîo
–
b
 );

620 if–
size
 != 0 )

622 * 
d©a
 = (*Ë
	`bs⁄_mÆloc
–
size
 );

623 i‡(
d©a
 =
NULL
Ë 
BSON_ERROR
;

624 
b
->
d©a
 = data;

625 
b
->
d©aSize
 = 
size
;

627 
b
->
ownsD©a
 = 1;

628 
b
->
cur
 = b->
d©a
 + 4;

629  
BSON_OK
;

630 
	}
}

632 
	$bs⁄_öô_unföished_d©a
–
bs⁄
 *
b
, *
d©a
, 
d©aSize
, 
bs⁄_boﬁ_t
 
ownsD©a
 ) {

633 
	`_bs⁄_zîo
–
b
 );

634 
b
->
d©a
 = data;

635 
b
->
d©aSize
 = dataSize;

636 
b
->
ownsD©a
 = ownsData;

637  
BSON_OK
;

638 
	}
}

640 
	$_bs⁄_≠≥nd_grow_°ack
–
bs⁄
 * 
b
 ) {

641 i‡–!
b
->
°ackPå
 ) {

643 
b
->
°ackPå
 = b->
°ack
;

644 
b
->
°ackSize
 = –b->
°ack
 ) / –
size_t
 );

646 i‡–
b
->
°ackPå
 =b->
°ack
 ) {

648 
size_t
 *
√w_°ack
 = ( size_à* ) 
	`bs⁄_mÆloc
–2 * –
b
->
°ack
 ) );

649 i‡–
√w_°ack
 ) {

650 
b
->
°ackPå
 = 
√w_°ack
;

651 
b
->
°ackSize
 = 2 * –b->
°ack
 ) / –
size_t
 );

652 
	`mem˝y
–
b
->
°ackPå
, b->
°ack
, ( b->stack ) );

655  
BSON_ERROR
;

660 
size_t
 *
√w_°ack
 = ( size_à* ) 
	`bs⁄_ªÆloc
–
b
->
°ackPå
, ( b->
°ackSize
 * 2 ) * ( size_t ) );

661 i‡–
√w_°ack
 ) {

662 
b
->
°ackPå
 = 
√w_°ack
;

663 
b
->
°ackSize
 *= 2;

666  
BSON_ERROR
;

669  
BSON_OK
;

670 
	}
}

672 
	$bs⁄_≠≥nd_byã
–
bs⁄
 *
b
, 
c
 ) {

673 
b
->
cur
[0] = 
c
;

674 
b
->
cur
++;

675 
	}
}

677 
	$bs⁄_≠≥nd
–
bs⁄
 *
b
, c⁄° *
d©a
, 
size_t
 
Àn
 ) {

678 
	`mem˝y
–
b
->
cur
 , 
d©a
 , 
Àn
 );

679 
b
->
cur
 +
Àn
;

680 
	}
}

682 
	$bs⁄_≠≥nd32
–
bs⁄
 *
b
, c⁄° *
d©a
 ) {

683 
	`bs⁄_lôée_ídün32
–
b
->
cur
, 
d©a
 );

684 
b
->
cur
 += 4;

685 
	}
}

687 
	$bs⁄_≠≥nd32_as_öt
–
bs⁄
 *
b
, 
d©a
 ) {

688 
	`bs⁄_lôée_ídün32
–
b
->
cur
, &
d©a
 );

689 
b
->
cur
 += 4;

690 
	}
}

692 
	$bs⁄_≠≥nd64
–
bs⁄
 *
b
, c⁄° *
d©a
 ) {

693 
	`bs⁄_lôée_ídün64
–
b
->
cur
, 
d©a
 );

694 
b
->
cur
 += 8;

695 
	}
}

697 
	$bs⁄_ísuª_•a˚
–
bs⁄
 *
b
, c⁄° 
size_t
 
byãsNìded
 ) {

698 
size_t
 
pos
 = 
	`_bs⁄_posôi⁄
(
b
);

699 *
‹ig
 = 
b
->
d©a
;

700 
√w_size
;

702 i‡–
pos
 + 
byãsNìded
 <(
size_t
Ë
b
->
d©aSize
 )

703  
BSON_OK
;

705 
√w_size
 = (Ë–1.5 * ( 
b
->
d©aSize
 + 
byãsNìded
 ) );

707 if–
√w_size
 < 
b
->
d©aSize
 ) {

708 if––
b
->
d©aSize
 + 
byãsNìded
 ) < 
INT_MAX
 )

709 
√w_size
 = 
INT_MAX
;

711 
b
->
îr
 = 
BSON_SIZE_OVERFLOW
;

712  
BSON_ERROR
;

716 i‡–! 
b
->
ownsD©a
 ) {

717 
b
->
îr
 = 
BSON_DOES_NOT_OWN_DATA
;

718  
BSON_ERROR
;

721 
b
->
d©a
 = 
	`bs⁄_ªÆloc
–b->d©a, 
√w_size
 );

722 i‡–!
b
->
d©a
 )

723 
	`bs⁄_Áèl_msg
–!!
b
->
d©a
, "realloc() failed" );

725 
b
->
d©aSize
 = 
√w_size
;

726 
b
->
cur
 +b->
d©a
 - 
‹ig
;

728  
BSON_OK
;

729 
	}
}

731 
MONGO_EXPORT
 
	$bs⁄_föish
–
bs⁄
 *
b
 ) {

732 
i
;

734 if–
b
->
îr
 & 
BSON_NOT_UTF8
 )

735  
BSON_ERROR
;

737 i‡–! 
b
->
föished
 ) {

738 
	`bs⁄_Áèl_msg
(!
b
->
°ackPos
, "SubobjectÇot finished before bson_finish().");

739 i‡–
	`bs⁄_ísuª_•a˚
–
b
, 1 ) =
BSON_ERROR
 )  BSON_ERROR;

740 
	`bs⁄_≠≥nd_byã
–
b
, 0 );

741 i‡–
	`_bs⁄_posôi⁄
(
b
Ë>
INT32_MAX
 ) {

742 
b
->
îr
 = 
BSON_SIZE_OVERFLOW
;

743  
BSON_ERROR
;

745 
i
 = ( Ë
	`_bs⁄_posôi⁄
(
b
);

746 
	`bs⁄_lôée_ídün32
–
b
->
d©a
, &
i
 );

747 
b
->
föished
 = 1;

750  
BSON_OK
;

751 
	}
}

753 
MONGO_EXPORT
 
	$bs⁄_de°roy
–
bs⁄
 *
b
 ) {

754 i‡–
b
 ) {

755 i‡–
b
->
ownsD©a
 && b->
d©a
 !
NULL
 ) {

756 
	`bs⁄_‰ì
–
b
->
d©a
 );

758 
b
->
d©a
 = 
NULL
;

759 
b
->
d©aSize
 = 0;

760 
b
->
ownsD©a
 = 0;

761 i‡–
b
->
°ackPå
 && b->°ackPå !b->
°ack
 ) {

762 
	`bs⁄_‰ì
–
b
->
°ackPå
 );

763 
b
->
°ackPå
 = 
NULL
;

765 
b
->
°ackSize
 = 0;

766 
b
->
°ackPos
 = 0;

767 
b
->
îr
 = 0;

768 
b
->
cur
 = 0;

769 
b
->
föished
 = 1;

771 
	}
}

773 
	$bs⁄_≠≥nd_e°¨t
–
bs⁄
 *
b
, 
ty≥
, c⁄° *
«me
, c⁄° 
size_t
 
d©aSize
 ) {

774 c⁄° 
size_t
 
Àn
 = 
	`°æí
–
«me
 ) + 1;

776 i‡–
b
->
föished
 ) {

777 
b
->
îr
 |
BSON_ALREADY_FINISHED
;

778  
BSON_ERROR
;

781 i‡–
	`bs⁄_ísuª_•a˚
–
b
, 1 + 
Àn
 + 
d©aSize
 ) =
BSON_ERROR
 ) {

782  
BSON_ERROR
;

785 if–
	`bs⁄_check_fõld_«me
–
b
, ( c⁄° * )
«me
, 
Àn
 - 1 ) =
BSON_ERROR
 ) {

786 
	`bs⁄_buûdî_îr‹
–
b
 );

787  
BSON_ERROR
;

790 
	`bs⁄_≠≥nd_byã
–
b
, ( )
ty≥
 );

791 
	`bs⁄_≠≥nd
–
b
, 
«me
, 
Àn
 );

792  
BSON_OK
;

793 
	}
}

799 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_öt
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
i
 ) {

800 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_INT
, 
«me
, 4 ) =
BSON_ERROR
 )

801  
BSON_ERROR
;

802 
	`bs⁄_≠≥nd32
–
b
 , &
i
 );

803  
BSON_OK
;

804 
	}
}

806 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_l⁄g
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
öt64_t
 
i
 ) {

807 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
 , 
BSON_LONG
, 
«me
, 8 ) =
BSON_ERROR
 )

808  
BSON_ERROR
;

809 
	`bs⁄_≠≥nd64
–
b
 , &
i
 );

810  
BSON_OK
;

811 
	}
}

813 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_doubÀ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
d
 ) {

814 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_DOUBLE
, 
«me
, 8 ) =
BSON_ERROR
 )

815  
BSON_ERROR
;

816 
	`bs⁄_≠≥nd64
–
b
 , &
d
 );

817  
BSON_OK
;

818 
	}
}

820 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_boﬁ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
bs⁄_boﬁ_t
 
i
 ) {

821 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_BOOL
, 
«me
, 1 ) =
BSON_ERROR
 )

822  
BSON_ERROR
;

823 
	`bs⁄_≠≥nd_byã
–
b
 , 
i
 != 0 );

824  
BSON_OK
;

825 
	}
}

827 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_nuŒ
–
bs⁄
 *
b
, c⁄° *
«me
 ) {

828 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
 , 
BSON_NULL
, 
«me
, 0 ) =
BSON_ERROR
 )

829  
BSON_ERROR
;

830  
BSON_OK
;

831 
	}
}

833 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_undeföed
–
bs⁄
 *
b
, c⁄° *
«me
 ) {

834 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_UNDEFINED
, 
«me
, 0 ) =
BSON_ERROR
 )

835  
BSON_ERROR
;

836  
BSON_OK
;

837 
	}
}

839 
	$bs⁄_≠≥nd_°rög_ba£
–
bs⁄
 *
b
, c⁄° *
«me
,

840 c⁄° *
vÆue
, 
size_t
 
Àn
, 
bs⁄_ty≥
 
ty≥
 ) {

842 
size_t
 
¶
 = 
Àn
 + 1;

843 i‡–
¶
 > 
INT32_MAX
 ) {

844 
b
->
îr
 = 
BSON_SIZE_OVERFLOW
;

846  
BSON_ERROR
;

848 i‡–
	`bs⁄_check_°rög
–
b
, ( c⁄° * )
vÆue
, 
¶
 - 1 ) =
BSON_ERROR
 )

849  
BSON_ERROR
;

850 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
ty≥
, 
«me
, 4 + 
¶
 ) =
BSON_ERROR
 ) {

851  
BSON_ERROR
;

853 
	`bs⁄_≠≥nd32_as_öt
–
b
 , ( )
¶
 );

854 
	`bs⁄_≠≥nd
–
b
 , 
vÆue
 , 
¶
 - 1 );

855 
	`bs⁄_≠≥nd
–
b
 , "\0" , 1 );

856  
BSON_OK
;

857 
	}
}

859 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_°rög
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
 ) {

860  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
	`°æí
 ( vÆuê), 
BSON_STRING
 );

861 
	}
}

863 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_symbﬁ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
 ) {

864  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
	`°æí
 ( vÆuê), 
BSON_SYMBOL
 );

865 
	}
}

867 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_code
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
 ) {

868  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
	`°æí
 ( vÆuê), 
BSON_CODE
 );

869 
	}
}

871 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_°rög_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
Àn
 ) {

872  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
Àn
, 
BSON_STRING
 );

873 
	}
}

875 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_symbﬁ_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
Àn
 ) {

876  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
Àn
, 
BSON_SYMBOL
 );

877 
	}
}

879 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_code_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
Àn
 ) {

880  
	`bs⁄_≠≥nd_°rög_ba£
–
b
, 
«me
, 
vÆue
, 
Àn
, 
BSON_CODE
 );

881 
	}
}

883 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_code_w_sc›e_n
–
bs⁄
 *
b
, c⁄° *
«me
,

884 c⁄° *
code
, 
size_t
 
Àn
, c⁄° 
bs⁄
 *
sc›e
 ) {

886 
size_t
 
¶
, 
size
;

887 i‡–!
sc›e
 )  
BSON_ERROR
;

888 
¶
 = 
Àn
 + 1;

889 
size
 = 4 + 4 + 
¶
 + 
	`bs⁄_size
–
sc›e
 );

890 i‡–
size
 > (
size_t
)
INT32_MAX
 ) {

891 
b
->
îr
 = 
BSON_SIZE_OVERFLOW
;

892  
BSON_ERROR
;

894 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_CODEWSCOPE
, 
«me
, 
size
 ) =
BSON_ERROR
 )

895  
BSON_ERROR
;

896 
	`bs⁄_≠≥nd32_as_öt
–
b
, ( )
size
 );

897 
	`bs⁄_≠≥nd32
–
b
, &
¶
 );

898 
	`bs⁄_≠≥nd
–
b
, 
code
, 
¶
 );

899 
	`bs⁄_≠≥nd
–
b
, 
sc›e
->
d©a
, 
	`bs⁄_size
( scope ) );

900  
BSON_OK
;

901 
	}
}

903 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_code_w_sc›e
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
code
, c⁄° bs⁄ *
sc›e
 ) {

904  
	`bs⁄_≠≥nd_code_w_sc›e_n
–
b
, 
«me
, 
code
, 
	`°æí
 ( codê), 
sc›e
 );

905 
	}
}

907 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_bö¨y
–
bs⁄
 *
b
, c⁄° *
«me
, 
ty≥
, c⁄° *
°r
, 
size_t
 
Àn
 ) {

908 i‡–
ty≥
 =
BSON_BIN_BINARY_OLD
 ) {

909 
size_t
 
subtwﬁí
 = 
Àn
 + 4;

910 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_BINDATA
, 
«me
, 4+1+4+
Àn
 ) =
BSON_ERROR
 )

911  
BSON_ERROR
;

912 
	`bs⁄_≠≥nd32_as_öt
–
b
, ( )
subtwﬁí
 );

913 
	`bs⁄_≠≥nd_byã
–
b
, 
ty≥
 );

914 
	`bs⁄_≠≥nd32_as_öt
–
b
, ( )
Àn
 );

915 
	`bs⁄_≠≥nd
–
b
, 
°r
, 
Àn
 );

918 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_BINDATA
, 
«me
, 4+1+
Àn
 ) =
BSON_ERROR
 )

919  
BSON_ERROR
;

920 
	`bs⁄_≠≥nd32_as_öt
–
b
, ( )
Àn
 );

921 
	`bs⁄_≠≥nd_byã
–
b
, 
ty≥
 );

922 
	`bs⁄_≠≥nd
–
b
, 
°r
, 
Àn
 );

924  
BSON_OK
;

925 
	}
}

927 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_oid
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
bs⁄_oid_t
 *
oid
 ) {

928 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_OID
, 
«me
, 12 ) =
BSON_ERROR
 )

929  
BSON_ERROR
;

930 
	`bs⁄_≠≥nd
–
b
 , 
oid
 , 12 );

931  
BSON_OK
;

932 
	}
}

934 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_√w_oid
–
bs⁄
 *
b
, c⁄° *
«me
 ) {

935 
bs⁄_oid_t
 
oid
;

936 
	`bs⁄_oid_gí
–&
oid
 );

937  
	`bs⁄_≠≥nd_oid
–
b
, 
«me
, &
oid
 );

938 
	}
}

940 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_ªgex
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
∑âîn
, c⁄° *
›ts
 ) {

941 c⁄° 
size_t
 
∂í
 = 
	`°æí
–
∑âîn
 )+1;

942 c⁄° 
size_t
 
ﬁí
 = 
	`°æí
–
›ts
 )+1;

943 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_REGEX
, 
«me
, 
∂í
 + 
ﬁí
 ) =
BSON_ERROR
 )

944  
BSON_ERROR
;

945 i‡–
	`bs⁄_check_°rög
–
b
, 
∑âîn
, 
∂í
 - 1 ) =
BSON_ERROR
 )

946  
BSON_ERROR
;

947 
	`bs⁄_≠≥nd
–
b
 , 
∑âîn
 , 
∂í
 );

948 
	`bs⁄_≠≥nd
–
b
 , 
›ts
 , 
ﬁí
 );

949  
BSON_OK
;

950 
	}
}

952 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_bs⁄
–
bs⁄
 *
b
, c⁄° *
«me
, const bson *bson ) {

953 i‡–!
bs⁄
 )  
BSON_ERROR
;

954 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_OBJECT
, 
«me
, 
	`bs⁄_size
–
bs⁄
 ) ) =
BSON_ERROR
 )

955  
BSON_ERROR
;

956 
	`bs⁄_≠≥nd
–
b
 , 
bs⁄
->
d©a
 , 
	`bs⁄_size
( bson ) );

957  
BSON_OK
;

958 
	}
}

960 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_ñemít
–
bs⁄
 *
b
, c⁄° *
«me_‹_nuŒ
, c⁄° 
bs⁄_ôî©‹
 *
ñem
 ) {

961 
bs⁄_ôî©‹
 
√xt
 = *
ñem
;

962 
size_t
 
size
;

964 
	`bs⁄_ôî©‹_√xt
–&
√xt
 );

965 
size
 = 
√xt
.
cur
 - 
ñem
->cur;

967 i‡–
«me_‹_nuŒ
 =
NULL
 ) {

968 if–
	`bs⁄_ísuª_•a˚
–
b
, 
size
 ) =
BSON_ERROR
 )

969  
BSON_ERROR
;

970 
	`bs⁄_≠≥nd
–
b
, 
ñem
->
cur
, 
size
 );

973 
size_t
 
d©a_size
 = 
size
 - 2 - 
	`°æí
–
	`bs⁄_ôî©‹_key
–
ñem
 ) );

974 
	`bs⁄_≠≥nd_e°¨t
–
b
, 
ñem
->
cur
[0], 
«me_‹_nuŒ
, 
d©a_size
 );

975 
	`bs⁄_≠≥nd
–
b
, 
	`bs⁄_ôî©‹_vÆue
–
ñem
 ), 
d©a_size
 );

978  
BSON_OK
;

979 
	}
}

981 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_time°amp
–
bs⁄
 *
b
, c⁄° *
«me
, 
bs⁄_time°amp_t
 *
ts
 ) {

982 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_TIMESTAMP
, 
«me
, 8 ) =
BSON_ERROR
 )  BSON_ERROR;

984 
	`bs⁄_≠≥nd32
–
b
 , &–
ts
->
i
 ) );

985 
	`bs⁄_≠≥nd32
–
b
 , &–
ts
->
t
 ) );

987  
BSON_OK
;

988 
	}
}

990 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_time°amp2
–
bs⁄
 *
b
, c⁄° *
«me
, 
time
, 
ö¸emít
 ) {

991 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_TIMESTAMP
, 
«me
, 8 ) =
BSON_ERROR
 )  BSON_ERROR;

993 
	`bs⁄_≠≥nd32
–
b
 , &
ö¸emít
 );

994 
	`bs⁄_≠≥nd32
–
b
 , &
time
 );

995  
BSON_OK
;

996 
	}
}

998 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_d©e
–
bs⁄
 *
b
, c⁄° *
«me
, 
bs⁄_d©e_t
 
mûlis
 ) {

999 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_DATE
, 
«me
, 8 ) =
BSON_ERROR
 )  BSON_ERROR;

1000 
	`bs⁄_≠≥nd64
–
b
 , &
mûlis
 );

1001  
BSON_OK
;

1002 
	}
}

1004 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_time_t
–
bs⁄
 *
b
, c⁄° *
«me
, 
time_t
 
£cs
 ) {

1005  
	`bs⁄_≠≥nd_d©e
–
b
, 
«me
, ( 
bs⁄_d©e_t
 )
£cs
 * 1000 );

1006 
	}
}

1008 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_°¨t_obje˘
–
bs⁄
 *
b
, c⁄° *
«me
 ) {

1009 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_OBJECT
, 
«me
, 5 ) =
BSON_ERROR
 )  BSON_ERROR;

1010 i‡–
b
->
°ackPos
 >b->
°ackSize
 && 
	`_bs⁄_≠≥nd_grow_°ack
–b ) =
BSON_ERROR
 )  BSON_ERROR;

1011 
b
->
°ackPå
[ b->
°ackPos
++ ] = 
	`_bs⁄_posôi⁄
(b);

1012 
	`bs⁄_≠≥nd32
–
b
 , &
zîo
 );

1013  
BSON_OK
;

1014 
	}
}

1016 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_°¨t_¨øy
–
bs⁄
 *
b
, c⁄° *
«me
 ) {

1017 i‡–
	`bs⁄_≠≥nd_e°¨t
–
b
, 
BSON_ARRAY
, 
«me
, 5 ) =
BSON_ERROR
 )  BSON_ERROR;

1018 i‡–
b
->
°ackPos
 >b->
°ackSize
 && 
	`_bs⁄_≠≥nd_grow_°ack
–b ) =
BSON_ERROR
 )  BSON_ERROR;

1019 
b
->
°ackPå
[ b->
°ackPos
++ ] = 
	`_bs⁄_posôi⁄
(b);

1020 
	`bs⁄_≠≥nd32
–
b
 , &
zîo
 );

1021  
BSON_OK
;

1022 
	}
}

1024 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_föish_obje˘
–
bs⁄
 *
b
 ) {

1025 *
°¨t
;

1026 
i
;

1027 i‡(!
b
Ë 
BSON_ERROR
;

1028 i‡(!
b
->
°ackPos
Ë{ b->
îr
 = 
BSON_NOT_IN_SUBOBJECT
;  
BSON_ERROR
; }

1029 i‡–
	`bs⁄_ísuª_•a˚
–
b
, 1 ) =
BSON_ERROR
 )  BSON_ERROR;

1030 
	`bs⁄_≠≥nd_byã
–
b
 , 0 );

1032 
°¨t
 = 
b
->
d©a
 + b->
°ackPå
[ --b->
°ackPos
 ];

1033 i‡–
b
->
cur
 - 
°¨t
 >
INT32_MAX
 ) {

1034 
b
->
îr
 = 
BSON_SIZE_OVERFLOW
;

1035  
BSON_ERROR
;

1037 
i
 = ( )–
b
->
cur
 - 
°¨t
 );

1038 
	`bs⁄_lôée_ídün32
–
°¨t
, &
i
 );

1040  
BSON_OK
;

1041 
	}
}

1043 
MONGO_EXPORT
 
	$bs⁄_öt64_to_doubÀ
–
öt64_t
 
i64
 ) {

1044  ()
i64
;

1045 
	}
}

1047 
MONGO_EXPORT
 
	$bs⁄_≠≥nd_föish_¨øy
–
bs⁄
 *
b
 ) {

1048  
	`bs⁄_≠≥nd_föish_obje˘
–
b
 );

1049 
	}
}

1053 
bs⁄_îr_h™dÀr
 
	gîr_h™dÀr
 = 
NULL
;

1055 
MONGO_EXPORT
 
bs⁄_îr_h™dÀr
 
	$£t_bs⁄_îr_h™dÀr
–
bs⁄_îr_h™dÀr
 
func
 ) {

1056 
bs⁄_îr_h™dÀr
 
ﬁd
 = 
îr_h™dÀr
;

1057 
îr_h™dÀr
 = 
func
;

1058  
ﬁd
;

1059 
	}
}

1061 
MONGO_EXPORT
 
	$bs⁄_‰ì
–*
±r
 ) {

1062 
	`bs⁄_‰ì_func
–
±r
 );

1063 
	}
}

1065 
MONGO_EXPORT
 *
	$bs⁄_mÆloc
–
size_t
 
size
 ) {

1066 *
p
;

1067 
p
 = 
	`bs⁄_mÆloc_func
–
size
 );

1068 
	`bs⁄_Áèl_msg
–!!
p
, "malloc() failed" );

1069  
p
;

1070 
	}
}

1072 *
	$bs⁄_ªÆloc
–*
±r
, 
size_t
 
size
 ) {

1073 *
p
;

1074 
p
 = 
	`bs⁄_ªÆloc_func
–
±r
, 
size
 );

1075 
	`bs⁄_Áèl_msg
–!!
p
, "realloc() failed" );

1076  
p
;

1077 
	}
}

1079 
	$_bs⁄_îΩrötf
–c⁄° *
f‹m©
, ... ) {

1080 
va_li°
 
≠
;

1081 
ªt
 = 0;

1082 
	`va_°¨t
–
≠
, 
f‹m©
 );

1083 #i‚de‡
R_SAFETY_NET


1084 
ªt
 = 
	`vÂrötf
–
°dîr
, 
f‹m©
, 
≠
 );

1086 
	`va_íd
–
≠
 );

1088  
ªt
;

1089 
	}
}

1097 
	$bs⁄_buûdî_îr‹
–
bs⁄
 *
b
 ) {

1098 if–
îr_h™dÀr
 )

1099 
	`îr_h™dÀr
( "BSONÉrror." );

1100 
	}
}

1102 
	$bs⁄_Áèl
–
ok
 ) {

1103 
	`bs⁄_Áèl_msg
–
ok
, "" );

1104 
	}
}

1106 
	$bs⁄_Áèl_msg
–
ok
 , c⁄° *
msg
 ) {

1107 i‡–
ok
 )

1110 i‡–
îr_h™dÀr
 ) {

1111 
	`îr_h™dÀr
–
msg
 );

1113 #i‚de‡
R_SAFETY_NET


1114 
	`bs⁄_îΩrötf
–"îr‹: %s\n" , 
msg
 );

1115 
	`exô
( -5 );

1117 
	}
}

1121 c⁄° 
bs⁄_num°rs
[1000][4];

1123 
	$bs⁄_num°r
–*
°r
, 
i
 ) {

1124 if–
i
 < 1000 )

1125 
	`mem˝y
–
°r
, 
bs⁄_num°rs
[
i
], 4 );

1127 
	`bs⁄_•rötf
–
°r
,"%d", 
i
 );

1128 
	}
}

1130 
MONGO_EXPORT
 
	$bs⁄_sw≠_ídün64
–*
ouç
, c⁄° *
öp
 ) {

1131 c⁄° *
ö
 = ( c⁄° * )
öp
;

1132 *
out
 = ( * )
ouç
;

1134 
out
[0] = 
ö
[7];

1135 
out
[1] = 
ö
[6];

1136 
out
[2] = 
ö
[5];

1137 
out
[3] = 
ö
[4];

1138 
out
[4] = 
ö
[3];

1139 
out
[5] = 
ö
[2];

1140 
out
[6] = 
ö
[1];

1141 
out
[7] = 
ö
[0];

1143 
	}
}

1145 
MONGO_EXPORT
 
	$bs⁄_sw≠_ídün32
–*
ouç
, c⁄° *
öp
 ) {

1146 c⁄° *
ö
 = ( c⁄° * )
öp
;

1147 *
out
 = ( * )
ouç
;

1149 
out
[0] = 
ö
[3];

1150 
out
[1] = 
ö
[2];

1151 
out
[2] = 
ö
[1];

1152 
out
[3] = 
ö
[0];

1153 
	}
}

	@bson.h

21 #i‚de‡
BSON_H_


22 
	#BSON_H_


	)

24 
	~<time.h
>

25 
	~<°rög.h
>

26 
	~<°dio.h
>

27 
	~<°dlib.h
>

28 
	~<°d¨g.h
>

30 #ifde‡
__GNUC__


31 
	#MONGO_INLINE
 
__ölöe__


	)

32 
	#MONGO_EXPORT


	)

34 
	#MONGO_INLINE
 

	)

35 #ifde‡
MONGO_STATIC_BUILD


36 
	#MONGO_EXPORT


	)

37 #ñi‡
deföed
(
MONGO_DLL_BUILD
)

38 
	#MONGO_EXPORT
 
	`__de˛•ec
(
dŒexp‹t
)

	)

40 
	#MONGO_EXPORT
 
	`__de˛•ec
(
dŒimp‹t
)

	)

44 #ifde‡
__˝lu•lus


45 
	#MONGO_EXTERN_C_START
 "C" {

	)

46 
	#MONGO_EXTERN_C_END
 }

	)

48 
	#MONGO_EXTERN_C_START


	)

49 
	#MONGO_EXTERN_C_END


	)

52 #i‡
deföed
(
MONGO_HAVE_STDINT
Ë|| 
__STDC_VERSION__
 >= 199901L

53 
	~<°döt.h
>

54 #ñi‡
deföed
(
MONGO_HAVE_UNISTD
)

55 
	~<uni°d.h
>

56 #ñi‡
deföed
(
MONGO_USE__INT64
)

57 
__öt64
 
	töt64_t
;

58 
	t__öt64
 
	tuöt64_t
;

59 
	#INT32_MAX
 0x7fffffffL

	)

60 #ñi‡
deföed
(
MONGO_USE_LONG_LONG_INT
)

61 
	töt64_t
;

62 
	tuöt64_t
;

64 #îr‹ 
Mu°
 
compûe
 
wôh
 
c99
 
‹
 
deföe
 
MONGO_HAVE_STDINT
, 
MONGO_HAVE_UNISTD
, 
MONGO_USE__INT64
, o∏
MONGO_USE_LONG_LONG_INT
.

67 #ifde‡
MONGO_BIG_ENDIAN


68 
	#bs⁄_lôée_ídün64
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün64
(out, inË)

	)

69 
	#bs⁄_lôée_ídün32
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün32
(out, inË)

	)

70 
	#bs⁄_big_ídün64
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 8Ë)

	)

71 
	#bs⁄_big_ídün32
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 4Ë)

	)

73 
	#bs⁄_lôée_ídün64
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 8Ë)

	)

74 
	#bs⁄_lôée_ídün32
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 4Ë)

	)

75 
	#bs⁄_big_ídün64
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün64
(out, inË)

	)

76 
	#bs⁄_big_ídün32
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün32
(out, inË)

	)

79 
	gMONGO_EXTERN_C_START


81 
	#BSON_OK
 0

	)

82 
	#BSON_ERROR
 -1

	)

84 
	ebs⁄_îr‹_t
 {

85 
	mBSON_SIZE_OVERFLOW
 = (1 << 0),

86 
	mBSON_ALREADY_FINISHED
 = (1 << 4),

87 
	mBSON_NOT_IN_SUBOBJECT
 = (1 << 5),

88 
	mBSON_DOES_NOT_OWN_DATA
 = (1 << 6)

91 
	ebs⁄_vÆidôy_t
 {

92 
	mBSON_VALID
 = 0,

93 
	mBSON_NOT_UTF8
 = (1 << 1),

94 
	mBSON_FIELD_HAS_DOT
 = (1 << 2),

95 
	mBSON_FIELD_INIT_DOLLAR
 = (1 << 3)

98 
	ebs⁄_bö¨y_subty≥_t
 {

99 
	mBSON_BIN_BINARY
 = 0,

100 
	mBSON_BIN_FUNC
 = 1,

101 
	mBSON_BIN_BINARY_OLD
 = 2,

102 
	mBSON_BIN_UUID
 = 3,

103 
	mBSON_BIN_MD5
 = 5,

104 
	mBSON_BIN_USER
 = 128

108 
	mBSON_EOO
 = 0,

109 
	mBSON_DOUBLE
 = 1,

110 
	mBSON_STRING
 = 2,

111 
	mBSON_OBJECT
 = 3,

112 
	mBSON_ARRAY
 = 4,

113 
	mBSON_BINDATA
 = 5,

114 
	mBSON_UNDEFINED
 = 6,

115 
	mBSON_OID
 = 7,

116 
	mBSON_BOOL
 = 8,

117 
	mBSON_DATE
 = 9,

118 
	mBSON_NULL
 = 10,

119 
	mBSON_REGEX
 = 11,

120 
	mBSON_DBREF
 = 12,

121 
	mBSON_CODE
 = 13,

122 
	mBSON_SYMBOL
 = 14,

123 
	mBSON_CODEWSCOPE
 = 15,

124 
	mBSON_INT
 = 16,

125 
	mBSON_TIMESTAMP
 = 17,

126 
	mBSON_LONG
 = 18

127 } 
	tbs⁄_ty≥
;

129 
	tbs⁄_boﬁ_t
;

132 c⁄° *
	mcur
;

133 
bs⁄_boﬁ_t
 
	mfú°
;

134 } 
	tbs⁄_ôî©‹
;

137 *
	md©a
;

138 *
	mcur
;

139 
	md©aSize
;

140 
bs⁄_boﬁ_t
 
	mföished
;

141 
bs⁄_boﬁ_t
 
	mownsD©a
;

142 
	mîr
;

143 
	m°ackSize
;

144 
	m°ackPos
;

145 
size_t
* 
	m°ackPå
;

146 
size_t
 
	m°ack
[32];

148 } 
	tbs⁄
;

150 #¥agm®
∑ck
(1)

152 
	mbyãs
[12];

153 
	möts
[3];

154 } 
	tbs⁄_oid_t
;

155 #¥agm®
∑ck
()

157 
öt64_t
 
	tbs⁄_d©e_t
;

160 
	mi
;

161 
	mt
;

162 } 
	tbs⁄_time°amp_t
;

177 
MONGO_EXPORT
 
bs⁄
* 
bs⁄_Æloc
( );

189 
MONGO_EXPORT
 
bs⁄_öô_zîo
–
bs⁄
 *
b
 );

196 
MONGO_EXPORT
 
bs⁄_dóŒoc
–
bs⁄
* 
b
 );

211 
bs⁄_öô_föished_d©a
–
bs⁄
 *
b
, *
d©a
, 
bs⁄_boﬁ_t
 
ownsD©a
 );

225 
bs⁄_öô_föished_d©a_wôh_c›y
–
bs⁄
 *
b
, c⁄° *
d©a
 );

234 
MONGO_EXPORT
 
bs⁄_size
–c⁄° 
bs⁄
 *
b
 );

243 
MONGO_EXPORT
 
size_t
 
bs⁄_buf„r_size
–c⁄° 
bs⁄
 *
b
 );

250 
MONGO_EXPORT
 
bs⁄_¥öt
–c⁄° 
bs⁄
 *
b
 );

257 
MONGO_EXPORT
 c⁄° *
bs⁄_d©a
–c⁄° 
bs⁄
 *
b
 );

268 
MONGO_EXPORT
 
bs⁄_has_d©a
–c⁄° 
bs⁄
 *
b
 );

276 
MONGO_EXPORT
 
bs⁄_¥öt_øw
–c⁄° *
bs⁄
 , 
dïth
 );

287 
MONGO_EXPORT
 
bs⁄_ty≥
 
bs⁄_föd
–
bs⁄_ôî©‹
 *
ô
, c⁄° 
bs⁄
 *
obj
, c⁄° *
«me
 );

290 
MONGO_EXPORT
 
bs⁄_ôî©‹
* 
bs⁄_ôî©‹_Æloc
( );

291 
MONGO_EXPORT
 
bs⁄_ôî©‹_dóŒoc
(
bs⁄_ôî©‹
*);

298 
MONGO_EXPORT
 
bs⁄_ôî©‹_öô
–
bs⁄_ôî©‹
 *
i
 , c⁄° 
bs⁄
 *
b
 );

307 
MONGO_EXPORT
 
bs⁄_ôî©‹_‰om_buf„r
–
bs⁄_ôî©‹
 *
i
, c⁄° *
buf„r
 );

317 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
bs⁄_ôî©‹_m‹e
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

326 
MONGO_EXPORT
 
bs⁄_ty≥
 
bs⁄_ôî©‹_√xt
–
bs⁄_ôî©‹
 *
i
 );

335 
MONGO_EXPORT
 
bs⁄_ty≥
 
bs⁄_ôî©‹_ty≥
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

344 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_key
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

353 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_vÆue
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

364 
MONGO_EXPORT
 
bs⁄_ôî©‹_doubÀ
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

373 
MONGO_EXPORT
 
bs⁄_ôî©‹_öt
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

382 
MONGO_EXPORT
 
öt64_t
 
bs⁄_ôî©‹_l⁄g
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

393 
MONGO_EXPORT
 
bs⁄_time°amp_t
 
bs⁄_ôî©‹_time°amp
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

394 
MONGO_EXPORT
 
bs⁄_ôî©‹_time°amp_time
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

395 
MONGO_EXPORT
 
bs⁄_ôî©‹_time°amp_ö¸emít
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

407 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
bs⁄_ôî©‹_boﬁ
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

418 
bs⁄_ôî©‹_doubÀ_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

428 
bs⁄_ôî©‹_öt_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

438 
öt64_t
 
bs⁄_ôî©‹_l⁄g_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

448 
bs⁄_boﬁ_t
 
bs⁄_ôî©‹_boﬁ_øw
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

458 
MONGO_EXPORT
 
bs⁄_oid_t
 *
bs⁄_ôî©‹_oid
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

469 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_°rög
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

479 
bs⁄_ôî©‹_°rög_Àn
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

492 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_code
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

509 
MONGO_EXPORT
 
bs⁄_ôî©‹_code_sc›e_öô
–c⁄° 
bs⁄_ôî©‹
 *
i
, 
bs⁄
 *
sc›e
, 
bs⁄_boﬁ_t
 
c›yD©a
 );

520 
MONGO_EXPORT
 
bs⁄_d©e_t
 
bs⁄_ôî©‹_d©e
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

530 
MONGO_EXPORT
 
time_t
 
bs⁄_ôî©‹_time_t
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

540 
MONGO_EXPORT
 
bs⁄_ôî©‹_bö_Àn
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

550 
MONGO_EXPORT
 
bs⁄_ôî©‹_bö_ty≥
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

560 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_bö_d©a
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

570 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_ªgex
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

580 
MONGO_EXPORT
 c⁄° *
bs⁄_ôî©‹_ªgex_›ts
–c⁄° 
bs⁄_ôî©‹
 *
i
 );

594 
MONGO_EXPORT
 
bs⁄_ôî©‹_subobje˘_öô
–c⁄° 
bs⁄_ôî©‹
 *
i
, 
bs⁄
 *
sub
, 
bs⁄_boﬁ_t
 
c›yD©a
 );

602 
MONGO_EXPORT
 
bs⁄_ôî©‹_subôî©‹
–c⁄° 
bs⁄_ôî©‹
 *
i
, bs⁄_ôî©‹ *
sub
 );

611 
MONGO_EXPORT
 
bs⁄_oid_‰om_°rög
–
bs⁄_oid_t
 *
oid
, c⁄° *
°r
 );

619 
MONGO_EXPORT
 
bs⁄_oid_to_°rög
–c⁄° 
bs⁄_oid_t
 *
oid
, *
°r
 );

626 
MONGO_EXPORT
 
bs⁄_oid_gí
–
bs⁄_oid_t
 *
oid
 );

634 
MONGO_EXPORT
 
bs⁄_£t_oid_fuzz
––*
func
 )( ) );

643 
MONGO_EXPORT
 
	`bs⁄_£t_oid_öc
––*
func
 )( ) );

650 
MONGO_EXPORT
 
time_t
 
	`bs⁄_oid_gíî©ed_time
–
bs⁄_oid_t
 *
oid
 );

667 
MONGO_EXPORT
 
	`bs⁄_öô
–
bs⁄
 *
b
 );

681 
	`bs⁄_öô_size
–
bs⁄
 *
b
, 
size
 );

701 
	`bs⁄_öô_unföished_d©a
–
bs⁄
 *
b
, *
d©a
, 
d©aSize
, 
bs⁄_boﬁ_t
 
ownsD©a
 );

712 
	`bs⁄_ísuª_•a˚
–
bs⁄
 *
b
, c⁄° 
size_t
 
byãsNìded
 );

722 
MONGO_EXPORT
 
	`bs⁄_föish
–
bs⁄
 *
b
 );

730 
MONGO_EXPORT
 
	`bs⁄_de°roy
–
bs⁄
 *
b
 );

743 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	`bs⁄_öô_em±y
–
bs⁄
 *
obj
 );

753 
MONGO_EXPORT
 c⁄° 
bs⁄
 *
	`bs⁄_sh¨ed_em±y
( );

763 
MONGO_EXPORT
 
	`bs⁄_c›y
–
bs⁄
 *
out
, c⁄° bs⁄ *
ö
 );

774 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_oid
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
bs⁄_oid_t
 *
oid
 );

784 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_√w_oid
–
bs⁄
 *
b
, c⁄° *
«me
 );

795 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_öt
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
i
 );

806 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_l⁄g
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
öt64_t
 
i
 );

817 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_doubÀ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
d
 );

828 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_°rög
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
 );

840 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_°rög_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
, 
size_t
 
Àn
 );

851 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_symbﬁ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
 );

863 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_symbﬁ_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
, 
size_t
 
Àn
 );

875 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_code
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
 );

887 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_code_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
, 
size_t
 
Àn
 );

899 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_code_w_sc›e
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
code
, c⁄° bs⁄ *
sc›e
 );

912 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_code_w_sc›e_n
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
code
, 
size_t
 
size
, c⁄° bs⁄ *
sc›e
 );

925 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_bö¨y
–
bs⁄
 *
b
, c⁄° *
«me
, 
ty≥
, c⁄° *
°r
, 
size_t
 
Àn
 );

936 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_boﬁ
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° 
bs⁄_boﬁ_t
 
v
 );

946 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_nuŒ
–
bs⁄
 *
b
, c⁄° *
«me
 );

956 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_undeföed
–
bs⁄
 *
b
, c⁄° *
«me
 );

968 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_ªgex
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
∑âîn
, c⁄° *
›ts
 );

979 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_bs⁄
–
bs⁄
 *
b
, c⁄° *
«me
, const bson *bson );

990 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_ñemít
–
bs⁄
 *
b
, c⁄° *
«me_‹_nuŒ
, c⁄° 
bs⁄_ôî©‹
 *
ñem
 );

1001 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_time°amp
–
bs⁄
 *
b
, c⁄° *
«me
, 
bs⁄_time°amp_t
 *
ts
 );

1002 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_time°amp2
–
bs⁄
 *
b
, c⁄° *
«me
, 
time
, 
ö¸emít
 );

1014 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_d©e
–
bs⁄
 *
b
, c⁄° *
«me
, 
bs⁄_d©e_t
 
mûlis
 );

1025 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_time_t
–
bs⁄
 *
b
, c⁄° *
«me
, 
time_t
 
£cs
 );

1035 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_°¨t_obje˘
–
bs⁄
 *
b
, c⁄° *
«me
 );

1045 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_°¨t_¨øy
–
bs⁄
 *
b
, c⁄° *
«me
 );

1054 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_föish_obje˘
–
bs⁄
 *
b
 );

1064 
MONGO_EXPORT
 
	`bs⁄_≠≥nd_föish_¨øy
–
bs⁄
 *
b
 );

1066 
	`bs⁄_num°r
–*
°r
, 
i
 );

1068 
	`bs⁄_ö˙um°r
–*
°r
 );

1074 –*
	tbs⁄_îr_h™dÀr
 )–c⁄° *
	tîrmsg
 );

1076 (*
	tbs⁄_¥ötf_func
)( const *, ... );

1077 (*
	tbs⁄_Ârötf_func
)–
	tFILE
 *, const *, ... );

1078 (*
	tbs⁄_•rötf_func
)( *, const *, ... );

1080 *–*
bs⁄_mÆloc_func
 )–
size_t
 );

1081 *–*
bs⁄_ªÆloc_func
 )–*, 
size_t
 );

1082 –*
bs⁄_‰ì_func
 )( * );

1084 
bs⁄_¥ötf_func
 
bs⁄_¥ötf
;

1085 
bs⁄_Ârötf_func
 
bs⁄_Ârötf
;

1086 
bs⁄_•rötf_func
 
bs⁄_•rötf
;

1087 
bs⁄_¥ötf_func
 
bs⁄_îΩrötf
;

1089 
MONGO_EXPORT
 
	`bs⁄_‰ì
–*
±r
 );

1100 
MONGO_EXPORT
 *
	`bs⁄_mÆloc
–
size_t
 
size
 );

1113 *
	`bs⁄_ªÆloc
–*
±r
, 
size_t
 
size
 );

1122 
MONGO_EXPORT
 
bs⁄_îr_h™dÀr
 
	`£t_bs⁄_îr_h™dÀr
–bs⁄_îr_h™dÀ∏
func
 );

1130 
	`bs⁄_Áèl
–
ok
 );

1138 
	`bs⁄_Áèl_msg
–
ok
, c⁄° *
msg
 );

1145 
	`bs⁄_buûdî_îr‹
–
bs⁄
 *
b
 );

1152 
MONGO_EXPORT
 
	`bs⁄_öt64_to_doubÀ
–
öt64_t
 
i64
 );

1154 
MONGO_EXPORT
 
	`bs⁄_sw≠_ídün32
–*
ouç
, c⁄° *
öp
 );

1155 
MONGO_EXPORT
 
	`bs⁄_sw≠_ídün64
–*
ouç
, c⁄° *
öp
 );

1157 
MONGO_EXTERN_C_END


	@cfg.h

2 #i‚de‡
__INDEP_CFG_H


3 
	#__INDEP_CFG_H


	)

5 
	#TYPE_INT
 0

	)

6 
	#TYPE_STRING
 1

	)

8 
	#PARM_OPT
 0

	)

9 
	#PARM_MAND
 1

	)

11 
	#MAX_STRING_LEN
 1024

	)

12 
	#STR_BUFF_LEN
 256

	)

14 
	#FULL_PATH_LEN
 64

	)

20 
	scfg_löe


22 *
	m∑ømëî
;

23 *
	mv¨übÀ
;

24 (*
	mfun˘i⁄
)();

25 
	mty≥
;

26 
	mm™d©‹y
;

27 
	mmö
;

28 
	mmax
;

32 
	schk∂ugs_°rsdef


34 
	mp‹t
;

35 *
	mcmdlöe
;

36 (*
	mfun˘i⁄
)();

37 *
	m∑øm
;

38 
	mok_loc
;

42 
∑r£_cfg_fûe
(*
cfg_fûe
,
cfg_löe
 *
cfg
);

43 
öô_c⁄fig
();

45 #i‚de‡
HAVE_GETOPT_LONG


46 
	s›ti⁄
 {

47 c⁄° *
	m«me
;

48 
	mhas_¨g
;

49 *
	mÊag
;

50 
	mvÆ
;

52 
	#gë›t_l⁄g
(
¨gc
, 
¨gv
, 
›t°rög
, 
l⁄g›ts
, 
l⁄gödex
Ë
	`gë›t
◊rgc,árgv, o±°rög)

	)

	@common.h

2 
	~<sys/ty≥s.h
>

4 #i‚de‡
GëTTR_COMMON_H


5 
	#GëTTR_COMMON_H


	)

7 
	#MAX32NUM
 4294967295LL

	)

8 
	#MAX32LL
 4294967296LL

	)

9 
	#MAX64LL
 18446744073709551615LL

	)

11 
	#MAX32
 0xFFFFFFFF

	)

16 
	#PREVIOUS_OP
 (-1)

	)

20 
	sS≥cülTokí


22 *
	m«me
;

23 
	mvÆue
;

28 *
	md©a
;

29 
	mÀn
;

30 } 
	tReque°D©a
;

33 
	#À≠_yór
(
yr
Ë((yrË<1752 ? !((yrË% 4Ë: (!((yrË% 4Ë&& ((yrË% 100)Ë|| !((yrË% 400))

	)

36 
	#˚¡urõs_sö˚_1700
(
yr
) \

37 ((
yr
Ë> 1700 ? (yrË/ 100 - 17 : 0)

	)

40 
	#quad_˚¡urõs_sö˚_1700
(
yr
) \

41 ((
yr
Ë> 1600 ? ((yrË- 1600Ë/ 400 : 0)

	)

44 
	#À≠_yórs_sö˚_yór_1
(
yr
) \

45 ((
yr
Ë/ 4 - 
	`˚¡urõs_sö˚_1700
(yrË+ 
	`quad_˚¡urõs_sö˚_1700
(yr))

	)

50 
	#TINYBUF
 128

	)

52 
	#SUCCESS
 0

	)

54 
	#FAIL
 (-1)

	)

56 
	#NOTSUPPORTED
 (-2)

	)

57 
	#NETWORK_ERROR
 (-3)

	)

58 
	#TIMEOUT_ERROR
 (-4)

	)

59 
	#AGENT_ERROR
 (-5)

	)

60 
	#NOSUCHMIB
 (-6)

	)

62 
	#MAX_BUF_LEN
 65000

	)

64 
	#MAX_QUERY_LEN
 4096

	)

65 
	#MAX_STRING_LEN
 
MAX_QUERY_LEN


	)

66 
	#SQL_DOWN
 1

	)

67 
	#MAX_COMMUNITY_LEN
 50

	)

68 
	#MAX_SQL_SOCKS
 256

	)

69 
	#MAX_TABLE_LEN
 20

	)

70 
	#MAX_STR_LEN
 1024

	)

71 
	#MIN_STR_LEN
 16

	)

72 
	#STRING_LEN
 128

	)

74 
	#QUERY_WAIT
 10000

	)

77 
	#°rs˝y
(
x
,
y
Ë{ 
	`°∫˝y
(x,y,(x)); x[(x)-1]=0; }

	)

79 
	sC⁄ãxt_Löe


81 
	mlöíumbî
;

83 *
	mc⁄ã¡
;

84 
C⁄ãxt_Löe
 *
	m√xt
;

85 
C⁄ãxt_Löe
 *
	m¥ev
;

86 } 
	tc⁄ãxt_löe
;

88 
	sSÁ_Sèã


90 
	mlöíumbî
;

92 
	m‹dî
;

94 *
	mc⁄ã¡
;

95 
SÁ_Sèã
 *
	m√xt
, *
	m¥ev
;

96 } 
	tsÁ_°©e
;

98 
	sDumpD©a


100 
	mty≥
;

101 
	mªcovî
;

102 
	md©e
;

103 
	mSh¨eName
;

104 
	m°¨t
, 
	míd
, 
	mœ°
;

105 } 
	tDump_D©a
;

107 
	#NORECOV
 1<<0

	)

108 
	#FORWARD
 1<<1

	)

109 
	#BACKWARD
 1<<2

	)

111 
	#SHDAY
 1<<5

	)

112 
	#SZDAY
 1<<6

	)

113 
	#SHMIN
 1<<7

	)

114 
	#SZMIN
 1<<8

	)

116 
	sDZH


119 
	md©e
;

121 
	m›í
;

123 
	mhigh
;

125 
	mlow
;

127 
	mídp
;

129 
	mvﬁumn
;

131 
	mamou¡
;

133 
	ma
;

135 
	mb
;

137 
	mc
;

139 } 
	tdzh
;

141 
	sSha£_Day_Hódî


144 
	mmagic
[6];

145 
	mªc‹ds
;

146 
	m°¨t
;

147 
	mÀngth
;

148 
	mcﬁ
;

150 } 
	tSha£DayHódî
;

152 
	sIndex_Desc


155 
	mÀngth
;

156 
	mRecCﬁ
;

158 
	mC⁄ã¡Sèπ
;

161 } 
	tIndexDesc
;

163 
	sProfô_Index_Desc


166 
	mty≥
;

167 
	m«me
[9];

168 
	m•a˚
;

169 
	m‹dî
;

170 
	mcﬁ
;

172 } 
	tProfôIndexDesc
;

174 
	sTTR_Des¸ùt


177 
	m›í‹
, 
	mhigh‹
, 
	mlow‹
, 
	míd‹
;

178 
	md©e
;

179 
	mvﬁumn
, 
	mamou¡
;

181 
TTR_Des¸ùt
 *
	m¥ev
, *
	m√xt
;

183 } 
	tTTRdesc
;

185 
	sTTR_Profô


188 
	md©e
;

190 
	mty≥
;

191 
	mba£
;

192 
	mdiv
;

193 
	msub
;

194 
	møã
;

195 
	m¥i˚
;

197 
TTR_Profô
 *
	m¥ev
, *
	m√xt
;

198 } 
	tTProfô
;

200 
	sProfô_Sèã_M


202 
	m¥ev°©e
;

203 
	m√xt°©e
;

204 *
	msm«me
;

205 
	msmassign
;

207 } 
	tProfôSèãM
;

226 
	#Sha£HódîLí
 0x10

	)

227 
	#ProfôHódîLí
 (
IndexDesc
)

	)

228 
	#ProfôIndexLí
 0x12

	)

230 
	#Rec‹dLí
 (
dzh
)

	)

232 
	#BeInô
 1<<0

	)

233 
	#BeSèπ
 1<<1

	)

234 
	#BeC⁄t
 1<<2

	)

235 
	#BeC⁄tPri˚
 1<<3

	)

236 
	#BeFö
 1<<4

	)

237 
	#BeTí
 1<<5

	)

238 
	#BeNum
 1<<6

	)

239 
	#BeEnd
 1<<8

	)

241 
	#P·H⁄gli
 1<<0

	)

242 
	#P·H⁄gGu
 1<<1

	)

243 
	#P·Peigu
 1<<2

	)

244 
	#P·PeiguP
 1<<3

	)

245 
	#P·Ba£
 1<<4

	)

247 
	#P·NŸhög
 1<<6

	)

249 
	#DATELEN
 10

	)

250 
	#P·Ba£Mít
 10

	)

252 
	#CNUM
 7

	)

254 
	#DIM
(
x
Ë((x)/(x[0]))

	)

256 
	#ISPRINT
(
c
Ë(
	`ißscii
 (cË&& 
	`i•röt
 (c))

	)

257 
	#ISDIGIT
(
c
Ë(
	`ißscii
 (cË&& 
	`isdigô
 (c))

	)

258 
	#ISALNUM
(
c
Ë(
	`ißscii
 (cË&& 
	`iß um
 (c))

	)

259 
	#ISALPHA
(
c
Ë(
	`ißscii
 (cË&& 
	`ißÕha
 (c))

	)

260 
	#ISCNTRL
(
c
Ë(
	`ißscii
 (cË&& 
	`is˙ål
 (c))

	)

261 
	#ISLOWER
(
c
Ë(
	`ißscii
 (cË&& 
	`i¶owî
 (c))

	)

262 
	#ISPUNCT
(
c
Ë(
	`ißscii
 (cË&& 
	`i•un˘
 (c))

	)

263 
	#ISSPACE
(
c
Ë(
	`ißscii
 (cË&& 
	`is•a˚
 (c))

	)

264 
	#ISUPPER
(
c
Ë(
	`ißscii
 (cË&& 
	`isuµî
 (c))

	)

265 
	#ISXDIGIT
(
c
Ë(
	`ißscii
 (cË&& 
	`isxdigô
 (c))

	)

267 
	#OPT_DIFF
 1

	)

268 
	#OPT_SETSTART
 1<<1

	)

269 
	#OPT_SETEND
 1<<2

	)

270 
	#OPT_REWARD
 1<<3

	)

271 
	#OPT_SUMMARY
 1<<4

	)

272 
	#OPT_PERIOD
 1<<5

	)

274 
	#OPT_RATE
 1<<6

	)

275 
	#OPT_AMOUNT
 1<<7

	)

277 
	#OPT_REFERENCE
 1<<8

	)

279 
	#OPT_FILES
 1<<9

	)

280 
	#OPT_DATES
 1<<10

	)

281 
	#OPT_PROFIT
 1<<11

	)

283 
	sCONFOPT


285 *
	mSëSåög
;

286 
	mty≥
;

287 
	m›t
;

289 } 
	tC⁄fO±
;

291 
c⁄ãxt_löe
 
	tLi°4Fûes
;

293 
	sSh¨eHﬁd_Sèã


295 *
	mSåName
;

296 
	m‹dî
;

297 } 
	tSh¨eHﬁdSèã
;

	@diffSelect.c

19 
	~"Rm⁄go.h
"

20 
	~"M⁄goQuîy.h
"

21 
	~"lz4.h
"

22 
	~"lz4hc.h
"

23 
	~<°rög.h
>

25 
	#DNUM
 12

	)

27 
	$£tDim
(
SEXP
 
ªsu…
, 
nCﬁ
, 
nRow
)

29 
ªtvÆ
 = 0;

30 
SEXP
 
dims
;

32 
	`PROTECT
(
dims
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

34 
	`INTEGER
(
dims
)[0] = 
nCﬁ
;

35 
	`INTEGER
(
dims
)[1] = 
nRow
;

37 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dims
);

38 
	`UNPROTECT
(1);

40  (
ªtvÆ
);

42 
	}
}

44 
	$£tDimName
(
SEXP
 
ªsu…
)

46 
ªtvÆ
 = 0;

47 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

48 
p
;

50 
p
 = 0;

52 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

53 
p
++;

54 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
DNUM
));

55 
p
++;

57 
	`SET_VECTOR_ELT
(
d«mes
, 0, 
	`mkCh¨
("seq"));

58 
	`SET_VECTOR_ELT
(
d«mes
, 1, 
	`mkCh¨
("stk"));

59 
	`SET_VECTOR_ELT
(
d«mes
, 2, 
	`mkCh¨
("t"));

60 
	`SET_VECTOR_ELT
(
d«mes
, 3, 
	`mkCh¨
("td"));

61 
	`SET_VECTOR_ELT
(
d«mes
, 4, 
	`mkCh¨
("amDiff"));

62 
	`SET_VECTOR_ELT
(
d«mes
, 5, 
	`mkCh¨
("SumBid"));

63 
	`SET_VECTOR_ELT
(
d«mes
, 6, 
	`mkCh¨
("SumAsk"));

64 
	`SET_VECTOR_ELT
(
d«mes
, 7, 
	`mkCh¨
("initB"));

65 
	`SET_VECTOR_ELT
(
d«mes
, 8, 
	`mkCh¨
("passO"));

66 
	`SET_VECTOR_ELT
(
d«mes
, 9, 
	`mkCh¨
("bInc"));

67 
	`SET_VECTOR_ELT
(
d«mes
, 10, 
	`mkCh¨
("oInc"));

68 
	`SET_VECTOR_ELT
(
d«mes
, 11, 
	`mkCh¨
("avP"));

70 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
d«mes
);

71 
∫ames
 = 
R_NûVÆue
;

72 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
∫ames
);

73 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

75 
	`UNPROTECT
(
p
);

77  (
ªtvÆ
);

79 
	}
}

81 
	$£tRTDimName
(
SEXP
 
ªsu…
)

84 
ªtvÆ
 = 0;

85 
SEXP
 
dimNames
, 
d«mes
, 
∫ames
;

86 
p
, 
n
;

88 
p
 = 
n
 = 0;

90 
	`PROTECT
(
dimNames
 = 
	`ÆlocVe˘‹
(
VECSXP
, 2));

91 
p
++;

92 
	`PROTECT
(
d«mes
 = 
	`ÆlocVe˘‹
(
VECSXP
, 
EMPTYROWS
));

93 
p
++;

95 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("_id"));

96 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("stk"));

97 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("to"));

98 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("yc"));

99 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("nw"));

100 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("hi"));

101 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("lo"));

102 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("nwb"));

103 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("nwo"));

104 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("vl"));

105 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("am"));

106 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b1v"));

107 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b1p"));

108 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b2v"));

109 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b2p"));

110 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b3v"));

111 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b3p"));

112 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b4v"));

113 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b4p"));

114 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b5v"));

115 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("b5p"));

116 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o1v"));

117 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o1p"));

118 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o2v"));

119 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o2p"));

120 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o3v"));

121 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o3p"));

122 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o4v"));

123 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o4p"));

124 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o5v"));

125 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("o5p"));

126 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("d"));

127 
	`SET_VECTOR_ELT
(
d«mes
, 
n
++, 
	`mkCh¨
("t"));

129 
	`SET_VECTOR_ELT
(
dimNames
, 0, 
d«mes
);

130 
∫ames
 = 
R_NûVÆue
;

131 
	`SET_VECTOR_ELT
(
dimNames
, 1, 
∫ames
);

132 
	`£tAârib
(
ªsu…
, 
R_DimNamesSymbﬁ
, 
dimNames
);

134 
	`UNPROTECT
(
p
);

136  (
ªtvÆ
);

137 
	}
}

139 
	$diffTime
(
cuº
, 
√xt
)

141 
H
, 
M
, 
S
;

143 
H
 = 
	`åunc
(
cuº
 / 10000Ë-Årunc(
√xt
 / 10000);

144 
M
 = 
	`åunc
((
cuº
 - (trunc(curr / 10000) * 10000)) / 100)

145 - 
	`åunc
((
√xt
 - (trunc(next / 10000) * 10000)) / 100);

146 
S
 = (
cuº
 - 
	`åunc
(curr / 100) * 100)

147 - (
√xt
 - 
	`åunc
(next / 100) * 100);

149 
S
 < 0) {

150 
S
 += 60;

151 
M
 -= 1;

153 
M
 < 0) {

154 
M
 += 60;

155 
H
 -= 1;

158  (
H
 * 3600 + 
M
 * 60 + 
S
);

160 
	}
}

162 
	$diffVÆue
(*
d°
, *
ds1
, *
ds2
)

165 
i
, 
j
, 
ªtvÆ
 = 0;

166 
avPri˚
, 
amDiff
, 
vDiff
;

168 *(
d°
 + 4Ë
amDiff
 = 
ds1
[10] - 
ds2
[10];

169 
vDiff
 = 
ds1
[9] - 
ds2
[9];

171 i‡(
vDiff
 != 0) {

172 
avPri˚
 = 
amDiff
 / 
vDiff
;

174 
i
 = 0; i <= 8; i += 2) {

175 *(
d°
 + 6Ë+
ds1
[21 + 
i
] * ds1[22 + i];

176 *(
d°
 + 5Ë+
ds1
[11 + 
i
] * ds1[12 + i];

179 
i
 = 0; i <= 8; i += 2) {

180 
j
 = 0; j <= 8; j += 2) {

181 i‡(
ds1
[22 + 
i
] =
ds2
[22 + 
j
]) {

182 *(
d°
 + 10Ë+(
ds1
[21 + 
i
] - 
ds2
[21 + 
j
]) * ds2[22 + j];

188 
i
 = 0; i <= 8; i += 2) {

189 
j
 = 0; j <= 8; j += 2) {

190 i‡(
ds1
[12 + 
i
] =
ds2
[12 + 
j
]) {

191 *(
d°
 + 9Ë+(
ds1
[11 + 
i
] - 
ds2
[11 + 
j
]) * ds2[12 + j];

196 *(
d°
 + 11Ë
avPri˚
;

198 i‡(
avPri˚
 >*(
ds2
 + 22)) {;

200 } i‡(
avPri˚
 <*(
ds2
 + 12)) {;

203 } i‡((
avPri˚
 > 
ds2
[12]) && (avPrice < ds2[22])) {

205 *(
d°
 + 7Ë(
amDiff
 - 
vDiff
 * 
ds2
[12])

206 / 
	`round
((
ds2
[22] - ds2[12]) * 100) * ds2[22] * 100;

208 *(
d°
 + 8Ë(
amDiff
 - 
vDiff
 * 
ds2
[22])

209 / 
	`round
((
ds2
[12] - ds2[22]) * 100) * ds2[12] * 100;

215  (
ªtvÆ
);

217 
	}
}

219 
	$d£À˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

221 
ªtvÆ
 = 0;

222 *
x±r
;

223 
i
, 
j
;

224 
p
 = 0;

227 
ªtvÆ
 = 
	`quîyRu¬ög
(
¨gs
, 
gp
);

229 i‡(
gp
->
nCﬁs
 == 0) {

230 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
DNUM
));

231 
p
++;

232 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

233 
	`mem£t
(
x±r
, 
NA_REAL
, (Ë* 
DNUM
);

234 
	`UNPROTECT
(
p
);

236 } i‡((
gp
->
£tSètus
 & 
£tCﬁs
) != 0) {

237 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
DNUM
 * (gp->
nRows
 - 1)));

238 
p
++;

239 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

240 
	`mem£t
(
x±r
, 0x0, (Ë* 
DNUM
 * (
gp
->
nRows
 - 1));

241 
gp
->
qVcuº
 = gp->
qVli°
;

242 
i
 = 0;

244 i‡(
gp
->
qVcuº
 =
NULL
)

246 
gp
->
qVcuº
->
√xt
 !
NULL
) {

247 *(
x±r
Ë++
i
;

248 *(
x±r
 + 1Ë*(
gp
->
qVcuº
->
v
 + 1);

249 *(
x±r
 + 2Ë*(
gp
->
qVcuº
->
v
 + 32);

250 *(
x±r
 + 3Ë
	`diffTime
(*(
gp
->
qVcuº
->
v
 + 32), *(gp->qVcuº->
√xt
->v + 32));

251 i‡(*(
x±r
 + 3) > 30)

252 *(
x±r
 + 3Ë
NA_REAL
;

254 
	`diffVÆue
(
x±r
, 
gp
->
qVcuº
->
v
, gp->qVcuº->
√xt
->v);

256 
x±r
 = x±∏+ 
DNUM
;

257 
gp
->
qVcuº
 = gp->qVcuº->
√xt
;

261 
	`UNPROTECT
(
p
);

264 
	`‰ìQvLi°
(
gp
->
qVli°
);

266 
	`£tDim
(
gp
->
ªsu…
, 
DNUM
, (gp->
nRows
 < 2) ? 1 : (gp->nRows - 1));

267 
	`£tDimName
(
gp
->
ªsu…
);

270  (
ªtvÆ
);

271 
	}
}

273 
	$zñe˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

276 
ªtvÆ
;

277 *
x±r
;

278 
SEXP
 
dims
, 
dimNames
, 
∫ames
;

280 
outSize
, 
öSize
;

281 *
out_buff
;

283 
i
;

285 
gridfs
 
gfs
[1];

286 
gridfûe
 
gfûe
[1];

288 
gp
->
£tSètus
 |
£tGridfs
;

289 
gp
->
gridFûeName
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

291 
ªtvÆ
 = 
	`quîyRu¬ög
(
¨gs
, 
gp
);

292 
gp
->
nCﬁs
 = 
EMPTYROWS
;

294 i‡(
gp
->
nCﬁs
 == 0) {

295 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
EMPTYROWS
));

296 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

297 
	`mem£t
(
x±r
, 
NA_REAL
, (Ë* 
EMPTYROWS
);

298 
gp
->
nRows
 = 1;

299 
öSize
 = (Ë* 
EMPTYROWS
;

302 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, gp->
nCﬁs
 * gp->
nRows
));

303 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

304 
gp
->
qVcuº
 = gp->
qVli°
;

306 
gp
->
qVcuº
 !
NULL
) {

307 
	`mem˝y
(
x±r
, 
gp
->
qVcuº
->
v
, (Ë* gp->
nCﬁs
);

309 
x±r
 = x±∏+ 
gp
->
nCﬁs
;

310 
gp
->
qVcuº
 = gp->qVcuº->
√xt
;

313 
öSize
 = (Ë* 
gp
->
nCﬁs
 * gp->
nRows
;

316 
out_buff
 = 
	`CÆloc
(
CHUNKSIZE
, );

318 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

319 
outSize
 = 
	`LZ4_com¥ess
((*)
x±r
, 
out_buff
 + 
MöiHódSize
, 
öSize
);

321 
	`mem˝y
(
out_buff
, &
outSize
, ());

322 
	`mem˝y
(
out_buff
 + (), &
öSize
, ());

323 
	`mem˝y
(
out_buff
 + (Ë* 2, &
gp
->
nRows
, ());

325 
	`gridfs_öô
(
gp
->
c⁄n
, "h·", "fs", 
gfs
);

326 
	`gridfs_°‹e_buf„r
(
gfs
, 
out_buff
, 
outSize
 + 
MöiHódSize
, 
gp
->
gridFûeName
, "lz4bö¨y",
GRIDFILE_DEFAULT
);

327 
	`gridfs_de°roy
(
gfs
);

329 
	`‰ì
(
out_buff
);

331 
	`UNPROTECT
(1);

332 
	`‰ìQvLi°
(
gp
->
qVli°
);

334 
	`£tDim
(
gp
->
ªsu…
, gp->
nCﬁs
, (gp->
nRows
 < 2) ? 1 : (gp->nRows));

335 
	`£tRTDimName
(
gp
->
ªsu…
);

337 i‡((
gp
->
£tSètus
 & 
£tGridfs
) != 0) {

338 
	`‰ì
(
gp
->
gridFûeName
);

341  (
ªtvÆ
);

343 
	}
}

345 
	$xñe˘_cmd
(
MgPx_¨gli°
 * 
¨gs
, 
m⁄goP¨am
 * 
gp
)

347 
ªtvÆ
;

348 *
x±r
;

349 
SEXP
 
dims
, 
dimNames
, 
∫ames
;

351 
outSize
=0, 
öSize
=0;

352 *
out_buff
;

354 
gridfs
 
gfs
[1];

355 
gridfûe
 
gfûe
[1];

357 
gp
->
£tSètus
 |
£tGridfs
;

358 
gp
->
£tSètus
 |
£tNoBQ
;

360 
gp
->
gridFûeName
 = 
	`CÆloc
(
STR_BUFF_LEN
, );

362 
ªtvÆ
 = 
	`quîyRu¬ög
(
¨gs
, 
gp
);

364 
out_buff
 = 
	`CÆloc
(
CHUNKSIZE
, );

365 
gp
->
£tSètus
 &~
£tgfûe
;

366 
gp
->
£tSètus
 &~
£tgfs
;

368 
ªtvÆ
 = -1;

370 
	`gridfs_öô
(
gp
->
c⁄n
, "h·", "fs", 
gfs
);

371 
gp
->
£tSètus
 |
£tgfs
;

375 i‡((
ªtvÆ
 = 
	`gridfs_föd_fûíame
(
gfs
, 
gp
->
gridFûeName
, 
gfûe
)Ë!
MONGO_OK
 ) {

376 
gp
->
£tSètus
 &~
£tgfûe
;

379 
gp
->
£tSètus
 |
£tgfûe
;

381 i‡(!
	`gridfûe_exi°s
(
gfûe
)) {

382 
öSize
 = 
MöiHódSize
 * 
DNUM
;

383 
gp
->
£tSètus
 &~
£tgfûe
;

387 
ªtvÆ
 = 
	`gridfûe_ªad_buf„r
(
gfûe
, 
out_buff
, 
CHUNKSIZE
);

389 i‡(
ªtvÆ
 < () * 4) {

390 
öSize
 = 
MöiHódSize
 * 
DNUM
;

394 
	`mem˝y
(&
öSize
, 
out_buff
, ());

395 i‡(
öSize
 > 
CHUNKSIZE
)

398 
	`mem˝y
(&
outSize
, 
out_buff
 + (), ());

399 
	`mem˝y
(&
gp
->
nRows
, 
out_buff
 + () * 2, ());

401 
gp
->
nCﬁs
 = 
EMPTYROWS
;

407 i‡–(
gp
->
£tSètus
 & 
£tgfûe
 ) != 0 )

408 
	`gridfûe_de°roy
(
gfûe
);

410 i‡((
gp
->
£tSètus
 & 
£tgfs
) != 0 )

411 
	`gridfs_de°roy
(
gfs
);

413 i‡(
ªtvÆ
 !(
öSize
 + 
MöiHódSize
)) {

415 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, 
EMPTYROWS
));

416 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

417 
	`mem£t
(
x±r
, 
NA_REAL
, (Ë* 
EMPTYROWS
);

418 
gp
->
nRows
 = 1;

419 
gp
->
nCﬁs
 = 
EMPTYROWS
;

423 
	`PROTECT
(
gp
->
ªsu…
 = 
	`ÆlocVe˘‹
(
REALSXP
, gp->
nCﬁs
 * gp->
nRows
));

424 
x±r
 = 
	`NUMERIC_POINTER
(
gp
->
ªsu…
);

425 
gp
->
qVcuº
 = gp->
qVli°
;

427 
ªtvÆ
 = 
	`LZ4_uncom¥ess_unknownOuçutSize
((*)
out_buff
 + 
MöiHódSize
, (*)
x±r
, 
öSize
, 
outSize
);

429 i‡(
ªtvÆ
 < 0)

430 
	`ndebug
("uncom¥es†îr‹ %d from zù≥d %dÅ¨gë %d gfûê%†\n", 
ªtvÆ
, 
öSize
, 
outSize
, 
gp
->
gridFûeName
);

434 
	`‰ì
(
out_buff
);

436 
	`£tDim
(
gp
->
ªsu…
, gp->
nCﬁs
, (gp->
nRows
 < 2) ? 1 : (gp->nRows));

437 
	`£tRTDimName
(
gp
->
ªsu…
);

439 
	`UNPROTECT
(1);

440 
	`‰ìQvLi°
(
gp
->
qVli°
);

442 i‡((
gp
->
£tSètus
 & 
£tGridfs
) != 0) {

443 
	`‰ì
(
gp
->
gridFûeName
);

444 
gp
->
£tSètus
 &~
£tGridfs
;

447 
gp
->
£tSètus
 &~
£tgfûe
;

448 
gp
->
£tSètus
 &~
£tgfs
;

450  (
ªtvÆ
);

452 
	}
}

	@encoding.c

40 
	~"bs⁄.h
"

41 
	~"ícodög.h
"

47 c⁄° 
	gåaûögByãsF‹UTF8
[256] = {

70 
	$isLegÆUTF8
–c⁄° *
sour˚
, 
Àngth
 ) {

71 
a
;

72 c⁄° *
§˝å
 = 
sour˚
 + 
Àngth
;

73  
Àngth
 ) {

78 i‡––
a
 = ( *--
§˝å
 ) ) < 0x80 ||á > 0xBF )  0;

80 i‡––
a
 = ( *--
§˝å
 ) ) < 0x80 ||á > 0xBF )  0;

82 i‡––
a
 = ( *--
§˝å
 ) ) > 0xBF )  0;

83  *
sour˚
 ) {

86 i‡–
a
 < 0xA0 )  0;

89 i‡–
a
 < 0x90 )  0;

92 i‡–
a
 > 0x8F )  0;

95 i‡–
a
 < 0x80 )  0;

98 i‡–*
sour˚
 >= 0x80 && *source < 0xC2 )  0;

99 i‡–*
sour˚
 > 0xF4 )  0;

102 
	}
}

105 
	$bs⁄_°rög_is_db_ªf
–c⁄° *
°rög
, c⁄° 
size_t
 
Àngth
 ) {

106 
ªsu…
 = 0;

108 if–
Àngth
 >= 4 ) {

109 if–
°rög
[1] == 'r' && string[2] == 'e' && string[3] == 'f' )

110 
ªsu…
 = 1;

112 if–
Àngth
 >= 3 ) {

113 if–
°rög
[1] == 'i' && string[2] == 'd' )

114 
ªsu…
 = 1;

115 if–
°rög
[1] == 'd' && string[2] == 'b' )

116 
ªsu…
 = 1;

119  
ªsu…
;

120 
	}
}

122 
	$bs⁄_vÆid©e_°rög
–
bs⁄
 *
b
, c⁄° *
°rög
,

123 c⁄° 
size_t
 
Àngth
, c⁄° 
check_utf8
, c⁄° 
check_dŸ
,

124 c⁄° 
check_dﬁœr
 ) {

126 
size_t
 
posôi⁄
 = 0;

127 
£quí˚_Àngth
 = 1;

129 if–
check_dﬁœr
 && 
°rög
[0] == '$' ) {

130 if–!
	`bs⁄_°rög_is_db_ªf
–
°rög
, 
Àngth
 ) )

131 
b
->
îr
 |
BSON_FIELD_INIT_DOLLAR
;

134  
posôi⁄
 < 
Àngth
 ) {

135 i‡–
check_dŸ
 && *–
°rög
 + 
posôi⁄
 ) == '.' ) {

136 
b
->
îr
 |
BSON_FIELD_HAS_DOT
;

139 i‡–
check_utf8
 ) {

140 
£quí˚_Àngth
 = 
åaûögByãsF‹UTF8
[*–
°rög
 + 
posôi⁄
 )] + 1;

141 i‡––
posôi⁄
 + 
£quí˚_Àngth
 ) > 
Àngth
 ) {

142 
b
->
îr
 |
BSON_NOT_UTF8
;

143  
BSON_ERROR
;

145 i‡–!
	`isLegÆUTF8
–
°rög
 + 
posôi⁄
, 
£quí˚_Àngth
 ) ) {

146 
b
->
îr
 |
BSON_NOT_UTF8
;

147  
BSON_ERROR
;

150 
posôi⁄
 +
£quí˚_Àngth
;

153  
BSON_OK
;

154 
	}
}

157 
	$bs⁄_check_°rög
–
bs⁄
 *
b
, c⁄° *
°rög
,

158 c⁄° 
size_t
 
Àngth
 ) {

160  
	`bs⁄_vÆid©e_°rög
–
b
, ( c⁄° * )
°rög
, 
Àngth
, 1, 0, 0 );

161 
	}
}

163 
	$bs⁄_check_fõld_«me
–
bs⁄
 *
b
, c⁄° *
°rög
,

164 c⁄° 
size_t
 
Àngth
 ) {

166  
	`bs⁄_vÆid©e_°rög
–
b
, ( c⁄° * )
°rög
, 
Àngth
, 1, 1, 1 );

167 
	}
}

	@encoding.h

17 #i‚de‡
BSON_ENCODING_H_


18 
	#BSON_ENCODING_H_


	)

20 
MONGO_EXTERN_C_START


37 
bs⁄_check_fõld_«me
–
bs⁄
 *
b
, c⁄° *
°rög
,

38 c⁄° 
size_t
 
Àngth
 );

50 
bs⁄_boﬁ_t
 
bs⁄_check_°rög
–
bs⁄
 *
b
, c⁄° *
°rög
,

51 c⁄° 
size_t
 
Àngth
 );

53 
	gMONGO_EXTERN_C_END


	@env.c

1 #i‡!
deföed
(
MONGO_ENV_STANDARD
Ë&& (deföed(
_WIN32
Ë|| deföed(
_WIN64
))

21 
	~"ív.h
"

22 
	~<°rög.h
>

24 #ifde‡
_MSC_VER


25 
	~<ws2t˝ù.h
>

26 
	~<w•üpi.h
>

28 
	~<ws2t˝ù.h
>

29 
	~<wösock2.h
>

30 
	tsockÀn_t
;

33 #i‚de‡
NI_MAXSERV


34 
	#NI_MAXSERV
 32

	)

37 
	$m⁄go_ív_˛o£_sockë
–
SOCKET
 
sockë
 ) {

38  
	`˛o£sockë
–
sockë
 );

39 
	}
}

41 
	$m⁄go_ív_wrôe_sockë
–
m⁄go
 *
c⁄n
, c⁄° *
buf
, 
size_t
 
Àn
 ) {

42 c⁄° *
cbuf
 = (c⁄° *)
buf
;

43 
Êags
 = 0;

45  
Àn
 ) {

46 
size_t
 
£¡
 = 
	`£nd
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 
Êags
 );

47 i‡–
£¡
 == -1 ) {

48 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, 
NULL
, 
	`WSAGëLa°Eº‹
() );

49 
c⁄n
->
c⁄√˘ed
 = 0;

50  
MONGO_ERROR
;

52 
cbuf
 +
£¡
;

53 
Àn
 -
£¡
;

56  
MONGO_OK
;

57 
	}
}

59 
	$m⁄go_ív_ªad_sockë
–
m⁄go
 *
c⁄n
, *
buf
, 
size_t
 
Àn
 ) {

60 *
cbuf
 = (*)
buf
;

62  
Àn
 ) {

63 
size_t
 
£¡
 = 
	`ªcv
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 0 );

64 i‡–
£¡
 == 0 || sent == -1 ) {

65 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, 
NULL
, 
	`WSAGëLa°Eº‹
() );

66  
MONGO_ERROR
;

68 
cbuf
 +
£¡
;

69 
Àn
 -
£¡
;

72  
MONGO_OK
;

73 
	}
}

75 
	$m⁄go_ív_£t_sockë_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 ) {

76 i‡–
	`£tsock›t
–
c⁄n
->
sock
, 
SOL_SOCKET
, 
SO_RCVTIMEO
, (c⁄° *)&
mûlis
,

77 –
mûlis
 ) ) == -1 ) {

78 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, "setsockopt SO_RCVTIMEO failed.",

79 
	`WSAGëLa°Eº‹
() );

80  
MONGO_ERROR
;

83 i‡–
	`£tsock›t
–
c⁄n
->
sock
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, (c⁄° *)&
mûlis
,

84 –
mûlis
 ) ) == -1 ) {

85 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, "setsockopt SO_SNDTIMEO failed.",

86 
	`WSAGëLa°Eº‹
() );

87  
MONGO_ERROR
;

90  
MONGO_OK
;

91 
	}
}

93 
	$m⁄go_ív_sockë_c⁄√˘
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 ) {

94 
p‹t_°r
[
NI_MAXSERV
];

95 
îr°r
[
MONGO_ERR_LEN
];

96 
°©us
;

98 
addröfo
 
ai_höts
;

99 
addröfo
 *
ai_li°
 = 
NULL
;

100 
addröfo
 *
ai_±r
 = 
NULL
;

102 
c⁄n
->
sock
 = 0;

103 
c⁄n
->
c⁄√˘ed
 = 0;

105 
	`bs⁄_•rötf
–
p‹t_°r
, "%d", 
p‹t
 );

107 
	`mem£t
–&
ai_höts
, 0, (ái_hints ) );

108 
ai_höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

109 
ai_höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

110 
ai_höts
.
ai_¥Ÿocﬁ
 = 
IPPROTO_TCP
;

112 
°©us
 = 
	`gëaddröfo
–
ho°
, 
p‹t_°r
, &
ai_höts
, &
ai_li°
 );

113 i‡–
°©us
 != 0 ) {

114 
	`bs⁄_•rötf
–
îr°r
, "gëaddröfÿÁûed wôhÉº‹ %d", 
°©us
 );

115 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_CONN_ADDR_FAIL
, 
îr°r
, 
	`WSAGëLa°Eº‹
() );

116  
MONGO_ERROR
;

119  
ai_±r
 = 
ai_li°
;ái_±∏!
NULL
;ái_±∏ai_±r->
ai_√xt
 ) {

120 
c⁄n
->
sock
 = 
	`sockë
–
ai_±r
->
ai_Ámûy
,ái_±r->
ai_sockty≥
,

121 
ai_±r
->
ai_¥Ÿocﬁ
 );

123 i‡–
c⁄n
->
sock
 =
INVALID_SOCKET
 ) {

124 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_SOCKET_ERROR
, "socket() failed",

125 
	`WSAGëLa°Eº‹
() );

126 
c⁄n
->
sock
 = 0;

130 
°©us
 = 
	`c⁄√˘
–
c⁄n
->
sock
, 
ai_±r
->
ai_addr
,ái_±r->
ai_addæí
 );

131 i‡–
°©us
 != 0 ) {

132 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_SOCKET_ERROR
, "connect() failed",

133 
	`WSAGëLa°Eº‹
() );

134 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

135 
c⁄n
->
sock
 = 0;

139 i‡–
ai_±r
->
ai_¥Ÿocﬁ
 =
IPPROTO_TCP
 ) {

140 
Êag
 = 1;

142 
	`£tsock›t
–
c⁄n
->
sock
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

143 –c⁄° * ) &
Êag
, ( flag ) );

145 i‡–
c⁄n
->
›_timeout_ms
 > 0 )

146 
	`m⁄go_ív_£t_sockë_›_timeout
–
c⁄n
, c⁄n->
›_timeout_ms
 );

149 
c⁄n
->
c⁄√˘ed
 = 1;

153 
	`‰ìaddröfo
–
ai_li°
 );

155 i‡–! 
c⁄n
->
c⁄√˘ed
 ) {

156 
c⁄n
->
îr
 = 
MONGO_CONN_FAIL
;

157  
MONGO_ERROR
;

160 
	`m⁄go_˛ór_îr‹s
–
c⁄n
 );

161  
MONGO_OK
;

163 
	}
}

165 
MONGO_EXPORT
 
	$m⁄go_ív_sock_öô
( ) {

167 
WSADATA
 
wßD©a
;

168 
WORD
 
wVîs
;

169 
ˇŒed_⁄˚
;

170 
ªtvÆ
;

172 i‡(
ˇŒed_⁄˚
Ë 
ªtvÆ
;

174 
ˇŒed_⁄˚
 = 1;

175 
wVîs
 = 
	`MAKEWORD
(1, 1);

176 
ªtvÆ
 = (
	`WSASèπup
(
wVîs
, &
wßD©a
) == 0);

178  
ªtvÆ
;

179 
	}
}

182 #ñi‡!
deföed
(
MONGO_ENV_STANDARD
Ë&& (deföed(
__APPLE__
Ë|| deföed(
__löux
Ë|| deföed(
__unix
Ë|| deföed(
__posix
))

202 
	~"ív.h
"

203 
	~<°rög.h
>

204 
	~<î∫o.h
>

205 
	~<sys/time.h
>

206 
	~<¨∑/öë.h
>

207 
	~<sys/ty≥s.h
>

208 
	~<sys/sockë.h
>

209 
	~<sys/un.h
>

210 
	~<√tdb.h
>

211 
	~<√töë/ö.h
>

212 
	~<√töë/t˝.h
>

213 
	~<f˙é.h
>

214 
	~<uni°d.h
>

216 #i‚de‡
NI_MAXSERV


217 
	#NI_MAXSERV
 32

	)

220 
	$m⁄go_ív_˛o£_sockë
–
SOCKET
 
sockë
 ) {

221  
	`˛o£
–
sockë
 );

222 
	}
}

224 
	$m⁄go_ív_sock_öô
( ) {

226 
	}
}

228 
	$m⁄go_ív_wrôe_sockë
–
m⁄go
 *
c⁄n
, c⁄° *
buf
, 
size_t
 
Àn
 ) {

229 c⁄° *
cbuf
 = 
buf
;

230 #ifde‡
__APPLE__


231 
Êags
 = 0;

233 
Êags
 = 
MSG_NOSIGNAL
;

236  
Àn
 ) {

237 
size_t
 
£¡
 = 
	`£nd
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 
Êags
 );

238 i‡–
£¡
 == -1 ) {

239 i‡(
î∫o
 =
EPIPE
)

240 
c⁄n
->
c⁄√˘ed
 = 0;

241 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, 
	`°ªº‹
–
î∫o
 ),Érrno );

242  
MONGO_ERROR
;

244 
cbuf
 +
£¡
;

245 
Àn
 -
£¡
;

248  
MONGO_OK
;

249 
	}
}

251 
	$m⁄go_ív_ªad_sockë
–
m⁄go
 *
c⁄n
, *
buf
, 
size_t
 
Àn
 ) {

252 *
cbuf
 = 
buf
;

253  
Àn
 ) {

254 
size_t
 
£¡
 = 
	`ªcv
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 0 );

255 i‡–
£¡
 == 0 || sent == -1 ) {

256 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, 
	`°ªº‹
–
î∫o
 ),Érrno );

257  
MONGO_ERROR
;

259 
cbuf
 +
£¡
;

260 
Àn
 -
£¡
;

263  
MONGO_OK
;

264 
	}
}

266 
	$m⁄go_ív_£t_sockë_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 ) {

267 
timevÆ
 
tv
;

268 
tv
.
tv_£c
 = 
mûlis
 / 1000;

269 
tv
.
tv_u£c
 = ( 
mûlis
 % 1000 ) * 1000;

271 i‡–
	`£tsock›t
–
c⁄n
->
sock
, 
SOL_SOCKET
, 
SO_RCVTIMEO
, &
tv
, (Åv ) ) == -1 ) {

272 
c⁄n
->
îr
 = 
MONGO_IO_ERROR
;

273 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, "£tsock›àSO_RCVTIMEO faûed.", 
î∫o
 );

274  
MONGO_ERROR
;

277 i‡–
	`£tsock›t
–
c⁄n
->
sock
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (Åv ) ) == -1 ) {

278 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_IO_ERROR
, "£tsock›àSO_SNDTIMEO faûed.", 
î∫o
 );

279  
MONGO_ERROR
;

282  
MONGO_OK
;

283 
	}
}

285 
	$m⁄go_ív_unix_sockë_c⁄√˘
–
m⁄go
 *
c⁄n
, c⁄° *
sock_∑th
 ) {

286 
sockaddr_un
 
addr
;

287 
°©us
, 
Àn
;

289 
c⁄n
->
c⁄√˘ed
 = 0;

291 
c⁄n
->
sock
 = 
	`sockë
–
AF_UNIX
, 
SOCK_STREAM
, 0 );

293 i‡–
c⁄n
->
sock
 =
INVALID_SOCKET
 ) {

294  
MONGO_ERROR
;

297 
addr
.
sun_Ámûy
 = 
AF_UNIX
;

298 
	`°∫˝y
–
addr
.
sun_∑th
, 
sock_∑th
, (addr.sun_path) - 1 );

299 
Àn
 = –
addr
 );

301 
°©us
 = 
	`c⁄√˘
–
c⁄n
->
sock
, (
sockaddr
 *Ë&
addr
, 
Àn
 );

302 if–
°©us
 < 0 ) {

303 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

304 
c⁄n
->
sock
 = 0;

305 
c⁄n
->
îr
 = 
MONGO_CONN_FAIL
;

306  
MONGO_ERROR
;

309 
c⁄n
->
c⁄√˘ed
 = 1;

311  
MONGO_OK
;

312 
	}
}

314 
	$m⁄go_ív_sockë_c⁄√˘
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 ) {

315 
p‹t_°r
[
NI_MAXSERV
];

316 
°©us
;

318 
addröfo
 
ai_höts
;

319 
addröfo
 *
ai_li°
 = 
NULL
;

320 
addröfo
 *
ai_±r
 = 
NULL
;

322 i‡–
p‹t
 < 0 ) {

323  
	`m⁄go_ív_unix_sockë_c⁄√˘
–
c⁄n
, 
ho°
 );

326 
c⁄n
->
sock
 = 0;

327 
c⁄n
->
c⁄√˘ed
 = 0;

328 
	`•rötf
(
p‹t_°r
,"%d",
p‹t
);

330 
	`bs⁄_•rötf
–
p‹t_°r
, "%d", 
p‹t
 );

332 
	`mem£t
–&
ai_höts
, 0, (ái_hints ) );

333 #ifde‡
AI_ADDRCONFIG


334 
ai_höts
.
ai_Êags
 = 
AI_ADDRCONFIG
;

336 
ai_höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

337 
ai_höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

339 
°©us
 = 
	`gëaddröfo
–
ho°
, 
p‹t_°r
, &
ai_höts
, &
ai_li°
 );

340 i‡–
°©us
 != 0 ) {

341 
	`bs⁄_îΩrötf
–"gëaddröfÿÁûed: %s", 
	`gai_°ªº‹
–
°©us
 ) );

342 
c⁄n
->
îr
 = 
MONGO_CONN_ADDR_FAIL
;

343  
MONGO_ERROR
;

346  
ai_±r
 = 
ai_li°
;ái_±∏!
NULL
;ái_±∏ai_±r->
ai_√xt
 ) {

347 
c⁄n
->
sock
 = 
	`sockë
–
ai_±r
->
ai_Ámûy
,ái_±r->
ai_sockty≥
,ái_±r->
ai_¥Ÿocﬁ
 );

348 i‡–
c⁄n
->
sock
 =
INVALID_SOCKET
 ) {

352 
°©us
 = 
	`c⁄√˘
–
c⁄n
->
sock
, 
ai_±r
->
ai_addr
,ái_±r->
ai_addæí
 );

353 i‡–
°©us
 != 0 ) {

354 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

355 
c⁄n
->
sock
 = 0;

358 #i‡
__APPLE__


360 
Êag
 = 1;

361 
	`£tsock›t
–
c⁄n
->
sock
, 
SOL_SOCKET
, 
SO_NOSIGPIPE
,

362 –* ) &
Êag
, ( flag ) );

366 i‡–
ai_±r
->
ai_¥Ÿocﬁ
 =
IPPROTO_TCP
 ) {

367 
Êag
 = 1;

369 
	`£tsock›t
–
c⁄n
->
sock
, 
IPPROTO_TCP
, 
TCP_NODELAY
,

370 –* ) &
Êag
, ( flag ) );

371 i‡–
c⁄n
->
›_timeout_ms
 > 0 )

372 
	`m⁄go_ív_£t_sockë_›_timeout
–
c⁄n
, c⁄n->
›_timeout_ms
 );

375 
c⁄n
->
c⁄√˘ed
 = 1;

379 
	`‰ìaddröfo
–
ai_li°
 );

381 i‡–! 
c⁄n
->
c⁄√˘ed
 ) {

382 
c⁄n
->
îr
 = 
MONGO_CONN_FAIL
;

383  
MONGO_ERROR
;

386  
MONGO_OK
;

387 
	}
}

408 
	~"ív.h
"

409 
	~<î∫o.h
>

410 
	~<°rög.h
>

412 #ifde‡
_WIN32


413 #ifde‡
_MSC_VER


414 
	~<ws2t˝ù.h
>

415 
	~<w•üpi.h
>

417 
	~<wödows.h
>

418 
	~<wösock.h
>

419 
	tsockÀn_t
;

422 
	~<¨∑/öë.h
>

423 
	~<sys/ty≥s.h
>

424 
	~<sys/sockë.h
>

425 
	~<√tdb.h
>

426 
	~<√töë/ö.h
>

427 
	~<√töë/t˝.h
>

428 
	~<f˙é.h
>

429 
	~<uni°d.h
>

432 #i‚de‡
NI_MAXSERV


433 
	#NI_MAXSERV
 32

	)

436 
	$m⁄go_ív_˛o£_sockë
–
SOCKET
 
sockë
 ) {

437 #ifde‡
_WIN32


438  
	`˛o£sockë
–
sockë
 );

440  
	`˛o£
–
sockë
 );

442 
	}
}

444 
	$m⁄go_ív_wrôe_sockë
–
m⁄go
 *
c⁄n
, c⁄° *
buf
, 
size_t
 
Àn
 ) {

445 c⁄° *
cbuf
 = 
buf
;

446 #ifde‡
_WIN32


447 
Êags
 = 0;

449 #ifde‡
__APPLE__


450 
Êags
 = 0;

452 
Êags
 = 
MSG_NOSIGNAL
;

456  
Àn
 ) {

457 
size_t
 
£¡
 = 
	`£nd
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 
Êags
 );

458 i‡–
£¡
 == -1 ) {

459 i‡(
î∫o
 =
EPIPE
)

460 
c⁄n
->
c⁄√˘ed
 = 0;

461 
c⁄n
->
îr
 = 
MONGO_IO_ERROR
;

462  
MONGO_ERROR
;

464 
cbuf
 +
£¡
;

465 
Àn
 -
£¡
;

468  
MONGO_OK
;

469 
	}
}

471 
	$m⁄go_ív_ªad_sockë
–
m⁄go
 *
c⁄n
, *
buf
, 
size_t
 
Àn
 ) {

472 *
cbuf
 = 
buf
;

473  
Àn
 ) {

474 
size_t
 
£¡
 = 
	`ªcv
–
c⁄n
->
sock
, 
cbuf
, 
Àn
, 0 );

475 i‡–
£¡
 == 0 || sent == -1 ) {

476 
c⁄n
->
îr
 = 
MONGO_IO_ERROR
;

477  
MONGO_ERROR
;

479 
cbuf
 +
£¡
;

480 
Àn
 -
£¡
;

483  
MONGO_OK
;

484 
	}
}

487 
	$m⁄go_ív_£t_sockë_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 ) {

488  
MONGO_OK
;

489 
	}
}

491 
	$m⁄go_ív_sockë_c⁄√˘
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 ) {

492 
sockaddr_ö
 
ß
;

493 
sockÀn_t
 
addªssSize
;

494 
Êag
 = 1;

496 i‡––
c⁄n
->
sock
 = 
	`sockë
–
AF_INET
, 
SOCK_STREAM
, 0 ) ) =
INVALID_SOCKET
 ) {

497 
c⁄n
->
sock
 = 0;

498 
c⁄n
->
îr
 = 
MONGO_CONN_NO_SOCKET
;

499  
MONGO_ERROR
;

502 
	`mem£t
–
ß
.
sö_zîo
 , 0 , ( sa.sin_zero ) );

503 
ß
.
sö_Ámûy
 = 
AF_INET
;

504 
ß
.
sö_p‹t
 = 
	`ht⁄s
–
p‹t
 );

505 
ß
.
sö_addr
.
s_addr
 = 
	`öë_addr
–
ho°
 );

506 
addªssSize
 = –
ß
 );

508 i‡–
	`c⁄√˘
–
c⁄n
->
sock
, ( 
sockaddr
 * )&
ß
, 
addªssSize
 ) =
INVALID_SOCKET
 ) {

509 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

510 
c⁄n
->
c⁄√˘ed
 = 0;

511 
c⁄n
->
sock
 = 0;

512 
c⁄n
->
îr
 = 
MONGO_CONN_FAIL
;

513  
MONGO_ERROR
;

516 
	`£tsock›t
–
c⁄n
->
sock
, 
IPPROTO_TCP
, 
TCP_NODELAY
, ( * ) &
Êag
, ( flag ) );

518 if–
c⁄n
->
›_timeout_ms
 > 0 )

519 
	`m⁄go_ív_£t_sockë_›_timeout
–
c⁄n
, c⁄n->
›_timeout_ms
 );

521 
c⁄n
->
c⁄√˘ed
 = 1;

523  
MONGO_OK
;

524 
	}
}

526 
MONGO_EXPORT
 
	$m⁄go_ív_sock_öô
( ) {

528 #i‡
	`deföed
(
_WIN32
)

529 
WSADATA
 
wßD©a
;

530 
WORD
 
wVîs
;

531 #ñi‡
	`deföed
(
SIGPIPE
)

532 
siga˘i⁄
 
a˘
;

535 
ˇŒed_⁄˚
;

536 
ªtvÆ
;

537 i‡(
ˇŒed_⁄˚
Ë 
ªtvÆ
;

538 
ˇŒed_⁄˚
 = 1;

540 #i‡
	`deföed
(
_WIN32
)

541 
wVîs
 = 
	`MAKEWORD
(1, 1);

542 
ªtvÆ
 = (
	`WSASèπup
(
wVîs
, &
wßD©a
) == 0);

543 #ñi‡
	`deföed
(
MACINTOSH
)

544 
	`GUSISëup
(
GUSIwôhI¡î√tSockës
);

545 
ªtvÆ
 = 1;

546 #ñi‡
	`deföed
(
SIGPIPE
)

547 
ªtvÆ
 = 1;

548 i‡(
	`siga˘i⁄
(
SIGPIPE
, (
siga˘i⁄
 *)
NULL
, &
a˘
) < 0)

549 
ªtvÆ
 = 0;

550 i‡(
a˘
.
ß_h™dÀr
 =
SIG_DFL
) {

551 
a˘
.
ß_h™dÀr
 = 
SIG_IGN
;

552 i‡(
	`siga˘i⁄
(
SIGPIPE
, &
a˘
, (
siga˘i⁄
 *)
NULL
) < 0)

553 
ªtvÆ
 = 0;

556  
ªtvÆ
;

557 
	}
}

	@env.h

19 #i‚de‡
MONGO_ENV_H_


20 
	#MONGO_ENV_H_


	)

22 
	~"m⁄go.h
"

24 
	gMONGO_EXTERN_C_START


26 #i‡!
deföed
(
MONGO_ENV_STANDARD
Ë&& (deföed(
__APPLE__
Ë|| deföed(
__löux
Ë|| deföed(
__unix
Ë|| deföed(
__posix
))

27 
	#INVALID_SOCKET
 (-1)

	)

31 
m⁄go_ív_£t_sockë_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 );

32 
m⁄go_ív_ªad_sockë
–
m⁄go
 *
c⁄n
, *
buf
, 
size_t
 
Àn
 );

33 
m⁄go_ív_wrôe_sockë
–
m⁄go
 *
c⁄n
, c⁄° *
buf
, 
size_t
 
Àn
 );

34 
m⁄go_ív_sockë_c⁄√˘
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 );

37 
MONGO_EXPORT
 
m⁄go_ív_sock_öô
( );

40 
MONGO_EXPORT
 
m⁄go_ív_˛o£_sockë
–
SOCKET
 
sockë
 );

42 
	gMONGO_EXTERN_C_END


	@export2mongo.h

1 #i‚de‡
__EXP2MONGO_H


2 
	#__EXP2MONGO_H


	)

4 
	~"bs⁄.h
"

5 
	~"m⁄go.h
"

8 
	mTy≥I¡
 =0,

9 
	mTy≥Så
,

10 
	mTy≥DoubÀ
,

11 
	mTy≥L⁄g
,

12 
	mTy≥D©e
,

13 
	mTy≥Time


14 } 
	tíumM⁄goTy≥
;

16 
	sD©aP¨amëî
 {

17 *
	mv±r
;

18 
	md©es
;

19 
	mtickë
;

20 } 
	td©aP¨amëî
;

23 
	sUæRe•_M
{

24 
	m¥ev°©e
;

25 
	m√xt°©e
;

26 *
	msm«me
;

27 
	msmassign
;

29 } 
	tuæRe•⁄£
;

32 
	srsöaOPT
 {

33 *
	m«me
;

34 
íumM⁄goTy≥
 
	mty≥
;

35 *
	mvÆue
;

37 } 
	trsöaO±
;

39 
°ruc
 
	tGlobÆP¨amëî
 {

40 
m⁄go_c⁄√˘i⁄
 *
	gc⁄n
;

41 } 
	tglobÆP¨amëî
;

	@gridfs.c

19 #i‡
_MSC_VER
 && ! 
_CRT_SECURE_NO_WARNINGS


20 
	#_CRT_SECURE_NO_WARNINGS


	)

23 #i‚de‡
MAX


24 
	#MAX
(
x
, 
y
Ë(((xË> (y)Ë? (xË: (y))

	)

26 #i‚de‡
MIN


27 
	#MIN
(
x
, 
y
Ë(((xË< (y)Ë? (xË: (y))

	)

30 
	~"gridfs.h
"

31 
	~<°dio.h
>

32 
	~<°dlib.h
>

33 
	~<°rög.h
>

34 
	~<˘y≥.h
>

35 
	~<as£π.h
>

37 #i‚de‡
_MSC_VER


38 
	~<˘y≥.h
>

39 *
	$_°ru¥
(*
°r
)

41 *
s
 = 
°r
;

42 *
s
) {

43 *
s
 = 
	`touµî
(()*s);

44 ++
s
;

46  
°r
;

47 
	}
}

48 *
	$_°æwr
(*
°r
)

50 *
s
 = 
°r
;

51 *
s
) {

52 *
s
 = 
	`tﬁowî
(()*s);

53 ++
s
;

55  
°r
;

56 
	}
}

60 
MONGO_EXPORT
 
gridfs
 *
	$gridfs_Æloc
( ) {

61  ( 
gridfs
* )
	`bs⁄_mÆloc
( ( gridfs ) );

62 
	}
}

64 
MONGO_EXPORT
 
	$gridfs_dóŒoc
–
gridfs
 *
gfs
 ) {

65 
	`bs⁄_‰ì
–
gfs
 );

66 
	}
}

68 
MONGO_EXPORT
 
gridfûe
 *
	$gridfûe_¸óã
( ) {

69 
gridfûe
* 
gfûe
 = (gridfûe*)
	`bs⁄_mÆloc
((gridfile));

70 
	`mem£t
–
gfûe
, 0,  ( 
gridfûe
 ) );

71  
gfûe
;

72 
	}
}

74 
MONGO_EXPORT
 
	$gridfûe_dóŒoc
–
gridfûe
 *
gf
 ) {

75 
	`bs⁄_‰ì
–
gf
 );

76 
	}
}

78 
MONGO_EXPORT
 
	$gridfûe_gë_des¸ùt‹
(
gridfûe
 *
gf
, 
bs⁄
 *
out
) {

79 *
out
 = *
gf
->
mëa
;

80 
	}
}

83 
	$gridfs_deÁu…_chunk_fûãr
(** 
èrgëBuf
, 
size_t
* 
èrgëLí
, c⁄° * 
§cD©a
, size_à
§cLí
, 
Êags
) {

84 *
èrgëBuf
 = (*Ë
§cD©a
;

85 *
èrgëLí
 = 
§cLí
;

87 
	}
}

89 
size_t
 
	$gridfs_deÁu…_≥ndög_d©a_size
 (
Êags
) {

90  
DEFAULT_CHUNK_SIZE
;

91 
	}
}

94 
gridfs_chunk_fûãr_func
 
	ggridfs_wrôe_fûãr
 = 
gridfs_deÁu…_chunk_fûãr
;

95 
gridfs_chunk_fûãr_func
 
	ggridfs_ªad_fûãr
 = 
gridfs_deÁu…_chunk_fûãr
;

96 
gridfs_≥ndög_d©a_size_func
 
	ggridfs_≥ndög_d©a_size
 = 
gridfs_deÁu…_≥ndög_d©a_size
;

98 
MONGO_EXPORT
 
	$gridfs_£t_chunk_fûãr_funcs
(
gridfs_chunk_fûãr_func
 
wrôeFûãr
, gridfs_chunk_fûãr_fun¯
ªadFûãr
, 
gridfs_≥ndög_d©a_size_func
 
≥ndögD©aNìdedSize
) {

99 
gridfs_wrôe_fûãr
 = 
wrôeFûãr
;

100 
gridfs_ªad_fûãr
 = 
ªadFûãr
;

101 
gridfs_≥ndög_d©a_size
 = 
≥ndögD©aNìdedSize
;

102 
	}
}

104 
bs⁄
 *
	$chunk_√w
(
bs⁄_oid_t
 
id
, 
chunkNumbî
, ** 
d©aBuf
, c⁄° * 
§cD©a
, 
size_t
 
Àn
, 
Êags
 ) {

105 
bs⁄
 *
b
 = 
	`bs⁄_Æloc
();

106 
size_t
 
d©aBufLí
 = 0;

108 if–
	`gridfs_wrôe_fûãr
–
d©aBuf
, &
d©aBufLí
, 
§cD©a
, 
Àn
, 
Êags
) != 0 ) {

109  
NULL
;

111 
	`bs⁄_öô_size
(
b
, (Ë
d©aBufLí
 + 128);

112 
	`bs⁄_≠≥nd_oid
(
b
, "fûes_id", &
id
);

113 
	`bs⁄_≠≥nd_öt
(
b
, "n", 
chunkNumbî
);

114 
	`bs⁄_≠≥nd_bö¨y
(
b
, "d©a", 
BSON_BIN_BINARY
, *
d©aBuf
, ()
d©aBufLí
);

115 
	`bs⁄_föish
(
b
);

116  
b
;

117 
	}
}

119 
	$chunk_‰ì
(
bs⁄
 *
oChunk
) {

120 if–
oChunk
 ) {

121 
	`bs⁄_de°roy
(
oChunk
);

122 
	`bs⁄_dóŒoc
(
oChunk
);

124 
	}
}

132 
MONGO_EXPORT
 
	$gridfs_öô
(
m⁄go
 *
˛õ¡
, c⁄° *
db«me
, c⁄° *
¥efix
, 
gridfs
 *
gfs
) {

134 
bs⁄
 
b
;

136 
gfs
->
ˇ£In£nsôive
 = 0;

137 
gfs
->
˛õ¡
 = client;

140 
gfs
->
db«me
 = (c⁄° *)
	`bs⁄_mÆloc
(()
	`°æí
(dbname) + 1);

141 
	`°r˝y
((*)
gfs
->
db«me
, dbname);

144 i‡(
¥efix
 =
NULL
) {

145 
¥efix
 = "fs";

147 
gfs
->
¥efix
 = (c⁄° *)
	`bs⁄_mÆloc
(()
	`°æí
(prefix) + 1);

148 
	`°r˝y
((*)
gfs
->
¥efix
,Örefix);

151 
gfs
->
fûes_ns
 = (c⁄° *)
	`bs⁄_mÆloc
(()(
	`°æí
(
¥efix
Ë+ såÀn(
db«me
) + strlen(".files") + 2));

152 
	`°r˝y
((*)
gfs
->
fûes_ns
, 
db«me
);

153 
	`°rˇt
((*)
gfs
->
fûes_ns
, ".");

154 
	`°rˇt
((*)
gfs
->
fûes_ns
, 
¥efix
);

155 
	`°rˇt
((*)
gfs
->
fûes_ns
, ".files");

158 
gfs
->
chunks_ns
 = (c⁄° *)
	`bs⁄_mÆloc
(()(
	`°æí
(
¥efix
Ë+ såÀn(
db«me
) + strlen(".chunks") + 2));

159 
	`°r˝y
((*)
gfs
->
chunks_ns
, 
db«me
);

160 
	`°rˇt
((*)
gfs
->
chunks_ns
, ".");

161 
	`°rˇt
((*)
gfs
->
chunks_ns
, 
¥efix
);

162 
	`°rˇt
((*)
gfs
->
chunks_ns
, ".chunks");

164 
	`bs⁄_öô
(&
b
);

165 
	`bs⁄_≠≥nd_öt
(&
b
, "filename", 1);

166 
	`bs⁄_föish
(&
b
);

167 if–
	`m⁄go_¸óã_ödex
(
gfs
->
˛õ¡
, gfs->
fûes_ns
, &
b
, 
NULL
, 0, NULLË!
MONGO_OK
) {

168 
	`bs⁄_de°roy
–&
b
 );

169 
	`gridfs_de°roy
–
gfs
 );

170  
MONGO_ERROR
;

172 
	`bs⁄_de°roy
(&
b
);

174 
	`bs⁄_öô
(&
b
);

175 
	`bs⁄_≠≥nd_öt
(&
b
, "files_id", 1);

176 
	`bs⁄_≠≥nd_öt
(&
b
, "n", 1);

177 
	`bs⁄_föish
(&
b
);

178 if–
	`m⁄go_¸óã_ödex
(
gfs
->
˛õ¡
, gfs->
chunks_ns
, &
b
, 
NULL
, 
MONGO_INDEX_UNIQUE
, NULLË!
MONGO_OK
 ) {

179 
	`bs⁄_de°roy
(&
b
);

180 
	`gridfs_de°roy
–
gfs
 );

181  
MONGO_ERROR
;

183 
	`bs⁄_de°roy
(&
b
);

185  
MONGO_OK
;

186 
	}
}

189 
MONGO_EXPORT
 
	$gridfs_de°roy
(
gridfs
 *
gfs
) {

190 if–
gfs
 =
NULL
 ) ;

191 if–
gfs
->
db«me
 ) {

192 
	`bs⁄_‰ì
((*)
gfs
->
db«me
);

193 
gfs
->
db«me
 = 
NULL
;

195 if–
gfs
->
¥efix
 ) {

196 
	`bs⁄_‰ì
((*)
gfs
->
¥efix
);

197 
gfs
->
¥efix
 = 
NULL
;

199 if–
gfs
->
fûes_ns
 ) {

200 
	`bs⁄_‰ì
((*)
gfs
->
fûes_ns
);

201 
gfs
->
fûes_ns
 = 
NULL
;

203 if–
gfs
->
chunks_ns
 ) {

204 
	`bs⁄_‰ì
((*)
gfs
->
chunks_ns
);

205 
gfs
->
chunks_ns
 = 
NULL
;

207 
	}
}

211 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$gridfs_gë_ˇ£In£nsôive
–c⁄° 
gridfs
 *
gfs
 ) {

212  
gfs
->
ˇ£In£nsôive
;

213 
	}
}

215 
MONGO_EXPORT
 
	$gridfs_£t_ˇ£In£nsôive
(
gridfs
 *
gfs
, 
bs⁄_boﬁ_t
 
√wVÆue
){

216 
gfs
->
ˇ£In£nsôive
 = 
√wVÆue
;

217 
	}
}

219 
	$bs⁄_≠≥nd_°rög_uµîˇ£
–
bs⁄
 *
b
, c⁄° *
«me
, c⁄° *
°r
, 
bs⁄_boﬁ_t
 
uµîCa£
 ) {

220 *
°rUµîCa£
;

221 i‡–
uµîCa£
 ) {

222 
ªs
;

223 
°rUµîCa£
 = (*Ë
	`bs⁄_mÆloc
–(Ë
	`°æí
–
°r
 ) + 1 );

224 
	`°r˝y
(
°rUµîCa£
, 
°r
);

225 
	`_°ru¥
(
°rUµîCa£
);

226 
ªs
 = 
	`bs⁄_≠≥nd_°rög
–
b
, 
«me
, 
°rUµîCa£
 );

227 
	`bs⁄_‰ì
–
°rUµîCa£
 );

228  
ªs
;

230  
	`bs⁄_≠≥nd_°rög
–
b
, 
«me
, 
°r
 );

232 
	}
}

234 
	$gridfs_ö£π_fûe
(
gridfs
 *
gfs
, c⁄° *
«me
, c⁄° 
bs⁄_oid_t
 
id
, 
gridfs_off£t
 
Àngth
, c⁄° *
c⁄ã¡ty≥
, 
Êags
, 
chunkSize
) {

235 
bs⁄
 
comm™d
[1];

236 
bs⁄
 
ªt
[1];

237 
bs⁄
 
ªs
[1];

238 
bs⁄_ôî©‹
 
ô
[1];

239 
bs⁄
 
q
[1];

240 
ªsu…
;

241 
öt64_t
 
d
;

244 if–!–
Êags
 & 
GRIDFILE_NOMD5
 ) ) {

246 
	`bs⁄_öô
(
comm™d
);

247 
	`bs⁄_≠≥nd_oid
(
comm™d
, "fûemd5", &
id
);

248 
	`bs⁄_≠≥nd_°rög
(
comm™d
, "roŸ", 
gfs
->
¥efix
);

249 
	`bs⁄_föish
(
comm™d
);

250 
ªsu…
 = 
	`m⁄go_run_comm™d
(
gfs
->
˛õ¡
, gfs->
db«me
, 
comm™d
, 
ªs
);

251 
	`bs⁄_de°roy
(
comm™d
);

252 i‡(
ªsu…
 !
MONGO_OK
)

253  
ªsu…
;

257 
	`bs⁄_öô
(
ªt
);

258 
	`bs⁄_≠≥nd_oid
(
ªt
, "_id", &
id
);

259 i‡(
«me
 !
NULL
 && *name != '\0') {

260 
	`bs⁄_≠≥nd_°rög_uµîˇ£
–
ªt
, "fûíame", 
«me
, 
gfs
->
ˇ£In£nsôive
 );

262 
	`bs⁄_≠≥nd_l⁄g
(
ªt
, "Àngth", 
Àngth
);

263 
	`bs⁄_≠≥nd_öt
(
ªt
, "chunkSize", 
chunkSize
);

264 
d
 = (
bs⁄_d©e_t
)1000 * 
	`time
(
NULL
);

265 
	`bs⁄_≠≥nd_d©e
(
ªt
, "u∂ﬂdD©e", 
d
);

266 if–!–
Êags
 & 
GRIDFILE_NOMD5
 ) ) {

267 
	`bs⁄_föd
(
ô
, 
ªs
, "md5");

268 
	`bs⁄_≠≥nd_°rög
(
ªt
, "md5", 
	`bs⁄_ôî©‹_°rög
(
ô
));

269 
	`bs⁄_de°roy
(
ªs
);

271 
	`bs⁄_≠≥nd_°rög
(
ªt
, "md5", "");

273 i‡(
c⁄ã¡ty≥
 !
NULL
 && *contenttype != '\0') {

274 
	`bs⁄_≠≥nd_°rög
(
ªt
, "c⁄ã¡Ty≥", 
c⁄ã¡ty≥
);

276 i‡–
gfs
->
ˇ£In£nsôive
 ) {

277 
	`bs⁄_≠≥nd_°rög
(
ªt
, "ªÆFûíame", 
«me
);

279 
	`bs⁄_≠≥nd_öt
(
ªt
, "Êags", 
Êags
);

280 
	`bs⁄_föish
(
ªt
);

282 
	`bs⁄_öô
(
q
);

283 
	`bs⁄_≠≥nd_oid
(
q
, "_id", &
id
);

284 
	`bs⁄_föish
(
q
);

286 
ªsu…
 = 
	`m⁄go_upd©e
(
gfs
->
˛õ¡
, gfs->
fûes_ns
, 
q
, 
ªt
, 
MONGO_UPDATE_UPSERT
, 
NULL
);

288 
	`bs⁄_de°roy
(
ªt
);

289 
	`bs⁄_de°roy
(
q
);

291  
ªsu…
;

292 
	}
}

294 
MONGO_EXPORT
 
	$gridfs_°‹e_buf„r
(
gridfs
 *
gfs
, c⁄° *
d©a
, 
gridfs_off£t
 
Àngth
, c⁄° *
ªmŸíame
, c⁄° *
c⁄ã¡ty≥
, 
Êags
 ) {

295 
gridfûe
 
gfûe
;

296 
gridfs_off£t
 
byãs_wrôãn
;

298 
	`gridfûe_öô
–
gfs
, 
NULL
, &
gfûe
 );

299 
	`gridfûe_wrôî_öô
–&
gfûe
, 
gfs
, 
ªmŸíame
, 
c⁄ã¡ty≥
, 
Êags
 );

301 
byãs_wrôãn
 = 
	`gridfûe_wrôe_buf„r
–&
gfûe
, 
d©a
, 
Àngth
 );

303 
	`gridfûe_wrôî_d⁄e
–&
gfûe
 );

304 
	`gridfûe_de°roy
–&
gfûe
 );

306  
byãs_wrôãn
 =
Àngth
 ? 
MONGO_OK
 : 
MONGO_ERROR
;

307 
	}
}

309 
MONGO_EXPORT
 
	$gridfs_°‹e_fûe
(
gridfs
 *
gfs
, c⁄° *
fûíame
, c⁄° *
ªmŸíame
, c⁄° *
c⁄ã¡ty≥
, 
Êags
 ) {

310 
buf„r
[
DEFAULT_CHUNK_SIZE
];

311 
FILE
 *
fd
;

312 
gridfs_off£t
 
chunkLí
;

313 
gridfûe
 
gfûe
;

314 
gridfs_off£t
 
byãs_wrôãn
 = 0;

317 i‡(
	`°rcmp
(
fûíame
, "-") == 0) {

318 
fd
 = 
°dö
;

320 
fd
 = 
	`f›í
(
fûíame
, "rb");

321 i‡(
fd
 =
NULL
) {

322  
MONGO_ERROR
;

327 i‡(
ªmŸíame
 =
NULL
 || *remotename == '\0') {

328 
ªmŸíame
 = 
fûíame
;

331 if–
	`gridfûe_öô
–
gfs
, 
NULL
, &
gfûe
 ) !
MONGO_OK
 )  
MONGO_ERROR
;

332 if–
	`gridfûe_wrôî_öô
–&
gfûe
, 
gfs
, 
ªmŸíame
, 
c⁄ã¡ty≥
, 
Êags
 ) !
MONGO_OK
 ){

333 
	`gridfûe_de°roy
–&
gfûe
 );

334  
MONGO_ERROR
;

337 
chunkLí
 = 
	`‰ód
(
buf„r
, 1, 
DEFAULT_CHUNK_SIZE
, 
fd
);

338  
chunkLí
 != 0 ) {

339 
byãs_wrôãn
 = 
	`gridfûe_wrôe_buf„r
–&
gfûe
, 
buf„r
, 
chunkLí
 );

340 if–
byãs_wrôãn
 !
chunkLí
 ) ;

341 
chunkLí
 = 
	`‰ód
(
buf„r
, 1, 
DEFAULT_CHUNK_SIZE
, 
fd
);

344 
	`gridfûe_wrôî_d⁄e
–&
gfûe
 );

345 
	`gridfûe_de°roy
–&
gfûe
 );

348 i‡–
fd
 !
°dö
 ) {

349 
	`f˛o£
–
fd
 );

351  ( 
chunkLí
 =0Ë|| ( 
byãs_wrôãn
 =chunkLí ) ? 
MONGO_OK
 : 
MONGO_ERROR
;

352 
	}
}

354 
MONGO_EXPORT
 
	$gridfs_ªmove_fûíame
(
gridfs
 *
gfs
, c⁄° *
fûíame
) {

355 
bs⁄
 
quîy
[1];

356 
m⁄go_curs‹
 *
fûes
;

357 
bs⁄
 
fûe
[1];

358 
bs⁄_ôî©‹
 
ô
[1];

359 
bs⁄_oid_t
 
id
;

360 
bs⁄
 
b
[1];

361 
ªt
 = 
MONGO_ERROR
;

363 
	`bs⁄_öô
(
quîy
);

364 
	`bs⁄_≠≥nd_°rög_uµîˇ£
–
quîy
, "fûíame", 
fûíame
, 
gfs
->
ˇ£In£nsôive
 );

365 
	`bs⁄_föish
(
quîy
);

366 
fûes
 = 
	`m⁄go_föd
(
gfs
->
˛õ¡
, gfs->
fûes_ns
, 
quîy
, 
NULL
, 0, 0, 0);

367 
	`bs⁄_de°roy
(
quîy
);

370 i‡–
fûes
 =
NULL
 )  
MONGO_ERROR
;

373 
	`m⁄go_curs‹_√xt
(
fûes
Ë=
MONGO_OK
) {

374 *
fûe
 = 
fûes
->
cuºít
;

375 
	`bs⁄_föd
(
ô
, 
fûe
, "_id");

376 
id
 = *
	`bs⁄_ôî©‹_oid
(
ô
);

379 
	`bs⁄_öô
(
b
);

380 
	`bs⁄_≠≥nd_oid
(
b
, "_id", &
id
);

381 
	`bs⁄_föish
(
b
);

382 
	`m⁄go_ªmove
(
gfs
->
˛õ¡
, gfs->
fûes_ns
, 
b
, 
NULL
);

383 
	`bs⁄_de°roy
(
b
);

386 
	`bs⁄_öô
(
b
);

387 
	`bs⁄_≠≥nd_oid
(
b
, "fûes_id", &
id
);

388 
	`bs⁄_föish
(
b
);

389 
ªt
 = 
	`m⁄go_ªmove
(
gfs
->
˛õ¡
, gfs->
chunks_ns
, 
b
, 
NULL
);

390 
	`bs⁄_de°roy
(
b
);

393 
	`m⁄go_curs‹_de°roy
(
fûes
);

394  
ªt
;

395 
	}
}

397 
MONGO_EXPORT
 
	$gridfs_föd_quîy
–
gridfs
 *
gfs
, c⁄° 
bs⁄
 *
quîy
, 
gridfûe
 *
gfûe
 ) {

399 
bs⁄
 
u∂ﬂdD©e
[1];

400 
bs⁄
 
föÆQuîy
[1];

401 
bs⁄
 
out
[1];

402 
i
;

404 
	`bs⁄_öô
(
u∂ﬂdD©e
);

405 
	`bs⁄_≠≥nd_öt
(
u∂ﬂdD©e
, "uploadDate", - 1);

406 
	`bs⁄_föish
(
u∂ﬂdD©e
);

408 
	`bs⁄_öô
(
föÆQuîy
);

409 
	`bs⁄_≠≥nd_bs⁄
(
föÆQuîy
, "quîy", 
quîy
);

410 
	`bs⁄_≠≥nd_bs⁄
(
föÆQuîy
, "‹dîby", 
u∂ﬂdD©e
);

411 
	`bs⁄_föish
(
föÆQuîy
);

413 
i
 = (
	`m⁄go_föd_⁄e
(
gfs
->
˛õ¡
, gfs->
fûes_ns
, 
föÆQuîy
, 
NULL
, 
out
Ë=
MONGO_OK
);

414 
	`bs⁄_de°roy
(
u∂ﬂdD©e
);

415 
	`bs⁄_de°roy
(
föÆQuîy
);

416 i‡(!
i
) {

417  
MONGO_ERROR
;

419 
	`gridfûe_öô
(
gfs
, 
out
, 
gfûe
);

420 
	`bs⁄_de°roy
(
out
);

421  
MONGO_OK
;

423 
	}
}

425 
MONGO_EXPORT
 
	$gridfs_föd_fûíame
(
gridfs
 *
gfs
, c⁄° *
fûíame
, 
gridfûe
 *
gfûe
){

426 
bs⁄
 
quîy
[1];

427 
ªs
;

429 
	`bs⁄_öô
(
quîy
);

430 
	`bs⁄_≠≥nd_°rög_uµîˇ£
–
quîy
, "fûíame", 
fûíame
, 
gfs
->
ˇ£In£nsôive
 );

431 
	`bs⁄_föish
(
quîy
);

432 
ªs
 = 
	`gridfs_föd_quîy
(
gfs
, 
quîy
, 
gfûe
);

433 
	`bs⁄_de°roy
(
quîy
);

434  
ªs
;

435 
	}
}

442 
gridfûe_Êush_≥ndögchunk
(
gridfûe
 *
gfûe
);

443 
gridfûe_öô_Êags
(
gridfûe
 *
gfûe
);

444 
gridfûe_öô_Àngth
(
gridfûe
 *
gfûe
);

445 
gridfûe_öô_chunkSize
(
gridfûe
 *
gfûe
);

449 
MONGO_EXPORT
 
	$gridfûe_öô
–
gridfs
 *
gfs
, c⁄° 
bs⁄
 *
mëa
, 
gridfûe
 *
gfûe
 ) {

450 
gfûe
->
gfs
 = gfs;

451 
gfûe
->
pos
 = 0;

452 
gfûe
->
≥ndög_Àn
 = 0;

453 
gfûe
->
≥ndög_d©a
 = 
NULL
;

454 
gfûe
->
mëa
 = 
	`bs⁄_Æloc
();

455 i‡(
gfûe
->
mëa
 =
NULL
) {

456  
MONGO_ERROR
;

457 } if–
mëa
 ) {

458 
	`bs⁄_c›y
(
gfûe
->
mëa
, meta);

460 
	`bs⁄_öô_em±y
(
gfûe
->
mëa
);

462 
	`gridfûe_öô_chunkSize
–
gfûe
 );

463 
	`gridfûe_öô_Àngth
–
gfûe
 );

464 
	`gridfûe_öô_Êags
–
gfûe
 );

465  
MONGO_OK
;

466 
	}
}

468 
MONGO_EXPORT
 
	$gridfûe_wrôî_d⁄e
(
gridfûe
 *
gfûe
) {

470 
ª•⁄£
 = 
MONGO_OK
;

472 i‡(
gfûe
->
≥ndög_Àn
) {

475 
ª•⁄£
 = 
	`gridfûe_Êush_≥ndögchunk
(
gfûe
);

477 if–
gfûe
->
≥ndög_d©a
 ) {

478 
	`bs⁄_‰ì
(
gfûe
->
≥ndög_d©a
);

479 
gfûe
->
≥ndög_d©a
 = 
NULL
;

481 if–
ª•⁄£
 =
MONGO_OK
 ) {

483 
ª•⁄£
 = 
	`gridfs_ö£π_fûe
(
gfûe
->
gfs
, gfûe->
ªmŸe_«me
, gfûe->
id
, gfûe->
Àngth
, gfûe->
c⁄ã¡_ty≥
, gfûe->
Êags
, gfûe->
chunkSize
);

485 if–
gfûe
->
ªmŸe_«me
 ) {

486 
	`bs⁄_‰ì
(
gfûe
->
ªmŸe_«me
);

487 
gfûe
->
ªmŸe_«me
 = 
NULL
;

489 if–
gfûe
->
c⁄ã¡_ty≥
 ) {

490 
	`bs⁄_‰ì
(
gfûe
->
c⁄ã¡_ty≥
);

491 
gfûe
->
c⁄ã¡_ty≥
 = 
NULL
;

493  
ª•⁄£
;

494 
	}
}

496 
	$gridfûe_öô_chunkSize
(
gridfûe
 *
gfûe
){

497 
bs⁄_ôî©‹
 
ô
[1];

499 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "chunkSize"Ë!
BSON_EOO
)

500 i‡(
	`bs⁄_ôî©‹_ty≥
(
ô
Ë=
BSON_INT
)

501 
gfûe
->
chunkSize
 = 
	`bs⁄_ôî©‹_öt
(
ô
);

503 
gfûe
->
chunkSize
 = ()
	`bs⁄_ôî©‹_l⁄g
(
ô
);

505 
gfûe
->
chunkSize
 = 
DEFAULT_CHUNK_SIZE
;

506 
	}
}

508 
	$gridfûe_öô_Àngth
(
gridfûe
 *
gfûe
) {

509 
bs⁄_ôî©‹
 
ô
[1];

511 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "Àngth"Ë!
BSON_EOO
)

512 i‡(
	`bs⁄_ôî©‹_ty≥
(
ô
Ë=
BSON_INT
)

513 
gfûe
->
Àngth
 = (
gridfs_off£t
)
	`bs⁄_ôî©‹_öt
(
ô
);

515 
gfûe
->
Àngth
 = (
gridfs_off£t
)
	`bs⁄_ôî©‹_l⁄g
(
ô
);

517 
gfûe
->
Àngth
 = 0;

518 
	}
}

520 
	$gridfûe_öô_Êags
(
gridfûe
 *
gfûe
) {

521 
bs⁄_ôî©‹
 
ô
[1];

523 if–
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "Êags"Ë!
BSON_EOO
 )

524 
gfûe
->
Êags
 = 
	`bs⁄_ôî©‹_öt
(
ô
);

526 
gfûe
->
Êags
 = 0;

527 
	}
}

529 
MONGO_EXPORT
 
	$gridfûe_wrôî_öô
(
gridfûe
 *
gfûe
, 
gridfs
 *
gfs
, c⁄° *
ªmŸe_«me
, c⁄° *
c⁄ã¡_ty≥
, 
Êags
 ) {

530 
gridfûe
 
tmpFûe
;

532 
gfûe
->
gfs
 = gfs;

533 i‡(
	`gridfs_föd_fûíame
(
gfs
, 
ªmŸe_«me
, &
tmpFûe
Ë=
MONGO_OK
) {

534 if–
	`gridfûe_exi°s
(&
tmpFûe
) ) {

537 
gfûe
->
id
 = 
	`gridfûe_gë_id
–&
tmpFûe
 );

538 
	`gridfûe_öô_Àngth
–&
tmpFûe
 );

539 
gfûe
->
Àngth
 = 
tmpFûe
.length;

540 
gfûe
->
chunkSize
 = 
	`gridfûe_gë_chunksize
( gfile );

541 if–
Êags
 !
GRIDFILE_DEFAULT
) {

542 
gfûe
->
Êags
 = flags;

544 
	`gridfûe_öô_Êags
–&
tmpFûe
 );

545 
gfûe
->
Êags
 = 
tmpFûe
.flags;

548 
	`gridfûe_de°roy
–&
tmpFûe
 );

551 
	`bs⁄_oid_gí
(&(
gfûe
->
id
));

552 
gfûe
->
Àngth
 = 0;

554 
gfûe
->
Êags
 = flags;

559 
gfûe
->
chunk_num
 = 0;

560 
gfûe
->
pos
 = 0;

562 
gfûe
->
ªmŸe_«me
 = (*)
	`bs⁄_mÆloc
(()
	`°æí
(remote_name) + 1);

563 
	`°r˝y
((*)
gfûe
->
ªmŸe_«me
,Ñemote_name);

565 
gfûe
->
c⁄ã¡_ty≥
 = (*)
	`bs⁄_mÆloc
(()
	`°æí
(content_type) + 1);

566 
	`°r˝y
((*)
gfûe
->
c⁄ã¡_ty≥
, content_type);

568 
gfûe
->
≥ndög_Àn
 = 0;

571 
gfûe
->
≥ndög_d©a
 = (*Ë
	`bs⁄_mÆloc
(()
	`gridfs_≥ndög_d©a_size
(gfûe->
Êags
));

573  
MONGO_OK
;

574 
	}
}

576 
MONGO_EXPORT
 
	$gridfûe_de°roy
(
gridfûe
 *
gfûe
) {

577 if–
gfûe
->
mëa
 ) {

578 
	`bs⁄_de°roy
(
gfûe
->
mëa
);

579 
	`bs⁄_dóŒoc
(
gfûe
->
mëa
);

580 
gfûe
->
mëa
 = 
NULL
;

582 
	}
}

586 
MONGO_EXPORT
 
bs⁄_oid_t
 
	$gridfûe_gë_id
–c⁄° 
gridfûe
 *
gfûe
 ) {

587 
bs⁄_ôî©‹
 
ô
[1];

589 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "_id"Ë!
BSON_EOO
)

590 i‡(
	`bs⁄_ôî©‹_ty≥
(
ô
Ë=
BSON_OID
)

591  *
	`bs⁄_ôî©‹_oid
(
ô
);

593  
gfûe
->
id
;

595  
gfûe
->
id
;

596 
	}
}

598 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$gridfûe_exi°s
–c⁄° 
gridfûe
 *
gfûe
 ) {

600  (
bs⁄_boﬁ_t
)(
gfûe
 !
NULL
 && gfûe->
mëa
 != NULL);

601 
	}
}

603 
MONGO_EXPORT
 c⁄° *
	$gridfûe_gë_fûíame
–c⁄° 
gridfûe
 *
gfûe
 ) {

604 
bs⁄_ôî©‹
 
ô
[1];

606 i‡(
gfûe
->
gfs
->
ˇ£In£nsôive
 && 
	`bs⁄_föd
–
ô
, gfûe->
mëa
, "ªÆFûíame" ) !
BSON_EOO
)

607  
	`bs⁄_ôî©‹_°rög
(
ô
);

608 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "fûíame"Ë!
BSON_EOO
)

609  
	`bs⁄_ôî©‹_°rög
(
ô
);

611  
gfûe
->
ªmŸe_«me
;

612 
	}
}

614 
MONGO_EXPORT
 
	$gridfûe_gë_chunksize
–c⁄° 
gridfûe
 *
gfûe
 ) {

615 
bs⁄_ôî©‹
 
ô
[1];

617 i‡(
gfûe
->
chunkSize
)

618  
gfûe
->
chunkSize
;

619 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "chunkSize"Ë!
BSON_EOO
)

620  
	`bs⁄_ôî©‹_öt
(
ô
);

622  
DEFAULT_CHUNK_SIZE
;

623 
	}
}

625 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_gë_c⁄ã¡Àngth
–c⁄° 
gridfûe
 *
gfûe
 ) {

626 
gridfs_off£t
 
e°im©edLí
;

627 
e°im©edLí
 = 
gfûe
->
≥ndög_Àn
 ? gfûe->
chunk_num
 * 
	`gridfûe_gë_chunksize
–gfûêË+ gfûe->≥ndög_À¿: gfûe->
Àngth
;

628  
	`MAX
–
e°im©edLí
, 
gfûe
->
Àngth
 );

629 
	}
}

631 
MONGO_EXPORT
 c⁄° *
	$gridfûe_gë_c⁄ã¡ty≥
–c⁄° 
gridfûe
 *
gfûe
 ) {

632 
bs⁄_ôî©‹
 
ô
[1];

634 i‡–
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "c⁄ã¡Ty≥"Ë!
BSON_EOO
 )

635  
	`bs⁄_ôî©‹_°rög
(
ô
);

637  
NULL
;

638 
	}
}

640 
MONGO_EXPORT
 
bs⁄_d©e_t
 
	$gridfûe_gë_u∂ﬂdd©e
–c⁄° 
gridfûe
 *
gfûe
 ) {

641 
bs⁄_ôî©‹
 
ô
[1];

643 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "u∂ﬂdD©e"Ë!
BSON_EOO
)

644  
	`bs⁄_ôî©‹_d©e
(
ô
);

647 
	}
}

649 
MONGO_EXPORT
 c⁄° *
	$gridfûe_gë_md5
–c⁄° 
gridfûe
 *
gfûe
 ) {

650 
bs⁄_ôî©‹
 
ô
[1];

652 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "md5"Ë!
BSON_EOO
 )

653  
	`bs⁄_ôî©‹_°rög
(
ô
);

655  
NULL
;

656 
	}
}

658 
MONGO_EXPORT
 
	$gridfûe_£t_Êags
(
gridfûe
 *
gfûe
, 
Êags
) {

659 
gfûe
->
Êags
 = flags;

660 
	}
}

662 
MONGO_EXPORT
 
	$gridfûe_gë_Êags
–c⁄° 
gridfûe
 *
gfûe
 ) {

663  
gfûe
->
Êags
;

664 
	}
}

666 
MONGO_EXPORT
 c⁄° *
	$gridfûe_gë_fõld
(
gridfûe
 *
gfûe
, c⁄° *
«me
) {

667 
bs⁄_ôî©‹
 
ô
[1];

669 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, 
«me
Ë!
BSON_EOO
)

670  
	`bs⁄_ôî©‹_vÆue
(
ô
);

672  
NULL
;

673 
	}
}

675 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$gridfûe_gë_boﬁón
–c⁄° 
gridfûe
 *
gfûe
, c⁄° *
«me
 ) {

676 
bs⁄_ôî©‹
 
ô
[1];

678 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, 
«me
Ë!
BSON_EOO
)

679  
	`bs⁄_ôî©‹_boﬁ
(
ô
);

682 
	}
}

684 
MONGO_EXPORT
 
	$gridfûe_gë_mëad©a
–c⁄° 
gridfûe
 *
gfûe
, 
bs⁄
 *
out
, 
bs⁄_boﬁ_t
 
c›yD©a
 ) {

685 
bs⁄_ôî©‹
 
ô
[1];

687 i‡(
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "mëad©a"Ë!
BSON_EOO
)

688 
	`bs⁄_ôî©‹_subobje˘_öô
(
ô
, 
out
, 
c›yD©a
);

690 
	`bs⁄_öô_em±y
(
out
);

691 
	}
}

697 
MONGO_EXPORT
 
	$gridfûe_gë_numchunks
–c⁄° 
gridfûe
 *
gfûe
 ) {

698 
bs⁄_ôî©‹
 
ô
[1];

699 
gridfs_off£t
 
Àngth
;

700 
gridfs_off£t
 
chunkSize
;

701 
numchunks
;

703 
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "length");

705 i‡(
	`bs⁄_ôî©‹_ty≥
(
ô
Ë=
BSON_INT
)

706 
Àngth
 = (
gridfs_off£t
)
	`bs⁄_ôî©‹_öt
(
ô
);

708 
Àngth
 = (
gridfs_off£t
)
	`bs⁄_ôî©‹_l⁄g
(
ô
);

710 
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "chunkSize");

711 
chunkSize
 = 
	`bs⁄_ôî©‹_öt
(
ô
);

712 
numchunks
 = (()
Àngth
 / ()
chunkSize
);

713  (
numchunks
 - ()numchunks > 0) ? ()(numchunks + 1): ()(numchunks);

714 
	}
}

716 
	$gridfûe_¥ï¨e_chunk_key_bs⁄
(
bs⁄
 *
q
, 
bs⁄_oid_t
 *
id
, 
chunk_num
) {

717 
	`bs⁄_öô
(
q
);

718 
	`bs⁄_≠≥nd_öt
(
q
, "n", 
chunk_num
);

719 
	`bs⁄_≠≥nd_oid
(
q
, "fûes_id", 
id
);

720 
	`bs⁄_föish
(
q
);

721 
	}
}

723 
	$gridfûe_Êush_≥ndögchunk
(
gridfûe
 *
gfûe
) {

724 
bs⁄
 *
oChunk
;

725 
bs⁄
 
q
[1];

726 * 
èrgëBuf
 = 
NULL
;

727 
ªs
 = 
MONGO_OK
;

729 i‡(
gfûe
->
≥ndög_Àn
) {

730 
size_t
 
föish_posôi⁄_a·î_Êush
;

731 
oChunk
 = 
	`chunk_√w
–
gfûe
->
id
, gfûe->
chunk_num
, &
èrgëBuf
, gfûe->
≥ndög_d©a
, gfûe->
≥ndög_Àn
, gfûe->
Êags
 );

732 
	`gridfûe_¥ï¨e_chunk_key_bs⁄
–
q
, &
gfûe
->
id
, gfûe->
chunk_num
 );

733 
ªs
 = 
	`m⁄go_upd©e
(
gfûe
->
gfs
->
˛õ¡
, gfûe->gfs->
chunks_ns
, 
q
, 
oChunk
, 
MONGO_UPDATE_UPSERT
, 
NULL
);

734 
	`bs⁄_de°roy
(
q
);

735 
	`chunk_‰ì
(
oChunk
);

736 if–
ªs
 =
MONGO_OK
 ){

737 
föish_posôi⁄_a·î_Êush
 = (
gfûe
->
chunk_num
 * gfûe->
chunkSize
Ë+ gfûe->
≥ndög_Àn
;

738 i‡(
föish_posôi⁄_a·î_Êush
 > 
gfûe
->
Àngth
)

739 
gfûe
->
Àngth
 = 
föish_posôi⁄_a·î_Êush
;

740 
gfûe
->
chunk_num
++;

741 
gfûe
->
≥ndög_Àn
 = 0;

744 i‡(
èrgëBuf
 &&Å¨gëBu‡!
gfûe
->
≥ndög_d©a
)

745 
	`bs⁄_‰ì
–
èrgëBuf
 );

746  
ªs
;

747 
	}
}

749 
	$gridfûe_lﬂd_≥ndög_d©a_wôh_pos_chunk
(
gridfûe
 *
gfûe
) {

750 
chunk_Àn
;

751 c⁄° *
chunk_d©a
;

752 
bs⁄_ôî©‹
 
ô
[1];

753 
bs⁄
 
chk
;

754 * 
èrgëBuf„r
 = 
NULL
;

755 
size_t
 
èrgëBuf„rLí
 = 0;

757 
chk
.
d©aSize
 = 0;

758 
	`gridfûe_gë_chunk
(
gfûe
, ()(gfûe->
pos
 / 
DEFAULT_CHUNK_SIZE
), &
chk
);

759 i‡(
chk
.
d©aSize
 <= 5) {

760 if–
chk
.
d©a
 ) {

761 
	`bs⁄_de°roy
–&
chk
 );

763  
MONGO_ERROR
;

765 if–
	`bs⁄_föd
(
ô
, &
chk
, "d©a"Ë!
BSON_EOO
){

766 
chunk_Àn
 = 
	`bs⁄_ôî©‹_bö_Àn
(
ô
);

767 
chunk_d©a
 = 
	`bs⁄_ôî©‹_bö_d©a
(
ô
);

768 
	`gridfs_ªad_fûãr
–&
èrgëBuf„r
, &
èrgëBuf„rLí
, 
chunk_d©a
, (
size_t
)
chunk_Àn
, 
gfûe
->
Êags
 );

769 
gfûe
->
≥ndög_Àn
 = ()
èrgëBuf„rLí
;

770 
gfûe
->
chunk_num
 = ()(gfûe->
pos
 / 
DEFAULT_CHUNK_SIZE
);

771 if–
èrgëBuf„rLí
 ) {

772 
	`mem˝y
(
gfûe
->
≥ndög_d©a
, 
èrgëBuf„r
, 
èrgëBuf„rLí
);

775 
	`bs⁄_de°roy
–&
chk
 );

776  
MONGO_ERROR
;

778 
	`bs⁄_de°roy
–&
chk
 );

779 if–
èrgëBuf„r
 &&Å¨gëBuf„∏!
chunk_d©a
 )

780 
	`bs⁄_‰ì
–
èrgëBuf„r
 );

781  
MONGO_OK
;

782 
	}
}

784 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_wrôe_buf„r
(
gridfûe
 *
gfûe
, c⁄° *
d©a
, 
gridfs_off£t
 
Àngth
) {

786 
bs⁄
 *
oChunk
;

787 
bs⁄
 
q
[1];

788 
size_t
 
buf_pos
, 
buf_byãs_to_wrôe
;

789 
gridfs_off£t
 
byãs_À·
 = 
Àngth
;

790 * 
èrgëBuf
 = 
NULL
;

791 
memAŒoˇãd
 = 0;

793 
gfûe
->
chunk_num
 = ()(gfûe->
pos
 / 
DEFAULT_CHUNK_SIZE
);

794 
buf_pos
 = ()(
gfûe
->
pos
 - (gfûe->po†/ 
DEFAULT_CHUNK_SIZE
) * DEFAULT_CHUNK_SIZE);

798 if–
buf_pos
 ) {

799 if–!
gfûe
->
≥ndög_Àn
 && 
	`gridfûe_lﬂd_≥ndög_d©a_wôh_pos_chunk
–gfûêË!
MONGO_OK
 )  0;

800 
buf_byãs_to_wrôe
 = (
size_t
)
	`MIN
–
Àngth
, 
DEFAULT_CHUNK_SIZE
 - 
buf_pos
 );

801 
	`mem˝y
–&
gfûe
->
≥ndög_d©a
[
buf_pos
], 
d©a
, 
buf_byãs_to_wrôe
);

802 i‡–
buf_byãs_to_wrôe
 + 
buf_pos
 > 
gfûe
->
≥ndög_Àn
 ) {

803 
gfûe
->
≥ndög_Àn
 = 
buf_byãs_to_wrôe
 + 
buf_pos
;

805 
gfûe
->
pos
 +
buf_byãs_to_wrôe
;

806 if–
buf_byãs_to_wrôe
 + 
buf_pos
 >
DEFAULT_CHUNK_SIZE
 && 
	`gridfûe_Êush_≥ndögchunk
(
gfûe
Ë!
MONGO_OK
 )  0;

807 
byãs_À·
 -
buf_byãs_to_wrôe
;

808 
d©a
 +
buf_byãs_to_wrôe
;

813  
byãs_À·
 >
DEFAULT_CHUNK_SIZE
 ) {

814 
ªs
;

815 if–(
oChunk
 = 
	`chunk_√w
–
gfûe
->
id
, gfûe->
chunk_num
, &
èrgëBuf
, 
d©a
, 
DEFAULT_CHUNK_SIZE
, gfûe->
Êags
 )Ë=
NULL
Ë 
Àngth
 - 
byãs_À·
;

816 
memAŒoˇãd
 = 
èrgëBuf
 !
d©a
;

817 
	`gridfûe_¥ï¨e_chunk_key_bs⁄
(
q
, &
gfûe
->
id
, gfûe->
chunk_num
);

818 
ªs
 = 
	`m⁄go_upd©e
(
gfûe
->
gfs
->
˛õ¡
, gfûe->gfs->
chunks_ns
, 
q
, 
oChunk
, 
MONGO_UPDATE_UPSERT
, 
NULL
);

819 
	`bs⁄_de°roy
(
q
 );

820 
	`chunk_‰ì
(
oChunk
);

821 if–
ªs
 !
MONGO_OK
 )  
Àngth
 - 
byãs_À·
;

822 
byãs_À·
 -
DEFAULT_CHUNK_SIZE
;

823 
gfûe
->
chunk_num
++;

824 
gfûe
->
pos
 +
DEFAULT_CHUNK_SIZE
;

825 i‡(
gfûe
->
pos
 > gfûe->
Àngth
) {

826 
gfûe
->
Àngth
 = gfûe->
pos
;

828 
d©a
 +
DEFAULT_CHUNK_SIZE
;

833 i‡–
byãs_À·
 > 0 ) {

837 if–!
gfûe
->
≥ndög_Àn
 && gfûe->
pos
 + 
byãs_À·
 < gfûe->
Àngth
 && 
	`gridfûe_lﬂd_≥ndög_d©a_wôh_pos_chunk
–gfûêË!
MONGO_OK
 )

838  
Àngth
 - 
byãs_À·
;

839 
	`mem˝y
–
gfûe
->
≥ndög_d©a
, 
d©a
, (
size_t
Ë
byãs_À·
 );

840 if–
byãs_À·
 > 
gfûe
->
≥ndög_Àn
 )

841 
gfûe
->
≥ndög_Àn
 = (Ë
byãs_À·
;

842 
gfûe
->
pos
 +
byãs_À·
;

845 if–
memAŒoˇãd
 ){

846 
	`bs⁄_‰ì
–
èrgëBuf
 );

848  
Àngth
;

849 
	}
}

851 
MONGO_EXPORT
 
	$gridfûe_gë_chunk
(
gridfûe
 *
gfûe
, 
n
, 
bs⁄
 *
out
) {

852 
bs⁄
 
quîy
[1];

854 
bs⁄_oid_t
 
id
;

855 
ªsu…
;

857 
	`bs⁄_öô
(
quîy
);

858 
id
 = 
	`gridfûe_gë_id
–
gfûe
 );

859 
	`bs⁄_≠≥nd_oid
(
quîy
, "fûes_id", &
id
);

860 
	`bs⁄_≠≥nd_öt
(
quîy
, "n", 
n
);

861 
	`bs⁄_föish
(
quîy
);

863 
ªsu…
 = (
	`m⁄go_föd_⁄e
(
gfûe
->
gfs
->
˛õ¡
, gfûe->gfs->
chunks_ns
, 
quîy
, 
NULL
, 
out
Ë=
MONGO_OK
);

864 
	`bs⁄_de°roy
(
quîy
);

865 i‡(!
ªsu…
)

866 
	`bs⁄_c›y
(
out
, 
	`bs⁄_sh¨ed_em±y
());

867 
	}
}

869 
MONGO_EXPORT
 
m⁄go_curs‹
 *
	$gridfûe_gë_chunks
(
gridfûe
 *
gfûe
, 
size_t
 
°¨t
, size_à
size
) {

870 
bs⁄_ôî©‹
 
ô
[1];

871 
bs⁄_oid_t
 
id
;

872 
bs⁄
 
gã
[1];

873 
bs⁄
 
quîy
[1];

874 
bs⁄
 
‹dîby
[1];

875 
bs⁄
 
comm™d
[1];

876 
m⁄go_curs‹
 *
curs‹
;

878 if–
	`bs⁄_föd
(
ô
, 
gfûe
->
mëa
, "_id"Ë!
BSON_EOO
)

879 
id
 = *
	`bs⁄_ôî©‹_oid
(
ô
);

881 
id
 = 
gfûe
->id;

883 
	`bs⁄_öô
(
quîy
);

884 
	`bs⁄_≠≥nd_oid
(
quîy
, "fûes_id", &
id
);

885 i‡(
size
 == 1) {

886 
	`bs⁄_≠≥nd_öt
(
quîy
, "n", ()
°¨t
);

888 
	`bs⁄_öô
(
gã
);

889 
	`bs⁄_≠≥nd_öt
(
gã
, "$gã", ()
°¨t
);

890 
	`bs⁄_föish
(
gã
);

891 
	`bs⁄_≠≥nd_bs⁄
(
quîy
, "n", 
gã
);

892 
	`bs⁄_de°roy
(
gã
);

894 
	`bs⁄_föish
(
quîy
);

896 
	`bs⁄_öô
(
‹dîby
);

897 
	`bs⁄_≠≥nd_öt
(
‹dîby
, "n", 1);

898 
	`bs⁄_föish
(
‹dîby
);

900 
	`bs⁄_öô
(
comm™d
);

901 
	`bs⁄_≠≥nd_bs⁄
(
comm™d
, "quîy", 
quîy
);

902 
	`bs⁄_≠≥nd_bs⁄
(
comm™d
, "‹dîby", 
‹dîby
);

903 
	`bs⁄_föish
(
comm™d
);

905 
curs‹
 = 
	`m⁄go_föd
(
gfûe
->
gfs
->
˛õ¡
, gfûe->gfs->
chunks_ns
, 
comm™d
, 
NULL
, ()
size
, 0, 0);

907 
	`bs⁄_de°roy
(
comm™d
);

908 
	`bs⁄_de°roy
(
quîy
);

909 
	`bs⁄_de°roy
(
‹dîby
);

911  
curs‹
;

912 
	}
}

914 
gridfs_off£t
 
gridfûe_ªad_‰om_≥ndög_buf„r
(
gridfûe
 *
gfûe
, gridfs_off£à
tŸÆByãsToRód
, * 
buf
, *
fú°_chunk
);

915 
gridfs_off£t
 
gridfûe_lﬂd_‰om_chunks
(
gridfûe
 *
gfûe
, 
tŸÆ_chunks
, gridfs_off£à
chunksize
, 
m⁄go_curs‹
 *
chunks
, * 
buf
,

916 
gridfs_off£t
 
byãs_À·
);

918 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_ªad_buf„r
–
gridfûe
 *
gfûe
, *
buf
, 
gridfs_off£t
 
size
 ) {

919 
m⁄go_curs‹
 *
chunks
;

921 
fú°_chunk
;

922 
tŸÆ_chunks
;

923 
gridfs_off£t
 
chunksize
;

924 
gridfs_off£t
 
c⁄ã¡Àngth
;

925 
gridfs_off£t
 
byãs_À·
;

926 
gridfs_off£t
 
ªÆSize
 = 0;

928 
c⁄ã¡Àngth
 = 
	`gridfûe_gë_c⁄ã¡Àngth
(
gfûe
);

929 
chunksize
 = 
	`gridfûe_gë_chunksize
(
gfûe
);

930 
size
 = 
	`MIN
–
c⁄ã¡Àngth
 - 
gfûe
->
pos
, size );

931 
byãs_À·
 = 
size
;

933 
fú°_chunk
 = ()((
gfûe
->
pos
Ë/ 
chunksize
);

934 
tŸÆ_chunks
 = ()((
gfûe
->
pos
 + 
size
 - 1Ë/ 
chunksize
Ë- 
fú°_chunk
 + 1;

936 if–(
ªÆSize
 = 
	`gridfûe_ªad_‰om_≥ndög_buf„r
–
gfûe
, 
byãs_À·
, 
buf
, &
fú°_chunk
 )) > 0 ) {

937 
gfûe
->
pos
 +
ªÆSize
;

938 if–--
tŸÆ_chunks
 <= 0) {

939  
ªÆSize
;

941 
buf
 +
ªÆSize
;

942 
byãs_À·
 -
ªÆSize
;

943 if–
	`gridfûe_Êush_≥ndögchunk
–
gfûe
 ) !
MONGO_OK
 ){

945  
ªÆSize
;

949 
chunks
 = 
	`gridfûe_gë_chunks
(
gfûe
, 
fú°_chunk
, 
tŸÆ_chunks
);

950 
ªÆSize
 +
	`gridfûe_lﬂd_‰om_chunks
–
gfûe
, 
tŸÆ_chunks
, 
chunksize
, 
chunks
, 
buf
, 
byãs_À·
);

951 
	`m⁄go_curs‹_de°roy
(
chunks
);

953 
gfûe
->
pos
 +
ªÆSize
;

955  
ªÆSize
;

956 
	}
}

958 
gridfs_off£t
 
	$gridfûe_ªad_‰om_≥ndög_buf„r
(
gridfûe
 *
gfûe
, 
gridfs_off£t
 
tŸÆByãsToRód
, * 
buf
,

959 *
fú°_chunk
){

960 
gridfs_off£t
 
ªÆSize
 = 0;

961 if–
gfûe
->
≥ndög_Àn
 > 0 && *
fú°_chunk
 =gfûe->
chunk_num
) {

962 *
chunk_d©a
;

963 
gridfs_off£t
 
chunksize
 = 
	`gridfûe_gë_chunksize
(
gfûe
);

964 
gridfs_off£t
 
ofs
 = 
gfûe
->
pos
 - gfûe->
chunk_num
 * 
chunksize
;

965 
ªÆSize
 = 
	`MIN
–
tŸÆByãsToRód
, 
gfûe
->
≥ndög_Àn
 - 
ofs
 );

966 
chunk_d©a
 = 
gfûe
->
≥ndög_d©a
 + 
ofs
;

967 
	`mem˝y
–
buf
, 
chunk_d©a
, (
size_t
)
ªÆSize
 );

968 (*
fú°_chunk
)++;

970  
ªÆSize
;

971 
	}
}

973 
gridfs_off£t
 
gridfûe_fûl_buf_‰om_chunk
(
gridfûe
 *
gfûe
, c⁄° 
bs⁄
 *
chunk
, gridfs_off£à
chunksize
, **
buf
, *
ÆloˇãdMem
, **
èrgëBuf
,

974 
size_t
 *
èrgëBufLí
, 
gridfs_off£t
 *
byãs_À·
, 
chunkNo
);

976 
gridfs_off£t
 
	$gridfûe_lﬂd_‰om_chunks
(
gridfûe
 *
gfûe
, 
tŸÆ_chunks
, 
gridfs_off£t
 
chunksize
, 
m⁄go_curs‹
 *
chunks
, * 
buf
,

977 
gridfs_off£t
 
byãs_À·
){

978 
i
;

979 * 
èrgëBuf
 = 
NULL
;

980 
size_t
 
èrgëBufLí
 = 0;

981 
ÆloˇãdMem
 = 0;

982 
gridfs_off£t
 
ªÆSize
 = 0;

984 
i
 = 0; i < 
tŸÆ_chunks
; i++) {

985 if–
	`m⁄go_curs‹_√xt
(
chunks
Ë!
MONGO_OK
 ){

988 
ªÆSize
 +
	`gridfûe_fûl_buf_‰om_chunk
–
gfûe
, &
chunks
->
cuºít
, 
chunksize
, &
buf
, &
ÆloˇãdMem
, &
èrgëBuf
, &
èrgëBufLí
, &
byãs_À·
, 
i
);

990 if–
ÆloˇãdMem
 ) {

991 
	`bs⁄_‰ì
–
èrgëBuf
 );

993  
ªÆSize
;

994 
	}
}

996 
gridfs_off£t
 
	$gridfûe_fûl_buf_‰om_chunk
(
gridfûe
 *
gfûe
, c⁄° 
bs⁄
 *
chunk
, 
gridfs_off£t
 
chunksize
, **
buf
, *
ÆloˇãdMem
, **
èrgëBuf
,

997 
size_t
 *
èrgëBufLí
, 
gridfs_off£t
 *
byãs_À·
, 
chunkNo
){

998 
bs⁄_ôî©‹
 
ô
[1];

999 
gridfs_off£t
 
chunk_Àn
;

1000 c⁄° *
chunk_d©a
;

1002 if–
	`bs⁄_föd
(
ô
, 
chunk
, "d©a"Ë!
BSON_EOO
 ) {

1003 
chunk_Àn
 = 
	`bs⁄_ôî©‹_bö_Àn
(
ô
);

1004 
chunk_d©a
 = 
	`bs⁄_ôî©‹_bö_d©a
(
ô
);

1005 if–
	`gridfs_ªad_fûãr
–
èrgëBuf
, 
èrgëBufLí
, 
chunk_d©a
, (
size_t
)
chunk_Àn
, 
gfûe
->
Êags
 ) != 0)  0;

1006 *
ÆloˇãdMem
 = *
èrgëBuf
 !
chunk_d©a
;

1007 
chunk_d©a
 = *
èrgëBuf
;

1008 i‡(
chunkNo
 == 0) {

1009 
chunk_d©a
 +(
gfûe
->
pos
Ë% 
chunksize
;

1010 *
èrgëBufLí
 -(
size_t
)–(
gfûe
->
pos
Ë% 
chunksize
 );

1012 i‡(*
byãs_À·
 > *
èrgëBufLí
) {

1013 
	`mem˝y
(*
buf
, 
chunk_d©a
, *
èrgëBufLí
);

1014 *
byãs_À·
 -*
èrgëBufLí
;

1015 *
buf
 +*
èrgëBufLí
;

1016  *
èrgëBufLí
;

1018 
	`mem˝y
(*
buf
, 
chunk_d©a
, (
size_t
)(*
byãs_À·
));

1019  *
byãs_À·
;

1022 
	`bs⁄_Áèl_msg
( 0, "Chunk object doesn't have 'data'áttribute" );

1025 
	}
}

1027 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_£ek
(
gridfûe
 *
gfûe
, 
gridfs_off£t
 
off£t
) {

1028 
gridfs_off£t
 
Àngth
;

1029 
gridfs_off£t
 
chunkSize
;

1030 
gridfs_off£t
 
√wPos
;

1032 
chunkSize
 = 
	`gridfûe_gë_chunksize
–
gfûe
 );

1033 
Àngth
 = 
	`gridfûe_gë_c⁄ã¡Àngth
–
gfûe
 );

1034 
√wPos
 = 
	`MIN
–
Àngth
, 
off£t
 );

1037 i‡(
gfûe
->
≥ndög_Àn
 && (
√wPos
 >(gfûe->
chunk_num
 + 1Ë* 
chunkSize
 ||ÇewPos < gfile->chunk_num * chunkSize) &&

1038 
	`gridfûe_Êush_≥ndögchunk
–
gfûe
 ) !
MONGO_OK
 )  gfûe->
pos
;

1039 
gfûe
->
pos
 = 
√wPos
;

1040  
√wPos
;

1041 
	}
}

1043 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_wrôe_fûe
(
gridfûe
 *
gfûe
, 
FILE
 *
°ªam
) {

1044 
buf„r
[
DEFAULT_CHUNK_SIZE
];

1045 
size_t
 
d©a_ªad
, 
d©a_wrôãn
 = 0;

1046 
gridfs_off£t
 
tŸÆ_wrôãn
 = 0;

1049 
d©a_ªad
 = (
size_t
)
	`gridfûe_ªad_buf„r
–
gfûe
, 
buf„r
, 
DEFAULT_CHUNK_SIZE
 );

1050 if–
d©a_ªad
 > 0 ){

1051 
d©a_wrôãn
 = 
	`fwrôe
–
buf„r
, (), 
d©a_ªad
, 
°ªam
 );

1052 
tŸÆ_wrôãn
 +
d©a_wrôãn
;

1054 } –
d©a_ªad
 > 0 ) && ( 
d©a_wrôãn
 == data_read ));

1056  
tŸÆ_wrôãn
;

1057 
	}
}

1059 
	$gridfûe_ªmove_chunks
–
gridfûe
 *
gfûe
, 
dñëeFromChunk
){

1060 
bs⁄
 
q
[1];

1061 
bs⁄_oid_t
 
id
 = 
	`gridfûe_gë_id
–
gfûe
 );

1062 
ªs
;

1064 
	`bs⁄_öô
–
q
 );

1065 
	`bs⁄_≠≥nd_oid
(
q
, "fûes_id", &
id
);

1066 if–
dñëeFromChunk
 >= 0 ) {

1067 
	`bs⁄_≠≥nd_°¨t_obje˘
–
q
, "n" );

1068 
	`bs⁄_≠≥nd_öt
–
q
, "$gã", 
dñëeFromChunk
 );

1069 
	`bs⁄_≠≥nd_föish_obje˘
–
q
 );

1071 
	`bs⁄_föish
–
q
 );

1072 
ªs
 = 
	`m⁄go_ªmove
–
gfûe
->
gfs
->
˛õ¡
, gfûe->gfs->
chunks_ns
, 
q
, 
NULL
);

1073 
	`bs⁄_de°roy
–
q
 );

1074  
ªs
;

1075 
	}
}

1077 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_åunˇã
(
gridfûe
 *
gfûe
, 
gridfs_off£t
 
√wSize
) {

1079 
dñëeFromChunk
;

1081 i‡–
√wSize
 > 
	`gridfûe_gë_c⁄ã¡Àngth
–
gfûe
 ) ) {

1082  
	`gridfûe_£ek
–
gfûe
, 
	`gridfûe_gë_c⁄ã¡Àngth
( gfile ) );

1084 if–
√wSize
 > 0 ) {

1085 
dñëeFromChunk
 = ()(
√wSize
 / 
	`gridfûe_gë_chunksize
–
gfûe
 ));

1086 if–
	`gridfûe_£ek
(
gfûe
, 
√wSize
Ë!√wSizêË gfûe->
Àngth
;

1087 if–
gfûe
->
pos
 % 
	`gridfûe_gë_chunksize
( gfile ) ) {

1088 if–!
gfûe
->
≥ndög_Àn
 && 
	`gridfûe_lﬂd_≥ndög_d©a_wôh_pos_chunk
–gfûêË!
MONGO_OK
 )  gfûe->
Àngth
;

1089 
gfûe
->
≥ndög_Àn
 = gfûe->
pos
 % 
	`gridfûe_gë_chunksize
( gfile );

1090 if–
	`gridfûe_Êush_≥ndögchunk
–
gfûe
 ) !
MONGO_OK
 )  gfûe->
Àngth
;

1091 
dñëeFromChunk
++;

1094 if–
	`gridfûe_ªmove_chunks
–
gfûe
, 
dñëeFromChunk
 ) !
MONGO_OK
 )  gfûe->
Àngth
;

1095 
gfûe
->
Àngth
 = 
√wSize
;

1098 if–
	`gridfûe_ªmove_chunks
–
gfûe
, -1 ) !
MONGO_OK
Ë gfûe->
Àngth
;

1099 
gfûe
->
Àngth
 = 0;

1100 
gfûe
->
pos
 = 0;

1102  
gfûe
->
Àngth
;

1103 
	}
}

1105 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_ex∑nd
(
gridfûe
 *
gfûe
, 
gridfs_off£t
 
byãsToEx∑nd
) {

1106 
gridfs_off£t
 
fûeSize
, 
√wSize
, 
curPos
, 
toWrôe
, 
bufSize
;

1108 * 
buf
;

1110 
fûeSize
 = 
	`gridfûe_gë_c⁄ã¡Àngth
–
gfûe
 );

1111 
√wSize
 = 
fûeSize
 + 
byãsToEx∑nd
;

1112 
curPos
 = 
fûeSize
;

1113 
bufSize
 = 
	`gridfûe_gë_chunksize
 ( 
gfûe
 );

1114 
buf
 = (*)
	`bs⁄_mÆloc
–(
size_t
)
bufSize
 );

1116 
	`mem£t
–
buf
, 0, (
size_t
)
bufSize
 );

1117 
	`gridfûe_£ek
–
gfûe
, 
fûeSize
 );

1119  
curPos
 < 
√wSize
 ) {

1120 
toWrôe
 = 
bufSize
 - 
curPos
 % bufSize;

1121 if–
toWrôe
 + 
curPos
 > 
√wSize
 ) {

1122 
toWrôe
 = 
√wSize
 - 
curPos
;

1125 if–
	`gridfûe_wrôe_buf„r
–
gfûe
, (c⁄° *)
buf
, 
toWrôe
 ) !toWrôeË 
curPos
;

1126 
curPos
 +
toWrôe
;

1129 
	`bs⁄_‰ì
–
buf
 );

1130  
√wSize
;

1131 
	}
}

1133 
MONGO_EXPORT
 
gridfs_off£t
 
	$gridfûe_£t_size
(
gridfûe
 *
gfûe
, 
gridfs_off£t
 
√wSize
) {

1134 
gridfs_off£t
 
fûeSize
;

1136 
fûeSize
 = 
	`gridfûe_gë_c⁄ã¡Àngth
–
gfûe
 );

1137 if–
√wSize
 <
fûeSize
 ) {

1138  
	`gridfûe_åunˇã
–
gfûe
, 
√wSize
 );

1140  
	`gridfûe_ex∑nd
–
gfûe
, 
√wSize
 - 
fûeSize
 );

1142 
	}
}

	@gridfs.h

22 
	~"m⁄go.h
"

24 #i‚de‡
MONGO_GRIDFS_H_


25 
	#MONGO_GRIDFS_H_


	)

27 íum {
	mDEFAULT_CHUNK_SIZE
 = 256 * 1024};

29 
uöt64_t
 
	tgridfs_off£t
;

33 
m⁄go
 *
	m˛õ¡
;

34 c⁄° *
	mdb«me
;

35 c⁄° *
	m¥efix
;

36 c⁄° *
	mfûes_ns
;

37 c⁄° *
	mchunks_ns
;

38 
bs⁄_boﬁ_t
 
	mˇ£In£nsôive
;

39 } 
	tgridfs
;

43 
gridfs
 *
	mgfs
;

44 
bs⁄
 *
	mmëa
;

45 
gridfs_off£t
 
	mpos
;

46 
bs⁄_oid_t
 
	mid
;

47 *
	mªmŸe_«me
;

48 *
	mc⁄ã¡_ty≥
;

49 
gridfs_off£t
 
	mÀngth
;

50 
	mchunk_num
;

51 *
	m≥ndög_d©a
;

52 
size_t
 
	m≥ndög_Àn
;

53 
	mÊags
;

54 
	mchunkSize
;

55 } 
	tgridfûe
;

57 
	egridfûe_°‹age_ty≥
 {

58 
	mGRIDFILE_DEFAULT
 = 0,

59 
	mGRIDFILE_NOMD5
 = ( 1<<0 )

62 #i‚de‡
_MSC_VER


63 *
_°ru¥
(*
°r
);

64 *
_°æwr
(*
°r
);

67 –*
	tgridfs_chunk_fûãr_func
 )–** 
	tèrgëBuf
, 
	tsize_t
* 
	tèrgëLí
, c⁄° * 
	t§cBuf
, size_à
	t§cLí
, 
	tÊags
 );

68 
	$size_t
 ( *
	tgridfs_≥ndög_d©a_size_func
 ) (
	tÊags
);

70 
MONGO_EXPORT
 
gridfs
* 
	`gridfs_Æloc
( );

71 
MONGO_EXPORT
 
	`gridfs_dóŒoc
(
gridfs
* 
gfs
);

72 
MONGO_EXPORT
 
gridfûe
* 
	`gridfûe_¸óã
( );

73 
MONGO_EXPORT
 
	`gridfûe_dóŒoc
(
gridfûe
* 
gf
);

74 
MONGO_EXPORT
 
	`gridfûe_gë_des¸ùt‹
(
gridfûe
* 
gf
, 
bs⁄
* 
out
);

75 
MONGO_EXPORT
 
	`gridfs_£t_chunk_fûãr_funcs
(
gridfs_chunk_fûãr_func
 
wrôeFûãr
, gridfs_chunk_fûãr_fun¯
ªadFûãr
, 
gridfs_≥ndög_d©a_size_func
 
≥ndögD©aNìdedSize
);

86 
MONGO_EXPORT
 
	`gridfs_öô
–
m⁄go
 *
˛õ¡
, c⁄° *
db«me
,

87 c⁄° *
¥efix
, 
gridfs
 *
gfs
 );

95 
MONGO_EXPORT
 
	`gridfs_de°roy
–
gridfs
 *
gfs
 );

105 
MONGO_EXPORT
 
	`gridfûe_öô
–
gridfs
 *
gfs
, c⁄° 
bs⁄
 *
mëa
, 
gridfûe
 *
gfûe
 );

112 
MONGO_EXPORT
 
	`gridfûe_de°roy
–
gridfûe
 *
gfûe
 );

122 
MONGO_EXPORT
 
	`gridfûe_wrôî_öô
–
gridfûe
 *
gfûe
, 
gridfs
 *
gfs
, c⁄° *
ªmŸe_«me
,

123 c⁄° *
c⁄ã¡_ty≥
, 
Êags
 );

135 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_wrôe_buf„r
–
gridfûe
 *
gfûe
, c⁄° *
d©a
, gridfs_off£à
Àngth
 );

144 
MONGO_EXPORT
 
	`gridfûe_wrôî_d⁄e
–
gridfûe
 *
gfûe
 );

156 
MONGO_EXPORT
 
	`gridfs_°‹e_buf„r
–
gridfs
 *
gfs
, c⁄° *
d©a
, 
gridfs_off£t
 
Àngth
,

157 c⁄° *
ªmŸíame
,

158 c⁄° *
c⁄ã¡ty≥
, 
Êags
 );

169 
MONGO_EXPORT
 
	`gridfs_°‹e_fûe
–
gridfs
 *
gfs
, c⁄° *
fûíame
,

170 c⁄° *
ªmŸíame
, c⁄° *
c⁄ã¡ty≥
, 
Êags
 );

181 
MONGO_EXPORT
 
	`gridfs_ªmove_fûíame
–
gridfs
 *
gfs
, c⁄° *
fûíame
 );

193 
MONGO_EXPORT
 
	`gridfs_föd_quîy
–
gridfs
 *
gfs
, c⁄° 
bs⁄
 *
quîy
, 
gridfûe
 *
gfûe
 );

204 
MONGO_EXPORT
 
	`gridfs_föd_fûíame
–
gridfs
 *
gfs
, c⁄° *
fûíame
, 
gridfûe
 *
gfûe
 );

210 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	`gridfûe_exi°s
–c⁄° 
gridfûe
 *
gfûe
 );

218 
MONGO_EXPORT
 c⁄° *
	`gridfûe_gë_fûíame
–c⁄° 
gridfûe
 *
gfûe
 );

226 
MONGO_EXPORT
 
	`gridfûe_gë_chunksize
–c⁄° 
gridfûe
 *
gfûe
 );

235 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_gë_c⁄ã¡Àngth
–c⁄° 
gridfûe
 *
gfûe
 );

245 
MONGO_EXPORT
 c⁄° *
	`gridfûe_gë_c⁄ã¡ty≥
–c⁄° 
gridfûe
 *
gfûe
 );

254 
MONGO_EXPORT
 
bs⁄_d©e_t
 
	`gridfûe_gë_u∂ﬂdd©e
–c⁄° 
gridfûe
 *
gfûe
 );

263 
MONGO_EXPORT
 c⁄° *
	`gridfûe_gë_md5
–c⁄° 
gridfûe
 *
gfûe
 );

272 
MONGO_EXPORT
 
bs⁄_oid_t
 
	`gridfûe_gë_id
–c⁄° 
gridfûe
 *
gfûe
 );

283 
MONGO_EXPORT
 c⁄° *
	`gridfûe_gë_fõld
–
gridfûe
 *
gfûe
,

284 c⁄° *
«me
 );

292 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	`gridfs_gë_ˇ£In£nsôive
–c⁄° 
gridfs
 *
gfs
 );

301 
MONGO_EXPORT
 
	`gridfs_£t_ˇ£In£nsôive
(
gridfs
 *
gfs
, 
bs⁄_boﬁ_t
 
√wVÆue
);

310 
MONGO_EXPORT
 
	`gridfûe_£t_Êags
(
gridfûe
 *
gfûe
, 
Êags
);

318 
MONGO_EXPORT
 
	`gridfûe_gë_Êags
–c⁄° 
gridfûe
 *
gfûe
 );

328 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	`gridfûe_gë_boﬁón
–c⁄° 
gridfûe
 *
gfûe
,

329 c⁄° *
«me
 );

345 
MONGO_EXPORT
 
	`gridfûe_gë_mëad©a
–c⁄° 
gridfûe
 *
gfûe
, 
bs⁄
* 
mëad©a
, 
bs⁄_boﬁ_t
 
c›yD©a
 );

353 
MONGO_EXPORT
 
	`gridfûe_gë_numchunks
–c⁄° 
gridfûe
 *
gfûe
 );

361 
MONGO_EXPORT
 
	`gridfûe_gë_chunk
–
gridfûe
 *
gfûe
, 
n
, 
bs⁄
* 
out
 );

372 
MONGO_EXPORT
 
m⁄go_curs‹
 *
	`gridfûe_gë_chunks
–
gridfûe
 *
gfûe
, 
size_t
 
°¨t
, size_à
size
 );

380 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_wrôe_fûe
–
gridfûe
 *
gfûe
, 
FILE
 *
°ªam
 );

394 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_ªad_buf„r
–
gridfûe
 *
gfûe
, *
buf
, gridfs_off£à
size
 );

406 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_£ek
–
gridfûe
 *
gfûe
, gridfs_off£à
off£t
 );

413 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_åunˇã
(
gridfûe
 *
gfûe
, gridfs_off£à
√wSize
);

420 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_ex∑nd
(
gridfûe
 *
gfûe
, gridfs_off£à
byãsToEx∑nd
);

427 
MONGO_EXPORT
 
gridfs_off£t
 
	`gridfûe_£t_size
(
gridfûe
 *
gfûe
, gridfs_off£à
√wSize
);

	@indexproc.h

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<°rög.h
>

4 
	~<sys/°©.h
>

5 
	~<sys/ty≥s.h
>

6 
	~<uni°d.h
>

7 
	~<°dio.h
>

8 
	~<°dlib.h
>

9 
	~<°rög.h
>

10 
	~<time.h
>

11 
	~<dúít.h
>

13 
	~<R.h
>

14 
	~<Röã∫Æs.h
>

15 
	~<RöãrÁ˚.h
>

17 
	~<R_ext/Arôh.h
>

18 
	~<R_ext/Eº‹.h
>

19 
	~<Rdeföes.h
>

20 
	~"R_ext/Rdy∆ﬂd.h
"

22 #i‚de‡
__INDEP_H__


23 
	#__INDEP_H__


	)

25 
	#SZRSV
 4000

	)

26 
	#INNRSV
 2000

	)

27 
	#SHRSV
 5000

	)

29 
	#STKSPACE
 
SZRSV
+
INNRSV
+
SHRSV


	)

31 
	#MAX_TICKET
 240*10+40

	)

33 
	#IndexFûeName
 "ödexh·.idx"

	)

34 
	#IDXMARK
 "RólTimeHFT0.1"

	)

36 
	#n‹mÆComma
 31

	)

37 
	#TRIEST
 800

	)

38 
	#n‹mÆTaû
 11

	)

40 
	#°rHód
 "v¨ hq_°r_s"

	)

	@lz4.c

42 
	#COMPRESSIONLEVEL
 12

	)

50 
	#NOTCOMPRESSIBLE_CONFIRMATION
 6

	)

57 
	#LZ4_COMPRESSMIN
 0

	)

69 #i‡(
deföed
(
__x86_64__
Ë|| deföed(
__x86_64
Ë|| deföed(
__amd64__
Ë|| deföed(
__amd64
Ë|| deföed(
__µc64__
Ë|| deföed(
_WIN64
Ë|| deföed(
__LP64__
Ë|| deföed(
_LP64
) )

70 
	#LZ4_ARCH64
 1

	)

72 
	#LZ4_ARCH64
 0

	)

77 #i‡(
deföed
(
__BIG_ENDIAN__
Ë|| deföed(
__BIG_ENDIAN
Ë|| deföed(
_BIG_ENDIAN
Ë|| deföed(
_ARCH_PPC
Ë|| deföed(
__PPC__
Ë|| deföed(
__PPC
Ë|| deföed(
PPC
Ë|| deföed(
__powîpc__
Ë|| deföed(
__powîpc
Ë|| deföed(
powîpc
Ë|| ((deföed(
__BYTE_ORDER__
)&&(__BYTE_ORDER__ =
__ORDER_BIG_ENDIAN__
))) )

78 
	#LZ4_BIG_ENDIAN
 1

	)

86 #i‡
deföed
(
__ARM_FEATURE_UNALIGNED
)

87 
	#LZ4_FORCE_UNALIGNED_ACCESS
 1

	)

91 #i‡
deföed
(
_MSC_VER
Ë&& deföed(
_WIN32_WCE
)

92 
	#LZ4_FORCE_SW_BITCOUNT


	)

98 #i‡
__STDC_VERSION__
 >= 199901L

101 
	#ª°ri˘


103 

	)

104 
	#GCC_VERSION
 (
__GNUC__
 * 100 + 
__GNUC_MINOR__
)

	)

106 #ifde‡
_MSC_VER


107 
	#ölöe
 
__f‹˚ölöe


108 #i‡
LZ4_ARCH64


109 #¥agm®
	`öåösic
(
_BôSˇnF‹w¨d64
)

110 #¥agm®
	`öåösic
(
_BôSˇnRevî£64
)

111 #ñ£

	)

112 #¥agm®
öåösic
(
_BôSˇnF‹w¨d
)

113 #¥agm®
öåösic
(
_BôSˇnRevî£
)

117 #ifde‡
_MSC_VER


118 
	#lz4_bsw≠16
(
x
Ë
	`_byãsw≠_ush‹t
(x)

	)

120 
	#lz4_bsw≠16
(
x
Ë((Ë((((xË>> 8Ë& 0xffuË| (((xË& 0xffuË<< 8)))

	)

123 #i‡(
GCC_VERSION
 >302Ë|| (
__INTEL_COMPILER
 >800Ë|| 
deföed
(
__˛™g__
)

124 
	#ex≥˘
(
ex¥
,
vÆue
Ë(
	`__buûtö_ex≥˘
 (”x¥),(vÆue)Ë)

	)

126 
	#ex≥˘
(
ex¥
,
vÆue
Ë”x¥)

	)

129 
	#likñy
(
ex¥
Ë
	`ex≥˘
(”x¥Ë!0, 1)

	)

130 
	#u∆ikñy
(
ex¥
Ë
	`ex≥˘
(”x¥Ë!0, 0)

	)

135 
	~<°dlib.h
>

136 
	~<°rög.h
>

137 
	~"lz4.h
"

142 #i‡
deföed
(
_MSC_VER
)

143 
	#BYTE
 
__öt8


	)

144 
	#U16
 
__öt16


	)

145 
	#U32
 
__öt32


	)

146 
	#S32
 
__öt32


	)

147 
	#U64
 
__öt64


	)

149 
	~<°döt.h
>

150 
	#BYTE
 
uöt8_t


	)

151 
	#U16
 
uöt16_t


	)

152 
	#U32
 
uöt32_t


	)

153 
	#S32
 
öt32_t


	)

154 
	#U64
 
uöt64_t


	)

157 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


158 #¥agm®
∑ck
(
push
, 1)

160 
	s_U16_S
 {

161 
U16
 
	mv
;

162 } 
	tU16_S
;

163 
	s_U32_S
 {

164 
U32
 
	mv
;

165 } 
	tU32_S
;

166 
	s_U64_S
 {

167 
U64
 
	mv
;

168 } 
	tU64_S
;

170 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


171 #¥agm®
∑ck
(
p›
)

174 
	#A64
(
x
Ë(((
U64_S
 *)(x))->
v
)

	)

175 
	#A32
(
x
Ë(((
U32_S
 *)(x))->
v
)

	)

176 
	#A16
(
x
Ë(((
U16_S
 *)(x))->
v
)

	)

181 
	#MINMATCH
 4

	)

183 
	#HASH_LOG
 
COMPRESSIONLEVEL


	)

184 
	#HASHTABLESIZE
 (1 << 
HASH_LOG
)

	)

185 
	#HASH_MASK
 (
HASHTABLESIZE
 - 1)

	)

187 
	#SKIPSTRENGTH
 (
NOTCOMPRESSIBLE_CONFIRMATION
>2?NOTCOMPRESSIBLE_CONFIRMATION:2)

	)

188 
	#STACKLIMIT
 13

	)

189 
	#HEAPMODE
 (
HASH_LOG
>
STACKLIMIT
)

190 
	#COPYLENGTH
 8

	)

191 
	#LASTLITERALS
 5

	)

192 
	#MFLIMIT
 (
COPYLENGTH
+
MINMATCH
)

	)

193 
	#MINLENGTH
 (
MFLIMIT
+1)

	)

195 
	#MAXD_LOG
 16

	)

196 
	#MAX_DISTANCE
 ((1 << 
MAXD_LOG
Ë- 1)

	)

198 
	#ML_BITS
 4

	)

199 
	#ML_MASK
 ((1U<<
ML_BITS
)-1)

	)

200 
	#RUN_BITS
 (8-
ML_BITS
)

	)

201 
	#RUN_MASK
 ((1U<<
RUN_BITS
)-1)

	)

206 #i‡
LZ4_ARCH64


207 
	#STEPSIZE
 8

	)

208 
	#UARCH
 
U64


	)

209 
	#AARCH
 
A64


	)

210 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A64
(dËA64(s); d+=8; s+=8;

	)

211 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d)

	)

212 
	#LZ4_SECURECOPY
(
s
,
d
,
e
Ëi‡(d<eË
	`LZ4_WILDCOPY
(s,d,e)

	)

213 
	#HTYPE
 
U32


	)

214 
	#INITBASE
(
ba£
Ëc⁄° 
BYTE
* c⁄° ba£ = 
ù


	)

216 
	#STEPSIZE
 4

	)

217 
	#UARCH
 
U32


	)

218 
	#AARCH
 
A32


	)

219 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A32
(dËA32(s); d+=4; s+=4;

	)

220 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d); LZ4_COPYSTEP(s,d);

	)

221 
	#LZ4_SECURECOPY
 
LZ4_WILDCOPY


	)

222 
	#HTYPE
 c⁄° 
BYTE
*

	)

223 
	#INITBASE
(
ba£
Ëc⁄° ba£ = 0

	)

226 #i‡(
deföed
(
LZ4_BIG_ENDIAN
Ë&& !deföed(
BIG_ENDIAN_NATIVE_BUT_INCOMPATIBLE
))

227 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ 
U16
 
v
 = 
	`A16
’); v = 
	`lz4_bsw≠16
(v); d = (sË- v; }

	)

228 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
i
Ë{ 
U16
 
v
 = (U16)(i); v = 
	`lz4_bsw≠16
(v); 
	`A16
’Ëv;Ö+=2; }

	)

230 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ d = (sË- 
	`A16
’); }

	)

231 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
v
Ë{ 
	`A16
’Ëv;Ö+=2; }

	)

237 
	sªfTabÀs
 {

238 
HTYPE
 
	mhashTabÀ
[
HASHTABLESIZE
];

244 
	#LZ4_HASH_FUNCTION
(
i
Ë(((iË* 2654435761UË>> ((
MINMATCH
*8)-
HASH_LOG
))

	)

245 
	#LZ4_HASH_VALUE
(
p
Ë
	`LZ4_HASH_FUNCTION
(
	`A32
’))

	)

246 
	#LZ4_WILDCOPY
(
s
,
d
,
e
Ëdÿ{ 
	`LZ4_COPYPACKET
(s,dË} d<e);

	)

247 
	#LZ4_BLINDCOPY
(
s
,
d
,
l
Ë{ 
BYTE
* 
e
=(d)+l; 
	`LZ4_WILDCOPY
(s,d,e); dÛ; }

	)

252 #i‡
LZ4_ARCH64


253 
ölöe
 
	$LZ4_NbComm⁄Byãs
(
U64
 
vÆ
)

256 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

257 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

258 
r
 = 0;

259 
	`_BôSˇnRevî£64
(&
r
, 
vÆ
);

260  ()(
r
 >> 3);

262 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

263  (
	`__buûtö_˛zŒ
(
vÆ
) >> 3);

266 
r
;

267 i‡(!(
vÆ
 >> 32)) {

268 
r
 = 4;

270 
r
 = 0;

271 
vÆ
 >>= 32;

273 i‡(!(
vÆ
 >> 16)) {

274 
r
 += 2;

275 
vÆ
 >>= 8;

277 
vÆ
 >>= 24;

279 
r
 +(!
vÆ
);

280  
r
;

284 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

285 
r
 = 0;

286 
	`_BôSˇnF‹w¨d64
(&
r
, 
vÆ
);

287  ()(
r
 >> 3);

289 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

290  (
	`__buûtö_˘zŒ
(
vÆ
) >> 3);

293 c⁄° 
DeBruijnByãPos
[64] =

296  
DeBruijnByãPos
[((
U64
Ë((
vÆ
 & -val) * 0x0218A392CDABBD3F)) >> 58];

300 
	}
}

304 
ölöe
 
	$LZ4_NbComm⁄Byãs
(
U32
 
vÆ
)

307 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

308 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

309 
r
 = 0;

310 
	`_BôSˇnRevî£
(&
r
, 
vÆ
);

311  ()(
r
 >> 3);

313 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

314  (
	`__buûtö_˛z
(
vÆ
) >> 3);

317 
r
;

318 i‡(!(
vÆ
 >> 16)) {

319 
r
 = 2;

320 
vÆ
 >>= 8;

322 
r
 = 0;

323 
vÆ
 >>= 24;

325 
r
 +(!
vÆ
);

326  
r
;

330 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

331 
r
 = 0;

332 
	`_BôSˇnF‹w¨d
(&
r
, 
vÆ
);

333  ()(
r
 >> 3);

335 #ñi‡
	`deföed
(
__GNUC__
Ë&& (
GCC_VERSION
 >304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

336  (
	`__buûtö_˘z
(
vÆ
) >> 3);

339 c⁄° 
DeBruijnByãPos
[32] =

341  
DeBruijnByãPos
[((
U32
Ë((
vÆ
 & -(
S32
) val) * 0x077CB531U)) >> 27];

345 
	}
}

353 
	$LZ4_com¥essBound
(
isize
)

355  (
isize
 + (isize / 255) + 16);

356 
	}
}

362 
	$LZ4_com¥essCtx
(**
˘x
, c⁄° *
sour˚
, *
de°
, 
isize
)

365 #i‡
HEAPMODE


366 
ªfTabÀs
 *
§t
 = (ªfTabÀ†*)(*
˘x
);

367 
HTYPE
 * 
HashTabÀ
;

370 
HTYPE
 
HashTabÀ
[
HASHTABLESIZE
] = {

374 c⁄° 
BYTE
 *
ù
 = (BYTE *Ë
sour˚
;

375 
	`INITBASE
(
ba£
);

376 c⁄° 
BYTE
 *
™ch‹
 = 
ù
;

377 c⁄° 
BYTE
 *c⁄° 
õnd
 = 
ù
 + 
isize
;

378 c⁄° 
BYTE
 *c⁄° 
mÊimô
 = 
õnd
 - 
MFLIMIT
;

380 
	#m©chlimô
 (
õnd
 - 
LASTLITERALS
)

	)

381 
BYTE
 * 
›
 = (BYTE *Ë
de°
;

382 
Àn
, 
Àngth
;

383 c⁄° 
skùSåígth
 = 
SKIPSTRENGTH
;

384 
U32
 
f‹w¨dH
;

387 i‡(
isize
 < 
MINLENGTH
)

388 
_œ°_lôîÆs
;

390 #i‡
HEAPMODE


391 i‡(*
˘x
 =
NULL
)

393 
§t
 = (
ªfTabÀs
 *)
	`mÆloc
((refTables));

394 *
˘x
 = (*)
§t
;

396 
HashTabÀ
 = (
HTYPE
 *Ë(
§t
->
hashTabÀ
);

397 
	`mem£t
((*)
HashTabÀ
, 0, (
§t
->
hashTabÀ
));

400 ()
˘x
;

405 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)] = i∞- 
ba£
;

406 
ù
++;

407 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(
ù
);

412 
födM©chAâem±s
 = (1U << 
skùSåígth
) + 3;

413 c⁄° 
BYTE
 *
f‹w¨dIp
 = 
ù
;

414 c⁄° 
BYTE
 *
ªf
;

415 
BYTE
 * 
tokí
;

419 
U32
 
h
 = 
f‹w¨dH
;

420 
°ï
 = 
födM©chAâem±s
++ >> 
skùSåígth
;

421 
ù
 = 
f‹w¨dIp
;

422 
f‹w¨dIp
 = 
ù
 + 
°ï
;

423 
u∆ikñy


424 (
f‹w¨dIp
 > 
mÊimô
) {

425 
_œ°_lôîÆs
;

427 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(
f‹w¨dIp
);

428 
ªf
 = 
ba£
 + 
HashTabÀ
[
h
];

429 
HashTabÀ
[
h
] = 
ù
 - 
ba£
;

430 } (
ªf
 < 
ù
 - 
MAX_DISTANCE
Ë|| (
	`A32
(ref) != A32(ip)));

433 (
ù
 > 
™ch‹
Ë&& (
ªf
 > (
BYTE
 *Ë
sour˚
Ë&& 
	`u∆ikñy
(ip[-1] ==Ñef[-1])) {

434 
ù
--;

435 
ªf
--;

439 
Àngth
 = 
ù
 - 
™ch‹
;

440 
tokí
 = 
›
++;

441 i‡(
Àngth
 >()
RUN_MASK
) {

442 *
tokí
 = (
RUN_MASK
 << 
ML_BITS
);

443 
Àn
 = 
Àngth
 - 
RUN_MASK
;

444 ; 
Àn
 > 254;Üen -= 255)

445 *
›
++ = 255;

446 *
›
++ = (
BYTE
Ë
Àn
;

450 *
tokí
 = (
Àngth
 << 
ML_BITS
);

453 
	`LZ4_BLINDCOPY
(
™ch‹
, 
›
, 
Àngth
);

454 
_√xt_m©ch
:

456 
	`LZ4_WRITE_LITTLEENDIAN_16
(
›
, 
ù
 - 
ªf
);

459 
ù
 +
MINMATCH
;

460 
ªf
 +
MINMATCH
;

461 
™ch‹
 = 
ù
;

462 
likñy


463 (
ù
 < 
m©chlimô
 - (
STEPSIZE
 - 1)) {

464 
UARCH
 
diff
 = 
	`AARCH
(
ªf
Ë^ AARCH(
ù
);

465 i‡(!
diff
) {

466 
ù
 +
STEPSIZE
;

467 
ªf
 +
STEPSIZE
;

470 
ù
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

471 
_ídCou¡
;

473 i‡(
LZ4_ARCH64
)

474 i‡((
ù
 < (
m©chlimô
 - 3)Ë&& (
	`A32
(
ªf
) == A32(ip))) {

475 
ù
 += 4;

476 
ªf
 += 4;

478 i‡((
ù
 < (
m©chlimô
 - 1)Ë&& (
	`A16
(
ªf
) == A16(ip))) {

479 
ù
 += 2;

480 
ªf
 += 2;

482 i‡((
ù
 < 
m©chlimô
Ë&& (*
ªf
 == *ip))

483 
ù
++;

484 
_ídCou¡
:

486 
Àn
 = (
ù
 - 
™ch‹
);

487 i‡(
Àn
 >()
ML_MASK
) {

488 *
tokí
 +
ML_MASK
;

489 
Àn
 -
ML_MASK
;

490 ; 
Àn
 > 509;Üen -= 510) {

491 *
›
++ = 255;

492 *
›
++ = 255;

494 i‡(
Àn
 > 254) {

495 
Àn
 -= 255;

496 *
›
++ = 255;

498 *
›
++ = (
BYTE
Ë
Àn
;

502 *
tokí
 +
Àn
;

505 i‡(
ù
 > 
mÊimô
) {

506 
™ch‹
 = 
ù
;

511 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
 - 2)] = i∞- 2 - 
ba£
;

514 
ªf
 = 
ba£
 + 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)];

515 
HashTabÀ
[
	`LZ4_HASH_VALUE
(
ù
)] = i∞- 
ba£
;

516 i‡((
ªf
 > 
ù
 - (
MAX_DISTANCE
 + 1)Ë&& (
	`A32
(ref) == A32(ip))) {

517 
tokí
 = 
›
++;

518 *
tokí
 = 0;

519 
_√xt_m©ch
;

523 
™ch‹
 = 
ù
++;

524 
f‹w¨dH
 = 
	`LZ4_HASH_VALUE
(
ù
);

526 
_œ°_lôîÆs
:

529 
œ°Run
 = 
õnd
 - 
™ch‹
;

530 i‡((
LZ4_COMPRESSMIN
 > 0)

531 && (((
›
 - (
BYTE
 *Ë
de°
Ë+ 
œ°Run
 + 1 + (÷a°Ru¿- 15Ë/ 255)Ë> 
isize
 - 
LZ4_COMPRESSMIN
))

533 i‡(
œ°Run
 >()
RUN_MASK
) {

534 *
›
++ = (
RUN_MASK
 << 
ML_BITS
);

535 
œ°Run
 -
RUN_MASK
;

536 ; 
œ°Run
 > 254;ÜastRun -= 255)

537 *
›
++ = 255;

538 *
›
++ = (
BYTE
Ë
œ°Run
;

542 *
›
++ = (
œ°Run
 << 
ML_BITS
);

543 
	`mem˝y
(
›
, 
™ch‹
, 
õnd
 -ánchor);

544 
›
 +
õnd
 - 
™ch‹
;

548  ()(((*)
›
Ë- 
de°
);

549 
	}
}

552 
	#LZ4_64KLIMIT
 ((1<<16Ë+ (
MFLIMIT
-1))

	)

553 
	#HASHLOG64K
 (
HASH_LOG
+1)

	)

554 
	#HASH64KTABLESIZE
 (1U<<
HASHLOG64K
)

	)

555 
	#LZ4_HASH64K_FUNCTION
(
i
Ë(((iË* 2654435761UË>> ((
MINMATCH
*8)-
HASHLOG64K
))

	)

556 
	#LZ4_HASH64K_VALUE
(
p
Ë
	`LZ4_HASH64K_FUNCTION
(
	`A32
’))

	)

557 
	$LZ4_com¥ess64kCtx
(**
˘x
, c⁄° *
sour˚
, *
de°
, 
isize
)

560 #i‡
HEAPMODE


561 
ªfTabÀs
 *
§t
 = (ªfTabÀ†*)(*
˘x
);

562 
U16
 * 
HashTabÀ
;

565 
U16
 
HashTabÀ
[
HASH64KTABLESIZE
] = {

569 c⁄° 
BYTE
 *
ù
 = (BYTE *Ë
sour˚
;

570 c⁄° 
BYTE
 *
™ch‹
 = 
ù
;

571 c⁄° 
BYTE
 *c⁄° 
ba£
 = 
ù
;

572 c⁄° 
BYTE
 *c⁄° 
õnd
 = 
ù
 + 
isize
;

573 c⁄° 
BYTE
 *c⁄° 
mÊimô
 = 
õnd
 - 
MFLIMIT
;

575 
	#m©chlimô
 (
õnd
 - 
LASTLITERALS
)

	)

576 
BYTE
 * 
›
 = (BYTE *Ë
de°
;

577 
Àn
, 
Àngth
;

578 c⁄° 
skùSåígth
 = 
SKIPSTRENGTH
;

579 
U32
 
f‹w¨dH
;

582 i‡(
isize
 < 
MINLENGTH
)

583 
_œ°_lôîÆs
;

585 #i‡
HEAPMODE


586 i‡(*
˘x
 =
NULL
)

588 
§t
 = (
ªfTabÀs
 *)
	`mÆloc
((refTables));

589 *
˘x
 = (*)
§t
;

591 
HashTabÀ
 = (
U16
 *Ë(
§t
->
hashTabÀ
);

592 
	`mem£t
((*)
HashTabÀ
, 0, (
§t
->
hashTabÀ
));

595 ()
˘x
;

600 
ù
++;

601 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(
ù
);

606 
födM©chAâem±s
 = (1U << 
skùSåígth
) + 3;

607 c⁄° 
BYTE
 *
f‹w¨dIp
 = 
ù
;

608 c⁄° 
BYTE
 *
ªf
;

609 
BYTE
 * 
tokí
;

613 
U32
 
h
 = 
f‹w¨dH
;

614 
°ï
 = 
födM©chAâem±s
++ >> 
skùSåígth
;

615 
ù
 = 
f‹w¨dIp
;

616 
f‹w¨dIp
 = 
ù
 + 
°ï
;

617 i‡(
f‹w¨dIp
 > 
mÊimô
) {

618 
_œ°_lôîÆs
;

620 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(
f‹w¨dIp
);

621 
ªf
 = 
ba£
 + 
HashTabÀ
[
h
];

622 
HashTabÀ
[
h
] = 
ù
 - 
ba£
;

623 } 
	`A32
(
ªf
Ë!A32(
ù
));

626 (
ù
 > 
™ch‹
Ë&& (
ªf
 > (
BYTE
 *Ë
sour˚
) && (ip[-1] ==Ñef[-1])) {

627 
ù
--;

628 
ªf
--;

632 
Àngth
 = 
ù
 - 
™ch‹
;

633 
tokí
 = 
›
++;

634 i‡(
Àngth
 >()
RUN_MASK
) {

635 *
tokí
 = (
RUN_MASK
 << 
ML_BITS
);

636 
Àn
 = 
Àngth
 - 
RUN_MASK
;

637 ; 
Àn
 > 254;Üen -= 255)

638 *
›
++ = 255;

639 *
›
++ = (
BYTE
Ë
Àn
;

643 *
tokí
 = (
Àngth
 << 
ML_BITS
);

646 
	`LZ4_BLINDCOPY
(
™ch‹
, 
›
, 
Àngth
);

647 
_√xt_m©ch
:

649 
	`LZ4_WRITE_LITTLEENDIAN_16
(
›
, 
ù
 - 
ªf
);

652 
ù
 +
MINMATCH
;

653 
ªf
 +
MINMATCH
;

654 
™ch‹
 = 
ù
;

655 
ù
 < 
m©chlimô
 - (
STEPSIZE
 - 1))

657 
UARCH
 
diff
 = 
	`AARCH
(
ªf
Ë^ AARCH(
ù
);

658 i‡(!
diff
) {

659 
ù
 +
STEPSIZE
;

660 
ªf
 +
STEPSIZE
;

663 
ù
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

664 
_ídCou¡
;

666 i‡(
LZ4_ARCH64
)

667 i‡((
ù
 < (
m©chlimô
 - 3)Ë&& (
	`A32
(
ªf
) == A32(ip))) {

668 
ù
 += 4;

669 
ªf
 += 4;

671 i‡((
ù
 < (
m©chlimô
 - 1)Ë&& (
	`A16
(
ªf
) == A16(ip))) {

672 
ù
 += 2;

673 
ªf
 += 2;

675 i‡((
ù
 < 
m©chlimô
Ë&& (*
ªf
 == *ip))

676 
ù
++;

677 
_ídCou¡
:

679 
Àn
 = (
ù
 - 
™ch‹
);

680 i‡(
Àn
 >()
ML_MASK
) {

681 *
tokí
 +
ML_MASK
;

682 
Àn
 -
ML_MASK
;

683 ; 
Àn
 > 509;Üen -= 510) {

684 *
›
++ = 255;

685 *
›
++ = 255;

687 i‡(
Àn
 > 254) {

688 
Àn
 -= 255;

689 *
›
++ = 255;

691 *
›
++ = (
BYTE
Ë
Àn
;

695 *
tokí
 +
Àn
;

698 i‡(
ù
 > 
mÊimô
) {

699 
™ch‹
 = 
ù
;

704 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
 - 2)] = i∞- 2 - 
ba£
;

707 
ªf
 = 
ba£
 + 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
)];

708 
HashTabÀ
[
	`LZ4_HASH64K_VALUE
(
ù
)] = i∞- 
ba£
;

709 i‡(
	`A32
(
ªf
Ë=A32(
ù
)) {

710 
tokí
 = 
›
++;

711 *
tokí
 = 0;

712 
_√xt_m©ch
;

716 
™ch‹
 = 
ù
++;

717 
f‹w¨dH
 = 
	`LZ4_HASH64K_VALUE
(
ù
);

719 
_œ°_lôîÆs
:

722 
œ°Run
 = 
õnd
 - 
™ch‹
;

723 i‡((
LZ4_COMPRESSMIN
 > 0)

724 && (((
›
 - (
BYTE
 *Ë
de°
Ë+ 
œ°Run
 + 1 + (÷a°Ru¿- 15Ë/ 255)Ë> 
isize
 - 
LZ4_COMPRESSMIN
))

726 i‡(
œ°Run
 >()
RUN_MASK
) {

727 *
›
++ = (
RUN_MASK
 << 
ML_BITS
);

728 
œ°Run
 -
RUN_MASK
;

729 ; 
œ°Run
 > 254;ÜastRun -= 255)

730 *
›
++ = 255;

731 *
›
++ = (
BYTE
Ë
œ°Run
;

735 *
›
++ = (
œ°Run
 << 
ML_BITS
);

736 
	`mem˝y
(
›
, 
™ch‹
, 
õnd
 -ánchor);

737 
›
 +
õnd
 - 
™ch‹
;

741  ()(((*)
›
Ë- 
de°
);

742 
	}
} 
	$LZ4_com¥ess
(c⁄° *
sour˚
, *
de°
, 
isize
)

745 #i‡
HEAPMODE


746 *
˘x
 = 
	`mÆloc
((
ªfTabÀs
));

747 
ªsu…
;

748 i‡(
isize
 < 
LZ4_64KLIMIT
)

749 
ªsu…
 = 
	`LZ4_com¥ess64kCtx
(&
˘x
, 
sour˚
, 
de°
, 
isize
);

752 
ªsu…
 = 
	`LZ4_com¥essCtx
(&
˘x
, 
sour˚
, 
de°
, 
isize
);

753 
	`‰ì
(
˘x
);

754  
ªsu…
;

757 i‡(
isize
 < ()
LZ4_64KLIMIT
)

758  
	`LZ4_com¥ess64kCtx
(
NULL
, 
sour˚
, 
de°
, 
isize
);

759  
	`LZ4_com¥essCtx
(
NULL
, 
sour˚
, 
de°
, 
isize
);

762 
	}
}

774 
	$LZ4_uncom¥ess
(c⁄° *
sour˚
, *
de°
, 
osize
)

778 c⁄° 
BYTE
 *
ª°ri˘
 
ù
 = (c⁄° BYTE *)
sour˚
;

779 c⁄° 
BYTE
 *
ª°ri˘
 
ªf
;

780 
BYTE
 * 
ª°ri˘
 
›
 = (BYTE *Ë
de°
;

781 
BYTE
 * c⁄° 
€nd
 = 
›
 + 
osize
;

782 
BYTE
 * 
˝y
;

783 
BYTE
 
tokí
;

784 
Àn
, 
Àngth
;

785 
size_t
 
dec
[] = {

793 
tokí
 = *
ù
++;

794 i‡((
Àngth
 = (
tokí
 >> 
ML_BITS
)Ë=
RUN_MASK
) {

795 ; (
Àn
 = *
ù
++Ë=255; 
Àngth
 += 255) {

797 
Àngth
 +
Àn
;

801 
˝y
 = 
›
 + 
Àngth
;

802 
u∆ikñy


803 (
˝y
 > 
€nd
 - 
COPYLENGTH
) {

804 i‡(
˝y
 > 
€nd
)

805 
_ouçut_îr‹
;

806 
	`mem˝y
(
›
, 
ù
, 
Àngth
);

807 
ù
 +
Àngth
;

810 
	`LZ4_WILDCOPY
(
ù
, 
›
, 
˝y
);

811 
ù
 -(
›
 - 
˝y
);

812 
›
 = 
˝y
;

815 
	`LZ4_READ_LITTLEENDIAN_16
(
ªf
, 
˝y
, 
ù
);

816 
ù
 += 2;

817 i‡(
ªf
 < (
BYTE
 * c⁄°)
de°
)

818 
_ouçut_îr‹
;

821 i‡((
Àngth
 = (
tokí
 & 
ML_MASK
)) == ML_MASK) {

822 ; *
ù
 =255; 
Àngth
 += 255) {

823 
ù
++;

825 
Àngth
 +*
ù
++;

829 
u∆ikñy


830 (
›
 - 
ªf
 < 
STEPSIZE
) {

832 #i‡
LZ4_ARCH64


833 
size_t
 
dec2èbÀ
[] = {

835 
size_t
 
dec2
 = 
dec2èbÀ
[
›
 - 
ªf
];

838 c⁄° 
dec2
 = 0;

841 *
›
++ = *
ªf
++;

842 *
›
++ = *
ªf
++;

843 *
›
++ = *
ªf
++;

844 *
›
++ = *
ªf
++;

845 
ªf
 -
dec
[
›
 -Ñef];

846 
	`A32
(
›
ËA32(
ªf
);

847 
›
 +
STEPSIZE
 - 4;

848 
ªf
 -
dec2
;

850 
	`LZ4_COPYSTEP
(
ªf
, 
›
);

852 
˝y
 = 
›
 + 
Àngth
 - (
STEPSIZE
 - 4);

853 i‡(
˝y
 > 
€nd
 - 
COPYLENGTH
)

855 i‡(
˝y
 > 
€nd
)

856 
_ouçut_îr‹
;

857 
	`LZ4_SECURECOPY
(
ªf
, 
›
, (
€nd
 - 
COPYLENGTH
));

858 
›
 < 
˝y
)

859 *
›
++ = *
ªf
++;

860 
›
 = 
˝y
;

861 i‡(
›
 =
€nd
)

865 
	`LZ4_SECURECOPY
(
ªf
, 
›
, 
˝y
);

866 
›
 = 
˝y
;

870  ()(((*)
ù
Ë- 
sour˚
);

873 
_ouçut_îr‹
:  ()(-(((*)
ù
Ë- 
sour˚
));

874 
	}
} 
	$LZ4_uncom¥ess_unknownOuçutSize
–c⁄° *
sour˚
, *
de°
, 
isize
, 
maxOuçutSize
)

878 c⁄° 
BYTE
 *
ª°ri˘
 
ù
 = (c⁄° BYTE *)
sour˚
;

879 c⁄° 
BYTE
 *c⁄° 
õnd
 = 
ù
 + 
isize
;

880 c⁄° 
BYTE
 *
ª°ri˘
 
ªf
;

881 
BYTE
 * 
ª°ri˘
 
›
 = (BYTE *Ë
de°
;

882 
BYTE
 * c⁄° 
€nd
 = 
›
 + 
maxOuçutSize
;

883 
BYTE
 * 
˝y
;

884 
size_t
 
dec
[] = {

888 
ù
 < 
õnd
)

890 
BYTE
 
tokí
;

891 
Àngth
;

894 
tokí
 = *
ù
++;

895 i‡((
Àngth
 = (
tokí
 >> 
ML_BITS
)Ë=
RUN_MASK
) {

896 
s
 = 255;

897 (
ù
 < 
õnd
Ë&& (
s
 == 255)) {

898 
s
 = *
ù
++;

899 
Àngth
 +
s
;

904 
˝y
 = 
›
 + 
Àngth
;

905 i‡((
˝y
 > 
€nd
 - 
COPYLENGTH
Ë|| (
ù
 + 
Àngth
 > 
õnd
 - COPYLENGTH))

907 i‡(
˝y
 > 
€nd
)

908 
_ouçut_îr‹
;

909 i‡(
ù
 + 
Àngth
 > 
õnd
)

910 
_ouçut_îr‹
;

911 
	`mem˝y
(
›
, 
ù
, 
Àngth
);

912 
›
 +
Àngth
;

913 
ù
 +
Àngth
;

914 i‡(
ù
 < 
õnd
)

915 
_ouçut_îr‹
;

918 
	`LZ4_WILDCOPY
(
ù
, 
›
, 
˝y
);

919 
ù
 -(
›
 - 
˝y
);

920 
›
 = 
˝y
;

923 
	`LZ4_READ_LITTLEENDIAN_16
(
ªf
, 
˝y
, 
ù
);

924 
ù
 += 2;

925 i‡(
ªf
 < (
BYTE
 * c⁄°)
de°
)

926 
_ouçut_îr‹
;

929 i‡((
Àngth
 = (
tokí
 & 
ML_MASK
)) == ML_MASK) {

930 
ù
 < 
õnd
) {

931 
s
 = *
ù
++;

932 
Àngth
 +
s
;

933 i‡(
s
 == 255)

940 
u∆ikñy


941 (
›
 - 
ªf
 < 
STEPSIZE
) {

943 #i‡
LZ4_ARCH64


944 
size_t
 
dec2èbÀ
[] = {

946 
size_t
 
dec2
 = 
dec2èbÀ
[
›
 - 
ªf
];

949 c⁄° 
dec2
 = 0;

952 *
›
++ = *
ªf
++;

953 *
›
++ = *
ªf
++;

954 *
›
++ = *
ªf
++;

955 *
›
++ = *
ªf
++;

956 
ªf
 -
dec
[
›
 -Ñef];

957 
	`A32
(
›
ËA32(
ªf
);

958 
›
 +
STEPSIZE
 - 4;

959 
ªf
 -
dec2
;

961 
	`LZ4_COPYSTEP
(
ªf
, 
›
);

963 
˝y
 = 
›
 + 
Àngth
 - (
STEPSIZE
 - 4);

964 i‡(
˝y
 > 
€nd
 - 
COPYLENGTH
)

966 i‡(
˝y
 > 
€nd
)

967 
_ouçut_îr‹
;

968 
	`LZ4_SECURECOPY
(
ªf
, 
›
, (
€nd
 - 
COPYLENGTH
));

969 
›
 < 
˝y
)

970 *
›
++ = *
ªf
++;

971 
›
 = 
˝y
;

972 i‡(
›
 =
€nd
)

976 
	`LZ4_SECURECOPY
(
ªf
, 
›
, 
˝y
);

977 
›
 = 
˝y
;

981  ()(((*)
›
Ë- 
de°
);

984 
_ouçut_îr‹
:  ()(-(((*)
ù
Ë- 
sour˚
));

985 
	}
}

	@lz4.h

34 #¥agm®
⁄˚


36 #i‡
deföed
 (
__˝lu•lus
)

45 
LZ4_com¥ess
 (c⁄° * 
sour˚
, * 
de°
, 
isize
);

46 
LZ4_uncom¥ess
 (c⁄° * 
sour˚
, * 
de°
, 
osize
);

70 
LZ4_com¥essBound
(
isize
);

83 
LZ4_uncom¥ess_unknownOuçutSize
 (c⁄° * 
sour˚
, * 
de°
, 
isize
, 
maxOuçutSize
);

97 
LZ4_com¥essCtx
(** 
˘x
, c⁄° * 
sour˚
, * 
de°
, 
isize
);

98 
LZ4_com¥ess64kCtx
(** 
˘x
, c⁄° * 
sour˚
, * 
de°
, 
isize
);

118 #i‡
deföed
 (
__˝lu•lus
)

	@lz4hc.c

38 #i‡(
deföed
(
__x86_64__
Ë|| deföed(
__x86_64
Ë|| deföed(
__amd64__
Ë|| deföed(
__amd64
Ë|| deföed(
__µc64__
Ë|| deföed(
_WIN64
Ë|| deföed(
__LP64__
Ë|| deföed(
_LP64
) )

39 
	#LZ4_ARCH64
 1

	)

41 
	#LZ4_ARCH64
 0

	)

45 #i‡(
deföed
(
__BIG_ENDIAN__
Ë|| deföed(
__BIG_ENDIAN
Ë|| deföed(
_BIG_ENDIAN
Ë|| deföed(
_ARCH_PPC
Ë|| deföed(
__PPC__
Ë|| deföed(
__PPC
Ë|| deföed(
PPC
Ë|| deföed(
__powîpc__
Ë|| deföed(
__powîpc
Ë|| deföed(
powîpc
Ë|| ((deföed(
__BYTE_ORDER__
)&&(__BYTE_ORDER__ =
__ORDER_BIG_ENDIAN__
))) )

46 
	#LZ4_BIG_ENDIAN
 1

	)

54 #i‡
deföed
(
__ARM_FEATURE_UNALIGNED
)

55 
	#LZ4_FORCE_UNALIGNED_ACCESS
 1

	)

61 #i‡
__STDC_VERSION__
 >= 199901L

64 
	#ª°ri˘


66 

	)

67 #ifde‡
_MSC_VER


68 
	#ölöe
 
__f‹˚ölöe


70 

	)

71 #ifde‡
_MSC_VER


72 
	#bsw≠16
(
x
Ë
	`_byãsw≠_ush‹t
(x)

	)

74 
	#bsw≠16
(
x
Ë((Ë((((xË>> 8Ë& 0xffuË| (((xË& 0xffuË<< 8)))

	)

80 
	~<°dlib.h
>

81 
	~<°rög.h
>

82 
	~"lz4hc.h
"

84 
	#ALLOCATOR
(
s
Ë
	`ˇŒoc
(1,s)

	)

85 
	#FREEMEM
 
‰ì


	)

86 
	#MEM_INIT
 
mem£t


	)

91 #i‡
deföed
(
_MSC_VER
)

92 
	#BYTE
 
__öt8


	)

93 
	#U16
 
__öt16


	)

94 
	#U32
 
__öt32


	)

95 
	#S32
 
__öt32


	)

96 
	#U64
 
__öt64


	)

98 
	~<°döt.h
>

99 
	#BYTE
 
uöt8_t


	)

100 
	#U16
 
uöt16_t


	)

101 
	#U32
 
uöt32_t


	)

102 
	#S32
 
öt32_t


	)

103 
	#U64
 
uöt64_t


	)

106 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


107 #¥agm®
∑ck
(
push
, 1)

109 
	s_U16_S
 {

110 
U16
 
	mv
;

111 } 
	tU16_S
;

112 
	s_U32_S
 {

113 
U32
 
	mv
;

114 } 
	tU32_S
;

115 
	s_U64_S
 {

116 
U64
 
	mv
;

117 } 
	tU64_S
;

119 #i‚de‡
LZ4_FORCE_UNALIGNED_ACCESS


120 #¥agm®
∑ck
(
p›
)

123 
	#A64
(
x
Ë(((
U64_S
 *)(x))->
v
)

	)

124 
	#A32
(
x
Ë(((
U32_S
 *)(x))->
v
)

	)

125 
	#A16
(
x
Ë(((
U16_S
 *)(x))->
v
)

	)

130 
	#MINMATCH
 4

	)

132 
	#DICTIONARY_LOGSIZE
 16

	)

133 
	#MAXD
 (1<<
DICTIONARY_LOGSIZE
)

	)

134 
	#MAXD_MASK
 ((
U32
)(
MAXD
 - 1))

	)

135 
	#MAX_DISTANCE
 (
MAXD
 - 1)

	)

137 
	#HASH_LOG
 (
DICTIONARY_LOGSIZE
-1)

	)

138 
	#HASHTABLESIZE
 (1 << 
HASH_LOG
)

	)

139 
	#HASH_MASK
 (
HASHTABLESIZE
 - 1)

	)

141 
	#MAX_NB_ATTEMPTS
 256

	)

143 
	#ML_BITS
 4

	)

144 
	#ML_MASK
 (
size_t
)((1U<<
ML_BITS
)-1)

	)

145 
	#RUN_BITS
 (8-
ML_BITS
)

	)

146 
	#RUN_MASK
 ((1U<<
RUN_BITS
)-1)

	)

148 
	#COPYLENGTH
 8

	)

149 
	#LASTLITERALS
 5

	)

150 
	#MFLIMIT
 (
COPYLENGTH
+
MINMATCH
)

	)

151 
	#MINLENGTH
 (
MFLIMIT
+1)

	)

152 
	#OPTIMAL_ML
 ()((
ML_MASK
-1)+
MINMATCH
)

	)

157 #i‡
LZ4_ARCH64


158 
	#STEPSIZE
 8

	)

159 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A64
(dËA64(s); d+=8; s+=8;

	)

160 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d)

	)

161 
	#UARCH
 
U64


	)

162 
	#AARCH
 
A64


	)

163 
	#HTYPE
 
U32


	)

164 
	#INITBASE
(
b
,
s
Ëc⁄° 
BYTE
* c⁄° b = 
	)
s

166 
	#STEPSIZE
 4

	)

167 
	#LZ4_COPYSTEP
(
s
,
d
Ë
	`A32
(dËA32(s); d+=4; s+=4;

	)

168 
	#LZ4_COPYPACKET
(
s
,
d
Ë
	`LZ4_COPYSTEP
(s,d); LZ4_COPYSTEP(s,d);

	)

169 
	#UARCH
 
U32


	)

170 
	#AARCH
 
A32


	)

171 
	#HTYPE
 c⁄° 
BYTE
*

	)

172 
	#INITBASE
(
b
,
s
Ëc⁄° b = 0

	)

175 #i‡
deföed
(
LZ4_BIG_ENDIAN
)

176 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ 
U16
 
v
 = 
	`A16
’); v = 
	`bsw≠16
(v); d = (sË- v; }

	)

177 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
i
Ë{ 
U16
 
v
 = (U16)(i); v = 
	`bsw≠16
(v); 
	`A16
’Ëv;Ö+=2; }

	)

179 
	#LZ4_READ_LITTLEENDIAN_16
(
d
,
s
,
p
Ë{ d = (sË- 
	`A16
’); }

	)

180 
	#LZ4_WRITE_LITTLEENDIAN_16
(
p
,
v
Ë{ 
	`A16
’Ëv;Ö+=2; }

	)

187 c⁄° 
BYTE
 *
	mba£
;

188 
HTYPE
 
	mhashTabÀ
[
HASHTABLESIZE
];

189 
U16
 
	mchaöTabÀ
[
MAXD
];

190 c⁄° 
BYTE
 *
	m√xtToUpd©e
;

191 } 
	tLZ4HC_D©a_Såu˘uª
;

196 
	#LZ4_WILDCOPY
(
s
,
d
,
e
Ëdÿ{ 
	`LZ4_COPYPACKET
(s,dË} d<e);

	)

197 
	#LZ4_BLINDCOPY
(
s
,
d
,
l
Ë{ 
BYTE
* 
e
=d+l; 
	`LZ4_WILDCOPY
(s,d,e); dÛ; }

	)

198 
	#HASH_FUNCTION
(
i
Ë(((iË* 2654435761UË>> ((
MINMATCH
*8)-
HASH_LOG
))

	)

199 
	#HASH_VALUE
(
p
Ë
	`HASH_FUNCTION
(*(
U32
*)’))

	)

200 
	#HASH_POINTER
(
p
Ë(
HashTabÀ
[
	`HASH_VALUE
’)] + 
ba£
)

	)

201 
	#DELTANEXT
(
p
Ë
chaöTabÀ
[(
size_t
)’Ë& 
MAXD_MASK
]

	)

202 
	#GETNEXT
(
p
Ë(’Ë- (
size_t
)
	`DELTANEXT
’))

	)

203 
	#ADD_HASH
(
p
Ë{ 
size_t
 
dñè
 = (pË- 
	`HASH_POINTER
’); i‡(dñè>
MAX_DISTANCE
Ëdñè = MAX_DISTANCE; 
	`DELTANEXT
’Ë(
U16
)dñè; 
HashTabÀ
[
	`HASH_VALUE
’)] = (pË- 
ba£
; }

	)

208 #i‡
LZ4_ARCH64


209 
ölöe
 
	$LZ4_NbComm⁄Byãs
(
U64
 
vÆ
)

212 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

213 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

214 
r
 = 0;

215 
	`_BôSˇnRevî£64
(&
r
, 
vÆ
);

216  ()(
r
 >> 3);

218 #ñi‡
	`deföed
(
__GNUC__
Ë&& ((__GNUC__ * 100 + 
__GNUC_MINOR__
Ë>304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

219  (
	`__buûtö_˛zŒ
(
vÆ
) >> 3);

222 
r
;

223 i‡(!(
vÆ
 >> 32)) {

224 
r
 = 4;

226 
r
 = 0;

227 
vÆ
 >>= 32;

229 i‡(!(
vÆ
 >> 16)) {

230 
r
 += 2;

231 
vÆ
 >>= 8;

233 
vÆ
 >>= 24;

235 
r
 +(!
vÆ
);

236  
r
;

240 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

241 
r
 = 0;

242 
	`_BôSˇnF‹w¨d64
(&
r
, 
vÆ
);

243  ()(
r
 >> 3);

245 #ñi‡
	`deföed
(
__GNUC__
Ë&& ((__GNUC__ * 100 + 
__GNUC_MINOR__
Ë>304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

246  (
	`__buûtö_˘zŒ
(
vÆ
) >> 3);

249 c⁄° 
DeBruijnByãPos
[64] =

252  
DeBruijnByãPos
[((
U64
Ë((
vÆ
 & -val) * 0x0218A392CDABBD3F)) >> 58];

256 
	}
}

260 
ölöe
 
	$LZ4_NbComm⁄Byãs
(
U32
 
vÆ
)

263 #i‡
	`deföed
(
LZ4_BIG_ENDIAN
)

264 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

265 
r
 = 0;

266 
	`_BôSˇnRevî£
(&
r
, 
vÆ
);

267  ()(
r
 >> 3);

269 #ñi‡
	`deföed
(
__GNUC__
Ë&& ((__GNUC__ * 100 + 
__GNUC_MINOR__
Ë>304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

270  (
	`__buûtö_˛z
(
vÆ
) >> 3);

273 
r
;

274 i‡(!(
vÆ
 >> 16)) {

275 
r
 = 2;

276 
vÆ
 >>= 8;

278 
r
 = 0;

279 
vÆ
 >>= 24;

281 
r
 +(!
vÆ
);

282  
r
;

286 #i‡
	`deföed
(
_MSC_VER
Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

287 
r
 = 0;

288 
	`_BôSˇnF‹w¨d
(&
r
, 
vÆ
);

289  ()(
r
 >> 3);

291 #ñi‡
	`deföed
(
__GNUC__
Ë&& ((__GNUC__ * 100 + 
__GNUC_MINOR__
Ë>304Ë&& !deföed(
LZ4_FORCE_SW_BITCOUNT
)

292  (
	`__buûtö_˘z
(
vÆ
) >> 3);

295 c⁄° 
DeBruijnByãPos
[32] =

297  
DeBruijnByãPos
[((
U32
Ë((
vÆ
 & -(
S32
) val) * 0x077CB531U)) >> 27];

301 
	}
}

305 
ölöe
 
	$LZ4HC_Inô
(
LZ4HC_D©a_Såu˘uª
 * 
hc4
, c⁄° 
BYTE
 * 
ba£
)

307 
	`MEM_INIT
((*)
hc4
->
hashTabÀ
, 0, (hc4->hashTable));

308 
	`MEM_INIT
(
hc4
->
chaöTabÀ
, 0xFF, (hc4->chainTable));

309 
hc4
->
√xtToUpd©e
 = 
ba£
 + 
LZ4_ARCH64
;

310 
hc4
->
ba£
 = base;

312 
	}
}

314 
ölöe
 *
	$LZ4HC_Cª©e
(c⁄° 
BYTE
 * 
ba£
)

316 *
hc4
 = 
	`ALLOCATOR
((
LZ4HC_D©a_Såu˘uª
));

317 
	`LZ4HC_Inô
(
hc4
, 
ba£
);

318  
hc4
;

319 
	}
}

321 
ölöe
 
	$LZ4HC_Fªe
(**
LZ4HC_D©a
)

323 
	`FREEMEM
(*
LZ4HC_D©a
);

324 *
LZ4HC_D©a
 = 
NULL
;

326 
	}
}

328 
ölöe
 
	$LZ4HC_In£π
(
LZ4HC_D©a_Såu˘uª
 * 
hc4
, c⁄° 
BYTE
 * 
ù
)

330 
U16
 * 
chaöTabÀ
 = 
hc4
->chainTable;

331 
HTYPE
 * 
HashTabÀ
 = 
hc4
->
hashTabÀ
;

332 
	`INITBASE
(
ba£
, 
hc4
->base);

333 
hc4
->
√xtToUpd©e
 < 
ù
)

335 
	`ADD_HASH
(
hc4
->
√xtToUpd©e
);

336 
hc4
->
√xtToUpd©e
++;

338 
	}
}

340 
ölöe
 
	$LZ4HC_In£πAndFödBe°M©ch
(
LZ4HC_D©a_Såu˘uª
 * 
hc4
, c⁄° 
BYTE
 * 
ù
,

341 c⁄° 
BYTE
 * c⁄° 
m©chlimô
, c⁄° BYTE ** 
m©chpos
)

343 
U16
 * c⁄° 
chaöTabÀ
 = 
hc4
->chainTable;

344 
HTYPE
 * c⁄° 
HashTabÀ
 = 
hc4
->
hashTabÀ
;

345 c⁄° 
BYTE
 *
ªf
;

346 
	`INITBASE
(
ba£
, 
hc4
->base);

347 
nbAâem±s
 = 
MAX_NB_ATTEMPTS
;

348 
ml
 = 0;

351 
	`LZ4HC_In£π
(
hc4
, 
ù
);

352 
ªf
 = 
	`HASH_POINTER
(
ù
);

353 (
ªf
 > (
ù
 - 
MAX_DISTANCE
)Ë&& (
nbAâem±s
))

355 
nbAâem±s
--;

356 i‡(*(
ªf
 + 
ml
Ë=*(
ù
 + ml))

357 i‡(*(
U32
 *Ë
ªf
 =*(U32 *Ë
ù
)

359 c⁄° 
BYTE
 *
ª·
 = 
ªf
 + 
MINMATCH
;

360 c⁄° 
BYTE
 *
ùt
 = 
ù
 + 
MINMATCH
;

361 
ùt
 < 
m©chlimô
 - (
STEPSIZE
 - 1))

363 
UARCH
 
diff
 = 
	`AARCH
(
ª·
Ë^ AARCH(
ùt
);

364 i‡(!
diff
) {

365 
ùt
 +
STEPSIZE
;

366 
ª·
 +
STEPSIZE
;

369 
ùt
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

370 
_ídCou¡
;

372 i‡(
LZ4_ARCH64
)

373 i‡((
ùt
 < (
m©chlimô
 - 3)Ë&& (
	`A32
(
ª·
) == A32(ipt))) {

374 
ùt
 += 4;

375 
ª·
 += 4;

377 i‡((
ùt
 < (
m©chlimô
 - 1)Ë&& (
	`A16
(
ª·
) == A16(ipt))) {

378 
ùt
 += 2;

379 
ª·
 += 2;

381 i‡((
ùt
 < 
m©chlimô
Ë&& (*
ª·
 == *ipt))

382 
ùt
++;

383 
_ídCou¡
: i‡(
ùt
 - 
ù
 > 
ml
) {

384 
ml
 = 
ùt
 - 
ù
;

385 *
m©chpos
 = 
ªf
;

388 
ªf
 = 
	`GETNEXT
(ref);

390  
ml
;

391 
	}
}

393 
ölöe
 
	$LZ4HC_In£πAndGëWidîM©ch
(
LZ4HC_D©a_Såu˘uª
 * 
hc4
, c⁄° 
BYTE
 * 
ù
, c⁄° BYTE * 
°¨tLimô
,

394 c⁄° 
BYTE
 * 
m©chlimô
, 
l⁄ge°
, c⁄° BYTE ** 
m©chpos
,

395 c⁄° 
BYTE
 ** 
°¨ços
)

397 
U16
 * c⁄° 
chaöTabÀ
 = 
hc4
->chainTable;

398 
HTYPE
 * c⁄° 
HashTabÀ
 = 
hc4
->
hashTabÀ
;

399 
	`INITBASE
(
ba£
, 
hc4
->base);

400 c⁄° 
BYTE
 *
ªf
;

401 
nbAâem±s
 = 
MAX_NB_ATTEMPTS
;

402 
dñè
 = 
ù
 - 
°¨tLimô
;

405 
	`LZ4HC_In£π
(
hc4
, 
ù
);

406 
ªf
 = 
	`HASH_POINTER
(
ù
);

407 (
ªf
 > 
ù
 - 
MAX_DISTANCE
Ë&& (ª‡>
hc4
->
ba£
Ë&& (
nbAâem±s
))

409 
nbAâem±s
--;

410 i‡(*(
°¨tLimô
 + 
l⁄ge°
Ë=*(
ªf
 - 
dñè
 +Üongest))

411 i‡(*(
U32
 *Ë
ªf
 =*(U32 *Ë
ù
)

413 c⁄° 
BYTE
 *
ª·
 = 
ªf
 + 
MINMATCH
;

414 c⁄° 
BYTE
 *
ùt
 = 
ù
 + 
MINMATCH
;

415 c⁄° 
BYTE
 *
°¨â
 = 
ù
;

416 
ùt
 < 
m©chlimô
 - (
STEPSIZE
 - 1))

418 
UARCH
 
diff
 = 
	`AARCH
(
ª·
Ë^ AARCH(
ùt
);

419 i‡(!
diff
) {

420 
ùt
 +
STEPSIZE
;

421 
ª·
 +
STEPSIZE
;

424 
ùt
 +
	`LZ4_NbComm⁄Byãs
(
diff
);

425 
_ídCou¡
;

427 i‡(
LZ4_ARCH64
)

428 i‡((
ùt
 < (
m©chlimô
 - 3)Ë&& (
	`A32
(
ª·
) == A32(ipt))) {

429 
ùt
 += 4;

430 
ª·
 += 4;

432 i‡((
ùt
 < (
m©chlimô
 - 1)Ë&& (
	`A16
(
ª·
) == A16(ipt))) {

433 
ùt
 += 2;

434 
ª·
 += 2;

436 i‡((
ùt
 < 
m©chlimô
Ë&& (*
ª·
 == *ipt))

437 
ùt
++;

438 
_ídCou¡
: 
ª·
 = 
ªf
;

439 (
°¨â
 > 
°¨tLimô
Ë&& (
ª·
 > 
hc4
->
ba£
) && (startt[-1] ==Ñeft[-1])) {

440 
°¨â
--;

441 
ª·
--;

443 i‡((
ùt
 - 
°¨â
Ë> 
l⁄ge°
)

445 
l⁄ge°
 = 
ùt
 - 
°¨â
;

446 *
m©chpos
 = 
ª·
;

447 *
°¨ços
 = 
°¨â
;

450 
ªf
 = 
	`GETNEXT
(ref);

452  
l⁄ge°
;

453 
	}
}

455 
ölöe
 
	$LZ4_ícodeSequí˚
(c⁄° 
BYTE
 ** 
ù
, BYTE ** 
›
, c⁄° BYTE ** 
™ch‹
, 
ml
, c⁄° BYTE * 
ªf
)

457 
Àngth
, 
Àn
;

458 
BYTE
 * 
tokí
;

461 
Àngth
 = *
ù
 - *
™ch‹
;

462 
tokí
 = (*
›
)++;

463 i‡(
Àngth
 >()
RUN_MASK
) {

464 *
tokí
 = (
RUN_MASK
 << 
ML_BITS
);

465 
Àn
 = 
Àngth
 - 
RUN_MASK
;

466 ; 
Àn
 > 254;Üen -= 255)

467 *(*
›
)++ = 255;

468 *(*
›
)++ = (
BYTE
Ë
Àn
;

472 *
tokí
 = (
Àngth
 << 
ML_BITS
);

475 
	`LZ4_BLINDCOPY
(*
™ch‹
, *
›
, 
Àngth
);

478 
	`LZ4_WRITE_LITTLEENDIAN_16
(*
›
, *
ù
 - 
ªf
);

481 
Àn
 = ()(
ml
 - 
MINMATCH
);

482 i‡(
Àn
 >()
ML_MASK
) {

483 *
tokí
 +
ML_MASK
;

484 
Àn
 -
ML_MASK
;

485 ; 
Àn
 > 509;Üen -= 510) {

486 *(*
›
)++ = 255;

487 *(*
›
)++ = 255;

489 i‡(
Àn
 > 254) {

490 
Àn
 -= 255;

491 *(*
›
)++ = 255;

493 *(*
›
)++ = (
BYTE
Ë
Àn
;

497 *
tokí
 +
Àn
;

500 *
ù
 +
ml
;

501 *
™ch‹
 = *
ù
;

503 
	}
}

509 
	$LZ4_com¥essHCCtx
(
LZ4HC_D©a_Såu˘uª
 * 
˘x
, c⁄° *
sour˚
, *
de°
, 
isize
)

511 c⁄° 
BYTE
 *
ù
 = (c⁄° BYTE *)
sour˚
;

512 c⁄° 
BYTE
 *
™ch‹
 = 
ù
;

513 c⁄° 
BYTE
 *c⁄° 
õnd
 = 
ù
 + 
isize
;

514 c⁄° 
BYTE
 *c⁄° 
mÊimô
 = 
õnd
 - 
MFLIMIT
;

515 c⁄° 
BYTE
 *c⁄° 
m©chlimô
 = (
õnd
 - 
LASTLITERALS
);

516 
BYTE
 * 
›
 = (BYTE *Ë
de°
;

517 
ml
, 
ml2
, 
ml3
, 
ml0
;

518 c⁄° 
BYTE
 *
ªf
 = 
NULL
;

519 c⁄° 
BYTE
 *
°¨t2
 = 
NULL
;

520 c⁄° 
BYTE
 *
ªf2
 = 
NULL
;

521 c⁄° 
BYTE
 *
°¨t3
 = 
NULL
;

522 c⁄° 
BYTE
 *
ªf3
 = 
NULL
;

523 c⁄° 
BYTE
 *
°¨t0
;

524 c⁄° 
BYTE
 *
ªf0
;

525 
ù
++;

528 
ù
 < 
mÊimô
)

530 
ml
 = 
	`LZ4HC_In£πAndFödBe°M©ch
(
˘x
, 
ù
, 
m©chlimô
, (&
ªf
));

531 i‡(!
ml
) {

532 
ù
++;

537 
°¨t0
 = 
ù
;

538 
ªf0
 = 
ªf
;

539 
ml0
 = 
ml
;

540 
_Sórch2
: i‡(
ù
 + 
ml
 < 
mÊimô
)

541 
ml2
 = 
	`LZ4HC_In£πAndGëWidîM©ch
(
˘x
, 
ù
 + 
ml
 - 2, i∞+ 1, 
m©chlimô
, ml, &
ªf2
, &
°¨t2
);

544 
ml2
 = 
ml
;

545 i‡(
ml2
 =
ml
)

547 
	`LZ4_ícodeSequí˚
(&
ù
, &
›
, &
™ch‹
, 
ml
, 
ªf
);

550 i‡(
°¨t0
 < 
ù
)

552 i‡(
°¨t2
 < 
ù
 + 
ml0
)

554 
ù
 = 
°¨t0
;

555 
ªf
 = 
ªf0
;

556 
ml
 = 
ml0
;

561 i‡((
°¨t2
 - 
ù
) < 3)

563 
ml
 = 
ml2
;

564 
ù
 = 
°¨t2
;

565 
ªf
 = 
ªf2
;

566 
_Sórch2
;

568 
_Sórch3
:

572 i‡((
°¨t2
 - 
ù
Ë< 
OPTIMAL_ML
)

574 
c‹ª˘i⁄
;

575 
√w_ml
 = 
ml
;

576 i‡(
√w_ml
 > 
OPTIMAL_ML
)

577 
√w_ml
 = 
OPTIMAL_ML
;

578 i‡(
ù
 + 
√w_ml
 > 
°¨t2
 + 
ml2
 - 
MINMATCH
)

579 
√w_ml
 = 
°¨t2
 - 
ù
 + 
ml2
 - 
MINMATCH
;

580 
c‹ª˘i⁄
 = 
√w_ml
 - (
°¨t2
 - 
ù
);

581 i‡(
c‹ª˘i⁄
 > 0)

583 
°¨t2
 +
c‹ª˘i⁄
;

584 
ªf2
 +
c‹ª˘i⁄
;

585 
ml2
 -
c‹ª˘i⁄
;

590 i‡(
°¨t2
 + 
ml2
 < 
mÊimô
)

591 
ml3
 = 
	`LZ4HC_In£πAndGëWidîM©ch
(
˘x
, 
°¨t2
 + 
ml2
 - 3, sèπ2, 
m©chlimô
, ml2, &
ªf3
, &
°¨t3
);

594 
ml3
 = 
ml2
;

595 i‡(
ml3
 =
ml2
)

599 i‡(
°¨t2
 < 
ù
 + 
ml
)

601 i‡((
°¨t2
 - 
ù
Ë< 
OPTIMAL_ML
)

603 
c‹ª˘i⁄
;

604 i‡(
ml
 > 
OPTIMAL_ML
)

605 
ml
 = 
OPTIMAL_ML
;

606 i‡(
ù
 + 
ml
 > 
°¨t2
 + 
ml2
 - 
MINMATCH
)

607 
ml
 = 
°¨t2
 - 
ù
 + 
ml2
 - 
MINMATCH
;

608 
c‹ª˘i⁄
 = 
ml
 - (
°¨t2
 - 
ù
);

609 i‡(
c‹ª˘i⁄
 > 0)

611 
°¨t2
 +
c‹ª˘i⁄
;

612 
ªf2
 +
c‹ª˘i⁄
;

613 
ml2
 -
c‹ª˘i⁄
;

619 
ml
 = 
°¨t2
 - 
ù
;

624 
	`LZ4_ícodeSequí˚
(&
ù
, &
›
, &
™ch‹
, 
ml
, 
ªf
);

625 
ù
 = 
°¨t2
;

626 
	`LZ4_ícodeSequí˚
(&
ù
, &
›
, &
™ch‹
, 
ml2
, 
ªf2
);

629 i‡(
°¨t3
 < 
ù
 + 
ml
 + 3)

631 i‡(
°¨t3
 >(
ù
 + 
ml
))

633 i‡(
°¨t2
 < 
ù
 + 
ml
)

635 
c‹ª˘i⁄
 = (
ù
 + 
ml
Ë- 
°¨t2
;

636 
°¨t2
 +
c‹ª˘i⁄
;

637 
ªf2
 +
c‹ª˘i⁄
;

638 
ml2
 -
c‹ª˘i⁄
;

639 i‡(
ml2
 < 
MINMATCH
)

641 
°¨t2
 = 
°¨t3
;

642 
ªf2
 = 
ªf3
;

643 
ml2
 = 
ml3
;

646 
	`LZ4_ícodeSequí˚
(&
ù
, &
›
, &
™ch‹
, 
ml
, 
ªf
);

647 
ù
 = 
°¨t3
;

648 
ªf
 = 
ªf3
;

649 
ml
 = 
ml3
;

650 
°¨t0
 = 
°¨t2
;

651 
ªf0
 = 
ªf2
;

652 
ml0
 = 
ml2
;

653 
_Sórch2
;

655 
°¨t2
 = 
°¨t3
;

656 
ªf2
 = 
ªf3
;

657 
ml2
 = 
ml3
;

658 
_Sórch3
;

663 i‡(
°¨t2
 < 
ù
 + 
ml
)

665 i‡((
°¨t2
 - 
ù
Ë< ()
ML_MASK
)

667 
c‹ª˘i⁄
;

668 i‡(
ml
 > 
OPTIMAL_ML
)

669 
ml
 = 
OPTIMAL_ML
;

670 i‡(
ù
 + 
ml
 > 
°¨t2
 + 
ml2
 - 
MINMATCH
)

671 
ml
 = 
°¨t2
 - 
ù
 + 
ml2
 - 
MINMATCH
;

672 
c‹ª˘i⁄
 = 
ml
 - (
°¨t2
 - 
ù
);

673 i‡(
c‹ª˘i⁄
 > 0)

675 
°¨t2
 +
c‹ª˘i⁄
;

676 
ªf2
 +
c‹ª˘i⁄
;

677 
ml2
 -
c‹ª˘i⁄
;

683 
ml
 = 
°¨t2
 - 
ù
;

686 
	`LZ4_ícodeSequí˚
(&
ù
, &
›
, &
™ch‹
, 
ml
, 
ªf
);

687 
ù
 = 
°¨t2
;

688 
ªf
 = 
ªf2
;

689 
ml
 = 
ml2
;

690 
°¨t2
 = 
°¨t3
;

691 
ªf2
 = 
ªf3
;

692 
ml2
 = 
ml3
;

693 
_Sórch3
;

698 
œ°Run
 = 
õnd
 - 
™ch‹
;

699 i‡(
œ°Run
 >()
RUN_MASK
) {

700 *
›
++ = (
RUN_MASK
 << 
ML_BITS
);

701 
œ°Run
 -
RUN_MASK
;

702 ; 
œ°Run
 > 254;ÜastRun -= 255)

703 *
›
++ = 255;

704 *
›
++ = (
BYTE
Ë
œ°Run
;

708 *
›
++ = (
œ°Run
 << 
ML_BITS
);

709 
	`mem˝y
(
›
, 
™ch‹
, 
õnd
 -ánchor);

710 
›
 +
õnd
 - 
™ch‹
;

714  ()(((*)
›
Ë- 
de°
);

715 
	}
} 
	$LZ4_com¥essHC
(c⁄° *
sour˚
, *
de°
, 
isize
)

717 *
˘x
 = 
	`LZ4HC_Cª©e
((c⁄° 
BYTE
 *)
sour˚
);

718 
ªsu…
 = 
	`LZ4_com¥essHCCtx
(
˘x
, 
sour˚
, 
de°
, 
isize
);

719 
	`LZ4HC_Fªe
(&
˘x
);

720  
ªsu…
;

721 
	}
}

	@lz4hc.h

34 #¥agm®
⁄˚


37 #i‡
deföed
 (
__˝lu•lus
)

42 
LZ4_com¥essHC
 (c⁄° * 
sour˚
, * 
de°
, 
isize
);

58 #i‡
deföed
 (
__˝lu•lus
)

	@matrix.c

1 
	~"Rm⁄go.h
"

2 
	~"g¶/g¶_m©rix.h
"

5 
	#LEVEL5
 10

	)

7 
g¶_m©rix
 *
	$øw2m©rix
(
TickRaw
 *
§c
,
x
, 
y
) {

8 
g¶_m©rix
 *
m
;

9 
m
 = 
	`g¶_m©rix_Æloc
 (
x
, 
y
);

11 (
m
);

12 
	}
}

14 
g¶_m©rix
 *
	$øw2gm©rixA
(c⁄° 
TickRaw
 *
øw
,
xcﬁ
, 
ycﬁ
){

15 
˙t
,
j
,
k
;

17 
g¶_m©rix
 *
m
,*
tm
,*
gm
=
NULL
;

18 
g¶_ve˘‹
 *
gv
;

20 
xmö
,
xmax
,
ymö
,
ymax
;

23 
øw
!=
NULL
) {

24 i‡–
øw
->
nRows
 < 2 ) ;

26 
j
 = 
˙t
 = 0;

27 
j
=0; j<
øw
->
nRows
; j++) {

28 i‡(
øw
->
v
[
xcﬁ
+
j
*
CONVERSLEN
] <= 0) ;

29 i‡(
øw
->
v
[
ycﬁ
+
j
*
CONVERSLEN
] <= 0) ;

30 
˙t
++;

33 
m
 = 
	`g¶_m©rix_Æloc
(
˙t
,
CONVERSLEN
);

35 
k
 = 0;

37 
j
=0; j<
øw
->
nRows
; j++) {

38 i‡(
øw
->
v
[
xcﬁ
+
j
*
CONVERSLEN
] <= 0) ;

39 i‡(
øw
->
v
[
ycﬁ
+
j
*
CONVERSLEN
] <= 0) ;

40 i‡–
k
>
˙t
) ;

41 
	`mem˝y
(&
m
->
d©a
[
k
*
CONVERSLEN
],&
øw
->
v
[
j
*CONVERSLEN],()*CONVERSLEN);

42 
k
++;

45 
tm
 = 
	`g¶_m©rix_Æloc
(
CONVERSLEN
,
˙t
);

46 
	`g¶_m©rix_å™•o£_mem˝y
(
tm
,
m
);

48 
gv
 = 
	`g¶_ve˘‹_Æloc
(
˙t
);

50 
	`mem˝y
(
gv
->
d©a
,&
tm
->d©a[
xcﬁ
*
˙t
],()*cnt);

51 
	`g¶_ve˘‹_mömax
(
gv
,&
xmö
,&
xmax
);

52 
	`ndebug
("%d xmö %4.2l‡xmax %4.2lf\n",
xcﬁ
, 
xmö
,
xmax
);

54 
	`mem˝y
(
gv
->
d©a
,&
tm
->d©a[
ycﬁ
*
˙t
],()*cnt);

55 
	`g¶_ve˘‹_mömax
(
gv
,&
ymö
,&
ymax
);

56 
	`ndebug
("%d ymö %4.2l‡ymax %4.2lf\n",
ycﬁ
, 
ymö
,
ymax
);

63 
	`g¶_ve˘‹_‰ì
(
gv
);

64 
	`g¶_m©rix_‰ì
(
m
);

68 –
tm
 );

70 
	}
}

73 
	$öønge
(
s
, 
s1
, 
s2
)

75  (((
s
 <
s1
Ë|| (†>
s2
)Ë? 
FALSE
 : 
TRUE
);

76 
	}
}

78 
	$wôhöønge
(
s
, 
s1
, 
s2
)

80  (((
s
 > 
s1
Ë&& (†< 
s2
)Ë? 
TRUE
 : 
FALSE
);

81 
	}
}

84 
	$ßmeside
(
i
, 
j
)

86  (((
i
 < 5Ë&& (
j
 < 5)Ë? 
TRUE
 : (((ò>5Ë&& (j >5)Ë? TRUE : 
FALSE
));

87 
	}
}

89 
	$nŸli°_¥i˚
(*
s1
, *
s2
) {

90 
ªtvÆ
 = 0.0;

91 
i
;

92 
i
 = 0; i < 
LEVEL5
; i++)

93 i‡(
	`wôhöønge
(
s2
[
B1P
 + 2 * 
i
], 
s1
[B1P], s1[
O1P
]Ë=
TRUE
) {

94 
ªtvÆ
 +
s2
[
B1P
 + 2 * 
i
] * s2[
B1V
 + 2 * i];

97 (
ªtvÆ
);

98 
	}
}

101 
	$bidaskIncDec
(*
±r
, *
s1
, *
s2
) {

103 
i
, 
j
,
x
, 
ªtvÆ
;

104 
found
;

106 
i
 = 0; i < 
LEVEL5
; i++) {

108 i‡(
s1
[
B1P
 + 2 * 
i
] == 0) ;

109 i‡(
	`wôhöønge
(
s1
[
B1P
 + 2 * 
i
], 
s2
[
B5P
], s2[
O5P
]Ë=
FALSE
) ;

111 
found
 = 
FALSE
;

113 
j
 = 0; j < 
LEVEL5
; j++) {

115 i‡(
	`wôhöønge
(
s2
[
B1P
 + 2 * 
j
], 
s1
[
B5P
], s1[
O5P
]Ë=
FALSE
) ;

117 i‡(
s1
[
B1P
 + 2 * 
i
] =
s2
[B1P + 2 * 
j
]) {

119 
found
 = 
TRUE
; 
x
 = 0;

121 i‡(
i
 >5Ë
x
 += 2;

123 i‡(
	`ßmeside
(
i
, 
j
Ë=
TRUE
) {

125 i‡(
s1
[
B1V
 + 2 * 
i
] < 
s2
[B1V + 2 * 
j
]Ë
x
 += 1;

126 
±r
[
EÀBidInc
 + 
x
] +
	`abs
(
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i]

127 - 
s2
[
B1P
 + 2 * 
j
] * s2[
B1V
 + 2 * j]);

129 
±r
[
EÀBidInc
 + 
x
] +
	`abs
(
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i]

130 + 
s2
[
B1P
 + 2 * 
j
] * s2[
B1V
 + 2 * j]);

139 i‡(
found
 !
TRUE
) {

140 
x
 = 0;

141 
x
 = (
i
 >= 5)?x+2:x;

142 
±r
[
EÀBidInc
 + 
x
] +
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i];

147 (
ªtvÆ
);

149 
	}
}

151 
	$dnöønge
(
s
, 
s1
, 
s2
)

153  (((
s
 <
s1
Ë|| (†> 
s2
)Ë? 
FALSE
 : 
TRUE
);

154 
	}
}

156 
	$nŸli°_uµri˚
(*
s1
, *
s2
) {

157 
ªtvÆ
 = 0.0;

158 
i
;

159 
i
 = 0; i < 
LEVEL5
; i++)

160 i‡(
	`dnöønge
(
s2
[
B1P
 + 2 * 
i
], 
s1
[B1P], s1[
O1P
]Ë=
TRUE
) {

161 
ªtvÆ
 +
s2
[
B1P
 + 2 * 
i
] * s2[
B1V
 + 2 * i];

164 (
ªtvÆ
);

165 
	}
}

167 
	$upöønge
(
s
, 
s1
, 
s2
)

169  (((
s
 < 
s1
Ë|| (†>
s2
)Ë? 
FALSE
 : 
TRUE
);

170 
	}
}

172 
	$nŸli°_d≈ri˚
(*
s1
, *
s2
) {

173 
ªtvÆ
 = 0.0;

174 
i
;

175 
i
 = 0; i < 
LEVEL5
; i++)

176 i‡(
	`upöønge
(
s2
[
B1P
 + 2 * 
i
], 
s1
[B1P], s1[
O1P
]Ë=
TRUE
) {

177 
ªtvÆ
 +
s2
[
B1P
 + 2 * 
i
] * s2[
B1V
 + 2 * i];

180 (
ªtvÆ
);

181 
	}
}

183 
TickRaw
 *
	$tick2øw
(
qV
 *
sd
, 
tDiff
)

186 
i
, 
j
, 
k
, 
t
, 
x
;

187 
TickRaw
 *
øw_hód
, *
±r
;

188 
found
, 
nRows
, *
up_t
, *
dn_t
;

189 
TRADE_STATE
 
t_b
;

191 
avPri˚
, 
amDiff
, 
vDiff
,
tmDiff
;

192 *
ds1
, *
ds2
, *
±r_v
;

193 
by_bid
, 
by_ask
;

194 
tSubs
 = ()
tDiff
;

196 
øw_hód
 = 
±r
 = 
	`CÆloc
(1, 
TickRaw
);

200 i‡(
sd
 =
NULL
) ;

201 i‡(
sd
->
nCﬁs
 < 2) ;

203 
k
 = 0; k < 
sd
->
nCﬁs
 - 1; k++) {

204 i‡(
tDiff
 == 0) ;

206 
ds1
 = ((*)
sd
->
v
Ë+ (
EMPTYCOLS
 * 
k
);

207 
ds2
 = 
ds1
 + 
EMPTYCOLS
;

209 i‡((
tDiff
 > 0Ë&& (
tSubs
 -
	`diffTime
(
ds1
[
T
], 
ds2
[T])) < 0) ;

212 i‡(
tDiff
 =0Ë
nRows
 = 
sd
->
nCﬁs
; nRow†
k
+1;

214 
±r
->
nRows
 =ÇRows - 1;

215 
±r
->
nCﬁs
 = 
CONVERSLEN
;

217 
±r
->
v
 = 
	`CÆloc
(
CONVERSLEN
 *Öå->
nRows
, );

219 
k
 = 0; k < 
nRows
 - 1; k++) {

220 
±r_v
 = 
±r
->
v
 + (
CONVERSLEN
 * 
k
);

222 
±r_v
[
EÀTickAm
] =Öå_v[
EÀTickPri˚
]

223 
±r_v
[
EÀHigh
] =Öå_v[
EÀLow
]

224 
±r_v
[
EÀAsk
] =Öå_v[
EÀBid
]

225 
±r_v
[
EÀPassAsk
] =Öå_v[
EÀPassBid
]

226 
±r_v
[
EÀA˘Ask
] =Öå_v[
EÀA˘Bid
] = 0.0;

228 
ds1
 = ((*)
sd
->
v
Ë+ (
EMPTYCOLS
 * 
k
);

229 
ds2
 = 
ds1
 + 
EMPTYCOLS
;

231 i‡––
tmDiff
 = 
	`diffTime
(
ds1
[
T
], 
ds2
[T]ËË> 
MINITICK
 ) ;

233 
found
 = 
FALSE
;

234 
t_b
 = 
T_un£t
;

235 
t
 = 0;

237 i‡–(
	`Ti°øde
(
ds1
[
T
]Ë=
FALSE
) &&

238 (
	`Ti°øde
(
ds2
[
T
]Ë=
FALSE
) ) ;

240 
amDiff
 = *(
ds1
 + 
AM
Ë- *(
ds2
 + AM);

241 
vDiff
 = *(
ds1
 + 
VL
Ë- *(
ds2
 + VL);

243 
±r_v
[
EÀTime
] = 
ds1
[
T
];

245 
±r_v
[
EÀHigh
] = 
ds1
[
HI
];

246 
±r_v
[
EÀLow
] = 
ds1
[
LO
];

247 
±r_v
[
EÀBidPri˚
] = 
ds2
[
B1P
];

248 
±r_v
[
EÀAskPri˚
] = 
ds2
[
O1P
];

249 
±r_v
[
EÀAvîagePri˚
] = 
ds1
[
AM
] / ds1[
VL
];

250 
±r_v
[
EÀBid
] =

251 
ds2
[
B1P
] * ds2[
B1V
] + ds2[
B2P
] * ds2[
B2V
] + ds2[
B3P
] * ds2[
B3V
] + ds2[
B4P
] * ds2[
B4V
] +

252 
ds2
[
B5P
] * ds2[
B5V
];

253 
±r_v
[
EÀAsk
] =

254 
ds2
[
O1P
] * ds2[
O1V
] + ds2[
O2P
] * ds2[
O2V
] + ds2[
O3P
] * ds2[
O3V
] + ds2[
O4P
] * ds2[
O4V
] +

255 
ds2
[
O5P
] * ds2[
O5V
];

257 i‡–
vDiff
 < 
MINIVOLVAR
 ) ;

259 
±r_v
[
EÀTickAm
] = 
amDiff
;

260 
avPri˚
 = 
amDiff
 / 
vDiff
;

261 
±r_v
[
EÀTickPri˚
] = 
avPri˚
;

265 
t_b
 = 
T_un£t
;

266 i‡–
tmDiff
 > 
MINITICK
/2 ) {

268 i‡–
avPri˚
 <
ds2
[
B1P
] ) { 
±r_v
[
EÀA˘Ask
] = 
amDiff
; }

269 i‡–
avPri˚
 >
ds2
[
O1P
] ) { 
±r_v
[
EÀA˘Bid
] = 
amDiff
; }

271 i‡–(
vDiff
<
ds2
[
B1V
]Ë&& (vDiff<ds2[
O1V
]) )

272 
	`bidaskIncDec
(
±r_v
,
ds1
,
ds2
);

281 
	`bidaskIncDec
(
±r_v
,
ds1
,
ds2
);

283 i‡(
	`wôhöønge
(
avPri˚
, 
ds2
[
B1P
], ds2[
O1P
]Ë=
TRUE
) {

284 
t_b
 = 
T_bÆ™˚
;

286 i‡––
amDiff
 > 
±r_v
[
EÀBid
] ) || (amDif‡>Öå_v[
EÀAsk
] ) )

288 
±r_v
[
EÀFœtFögî
] = 
amDiff
;

292 i‡–
avPri˚
 =
ds2
[
B1P
] ) { 
±r_v
[
EÀPassAsk
] = 
amDiff
; ; }

293 i‡–
avPri˚
 =
ds2
[
O1P
] ) { 
±r_v
[
EÀPassBid
] = 
amDiff
; ; }

295 
±r_v
[
EÀPassBid
] =

296 (
amDiff
 - 
vDiff
 * 
ds1
[
B1P
]Ë/ 
	`round
((ds1[
O1P
] - ds1[B1P]) * 100) * ds1[O1P] / 100;

298 
±r_v
[
EÀPassAsk
] =

299 (
amDiff
 - 
vDiff
 * 
ds1
[
O1P
]Ë/ 
	`round
((ds1[
B1P
] - ds1[O1P]) * 100) * ds1[B1P] / 100;

301 if–
±r_v
[
EÀPassAsk
] < 0Ë{Öå_v[
EÀPassBid
] +=Ötr_v[ElePassAsk];Ötr_v[ElePassAsk] =0.0; ; }

302 if–
±r_v
[
EÀPassBid
] < 0Ë{Öå_v[
EÀPassAsk
] +=Ötr_v[ElePassBid];Ötr_v[ElePassBid] =0.0;; }

306 i‡((
ds1
[
B1P
] + ds1[
O1P
]Ë=(
ds2
[B1P] + ds2[O1P])){

307 
t_b
 = 
T_bÆ™˚
;

309 i‡––
amDiff
 > 
±r_v
[
EÀBid
] ) || (amDif‡>Öå_v[
EÀAsk
] ) )

311 
±r_v
[
EÀFœtFögî
] = 
amDiff
;

315 i‡–
avPri˚
 =
ds2
[
B1P
] ) { 
±r_v
[
EÀPassAsk
] = 
amDiff
; ; }

316 i‡–
avPri˚
 =
ds2
[
O1P
] ) { 
±r_v
[
EÀPassBid
] = 
amDiff
; ; }

318 
±r_v
[
EÀPassAsk
] =

319 (
amDiff
 - 
vDiff
 * 
ds1
[
B1P
]Ë/ 
	`round
((ds1[
O1P
] - ds1[B1P]) * 100) * ds1[O1P] / 100;

321 
±r_v
[
EÀPassBid
] =

322 (
amDiff
 - 
vDiff
 * 
ds1
[
O1P
]Ë/ 
	`round
((ds1[
B1P
] - ds1[O1P]) * 100) * ds1[B1P] / 100;

324 if–
±r_v
[
EÀPassAsk
] < 0Ë{Öå_v[EÀPassAsk] +±r_v[
EÀPassBid
];Ötr_v[ElePassBid] =0.0; ; }

325 if–
±r_v
[
EÀPassBid
] < 0Ë{Öå_v[EÀPassBid] +±r_v[
EÀPassAsk
];Ötr_v[ElePassAsk] =0.0;; }

330 i‡(
ds2
[
B1P
] =
	`round
(
ds1
[
YC
] * 1.1 * 100) / 100) {

331 
t_b
 = 
T_ri£_limô
;

332 (
amDiff
 < ()
HUGEAM
Ë? (
±r_v
[
EÀA˘Bid
] =ámDiffË: (±r_v[
EÀA˘Ask
] =ámDiff);

336 i‡(
ds2
[
O1P
] =
	`round
(
ds1
[
YC
] * 0.9 * 100) / 100) {

337 
t_b
 = 
T_down_limô
;

338 (
amDiff
 < ()
HUGEAM
Ë? (
±r_v
[
EÀA˘Ask
] =ámDiffË: (±r_v[
EÀA˘Bid
] =ámDiff);

342 i‡((
ds1
[
B1P
] + ds1[
O1P
]Ë> (
ds2
[B1P] + ds2[O1P])) {

343 
t_b
 = 
T_ri£
;

345 i‡–
amDiff
 > 
±r_v
[
EÀBid
] )

346 
±r_v
[
EÀFœtFögî
] = 
amDiff
;

348 
±r_v
[
EÀA˘Bid
] = 
	`nŸli°_¥i˚
(
ds1
,
ds2
);

349 i‡(
amDiff
 > 
±r_v
[
EÀA˘Bid
]) {

350 
±r_v
[
EÀPassBid
]=
amDiff
-±r_v[
EÀA˘Bid
];

351 
±r_v
[
EÀA˘Bid
] = 
amDiff
 -Öå_v[
EÀPassBid
];

352 } 
±r_v
[
EÀA˘Bid
] = 
amDiff
;

355 i‡((
ds1
[
B1P
] + ds1[
O1P
]Ë< (
ds2
[B1P] + ds2[O1P])) {

356 
t_b
 = 
T_down
;

357 i‡–
amDiff
 > 
±r_v
[
EÀAsk
] )

358 
±r_v
[
EÀFœtFögî
] = 
amDiff
;

360 
±r_v
[
EÀA˘Ask
] = 
	`nŸli°_¥i˚
(
ds1
,
ds2
);

361 i‡(
amDiff
 > 
±r_v
[
EÀA˘Ask
]) {

362 
±r_v
[
EÀPassAsk
]=
amDiff
-±r_v[
EÀA˘Ask
];

363 
±r_v
[
EÀA˘Ask
] = 
amDiff
 -Öå_v[
EÀPassAsk
];

364 } 
±r_v
[
EÀA˘Ask
] = 
amDiff
;

375  (
øw_hód
);

377 
	}
}

381 
	$diffVÆue
(*
d°
,*
ds1
,*
ds2
) {

383 
i
,
j
,
ªtvÆ
 = 0;

384 
avPri˚
,
amDiff
,
vDiff
;

386 *(
d°
 + 4Ë
amDiff
 = 
ds1
[10] - 
ds2
[10];

387 
vDiff
 = 
ds1
[9]-
ds2
[9];

390 if–
vDiff
 != 0) {

391 
avPri˚
 = 
amDiff
 / 
vDiff
;

393 
i
=0;i<=8;i+=2) {

394 *(
d°
+6Ë+
ds1
[21+
i
] * ds1[22+i];

395 *(
d°
+5Ë+
ds1
[11+
i
] * ds1[12+i];

398 
i
=0;i<=8;i+=2) {

399 
j
=0;j<=8;j+=2) {

400 if(
ds1
[22+
i
] =
ds2
[22+
j
]) {

401 *(
d°
 +10Ë+(
ds1
[21+
i
] - 
ds2
[21+
j
])*ds2[22+j];

406 
i
=0;i<=8;i+=2) {

407 
j
=0;j<=8;j+=2) {

408 if(
ds1
[12+
i
] =
ds2
[12+
j
]) {

409 *(
d°
 +9Ë+(
ds1
[11+
i
] - 
ds2
[11+
j
])*ds2[12+j];

413 *(
d°
 +11Ë
avPri˚
;

415 if–
avPri˚
 >*(
ds2
+22)) { ;

417 } if–
avPri˚
 <*(
ds2
+12)) { ;

420 } if–(
avPri˚
 > 
ds2
[12]) && (avPrice < ds2[22]) ) {

425 
	`bÆ™˚_ba_∑ssive
(*
±r
, *
s1
, *
s2
,
amD
,
vD
) {

427 
±r
[
EÀPassBid
] =

428 (
amD
 - 
vD
 * 
s1
[
B1P
]Ë/ ( 
	`round
((s1[
O1P
] - s1[B1P]) * 100) / 100 ) * s1[O1P];

430 
±r
[
EÀPassAsk
] =

431 (
amD
 - 
vD
 * 
s1
[
O1P
]Ë/ ( 
	`round
((s1[
B1P
] - s1[O1P]) * 100) / 100 ) * s1[B1P];

433 if–
±r
[
EÀPassAsk
] < 0)

434 { 
±r
[
EÀPassBid
] +±r[
EÀPassAsk
];Ötr[ElePassAsk] =0.0; ; }

435 if–
±r
[
EÀPassBid
] < 0)

436 { 
±r
[
EÀPassAsk
] +±r[
EÀPassBid
];Ötr[ElePassBid] =0.0; ; }

443 
	`bÆ™˚_bidaskIncDec
(*
±r
, *
s1
, *
s2
) {

445 
i
, 
j
,
x
, 
ªtvÆ
=0;

446 
found
;

448 
i
 = 0; i < 
LEVEL5
; i++) {

450 i‡(
s1
[
B1P
 + 2 * 
i
] == 0) ;

451 i‡(
	`wôhöønge
(
s1
[
B1P
 + 2 * 
i
], 
s2
[
B5P
], s2[
O5P
]Ë=
FALSE
) ;

453 
found
 = 
FALSE
;

455 
j
 = 0; j < 
LEVEL5
; j++) {

457 i‡(
	`wôhöønge
(
s2
[
B1P
 + 2 * 
j
], 
s1
[
B5P
], s1[
O5P
]Ë=
FALSE
) ;

459 i‡(
s1
[
B1P
 + 2 * 
i
] =
s2
[B1P + 2 * 
j
]) {

461 
x
 = (
i
 >= 5)? x = 2: 0;

463 i‡(
	`ßmeside
(
i
, 
j
Ë=
TRUE
) {

465 i‡(
s1
[
B1V
 + 2 * 
i
] < 
s2
[B1V + 2 * 
j
]Ë
x
 += 1;

466 
±r
[
EÀBidInc
 + 
x
] +
	`abs
(
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i]

467 - 
s2
[
B1P
 + 2 * 
j
] * s2[
B1V
 + 2 * j]);

469 
±r
[
EÀBidInc
 + 
x
] +
	`abs
(
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i]

470 + 
s2
[
B1P
 + 2 * 
j
] * s2[
B1V
 + 2 * j]);

473 
found
 = 
TRUE
;

479 i‡(
found
 !
TRUE
) {

480 
x
 = 0;

481 
x
 = (
i
 >= 5)?x+2:x;

482 
±r
[
EÀBidInc
 + 
x
] +
s1
[
B1P
 + 2 * 
i
] * s1[
B1V
 + 2 * i];

487 (
ªtvÆ
);

491 
TickRaw
 *
	`tick2dëaû
(
qV
 *
sd
, 
tDiff
)

494 
i
, 
j
, 
k
, 
t
, 
x
;

495 
TickRaw
 *
øw_hód
, *
±r
;

496 
found
, 
nRows
, *
up_t
, *
dn_t
;

497 
TRADE_STATE
 
t_b
;

499 
avPri˚
, 
amDiff
, 
vDiff
,
tmDiff
;

500 *
ds1
, *
ds2
, *
±r_v
;

501 
by_bid
, 
by_ask
;

502 
tSubs
 = ()
tDiff
;

504 
øw_hód
 = 
±r
 = 
	`CÆloc
(1, 
TickRaw
);

508 i‡(
sd
 =
NULL
) ;

509 i‡(
sd
->
nCﬁs
 < 2) ;

511 
k
 = 0; k < 
sd
->
nCﬁs
 - 1; k++) {

512 i‡(
tDiff
 == 0) ;

514 
ds1
 = ((*)
sd
->
v
Ë+ (
EMPTYCOLS
 * 
k
);

515 
ds2
 = 
ds1
 + 
EMPTYCOLS
;

517 i‡((
tDiff
 > 0Ë&& (
tSubs
 -
	`diffTime
(
ds1
[
T
], 
ds2
[T])) < 0) ;

520 i‡(
tDiff
 =0Ë
nRows
 = 
sd
->
nCﬁs
; nRow†
k
+1;

522 
±r
->
nRows
 =ÇRows - 1;

523 
±r
->
nCﬁs
 = 
CONVERSLEN
;

525 
±r
->
v
 = 
	`CÆloc
(
CONVERSLEN
 *Öå->
nRows
, );

527 
k
 = 0; k < 
nRows
 - 1; k++) {

528 
±r_v
 = 
±r
->
v
 + (
CONVERSLEN
 * 
k
);

530 
±r_v
[
EÀTickAm
] =Öå_v[
EÀTickPri˚
] =Öå_v[
EÀHigh
] =Öå_v[
EÀLow
]

531 
±r_v
[
EÀAsk
] =Öå_v[
EÀBid
] =Öå_v[
EÀPassAsk
] =Öå_v[
EÀPassBid
]

532 
±r_v
[
EÀA˘Ask
] =Öå_v[
EÀA˘Bid
] = 0.0;

534 
ds1
 = ((*)
sd
->
v
Ë+ (
EMPTYCOLS
 * 
k
);

535 
ds2
 = 
ds1
 + 
EMPTYCOLS
;

537 
found
 = 
FALSE
;

538 
t_b
 = 
T_un£t
;

540 i‡–(
	`Ti°øde
(
ds1
[
T
]Ë=
FALSE
) &&

541 (
	`Ti°øde
(
ds2
[
T
]Ë=
FALSE
) ) ;

543 
amDiff
 = *(
ds1
 + 
AM
Ë- *(
ds2
 + AM);

544 
vDiff
 = *(
ds1
 + 
VL
Ë- *(
ds2
 + VL);

546 
x
=0;

547 i‡(
ds1
[
B1P
]==
ds2
[B1P]Ë
x
++;

548 i‡(
ds1
[
O1P
]==
ds2
[O1P]Ë
x
++;

549 i‡(
ds1
[
B2P
]==
ds2
[B2P]Ë
x
++;

550 i‡(
ds1
[
O2P
]==
ds2
[O2P]Ë
x
++;

551 i‡(
ds1
[
B3P
]==
ds2
[B3P]Ë
x
++;

552 i‡(
ds1
[
O3P
]==
ds2
[O3P]Ë
x
++;

553 i‡(
ds1
[
B4P
]==
ds2
[B4P]Ë
x
++;

554 i‡(
ds1
[
O4P
]==
ds2
[O4P]Ë
x
++;

555 i‡(
ds1
[
B5P
]==
ds2
[B5P]Ë
x
++;

556 i‡(
ds1
[
O5P
]==
ds2
[O5P]Ë
x
++;

558 if–
x
 >=8 ) 
skù_diff
;

560 if––
vDiff
 / ( *(
ds1
+
VL
) ) > 0.5 ) || ( vDiff / ( *(ds1+VL) ) < -0.5 )

561 || ( 
amDiff
 / ( *(
ds1
+
AM
) ) > 0.5 ) || (ámDiff / ( *(ds1+AM) ) < -0.5 ) ) ;

563 i‡–(
ds1
[
B1P
]/
ds2
[B1P])>1.2 || (ds1[
O1P
]/ds2[O1P])>1.2

564 || (
ds1
[
B2P
]/
ds2
[B2P])>1.2 || (ds1[
O2P
]/ds2[O2P])>1.2

565 || (
ds1
[
B3P
]/
ds2
[B3P])>1.2 || (ds1[
O3P
]/ds2[O3P])>1.2

566 || (
ds1
[
B4P
]/
ds2
[B4P])>1.2 || (ds1[
O4P
]/ds2[O4P])>1.2

567 || (
ds1
[
B5P
]/
ds2
[B5P])>1.2 || (ds1[
O5P
]/ds2[O5P])>1.2

568 || (
ds1
[
B1P
]/
ds2
[B1P])<0.8 || (ds1[
O1P
]/ds2[O1P])<0.8

569 || (
ds1
[
B2P
]/
ds2
[B2P])<0.8 || (ds1[
O2P
]/ds2[O2P])<0.8

570 || (
ds1
[
B3P
]/
ds2
[B3P])<0.8 || (ds1[
O3P
]/ds2[O3P])<0.8

571 || (
ds1
[
B4P
]/
ds2
[B4P])<0.8 || (ds1[
O4P
]/ds2[O4P])<0.8

572 || (
ds1
[
B5P
]/
ds2
[B5P])<0.8 || (ds1[
O5P
]/ds2[O5P])<0.8 ) ;

574 
skù_diff
:

575 
±r_v
[
EÀTime
] = 
ds1
[
T
];

577 
±r_v
[
EÀHigh
] = 
ds1
[
HI
];

578 
±r_v
[
EÀLow
] = 
ds1
[
LO
];

579 
±r_v
[
EÀBidPri˚
] = 
ds2
[
B1P
];

580 
±r_v
[
EÀAskPri˚
] = 
ds2
[
O1P
];

581 
±r_v
[
EÀAvîagePri˚
] = 
ds1
[
AM
] / ds1[
VL
];

582 
±r_v
[
EÀBid
] =

583 
ds2
[
B1P
] * ds2[
B1V
] + ds2[
B2P
] * ds2[
B2V
] + ds2[
B3P
] * ds2[
B3V
] + ds2[
B4P
] * ds2[
B4V
] +

584 
ds2
[
B5P
] * ds2[
B5V
];

585 
±r_v
[
EÀAsk
] =

586 
ds2
[
O1P
] * ds2[
O1V
] + ds2[
O2P
] * ds2[
O2V
] + ds2[
O3P
] * ds2[
O3V
] + ds2[
O4P
] * ds2[
O4V
] +

587 
ds2
[
O5P
] * ds2[
O5V
];

589 i‡–
vDiff
 < 
MINIVOLVAR
 ) ;

591 
±r_v
[
EÀTickAm
] = 
amDiff
;

592 
avPri˚
 = 
amDiff
 / 
vDiff
;

593 
±r_v
[
EÀTickPri˚
] = 
avPri˚
;

595 
x
=0;

596 i‡(
ds1
[
B1P
]==
ds2
[B1P]Ë
x
++;

597 i‡(
ds1
[
O1P
]==
ds2
[O1P]Ë
x
++;

598 i‡(
ds1
[
B2P
]==
ds2
[B2P]Ë
x
++;

599 i‡(
ds1
[
O2P
]==
ds2
[O2P]Ë
x
++;

600 i‡(
ds1
[
B3P
]==
ds2
[B3P]Ë
x
++;

601 i‡(
ds1
[
O3P
]==
ds2
[O3P]Ë
x
++;

602 i‡(
ds1
[
B4P
]==
ds2
[B4P]Ë
x
++;

603 i‡(
ds1
[
O4P
]==
ds2
[O4P]Ë
x
++;

604 i‡(
ds1
[
B5P
]==
ds2
[B5P]Ë
x
++;

605 i‡(
ds1
[
O5P
]==
ds2
[O5P]Ë
x
++;

607 if–
x
 >=9 ) 
skù_time
;

609 i‡––
tmDiff
 = 
	`diffTime
(
ds1
[
T
], 
ds2
[T]ËË> 
MINITICK
/4 ) ;

612 i‡–
tmDiff
 =
MINITICK
/4 ) {

614 i‡–
avPri˚
 <
ds2
[
B1P
] ) { 
±r_v
[
EÀA˘Ask
] = 
amDiff
; }

615 i‡–
avPri˚
 >
ds2
[
O1P
] ) { 
±r_v
[
EÀA˘Bid
] = 
amDiff
; }

617 i‡–(
vDiff
<
ds2
[
B1V
]Ë&& (vDiff<ds2[
O1V
]) )

618 
	`bidaskIncDec
(
±r_v
,
ds1
,
ds2
);

626 
skù_time
:

629 i‡–(
ds1
[
B1P
] =
ds2
[B1P]Ë& (ds2[B1P] =
	`round
(ds1[
YC
] * 1.1 * 100) / 100) ) {

630 
t_b
 = 
T_ri£_limô
; ; }

631 i‡–(
ds1
[
O1P
]==
ds2
[O1P]Ë& (ds2[O1P] =
	`round
(ds1[
YC
] * 0.9 * 100) / 100) ) {

632 
t_b
 = 
T_down_limô
; ; }

633 i‡–(
ds1
[
B1P
] =
ds2
[B1P]Ë&& (ds1[
O1P
] == ds2[O1P]) ) {

634 
t_b
 = 
T_bÆ™˚
; ; }

635 i‡–(
ds1
[
B1P
] =
ds2
[B1P]Ë&& (ds1[
O1P
] > ds2[O1P]) ) {

636 
t_b
 = 
T_ri£1
; ; }

637 i‡–(
ds1
[
B1P
] =
ds2
[B1P]Ë&& (ds1[
O1P
] < ds2[O1P]) ) {

638 
t_b
 = 
T_down1
; ; }

640 i‡–(
ds1
[
B1P
] < 
ds2
[B1P]Ë&& (ds1[
O1P
] < ds2[O1P]) ) {

641 
t_b
 = 
T_down
; ; }

642 i‡–(
ds1
[
B1P
] < 
ds2
[B1P]Ë&& (ds1[
O1P
] == ds2[O1P]) ) {

643 
t_b
 = 
T_down2
; ; }

644 i‡–(
ds1
[
B1P
] < 
ds2
[B1P]Ë&& (ds1[
O1P
] > ds2[O1P]) ) {

645 
t_b
 = 
T_Ê©
; ; }

647 i‡–(
ds1
[
B1P
] > 
ds2
[B1P]Ë&& (ds1[
O1P
] > ds2[O1P]) ) {

648 
t_b
 = 
T_ri£
; ; }

649 i‡–(
ds1
[
B1P
] > 
ds2
[B1P]Ë&& (ds1[
O1P
] == ds2[O1P]) ) {

650 
t_b
 = 
T_ri£2
; ; }

651 i‡–(
ds1
[
B1P
] > 
ds2
[B1P]Ë&& (ds1[
O1P
] < ds2[O1P]) ) {

652 
t_b
 = 
T_Ê©1
; ; }

657 
±r_v
[
EÀTy≥
] = 
t_b
;

660 
	`bÆ™˚_bidaskIncDec
(
±r_v
,
ds1
,
ds2
);

662  
t_b
 ) {

663 
T_un£t
: ;

664 
T_bÆ™˚
:

666 i‡(
	`wôhöønge
(
avPri˚
, 
ds2
[
B1P
], ds2[
O1P
]Ë=
TRUE
) {

667 i‡–
amDiff
 > (
±r_v
[
EÀBid
]+±r_v[
EÀAsk
]) ) {

668 
±r_v
[
EÀFœtFögî
] = 
amDiff
; ; }

669 
	`bÆ™˚_ba_∑ssive
(
±r_v
,
ds1
,
ds2
,
amDiff
,
vDiff
);

670 } i‡–
avPri˚
 =
ds2
[
B1P
] ) {

671 
±r_v
[
EÀA˘Ask
] = 
amDiff
;

672 } i‡–
avPri˚
 =
ds2
[
O1P
] ) {

673 
±r_v
[
EÀA˘Bid
] = 
amDiff
;

677 
T_ri£
:

678 
T_ri£1
:

679 
T_ri£2
:

682 i‡(
	`wôhöønge
(
avPri˚
, 
ds2
[
B1P
], ds2[
O1P
]Ë=
TRUE
) {

683 
	`bÆ™˚_ba_∑ssive
(
±r_v
,
ds1
,
ds2
,
amDiff
,
vDiff
);

684 
±r_v
[
EÀA˘Bid
] +±r_v[
EÀPassBid
];

685 
±r_v
[
EÀPassBid
] = 0;

689 i‡–––
avPri˚
 >
ds2
[
O5P
] ) && ds2[O5P]!=0 ) ||

690 ––
avPri˚
 > 
ds2
[
O4P
] ) && ds2[
O5P
]==0 ) ) {

691 
±r_v
[
EÀA˘Bid
] = 
ds2
[
O1P
] * ds2[
O1V
] + ds2[
O2P
] * ds2[
O2V
]

692 + 
ds2
[
O3P
] * ds2[
O3V
] + ds2[
O4P
] * ds2[
O4V
];

693 i‡–
±r_v
[
EÀA˘Bid
] < 
amDiff
 )

694 
±r_v
[
EÀFœtFögî
] = 
amDiff
-±r_v[
EÀA˘Bid
];

698 i‡–––
avPri˚
 >
ds2
[
O4P
] ) && ds2[O4P]!=0 ) ||

699 ––
avPri˚
 > 
ds2
[
O3P
] ) && ds2[
O4P
]==0 ) ) {

700 
±r_v
[
EÀA˘Bid
] = 
ds2
[
O1P
] * ds2[
O1V
] + ds2[
O2P
] * ds2[
O2V
]

701 + 
ds2
[
O3P
] * ds2[
O3V
];

702 i‡–
±r_v
[
EÀA˘Bid
] < 
amDiff
 )

703 
±r_v
[
EÀPassBid
] = 
amDiff
-±r_v[
EÀA˘Bid
];

707 i‡–––
avPri˚
 >
ds2
[
O3P
] ) && ds2[O3P]!=0 ) ||

708 ––
avPri˚
 > 
ds2
[
O2P
] ) && ds2[
O3P
]==0 ) ) {

709 
±r_v
[
EÀA˘Bid
] = 
ds2
[
O1P
] * ds2[
O1V
] + ds2[
O2P
] * ds2[
O2V
]

710 + 
ds2
[
O3P
] * ds2[
O3V
];

711 i‡–
±r_v
[
EÀA˘Bid
] < 
amDiff
 )

712 
±r_v
[
EÀPassBid
] = 
amDiff
-±r_v[
EÀA˘Bid
];

716 i‡–––
avPri˚
 >
ds2
[
O2P
] ) && ds2[O2P]!=0 ) ||

717 ––
avPri˚
 > 
ds2
[
O1P
] ) && ds2[
O2P
]==0 ) ) {

718 
±r_v
[
EÀA˘Bid
] = 
ds2
[
O1P
] * ds2[
O1V
] ;

719 i‡–
±r_v
[
EÀA˘Bid
] < 
amDiff
 )

720 
±r_v
[
EÀPassBid
] = 
amDiff
-±r_v[
EÀA˘Bid
];

724 i‡––
avPri˚
 > 
ds2
[
O1P
] ) && ds2[O1P]!=0 ) {

725 
±r_v
[
EÀA˘Bid
] = 
ds2
[
O1P
] * ds2[
O1V
];

726 i‡–
±r_v
[
EÀA˘Bid
] < 
amDiff
 )

727 
±r_v
[
EÀPassBid
] = 
amDiff
-±r_v[
EÀA˘Bid
];

731 i‡–
avPri˚
 =
ds2
[
O1P
] ) {

732 
±r_v
[
EÀPassBid
] = 
amDiff
;

739 
T_down
:

740 
T_down1
:

741 
T_down2
:

743 i‡(
	`wôhöønge
(
avPri˚
, 
ds2
[
B1P
], ds2[
O1P
]Ë=
TRUE
) {

744 
	`bÆ™˚_ba_∑ssive
(
±r_v
,
ds1
,
ds2
,
amDiff
,
vDiff
);

745 
±r_v
[
EÀA˘Ask
] +±r_v[
EÀPassAsk
];

746 
±r_v
[
EÀPassAsk
] = 0;

750 i‡–––
avPri˚
 <
ds2
[
B5P
] ) && ds2[B5P]!=0 ) ||

751 ––
avPri˚
 < 
ds2
[
B4P
] ) && ds2[
B5P
]==0 ) ) {

752 
±r_v
[
EÀA˘Ask
] = 
ds2
[
B1P
] * ds2[
B1V
] + ds2[
B2P
] * ds2[
B2V
]

753 + 
ds2
[
B3P
] * ds2[
B3V
] + ds2[
B4P
] * ds2[
B4V
];

754 i‡–
±r_v
[
EÀA˘Ask
] < 
amDiff
 )

755 
±r_v
[
EÀFœtFögî
] = 
amDiff
-±r_v[
EÀA˘Ask
];

759 i‡–––
avPri˚
 <
ds2
[
B4P
] ) && ds2[B4P]!=0 ) ||

760 ––
avPri˚
 < 
ds2
[
B3P
] ) && ds2[
B4P
]==0 ) ) {

761 
±r_v
[
EÀA˘Ask
] = 
ds2
[
B1P
] * ds2[
B1V
] + ds2[
B2P
] * ds2[
B2V
]

762 + 
ds2
[
B3P
] * ds2[
B3V
];

763 i‡–
±r_v
[
EÀA˘Ask
] < 
amDiff
 )

764 
±r_v
[
EÀPassAsk
] = 
amDiff
-±r_v[
EÀA˘Ask
];

768 i‡–––
avPri˚
 <
ds2
[
B3P
] ) && ds2[B3P]!=0 ) ||

769 ––
avPri˚
 < 
ds2
[
B2P
] ) && ds2[
B3P
]==0 ) ) {

770 
±r_v
[
EÀA˘Ask
] = 
ds2
[
B1P
] * ds2[
B1V
] + ds2[
B2P
] * ds2[
B2V
]

771 + 
ds2
[
B3P
] * ds2[
B3V
];

772 i‡–
±r_v
[
EÀA˘Ask
] < 
amDiff
 )

773 
±r_v
[
EÀPassAsk
] = 
amDiff
-±r_v[
EÀA˘Ask
];

777 i‡–––
avPri˚
 <
ds2
[
B2P
] ) && ds2[B2P]!=0 ) ||

778 ––
avPri˚
 < 
ds2
[
B1P
] ) && ds2[
B2P
]==0 ) ) {

779 
±r_v
[
EÀA˘Ask
] = 
ds2
[
B1P
] * ds2[
B1V
] ;

780 i‡–
±r_v
[
EÀA˘Ask
] < 
amDiff
 )

781 
±r_v
[
EÀPassAsk
] = 
amDiff
-±r_v[
EÀA˘Ask
];

785 i‡––
avPri˚
 < 
ds2
[
B1P
] ) && ds2[B1P]!=0 ) {

786 
±r_v
[
EÀA˘Ask
] = 
ds2
[
B1P
] * ds2[
B1V
];

787 i‡–
±r_v
[
EÀA˘Ask
] < 
amDiff
 )

788 
±r_v
[
EÀPassAsk
] = 
amDiff
-±r_v[
EÀA˘Ask
];

792 i‡–
avPri˚
 =
ds2
[
B1P
] ) {

793 
±r_v
[
EÀPassAsk
] = 
amDiff
;

801 
T_Ê©
:

802 
T_Ê©1
:

804 i‡(
	`wôhöønge
(
avPri˚
, 
ds2
[
B1P
], ds2[
O1P
]Ë=
TRUE
) {

805 
	`bÆ™˚_ba_∑ssive
(
±r_v
,
ds1
,
ds2
,
amDiff
,
vDiff
);

809 
T_ri£_limô
:

810 i‡–(
amDiff
>500000Ë& (ámDiff*0.02 > 
ds2
[
O1P
]*ds2[
O1V
] ) )

811 
±r_v
[
EÀPassAsk
] = 
amDiff
;

813 
±r_v
[
EÀPassBid
] = 
amDiff
;

816 
T_down_limô
:

817 i‡–(
amDiff
>500000Ë& (ámDiff*0.02 > 
ds2
[
B1P
]*ds2[
B1V
] ) )

818 
±r_v
[
EÀPassBid
] = 
amDiff
;

820 
±r_v
[
EÀPassAsk
] = 
amDiff
;

836  (
øw_hód
);

	@md5.c

54 
	~"md5.h
"

55 
	~<°rög.h
>

57 #unde‡
BYTE_ORDER


58 #ifde‡
MONGO_BIG_ENDIAN


59 
	#BYTE_ORDER
 1

	)

61 
	#BYTE_ORDER
 -1

	)

64 
	#T_MASK
 ((
m⁄go_md5_w‹d_t
)~0)

	)

65 
	#T1
 (
T_MASK
 ^ 0x28955b87)

	)

66 
	#T2
 (
T_MASK
 ^ 0x173848a9)

	)

67 
	#T3
 0x242070db

	)

68 
	#T4
 (
T_MASK
 ^ 0x3e423111)

	)

69 
	#T5
 (
T_MASK
 ^ 0x0a83f050)

	)

70 
	#T6
 0x4787c62a

	)

71 
	#T7
 (
T_MASK
 ^ 0x57cfb9ec)

	)

72 
	#T8
 (
T_MASK
 ^ 0x02b96a„)

	)

73 
	#T9
 0x698098d8

	)

74 
	#T10
 (
T_MASK
 ^ 0x74bb0850)

	)

75 
	#T11
 (
T_MASK
 ^ 0x0000a44e)

	)

76 
	#T12
 (
T_MASK
 ^ 0x76a32841)

	)

77 
	#T13
 0x6b901122

	)

78 
	#T14
 (
T_MASK
 ^ 0x02678e6c)

	)

79 
	#T15
 (
T_MASK
 ^ 0x5986bc71)

	)

80 
	#T16
 0x49b40821

	)

81 
	#T17
 (
T_MASK
 ^ 0x09e1da9d)

	)

82 
	#T18
 (
T_MASK
 ^ 0x3fbf4cbf)

	)

83 
	#T19
 0x265e5a51

	)

84 
	#T20
 (
T_MASK
 ^ 0x16493855)

	)

85 
	#T21
 (
T_MASK
 ^ 0x29d0eÁ2)

	)

86 
	#T22
 0x02441453

	)

87 
	#T23
 (
T_MASK
 ^ 0x275e197e)

	)

88 
	#T24
 (
T_MASK
 ^ 0x182c0437)

	)

89 
	#T25
 0x21e1cde6

	)

90 
	#T26
 (
T_MASK
 ^ 0x3cc8f829)

	)

91 
	#T27
 (
T_MASK
 ^ 0x0b2af278)

	)

92 
	#T28
 0x455a14ed

	)

93 
	#T29
 (
T_MASK
 ^ 0x561c16Á)

	)

94 
	#T30
 (
T_MASK
 ^ 0x03105c07)

	)

95 
	#T31
 0x676f02d9

	)

96 
	#T32
 (
T_MASK
 ^ 0x72d5b375)

	)

97 
	#T33
 (
T_MASK
 ^ 0x0005c6bd)

	)

98 
	#T34
 (
T_MASK
 ^ 0x788e097e)

	)

99 
	#T35
 0x6d9d6122

	)

100 
	#T36
 (
T_MASK
 ^ 0x021ac7f3)

	)

101 
	#T37
 (
T_MASK
 ^ 0x5b4115bb)

	)

102 
	#T38
 0x4bdecÁ9

	)

103 
	#T39
 (
T_MASK
 ^ 0x0944b49f)

	)

104 
	#T40
 (
T_MASK
 ^ 0x4140438f)

	)

105 
	#T41
 0x289b7ec6

	)

106 
	#T42
 (
T_MASK
 ^ 0x155ed805)

	)

107 
	#T43
 (
T_MASK
 ^ 0x2b10cf7a)

	)

108 
	#T44
 0x04881d05

	)

109 
	#T45
 (
T_MASK
 ^ 0x262b2fc6)

	)

110 
	#T46
 (
T_MASK
 ^ 0x1924661a)

	)

111 
	#T47
 0x1Á27cf8

	)

112 
	#T48
 (
T_MASK
 ^ 0x3b53a99a)

	)

113 
	#T49
 (
T_MASK
 ^ 0x0bd6ddbb)

	)

114 
	#T50
 0x432aff97

	)

115 
	#T51
 (
T_MASK
 ^ 0x546bdc58)

	)

116 
	#T52
 (
T_MASK
 ^ 0x036c5fc6)

	)

117 
	#T53
 0x655b59c3

	)

118 
	#T54
 (
T_MASK
 ^ 0x70f3336d)

	)

119 
	#T55
 (
T_MASK
 ^ 0x00100b82)

	)

120 
	#T56
 (
T_MASK
 ^ 0x7a7ba22e)

	)

121 
	#T57
 0x6Á87e4f

	)

122 
	#T58
 (
T_MASK
 ^ 0x01d3191f)

	)

123 
	#T59
 (
T_MASK
 ^ 0x5c„b˚b)

	)

124 
	#T60
 0x4e0811a1

	)

125 
	#T61
 (
T_MASK
 ^ 0x08ac817d)

	)

126 
	#T62
 (
T_MASK
 ^ 0x42c50dˇ)

	)

127 
	#T63
 0x2ad7d2bb

	)

128 
	#T64
 (
T_MASK
 ^ 0x14792c6e)

	)

132 
	$m⁄go_md5_¥o˚ss
(
m⁄go_md5_°©e_t
 *
pms
, c⁄° 
m⁄go_md5_byã_t
 *
d©a
 ) {

133 
m⁄go_md5_w‹d_t


134 
a
 = 
pms
->
abcd
[0], 
b
 =Öms->abcd[1],

135 
c
 = 
pms
->
abcd
[2], 
d
 =Öms->abcd[3];

136 
m⁄go_md5_w‹d_t
 
t
;

137 #i‡
BYTE_ORDER
 > 0

139 
m⁄go_md5_w‹d_t
 
X
[16];

142 
m⁄go_md5_w‹d_t
 
xbuf
[16];

143 c⁄° 
m⁄go_md5_w‹d_t
 *
X
;

147 #i‡
BYTE_ORDER
 == 0

153 c⁄° 
w
 = 1;

155 i‡(*((c⁄° 
m⁄go_md5_byã_t
 *)&
w
))

157 #i‡
BYTE_ORDER
 <= 0

163 i‡(!((
d©a
 - (c⁄° 
m⁄go_md5_byã_t
 *)0) & 3)) {

165 
X
 = (c⁄° 
m⁄go_md5_w‹d_t
 *)
d©a
;

169 
	`mem˝y
(
xbuf
, 
d©a
, 64);

170 
X
 = 
xbuf
;

174 #i‡
BYTE_ORDER
 == 0

177 #i‡
BYTE_ORDER
 >= 0

183 c⁄° 
m⁄go_md5_byã_t
 *
xp
 = 
d©a
;

184 
i
;

186 #i‡
BYTE_ORDER
 == 0

187 
X
 = 
xbuf
;

189 
	#xbuf
 
X


	)

191 
i
 = 0; i < 16; ++i, 
xp
 += 4)

192 
xbuf
[
i
] = 
xp
[0] + (xp[1] << 8) + (xp[2] << 16) + (xp[3] << 24);

197 
	#ROTATE_LEFT
(
x
, 
n
Ë(((xË<< (n)Ë| ((xË>> (32 - (n))))

	)

202 
	#F
(
x
, 
y
, 
z
Ë(((xË& (y)Ë| (~(xË& (z)))

	)

203 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

204 
t
 = 
a
 + 
	`F
(
b
,
c
,
d
Ë+ 
X
[
k
] + 
Ti
;\

205 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
Ë+ 
b


	)

207 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 7, 
T1
);

208 
	`SET
(
d
, 
a
, 
b
, 
c
, 1, 12, 
T2
);

209 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 17, 
T3
);

210 
	`SET
(
b
, 
c
, 
d
, 
a
, 3, 22, 
T4
);

211 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 7, 
T5
);

212 
	`SET
(
d
, 
a
, 
b
, 
c
, 5, 12, 
T6
);

213 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 17, 
T7
);

214 
	`SET
(
b
, 
c
, 
d
, 
a
, 7, 22, 
T8
);

215 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 7, 
T9
);

216 
	`SET
(
d
, 
a
, 
b
, 
c
, 9, 12, 
T10
);

217 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 17, 
T11
);

218 
	`SET
(
b
, 
c
, 
d
, 
a
, 11, 22, 
T12
);

219 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 7, 
T13
);

220 
	`SET
(
d
, 
a
, 
b
, 
c
, 13, 12, 
T14
);

221 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 17, 
T15
);

222 
	`SET
(
b
, 
c
, 
d
, 
a
, 15, 22, 
T16
);

223 #unde‡
SET


228 
	#G
(
x
, 
y
, 
z
Ë(((xË& (z)Ë| ((yË& ~(z)))

	)

229 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

230 
t
 = 
a
 + 
	`G
(
b
,
c
,
d
Ë+ 
X
[
k
] + 
Ti
;\

231 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
Ë+ 
b


	)

233 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 5, 
T17
);

234 
	`SET
(
d
, 
a
, 
b
, 
c
, 6, 9, 
T18
);

235 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 14, 
T19
);

236 
	`SET
(
b
, 
c
, 
d
, 
a
, 0, 20, 
T20
);

237 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 5, 
T21
);

238 
	`SET
(
d
, 
a
, 
b
, 
c
, 10, 9, 
T22
);

239 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 14, 
T23
);

240 
	`SET
(
b
, 
c
, 
d
, 
a
, 4, 20, 
T24
);

241 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 5, 
T25
);

242 
	`SET
(
d
, 
a
, 
b
, 
c
, 14, 9, 
T26
);

243 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 14, 
T27
);

244 
	`SET
(
b
, 
c
, 
d
, 
a
, 8, 20, 
T28
);

245 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 5, 
T29
);

246 
	`SET
(
d
, 
a
, 
b
, 
c
, 2, 9, 
T30
);

247 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 14, 
T31
);

248 
	`SET
(
b
, 
c
, 
d
, 
a
, 12, 20, 
T32
);

249 #unde‡
SET


254 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

255 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

256 
t
 = 
a
 + 
	`H
(
b
,
c
,
d
Ë+ 
X
[
k
] + 
Ti
;\

257 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
Ë+ 
b


	)

259 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 4, 
T33
);

260 
	`SET
(
d
, 
a
, 
b
, 
c
, 8, 11, 
T34
);

261 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 16, 
T35
);

262 
	`SET
(
b
, 
c
, 
d
, 
a
, 14, 23, 
T36
);

263 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 4, 
T37
);

264 
	`SET
(
d
, 
a
, 
b
, 
c
, 4, 11, 
T38
);

265 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 16, 
T39
);

266 
	`SET
(
b
, 
c
, 
d
, 
a
, 10, 23, 
T40
);

267 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 4, 
T41
);

268 
	`SET
(
d
, 
a
, 
b
, 
c
, 0, 11, 
T42
);

269 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 16, 
T43
);

270 
	`SET
(
b
, 
c
, 
d
, 
a
, 6, 23, 
T44
);

271 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 4, 
T45
);

272 
	`SET
(
d
, 
a
, 
b
, 
c
, 12, 11, 
T46
);

273 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 16, 
T47
);

274 
	`SET
(
b
, 
c
, 
d
, 
a
, 2, 23, 
T48
);

275 #unde‡
SET


280 
	#I
(
x
, 
y
, 
z
Ë((yË^ ((xË| ~(z)))

	)

281 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

282 
t
 = 
a
 + 
	`I
(
b
,
c
,
d
Ë+ 
X
[
k
] + 
Ti
;\

283 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
Ë+ 
b


	)

285 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 6, 
T49
);

286 
	`SET
(
d
, 
a
, 
b
, 
c
, 7, 10, 
T50
);

287 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 15, 
T51
);

288 
	`SET
(
b
, 
c
, 
d
, 
a
, 5, 21, 
T52
);

289 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 6, 
T53
);

290 
	`SET
(
d
, 
a
, 
b
, 
c
, 3, 10, 
T54
);

291 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 15, 
T55
);

292 
	`SET
(
b
, 
c
, 
d
, 
a
, 1, 21, 
T56
);

293 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 6, 
T57
);

294 
	`SET
(
d
, 
a
, 
b
, 
c
, 15, 10, 
T58
);

295 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 15, 
T59
);

296 
	`SET
(
b
, 
c
, 
d
, 
a
, 13, 21, 
T60
);

297 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 6, 
T61
);

298 
	`SET
(
d
, 
a
, 
b
, 
c
, 11, 10, 
T62
);

299 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 15, 
T63
);

300 
	`SET
(
b
, 
c
, 
d
, 
a
, 9, 21, 
T64
);

301 #unde‡
SET


306 
pms
->
abcd
[0] +
a
;

307 
pms
->
abcd
[1] +
b
;

308 
pms
->
abcd
[2] +
c
;

309 
pms
->
abcd
[3] +
d
;

310 
	}
}

312 
MONGO_EXPORT
 

313 
	$m⁄go_md5_öô
(
m⁄go_md5_°©e_t
 *
pms
) {

314 
pms
->
cou¡
[0] =Öms->count[1] = 0;

315 
pms
->
abcd
[0] = 0x67452301;

316 
pms
->
abcd
[1] = 
T_MASK
 ^ 0x10325476;

317 
pms
->
abcd
[2] = 
T_MASK
 ^ 0x67452301;

318 
pms
->
abcd
[3] = 0x10325476;

319 
	}
}

321 
MONGO_EXPORT
 

322 
	$m⁄go_md5_≠≥nd
(
m⁄go_md5_°©e_t
 *
pms
, c⁄° 
m⁄go_md5_byã_t
 *
d©a
, 
nbyãs
) {

323 c⁄° 
m⁄go_md5_byã_t
 *
p
 = 
d©a
;

324 
À·
 = 
nbyãs
;

325 
off£t
 = (
pms
->
cou¡
[0] >> 3) & 63;

326 
m⁄go_md5_w‹d_t
 
nbôs
 = (m⁄go_md5_w‹d_t)(
nbyãs
 << 3);

328 i‡(
nbyãs
 <= 0)

332 
pms
->
cou¡
[1] +
nbyãs
 >> 29;

333 
pms
->
cou¡
[0] +
nbôs
;

334 i‡(
pms
->
cou¡
[0] < 
nbôs
)

335 
pms
->
cou¡
[1]++;

338 i‡(
off£t
) {

339 
c›y
 = (
off£t
 + 
nbyãs
 > 64 ? 64 - offset :Çbytes);

341 
	`mem˝y
(
pms
->
buf
 + 
off£t
, 
p
, 
c›y
);

342 i‡(
off£t
 + 
c›y
 < 64)

344 
p
 +
c›y
;

345 
À·
 -
c›y
;

346 
	`m⁄go_md5_¥o˚ss
(
pms
,Öms->
buf
);

350 ; 
À·
 >64; 
p
 += 64,Üeft -= 64)

351 
	`m⁄go_md5_¥o˚ss
(
pms
, 
p
);

354 i‡(
À·
)

355 
	`mem˝y
(
pms
->
buf
, 
p
, 
À·
);

356 
	}
}

358 
MONGO_EXPORT
 

359 
	$m⁄go_md5_föish
(
m⁄go_md5_°©e_t
 *
pms
, 
m⁄go_md5_byã_t
 
dige°
[16]) {

360 c⁄° 
m⁄go_md5_byã_t
 
∑d
[64] = {

366 
m⁄go_md5_byã_t
 
d©a
[8];

367 
i
;

370 
i
 = 0; i < 8; ++i)

371 
d©a
[
i
] = (
m⁄go_md5_byã_t
)(
pms
->
cou¡
[i >> 2] >> ((i & 3) << 3));

373 
	`m⁄go_md5_≠≥nd
(
pms
, 
∑d
, ((55 - (pms->
cou¡
[0] >> 3)) & 63) + 1);

375 
	`m⁄go_md5_≠≥nd
(
pms
, 
d©a
, 8);

376 
i
 = 0; i < 16; ++i)

377 
dige°
[
i
] = (
m⁄go_md5_byã_t
)(
pms
->
abcd
[i >> 2] >> ((i & 3) << 3));

378 
	}
}

	@md5.h

50 #i‚de‡
MONGO_MD5_H_


51 
	#MONGO_MD5_H_


	)

62 
	~"bs⁄.h
"

64 
	tm⁄go_md5_byã_t
;

65 
	tm⁄go_md5_w‹d_t
;

68 
	sm⁄go_md5_°©e_s
 {

69 
m⁄go_md5_w‹d_t
 
	mcou¡
[2];

70 
m⁄go_md5_w‹d_t
 
	mabcd
[4];

71 
m⁄go_md5_byã_t
 
	mbuf
[64];

72 } 
	tm⁄go_md5_°©e_t
;

74 #ifde‡
__˝lu•lus


80 
MONGO_EXPORT
 
m⁄go_md5_öô
(
m⁄go_md5_°©e_t
 *
pms
);

83 
MONGO_EXPORT
 
m⁄go_md5_≠≥nd
(
m⁄go_md5_°©e_t
 *
pms
, c⁄° 
m⁄go_md5_byã_t
 *
d©a
, 
nbyãs
);

86 
MONGO_EXPORT
 
m⁄go_md5_föish
(
m⁄go_md5_°©e_t
 *
pms
, 
m⁄go_md5_byã_t
 
dige°
[16]);

88 #ifde‡
__˝lu•lus


	@mongo.c

18 #i‡
_MSC_VER
 && ! 
_CRT_SECURE_NO_WARNINGS


19 
	#_CRT_SECURE_NO_WARNINGS


	)

22 
	~"m⁄go.h
"

23 
	~"bs⁄.h
"

24 
	~"md5.h
"

25 
	~"ív.h
"

27 
	~<°rög.h
>

28 
	~<as£π.h
>

30 
MONGO_EXPORT
 
m⁄go
* 
	$m⁄go_Æloc
( ) {

31  ( 
m⁄go
* )
	`bs⁄_mÆloc
( ( mongo ) );

32 
	}
}

35 
MONGO_EXPORT
 
	$m⁄go_dóŒoc
(
m⁄go
* 
c⁄n
) {

36 
	`bs⁄_‰ì
–
c⁄n
 );

37 
	}
}

39 
MONGO_EXPORT
 
	$m⁄go_gë_îr
(
m⁄go
* 
c⁄n
) {

40  
c⁄n
->
îr
;

41 
	}
}

44 
MONGO_EXPORT
 
	$m⁄go_is_c⁄√˘ed
(
m⁄go
* 
c⁄n
) {

45  
c⁄n
->
c⁄√˘ed
 != 0;

46 
	}
}

49 
MONGO_EXPORT
 
	$m⁄go_gë_›_timeout
(
m⁄go
* 
c⁄n
) {

50  
c⁄n
->
›_timeout_ms
;

51 
	}
}

54 c⁄° * 
	$_gë_ho°_p‹t
(
m⁄go_ho°_p‹t
* 
hp
) {

55 
_hp
[(
hp
->
ho°
)+12];

56 
	`bs⁄_•rötf
(
_hp
, "%s:%d", 
hp
->
ho°
, hp->
p‹t
);

57  
_hp
;

58 
	}
}

61 
MONGO_EXPORT
 c⁄° * 
	$m⁄go_gë_¥im¨y
(
m⁄go
* 
c⁄n
) {

62 
m⁄go
* 
c⁄n_
 = (m⁄go*)
c⁄n
;

63 if–!(
c⁄n_
->
c⁄√˘ed
Ë|| (c⁄n_->
¥im¨y
->
ho°
[0] == '\0') )

64  
NULL
;

65  
	`_gë_ho°_p‹t
(
c⁄n_
->
¥im¨y
);

66 
	}
}

69 
MONGO_EXPORT
 
SOCKET
 
	$m⁄go_gë_sockë
(
m⁄go
* 
c⁄n
) {

70 
m⁄go
* 
c⁄n_
 = (m⁄go*)
c⁄n
;

71  
c⁄n_
->
sock
;

72 
	}
}

75 
MONGO_EXPORT
 
	$m⁄go_gë_ho°_cou¡
(
m⁄go
* 
c⁄n
) {

76 
m⁄go_ª∂iˇ_£t
* 
r
 = 
c⁄n
->
ª∂iˇ_£t
;

77 
m⁄go_ho°_p‹t
* 
hp
;

78 
cou¡
 = 0;

79 i‡(!
r
)  0;

80 
hp
 = 
r
->
ho°s
; hp; h∞hp->
√xt
)

81 ++
cou¡
;

82  
cou¡
;

83 
	}
}

86 
MONGO_EXPORT
 c⁄° * 
	$m⁄go_gë_ho°
(
m⁄go
* 
c⁄n
, 
i
) {

87 
m⁄go_ª∂iˇ_£t
* 
r
 = 
c⁄n
->
ª∂iˇ_£t
;

88 
m⁄go_ho°_p‹t
* 
hp
;

89 
cou¡
 = 0;

90 i‡(!
r
)  0;

91 
hp
 = 
r
->
ho°s
; hp; h∞hp->
√xt
) {

92 i‡(
cou¡
 =
i
)

93  
	`_gë_ho°_p‹t
(
hp
);

94 ++
cou¡
;

97 
	}
}

99 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫
* 
	$m⁄go_wrôe_c⁄˚∫_Æloc
( ) {

100  ( 
m⁄go_wrôe_c⁄˚∫
* )
	`bs⁄_mÆloc
( ( mongo_write_concern ) );

101 
	}
}

104 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_dóŒoc
–
m⁄go_wrôe_c⁄˚∫
* 
wrôe_c⁄˚∫
 ) {

105 
	`bs⁄_‰ì
–
wrôe_c⁄˚∫
 );

106 
	}
}

109 
MONGO_EXPORT
 
m⁄go_curs‹
* 
	$m⁄go_curs‹_Æloc
( ) {

110  ( 
m⁄go_curs‹
* )
	`bs⁄_mÆloc
( ( mongo_cursor ) );

111 
	}
}

114 
MONGO_EXPORT
 
	$m⁄go_curs‹_dóŒoc
–
m⁄go_curs‹
* 
curs‹
 ) {

115 
	`bs⁄_‰ì
–
curs‹
 );

116 
	}
}

119 
MONGO_EXPORT
 
	$m⁄go_gë_£rvî_îr
(
m⁄go
* 
c⁄n
) {

120  
c⁄n
->
œ°îrcode
;

121 
	}
}

124 
MONGO_EXPORT
 c⁄° * 
	$m⁄go_gë_£rvî_îr_°rög
(
m⁄go
* 
c⁄n
) {

125  
c⁄n
->
œ°îr°r
;

126 
	}
}

128 
MONGO_EXPORT
 
	$__m⁄go_£t_îr‹
–
m⁄go
 *
c⁄n
, 
m⁄go_îr‹_t
 
îr
, c⁄° *
°r
,

129 
îrcode
 ) {

130 
size_t
 
°r_size
 = 1;

131 
c⁄n
->
îr
 =Érr;

132 
c⁄n
->
îrcode
 =Érrcode;

133 if–
°r
 ) {

134 
°r_size
 = 
	`°æí
–
°r
 ) + 1;

135 i‡(
°r_size
 > 
MONGO_ERR_LEN
) str_size = MONGO_ERR_LEN;

136 
	`mem˝y
–
c⁄n
->
îr°r
, 
°r
, 
°r_size
 );

138 
c⁄n
->
îr°r
[
°r_size
-1] = '\0';

139 
	}
}

141 
MONGO_EXPORT
 
	$m⁄go_˛ór_îr‹s
–
m⁄go
 *
c⁄n
 ) {

142 
c⁄n
->
îr
 = 
MONGO_CONN_SUCCESS
;

143 
c⁄n
->
îrcode
 = 0;

144 
c⁄n
->
œ°îrcode
 = 0;

145 
c⁄n
->
îr°r
[0] = 0;

146 
c⁄n
->
œ°îr°r
[0] = 0;

147 
	}
}

150 *
	$m⁄go_ns_to_cmd_db
–c⁄° *
ns
 ) {

151 *
cuºít
 = 
NULL
;

152 *
cmd_db_«me
 = 
NULL
;

153 
Àn
 = 0;

155  
cuºít
 = (*)
ns
; *current != '.'; current++ ) {

156 
Àn
++;

159 
cmd_db_«me
 = (*)
	`bs⁄_mÆloc
–
Àn
 + 6 );

160 
	`°∫˝y
–
cmd_db_«me
, 
ns
, 
Àn
 );

161 
	`°∫˝y
–
cmd_db_«me
 + 
Àn
, ".$cmd", 6 );

163  
cmd_db_«me
;

164 
	}
}

166 
MONGO_EXPORT
 
	$m⁄go_vÆid©e_ns
–
m⁄go
 *
c⁄n
, c⁄° *
ns
 ) {

167 *
œ°
 = 
NULL
;

168 *
cuºít
 = 
NULL
;

169 c⁄° *
db_«me
 = 
ns
;

170 *
cﬁÀ˘i⁄_«me
 = 
NULL
;

171 
îrmsg
[64];

172 
ns_Àn
 = 0;

175 if–*
ns
 == '.' ) {

176 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
, "ns cannot start withá '.'.", 0 );

177  
MONGO_ERROR
;

181  
cuºít
 = (*)
ns
; *current != '\0'; current++ ) {

182 if–*
cuºít
 == '.' ) {

183 
cuºít
++;

189 if–*
cuºít
 == '.' ) {

190 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
, "ns cannot start withá '.'.", 0 );

191  
MONGO_ERROR
;

196 if–*
cuºít
 == '\0' ) {

197 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
, "CollectionÇame missing.", 0 );

198  
MONGO_ERROR
;

203 
cﬁÀ˘i⁄_«me
 = 
cuºít
;

206 if–
cﬁÀ˘i⁄_«me
 - 1 =
db_«me
 ) {

207 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
, "DatabaseÇame missing.", 0 );

208  
MONGO_ERROR
;

212  
cuºít
 = (*)
db_«me
; *current != '.'; current++ ) {

213  *
cuºít
 ) {

218 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
,

220  
MONGO_ERROR
;

225 
ns_Àn
++;

229 
ns_Àn
++;

232  
cuºít
 = 
cﬁÀ˘i⁄_«me
; *current != '\0'; current++ ) {

235 if–
œ°
 && *œ° ='.' && *
cuºít
 == '.' ) {

236 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
,

238  
MONGO_ERROR
;

242 if–*
cuºít
 == '$' ) {

243 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
,

245  
MONGO_ERROR
;

248 
œ°
 = 
cuºít
;

249 
ns_Àn
++;

252 if–
ns_Àn
 > 128 ) {

253 
	`bs⁄_•rötf
–
îrmsg
, "NamespaceÅooÜong; has %d but must <= 128.",

254 
ns_Àn
 );

255 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
, 
îrmsg
, 0 );

256  
MONGO_ERROR
;

260 if–*(
cuºít
 - 1) == '.' ) {

261 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_NS_INVALID
,

263  
MONGO_ERROR
;

266  
MONGO_OK
;

267 
	}
}

269 
	$m⁄go_£t_œ°_îr‹
–
m⁄go
 *
c⁄n
, 
bs⁄_ôî©‹
 *
ô
, 
bs⁄
 *
obj
 ) {

270 
bs⁄_ôî©‹
 
ôî
[1];

271 
ªsu…_Àn
 = 
	`bs⁄_ôî©‹_°rög_Àn
–
ô
 );

272 c⁄° *
ªsu…_°rög
 = 
	`bs⁄_ôî©‹_°rög
–
ô
 );

273 
Àn
 = 
ªsu…_Àn
 < 
MONGO_ERR_LEN
 ?Ñesult_len : MONGO_ERR_LEN;

274 
	`mem˝y
–
c⁄n
->
œ°îr°r
, 
ªsu…_°rög
, 
Àn
 );

275 
ôî
[0] = *
ô
;

276 if–
	`bs⁄_föd
–
ôî
, 
obj
, "code" ) !
BSON_NULL
 )

277 
c⁄n
->
œ°îrcode
 = 
	`bs⁄_ôî©‹_öt
–
ôî
 );

278 
	}
}

280 c⁄° 
	gZERO
 = 0;

281 c⁄° 
	gONE
 = 1;

282 
m⁄go_mesßge
 *
	$m⁄go_mesßge_¸óã
–
size_t
 
Àn
 , 
id
 , 
ª•⁄£To
 , 
›
 ) {

283 
m⁄go_mesßge
 *
mm
;

285 if–
Àn
 >
INT32_MAX
) {

286  
NULL
;

288 
mm
 = ( 
m⁄go_mesßge
 * )
	`bs⁄_mÆloc
–
Àn
 );

289 i‡–!
id
 )

290 
id
 = 
	`ønd
();

293 
mm
->
hód
.
Àn
 = ( )len;

294 
mm
->
hód
.
id
 = id;

295 
mm
->
hód
.
ª•⁄£To
 =ÑesponseTo;

296 
mm
->
hód
.
›
 = op;

298  
mm
;

299 
	}
}

302 
	$m⁄go_mesßge_£nd
–
m⁄go
 *
c⁄n
, 
m⁄go_mesßge
 *
mm
 ) {

303 
m⁄go_hódî
 
hód
;

304 
ªs
;

305 
	`bs⁄_lôée_ídün32
–&
hód
.
Àn
, &
mm
->head.len );

306 
	`bs⁄_lôée_ídün32
–&
hód
.
id
, &
mm
->head.id );

307 
	`bs⁄_lôée_ídün32
–&
hód
.
ª•⁄£To
, &
mm
->head.responseTo );

308 
	`bs⁄_lôée_ídün32
–&
hód
.
›
, &
mm
->head.op );

310 
ªs
 = 
	`m⁄go_ív_wrôe_sockë
–
c⁄n
, &
hód
, ( head ) );

311 if–
ªs
 !
MONGO_OK
 ) {

312 
	`bs⁄_‰ì
–
mm
 );

313  
ªs
;

316 
ªs
 = 
	`m⁄go_ív_wrôe_sockë
–
c⁄n
, &
mm
->
d©a
, mm->
hód
.
Àn
 - ( head ) );

317 if–
ªs
 !
MONGO_OK
 ) {

318 
	`bs⁄_‰ì
–
mm
 );

319  
ªs
;

322 
	`bs⁄_‰ì
–
mm
 );

323  
MONGO_OK
;

324 
	}
}

326 
	$m⁄go_ªad_ª•⁄£
–
m⁄go
 *
c⁄n
, 
m⁄go_ª∂y
 **
ª∂y
 ) {

327 
m⁄go_hódî
 
hód
;

328 
m⁄go_ª∂y_fõlds
 
fõlds
;

329 
m⁄go_ª∂y
 *
out
;

330 
Àn
;

331 
ªs
;

333 i‡––
ªs
 = 
	`m⁄go_ív_ªad_sockë
–
c⁄n
, &
hód
, –hód ) ) ) !
MONGO_OK
 ||

334 –
ªs
 = 
	`m⁄go_ív_ªad_sockë
–
c⁄n
, &
fõlds
, –fõld†ËËË!
MONGO_OK
 ) {

335  
ªs
;

338 
	`bs⁄_lôée_ídün32
–&
Àn
, &
hód
.len );

340 i‡–
Àn
 < –
hód
 )+–
fõlds
 ) ||Üen > 64*1024*1024 )

341  
MONGO_READ_SIZE_ERROR
;

350 
out
 = ( 
m⁄go_ª∂y
 * )
	`bs⁄_mÆloc
–(m⁄go_ª∂yË- (Ë+ 
Àn
 - 16 - 20 );

352 
out
->
hód
.
Àn
 =Üen;

353 
	`bs⁄_lôée_ídün32
–&
out
->
hód
.
id
, &head.id );

354 
	`bs⁄_lôée_ídün32
–&
out
->
hód
.
ª•⁄£To
, &head.responseTo );

355 
	`bs⁄_lôée_ídün32
–&
out
->
hód
.
›
, &head.op );

357 
	`bs⁄_lôée_ídün32
–&
out
->
fõlds
.
Êag
, &fields.flag );

358 
	`bs⁄_lôée_ídün64
–&
out
->
fõlds
.
curs‹ID
, &fields.cursorID );

359 
	`bs⁄_lôée_ídün32
–&
out
->
fõlds
.
°¨t
, &fields.start );

360 
	`bs⁄_lôée_ídün32
–&
out
->
fõlds
.
num
, &fields.num );

362 
ªs
 = 
	`m⁄go_ív_ªad_sockë
–
c⁄n
, &
out
->
objs
, 
Àn
 - 16 - 20 );

363 if–
ªs
 !
MONGO_OK
 ) {

364 
	`bs⁄_‰ì
–
out
 );

365  
ªs
;

368 *
ª∂y
 = 
out
;

370  
MONGO_OK
;

371 
	}
}

374 *
	$m⁄go_d©a_≠≥nd
–*
°¨t
 , c⁄° *
d©a
 , 
size_t
 
Àn
 ) {

375 
	`mem˝y
–
°¨t
 , 
d©a
 , 
Àn
 );

376  
°¨t
 + 
Àn
;

377 
	}
}

379 *
	$m⁄go_d©a_≠≥nd32
–*
°¨t
 , c⁄° *
d©a
 ) {

380 
	`bs⁄_lôée_ídün32
–
°¨t
 , 
d©a
 );

381  
°¨t
 + 4;

382 
	}
}

384 *
	$m⁄go_d©a_≠≥nd64
–*
°¨t
 , c⁄° *
d©a
 ) {

385 
	`bs⁄_lôée_ídün64
–
°¨t
 , 
d©a
 );

386  
°¨t
 + 8;

387 
	}
}

391 
	$m⁄go_check_is_ma°î
–
m⁄go
 *
c⁄n
 ) {

392 
bs⁄
 
out
;

393 
bs⁄_ôî©‹
 
ô
;

394 
bs⁄_boﬁ_t
 
isma°î
 = 0;

395 
max_bs⁄_size
 = 
MONGO_DEFAULT_MAX_BSON_SIZE
;

397 i‡–
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, "admö", "isma°î", 1, &
out
 ) !
MONGO_OK
 )

398  
MONGO_ERROR
;

400 if–
	`bs⁄_föd
–&
ô
, &
out
, "ismaster" ) )

401 
isma°î
 = 
	`bs⁄_ôî©‹_boﬁ
–&
ô
 );

402 if–
	`bs⁄_föd
–&
ô
, &
out
, "maxBsonObjectSize" ) )

403 
max_bs⁄_size
 = 
	`bs⁄_ôî©‹_öt
–&
ô
 );

404 
c⁄n
->
max_bs⁄_size
 = max_bson_size;

406 
	`bs⁄_de°roy
–&
out
 );

408 if–
isma°î
 )

409  
MONGO_OK
;

411 
c⁄n
->
îr
 = 
MONGO_CONN_NOT_MASTER
;

412  
MONGO_ERROR
;

414 
	}
}

416 
MONGO_EXPORT
 
	$m⁄go_öô_sockës
( ) {

417 
	`m⁄go_ív_sock_öô
();

418 
	}
}

421 
	gWC1_d©a
[] = {23,0,0,0,16,103,101,116,108,97,115,116,101,114,114,111,114,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0};

422 
bs⁄
 
	gWC1_cmd
 = {

423 
WC1_d©a
, WC1_data, 128, 1, 0

425 
m⁄go_wrôe_c⁄˚∫
 
	gWC1
 = { 1, 0, 0, 0, 0, &
WC1_cmd
 };

427 
MONGO_EXPORT
 
	$m⁄go_öô
–
m⁄go
 *
c⁄n
 ) {

428 
	`mem£t
–
c⁄n
, 0, –
m⁄go
 ) );

429 
c⁄n
->
max_bs⁄_size
 = 
MONGO_DEFAULT_MAX_BSON_SIZE
;

430 
	`m⁄go_£t_wrôe_c⁄˚∫
–
c⁄n
, &
WC1
 );

431 
	}
}

433 
MONGO_EXPORT
 
	$m⁄go_˛õ¡
–
m⁄go
 *
c⁄n
 , c⁄° *
ho°
, 
p‹t
 ) {

434 
	`m⁄go_öô
–
c⁄n
 );

436 
c⁄n
->
¥im¨y
 = (
m⁄go_ho°_p‹t
*)
	`bs⁄_mÆloc
( ( mongo_host_port ) );

437 
	`°∫˝y
–
c⁄n
->
¥im¨y
->
ho°
, ho°, 
	`°æí
( host ) + 1 );

438 
c⁄n
->
¥im¨y
->
p‹t
 =Öort;

439 
c⁄n
->
¥im¨y
->
√xt
 = 
NULL
;

441 if–
	`m⁄go_ív_sockë_c⁄√˘
–
c⁄n
, 
ho°
, 
p‹t
 ) !
MONGO_OK
 )

442  
MONGO_ERROR
;

444  
	`m⁄go_check_is_ma°î
–
c⁄n
 );

445 
	}
}

447 
MONGO_EXPORT
 
	$m⁄go_c⁄√˘
–
m⁄go
 *
c⁄n
 , c⁄° *
ho°
, 
p‹t
 ) {

448 
ªt
;

449 
	`bs⁄_îΩrötf
("WARNING: mongo_connect() is deprecated,Ölease use mongo_client()\n");

450 
ªt
 = 
	`m⁄go_˛õ¡
–
c⁄n
, 
ho°
, 
p‹t
 );

451 
	`m⁄go_£t_wrôe_c⁄˚∫
–
c⁄n
, 0 );

452  
ªt
;

453 
	}
}

455 
MONGO_EXPORT
 
	$m⁄go_ª∂iˇ_£t_öô
–
m⁄go
 *
c⁄n
, c⁄° *
«me
 ) {

456 
	`m⁄go_öô
–
c⁄n
 );

458 
c⁄n
->
ª∂iˇ_£t
 = (
m⁄go_ª∂iˇ_£t
*)
	`bs⁄_mÆloc
( ( mongo_replica_set ) );

459 
c⁄n
->
ª∂iˇ_£t
->
¥im¨y_c⁄√˘ed
 = 0;

460 
c⁄n
->
ª∂iˇ_£t
->
£eds
 = 
NULL
;

461 
c⁄n
->
ª∂iˇ_£t
->
ho°s
 = 
NULL
;

462 
c⁄n
->
ª∂iˇ_£t
->
«me
 = ( * )
	`bs⁄_mÆloc
–
	`°æí
(Çame ) + 1 );

463 
	`mem˝y
–
c⁄n
->
ª∂iˇ_£t
->
«me
,Çame, 
	`°æí
(Çame ) + 1 );

465 
c⁄n
->
¥im¨y
 = (
m⁄go_ho°_p‹t
*)
	`bs⁄_mÆloc
( ( mongo_host_port ) );

466 
c⁄n
->
¥im¨y
->
ho°
[0] = '\0';

467 
c⁄n
->
¥im¨y
->
√xt
 = 
NULL
;

468 
	}
}

470 
MONGO_EXPORT
 
	$m⁄go_ª∂£t_öô
–
m⁄go
 *
c⁄n
, c⁄° *
«me
 ) {

471 
	`bs⁄_îΩrötf
("WARNING: mongo_replset_init() is deprecated,Ölease use mongo_replica_set_init()\n");

472 
	`m⁄go_ª∂iˇ_£t_öô
–
c⁄n
, 
«me
 );

473 
	}
}

475 
	$m⁄go_ª∂iˇ_£t_add_node
–
m⁄go_ho°_p‹t
 **
li°
, c⁄° *
ho°
, 
p‹t
 ) {

476 
m⁄go_ho°_p‹t
 *
ho°_p‹t
 = (m⁄go_ho°_p‹t*)
	`bs⁄_mÆloc
( ( mongo_host_port ) );

477 
ho°_p‹t
->
p‹t
 =Öort;

478 
ho°_p‹t
->
√xt
 = 
NULL
;

479 
	`°∫˝y
–
ho°_p‹t
->
ho°
, ho°, 
	`°æí
( host ) + 1 );

481 if–*
li°
 =
NULL
 )

482 *
li°
 = 
ho°_p‹t
;

484 
m⁄go_ho°_p‹t
 *
p
 = *
li°
;

485  
p
->
√xt
 !
NULL
 )

486 
p
 =Ö->
√xt
;

487 
p
->
√xt
 = 
ho°_p‹t
;

489 
	}
}

491 
	$m⁄go_ª∂iˇ_£t_‰ì_li°
–
m⁄go_ho°_p‹t
 **
li°
 ) {

492 
m⁄go_ho°_p‹t
 *
node
 = *
li°
;

493 
m⁄go_ho°_p‹t
 *
¥ev
;

495  
node
 !
NULL
 ) {

496 
¥ev
 = 
node
;

497 
node
 =Çode->
√xt
;

498 
	`bs⁄_‰ì
–
¥ev
 );

501 *
li°
 = 
NULL
;

502 
	}
}

504 
MONGO_EXPORT
 
	$m⁄go_ª∂iˇ_£t_add_£ed
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 ) {

505 
	`m⁄go_ª∂iˇ_£t_add_node
–&
c⁄n
->
ª∂iˇ_£t
->
£eds
, 
ho°
, 
p‹t
 );

506 
	}
}

508 
MONGO_EXPORT
 
	$m⁄go_ª∂£t_add_£ed
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 ) {

509 
	`bs⁄_îΩrötf
("WARNING: mongo_replset_add_seed() is deprecated,Ölease use mongo_replica_set_add_seed()\n");

510 
	`m⁄go_ª∂iˇ_£t_add_node
–&
c⁄n
->
ª∂iˇ_£t
->
£eds
, 
ho°
, 
p‹t
 );

511 
	}
}

513 
	$m⁄go_∑r£_ho°
–c⁄° *
ho°_°rög
, 
m⁄go_ho°_p‹t
 *
ho°_p‹t
 ) {

514 
Àn
, 
idx
, 
•lô
;

515 
Àn
 = 
•lô
 = 
idx
 = 0;

519 if–*–
ho°_°rög
 + 
Àn
 ) == '\0' )

521 if–*–
ho°_°rög
 + 
Àn
 ) == ':' )

522 
•lô
 = 
Àn
;

524 
Àn
++;

529 
idx
 = 
•lô
 ? s∂ô : 
Àn
;

530 
	`mem˝y
–
ho°_p‹t
->
ho°
, 
ho°_°rög
, 
idx
 );

531 
	`mem˝y
–
ho°_p‹t
->
ho°
 + 
idx
, "\0", 1 );

532 if–
•lô
 )

533 
ho°_p‹t
->
p‹t
 = 
	`©oi
–
ho°_°rög
 + 
idx
 + 1 );

535 
ho°_p‹t
->
p‹t
 = 
MONGO_DEFAULT_PORT
;

536 
	}
}

538 
	$m⁄go_ª∂iˇ_£t_check_£ed
–
m⁄go
 *
c⁄n
 ) {

539 
bs⁄
 
out
[1];

540 c⁄° *
d©a
;

541 
bs⁄_ôî©‹
 
ô
[1];

542 
bs⁄_ôî©‹
 
ô_sub
[1];

543 c⁄° *
ho°_°rög
;

544 
m⁄go_ho°_p‹t
 *
ho°_p‹t
 = 
NULL
;

546 if–
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, "admö", "isma°î", 1, 
out
 ) =
MONGO_OK
 ) {

548 if–
	`bs⁄_föd
–
ô
, 
out
, "hosts" ) ) {

549 
d©a
 = 
	`bs⁄_ôî©‹_vÆue
–
ô
 );

550 
	`bs⁄_ôî©‹_‰om_buf„r
–
ô_sub
, 
d©a
 );

554  
	`bs⁄_ôî©‹_√xt
–
ô_sub
 ) ) {

555 
ho°_°rög
 = 
	`bs⁄_ôî©‹_°rög
–
ô_sub
 );

557 
ho°_p‹t
 = (
m⁄go_ho°_p‹t
*)
	`bs⁄_mÆloc
( ( mongo_host_port ) );

559 if–
ho°_p‹t
 ) {

560 
	`m⁄go_∑r£_ho°
–
ho°_°rög
, 
ho°_p‹t
 );

561 
	`m⁄go_ª∂iˇ_£t_add_node
–&
c⁄n
->
ª∂iˇ_£t
->
ho°s
,

562 
ho°_p‹t
->
ho°
, ho°_p‹t->
p‹t
 );

564 
	`bs⁄_‰ì
–
ho°_p‹t
 );

565 
ho°_p‹t
 = 
NULL
;

571 
	`bs⁄_de°roy
(
out
);

572 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

573 
c⁄n
->
sock
 = 0;

574 
c⁄n
->
c⁄√˘ed
 = 0;

575 
	}
}

580 
	$m⁄go_ª∂iˇ_£t_check_ho°
–
m⁄go
 *
c⁄n
 ) {

582 
bs⁄
 
out
[1];

583 
bs⁄_ôî©‹
 
ô
[1];

584 
bs⁄_boﬁ_t
 
isma°î
 = 0;

585 c⁄° *
£t_«me
;

586 
max_bs⁄_size
 = 
MONGO_DEFAULT_MAX_BSON_SIZE
;

588 i‡–
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, "admö", "isma°î", 1, 
out
 ) =
MONGO_OK
 ) {

589 if–
	`bs⁄_föd
–
ô
, 
out
, "ismaster" ) )

590 
isma°î
 = 
	`bs⁄_ôî©‹_boﬁ
–
ô
 );

592 if–
	`bs⁄_föd
–
ô
, 
out
, "maxBsonObjectSize" ) )

593 
max_bs⁄_size
 = 
	`bs⁄_ôî©‹_öt
–
ô
 );

594 
c⁄n
->
max_bs⁄_size
 = max_bson_size;

596 if–
	`bs⁄_föd
–
ô
, 
out
, "setName" ) ) {

597 
£t_«me
 = 
	`bs⁄_ôî©‹_°rög
–
ô
 );

598 if–
	`°rcmp
–
£t_«me
, 
c⁄n
->
ª∂iˇ_£t
->
«me
 ) != 0 ) {

599 
	`bs⁄_de°roy
–
out
 );

600 
c⁄n
->
îr
 = 
MONGO_CONN_BAD_SET_NAME
;

601  
MONGO_ERROR
;

606 
	`bs⁄_de°roy
–
out
 );

608 if–
isma°î
 ) {

609 
c⁄n
->
ª∂iˇ_£t
->
¥im¨y_c⁄√˘ed
 = 1;

612 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

615  
MONGO_OK
;

616 
	}
}

618 
MONGO_EXPORT
 
	$m⁄go_ª∂iˇ_£t_˛õ¡
–
m⁄go
 *
c⁄n
 ) {

620 
ªs
 = 0;

621 
m⁄go_ho°_p‹t
 *
node
;

623 
c⁄n
->
sock
 = 0;

624 
c⁄n
->
c⁄√˘ed
 = 0;

629 
node
 = 
c⁄n
->
ª∂iˇ_£t
->
£eds
;

630  
node
 !
NULL
 ) {

631 
ªs
 = 
	`m⁄go_ív_sockë_c⁄√˘
–
c⁄n
, ( c⁄° * )&
node
->
ho°
,Çode->
p‹t
 );

632 if–
ªs
 =
MONGO_OK
 ) {

633 
	`m⁄go_ª∂iˇ_£t_check_£ed
–
c⁄n
 );

634 if–
c⁄n
->
ª∂iˇ_£t
->
ho°s
 )

637 
node
 =Çode->
√xt
;

641 if–!
c⁄n
->
ª∂iˇ_£t
->
ho°s
 ) {

642 
c⁄n
->
îr
 = 
MONGO_CONN_NO_PRIMARY
;

643  
MONGO_ERROR
;

646 
node
 = 
c⁄n
->
ª∂iˇ_£t
->
ho°s
;

648  
node
 !
NULL
 ) {

649 
ªs
 = 
	`m⁄go_ív_sockë_c⁄√˘
–
c⁄n
, ( c⁄° * )&
node
->
ho°
,Çode->
p‹t
 );

651 if–
ªs
 =
MONGO_OK
 ) {

652 if–
	`m⁄go_ª∂iˇ_£t_check_ho°
–
c⁄n
 ) !
MONGO_OK
 )

653  
MONGO_ERROR
;

656 if–
c⁄n
->
ª∂iˇ_£t
->
¥im¨y_c⁄√˘ed
 ) {

657 
c⁄n
->
¥im¨y
 = 
	`bs⁄_mÆloc
––
m⁄go_ho°_p‹t
 ) );

658 
	`°∫˝y
–
c⁄n
->
¥im¨y
->
ho°
, 
node
->ho°, 
	`°æí
(Çode->host ) + 1 );

659 
c⁄n
->
¥im¨y
->
p‹t
 = 
node
->port;

660  
MONGO_OK
;

665 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

666 
c⁄n
->
sock
 = 0;

667 
c⁄n
->
c⁄√˘ed
 = 0;

671 
node
 =Çode->
√xt
;

676 
c⁄n
->
îr
 = 
MONGO_CONN_NO_PRIMARY
;

677  
MONGO_ERROR
;

678 
	}
}

680 
MONGO_EXPORT
 
	$m⁄go_ª∂£t_c⁄√˘
–
m⁄go
 *
c⁄n
 ) {

681 
ªt
;

682 
	`bs⁄_îΩrötf
("WARNING: mongo_replset_connect() is deprecated,Ölease use mongo_replica_set_client()\n");

683 
ªt
 = 
	`m⁄go_ª∂iˇ_£t_˛õ¡
–
c⁄n
 );

684 
	`m⁄go_£t_wrôe_c⁄˚∫
–
c⁄n
, 0 );

685  
ªt
;

686 
	}
}

688 
MONGO_EXPORT
 
	$m⁄go_£t_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 ) {

689 
c⁄n
->
›_timeout_ms
 = 
mûlis
;

690 if–
c⁄n
->
sock
 && c⁄n->
c⁄√˘ed
 )

691 
	`m⁄go_ív_£t_sockë_›_timeout
–
c⁄n
, 
mûlis
 );

693  
MONGO_OK
;

694 
	}
}

696 
MONGO_EXPORT
 
	$m⁄go_ªc⁄√˘
–
m⁄go
 *
c⁄n
 ) {

697 
ªs
;

698 
	`m⁄go_disc⁄√˘
–
c⁄n
 );

700 if–
c⁄n
->
ª∂iˇ_£t
 ) {

701 
c⁄n
->
ª∂iˇ_£t
->
¥im¨y_c⁄√˘ed
 = 0;

702 
	`m⁄go_ª∂iˇ_£t_‰ì_li°
–&
c⁄n
->
ª∂iˇ_£t
->
ho°s
 );

703 
c⁄n
->
ª∂iˇ_£t
->
ho°s
 = 
NULL
;

704 
ªs
 = 
	`m⁄go_ª∂iˇ_£t_˛õ¡
–
c⁄n
 );

705  
ªs
;

708  
	`m⁄go_ív_sockë_c⁄√˘
–
c⁄n
, c⁄n->
¥im¨y
->
ho°
, c⁄n->¥im¨y->
p‹t
 );

709 
	}
}

711 
MONGO_EXPORT
 
	$m⁄go_check_c⁄√˘i⁄
–
m⁄go
 *
c⁄n
 ) {

712 if–! 
c⁄n
->
c⁄√˘ed
 )

713  
MONGO_ERROR
;

715  
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, "admö", "pög", 1, 
NULL
 );

716 
	}
}

718 
MONGO_EXPORT
 
	$m⁄go_disc⁄√˘
–
m⁄go
 *
c⁄n
 ) {

719 if–! 
c⁄n
->
c⁄√˘ed
 )

722 if–
c⁄n
->
ª∂iˇ_£t
 ) {

723 
c⁄n
->
ª∂iˇ_£t
->
¥im¨y_c⁄√˘ed
 = 0;

724 
	`m⁄go_ª∂iˇ_£t_‰ì_li°
–&
c⁄n
->
ª∂iˇ_£t
->
ho°s
 );

725 
c⁄n
->
ª∂iˇ_£t
->
ho°s
 = 
NULL
;

728 
	`m⁄go_ív_˛o£_sockë
–
c⁄n
->
sock
 );

730 
c⁄n
->
sock
 = 0;

731 
c⁄n
->
c⁄√˘ed
 = 0;

732 
	}
}

734 
MONGO_EXPORT
 
	$m⁄go_de°roy
–
m⁄go
 *
c⁄n
 ) {

735 
	`m⁄go_disc⁄√˘
–
c⁄n
 );

737 if–
c⁄n
->
ª∂iˇ_£t
 ) {

738 
	`m⁄go_ª∂iˇ_£t_‰ì_li°
–&
c⁄n
->
ª∂iˇ_£t
->
£eds
 );

739 
	`m⁄go_ª∂iˇ_£t_‰ì_li°
–&
c⁄n
->
ª∂iˇ_£t
->
ho°s
 );

740 
	`bs⁄_‰ì
–
c⁄n
->
ª∂iˇ_£t
->
«me
 );

741 
	`bs⁄_‰ì
–
c⁄n
->
ª∂iˇ_£t
 );

742 
c⁄n
->
ª∂iˇ_£t
 = 
NULL
;

745 
	`bs⁄_‰ì
–
c⁄n
->
¥im¨y
 );

747 
	`m⁄go_˛ór_îr‹s
–
c⁄n
 );

748 
	}
}

751 
	$m⁄go_bs⁄_vÆid
–
m⁄go
 *
c⁄n
, c⁄° 
bs⁄
 *bs⁄, 
wrôe
 ) {

752 
size
;

754 if–! 
bs⁄
->
föished
 ) {

755 
c⁄n
->
îr
 = 
MONGO_BSON_NOT_FINISHED
;

756  
MONGO_ERROR
;

759 
size
 = 
	`bs⁄_size
–
bs⁄
 );

760 if–
size
 > 
c⁄n
->
max_bs⁄_size
 ) {

761 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

762  
MONGO_ERROR
;

765 if–
bs⁄
->
îr
 & 
BSON_NOT_UTF8
 ) {

766 
c⁄n
->
îr
 = 
MONGO_BSON_INVALID
;

767  
MONGO_ERROR
;

770 if–
wrôe
 ) {

771 if––
bs⁄
->
îr
 & 
BSON_FIELD_HAS_DOT
 ) ||

772 –
bs⁄
->
îr
 & 
BSON_FIELD_INIT_DOLLAR
 ) ) {

774 
c⁄n
->
îr
 = 
MONGO_BSON_INVALID
;

775  
MONGO_ERROR
;

780 
c⁄n
->
îr
 = 
MONGO_CONN_SUCCESS
;

782  
MONGO_OK
;

783 
	}
}

786 
	$m⁄go_curs‹_bs⁄_vÆid
–
m⁄go_curs‹
 *
curs‹
, c⁄° 
bs⁄
 *bson ) {

787 if–! 
bs⁄
->
föished
 ) {

788 
curs‹
->
îr
 = 
MONGO_CURSOR_BSON_ERROR
;

789 
curs‹
->
c⁄n
->
îr
 = 
MONGO_BSON_NOT_FINISHED
;

790  
MONGO_ERROR
;

793 if–
bs⁄
->
îr
 & 
BSON_NOT_UTF8
 ) {

794 
curs‹
->
îr
 = 
MONGO_CURSOR_BSON_ERROR
;

795 
curs‹
->
c⁄n
->
îr
 = 
MONGO_BSON_INVALID
;

796  
MONGO_ERROR
;

799  
MONGO_OK
;

800 
	}
}

802 
	$m⁄go_check_œ°_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
ns
,

803 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

804 
bs⁄
 
ª•⁄£
[1];

805 
bs⁄_ôî©‹
 
ô
[1];

806 
ªs
 = 0;

807 *
cmd_ns
 = 
	`m⁄go_ns_to_cmd_db
–
ns
 );

809 
ªs
 = 
	`m⁄go_föd_⁄e
–
c⁄n
, 
cmd_ns
, 
wrôe_c⁄˚∫
->
cmd
, 
	`bs⁄_sh¨ed_em±y
–), 
ª•⁄£
 );

810 
	`bs⁄_‰ì
–
cmd_ns
 );

812 i‡(
ªs
 =
MONGO_OK
 &&

813 (
	`bs⁄_föd
–
ô
, 
ª•⁄£
, "$îr" ) =
BSON_STRING
 ||

814 
	`bs⁄_föd
–
ô
, 
ª•⁄£
, "îr" ) =
BSON_STRING
)) {

816 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_WRITE_ERROR
,

818 
	`m⁄go_£t_œ°_îr‹
–
c⁄n
, 
ô
, 
ª•⁄£
 );

819 
ªs
 = 
MONGO_ERROR
;

822 
	`bs⁄_de°roy
–
ª•⁄£
 );

823  
ªs
;

824 
	}
}

826 
	$m⁄go_choo£_wrôe_c⁄˚∫
–
m⁄go
 *
c⁄n
,

827 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
,

828 
m⁄go_wrôe_c⁄˚∫
 **
wrôe_c⁄˚∫
 ) {

830 if–
cu°om_wrôe_c⁄˚∫
 ) {

831 *
wrôe_c⁄˚∫
 = 
cu°om_wrôe_c⁄˚∫
;

833 if–
c⁄n
->
wrôe_c⁄˚∫
 ) {

834 *
wrôe_c⁄˚∫
 = 
c⁄n
->write_concern;

836 i‡–*
wrôe_c⁄˚∫
 && (*wrôe_c⁄˚∫)->
w
 < 1 ) {

837 *
wrôe_c⁄˚∫
 = 0;

839 if–*
wrôe_c⁄˚∫
 && !((*wrôe_c⁄˚∫)->
cmd
) ) {

840 
	`__m⁄go_£t_îr‹
–
c⁄n
, 
MONGO_WRITE_CONCERN_INVALID
,

842  
MONGO_ERROR
;

845  
MONGO_OK
;

846 
	}
}

853 
	$m⁄go_mesßge_£nd_™d_check_wrôe_c⁄˚∫
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, 
m⁄go_mesßge
 *
mm
, 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

854 if–
wrôe_c⁄˚∫
 ) {

855 if–
	`m⁄go_mesßge_£nd
–
c⁄n
, 
mm
 ) =
MONGO_ERROR
 ) {

856  
MONGO_ERROR
;

859  
	`m⁄go_check_œ°_îr‹
–
c⁄n
, 
ns
, 
wrôe_c⁄˚∫
 );

862  
	`m⁄go_mesßge_£nd
–
c⁄n
, 
mm
 );

864 
	}
}

866 
MONGO_EXPORT
 
	$m⁄go_ö£π
–
m⁄go
 *
c⁄n
, c⁄° *
ns
,

867 c⁄° 
bs⁄
 *bs⁄, 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 ) {

869 *
d©a
;

870 
m⁄go_mesßge
 *
mm
;

871 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 = 
NULL
;

873 if–
	`m⁄go_vÆid©e_ns
–
c⁄n
, 
ns
 ) !
MONGO_OK
 )

874  
MONGO_ERROR
;

876 if–
	`m⁄go_bs⁄_vÆid
–
c⁄n
, 
bs⁄
, 1 ) !
MONGO_OK
 ) {

877  
MONGO_ERROR
;

880 if–
	`m⁄go_choo£_wrôe_c⁄˚∫
–
c⁄n
, 
cu°om_wrôe_c⁄˚∫
,

881 &
wrôe_c⁄˚∫
 ) =
MONGO_ERROR
 ) {

882  
MONGO_ERROR
;

885 
mm
 = 
	`m⁄go_mesßge_¸óã
( 16

887 + 
	`°æí
–
ns
 )

888 + 1 + 
	`bs⁄_size
–
bs⁄
 )

889 , 0, 0, 
MONGO_OP_INSERT
 );

890 if–
mm
 =
NULL
 ) {

891 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

892  
MONGO_ERROR
;

895 
d©a
 = &
mm
->data;

896 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

897 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
ns
, 
	`°æí
(Çs ) + 1 );

898 
	`m⁄go_d©a_≠≥nd
–
d©a
, 
bs⁄
->d©a, 
	`bs⁄_size
( bson ) );

900  
	`m⁄go_mesßge_£nd_™d_check_wrôe_c⁄˚∫
–
c⁄n
, 
ns
, 
mm
, 
wrôe_c⁄˚∫
 );

901 
	}
}

903 
MONGO_EXPORT
 
	$m⁄go_ö£π_b©ch
–
m⁄go
 *
c⁄n
, c⁄° *
ns
,

904 c⁄° 
bs⁄
 **
bs⁄s
, 
cou¡
, 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
,

905 
Êags
 ) {

907 
m⁄go_mesßge
 *
mm
;

908 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 = 
NULL
;

909 
i
;

910 *
d©a
;

911 
size_t
 
ovîhód
 = 16 + 4 + 
	`°æí
–
ns
 ) + 1;

912 
size_t
 
size
 = 
ovîhód
;

914 if–
	`m⁄go_vÆid©e_ns
–
c⁄n
, 
ns
 ) !
MONGO_OK
 )

915  
MONGO_ERROR
;

917  
i
=0; i<
cou¡
; i++ ) {

918 
size
 +
	`bs⁄_size
–
bs⁄s
[
i
] );

919 if–
	`m⁄go_bs⁄_vÆid
–
c⁄n
, 
bs⁄s
[
i
], 1 ) !
MONGO_OK
 )

920  
MONGO_ERROR
;

923 if––
size
 - 
ovîhód
 ) > (
size_t
)
c⁄n
->
max_bs⁄_size
 ) {

924 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

925  
MONGO_ERROR
;

928 if–
	`m⁄go_choo£_wrôe_c⁄˚∫
–
c⁄n
, 
cu°om_wrôe_c⁄˚∫
,

929 &
wrôe_c⁄˚∫
 ) =
MONGO_ERROR
 ) {

930  
MONGO_ERROR
;

933 
mm
 = 
	`m⁄go_mesßge_¸óã
–
size
 , 0 , 0 , 
MONGO_OP_INSERT
 );

934 if–
mm
 =
NULL
 ) {

935 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

936  
MONGO_ERROR
;

939 
d©a
 = &
mm
->data;

940 if–
Êags
 & 
MONGO_CONTINUE_ON_ERROR
 )

941 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ONE
 );

943 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

944 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
ns
, 
	`°æí
(Çs ) + 1 );

946  
i
=0; i<
cou¡
; i++ ) {

947 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
bs⁄s
[
i
]->d©a, 
	`bs⁄_size
( bsons[i] ) );

950  
	`m⁄go_mesßge_£nd_™d_check_wrôe_c⁄˚∫
–
c⁄n
, 
ns
, 
mm
, 
wrôe_c⁄˚∫
 );

951 
	}
}

953 
MONGO_EXPORT
 
	$m⁄go_upd©e
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
c⁄d
,

954 c⁄° 
bs⁄
 *
›
, 
Êags
, 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 ) {

956 *
d©a
;

957 
m⁄go_mesßge
 *
mm
;

958 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 = 
NULL
;

963 if–
	`m⁄go_bs⁄_vÆid
–
c⁄n
, ( 
bs⁄
 * )
›
, 0 ) !
MONGO_OK
 ) {

964  
MONGO_ERROR
;

967 if–
	`m⁄go_choo£_wrôe_c⁄˚∫
–
c⁄n
, 
cu°om_wrôe_c⁄˚∫
,

968 &
wrôe_c⁄˚∫
 ) =
MONGO_ERROR
 ) {

969  
MONGO_ERROR
;

972 
mm
 = 
	`m⁄go_mesßge_¸óã
( 16

974 + 
	`°æí
–
ns
 ) + 1

976 + 
	`bs⁄_size
–
c⁄d
 )

977 + 
	`bs⁄_size
–
›
 )

978 , 0 , 0 , 
MONGO_OP_UPDATE
 );

979 if–
mm
 =
NULL
 ) {

980 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

981  
MONGO_ERROR
;

984 
d©a
 = &
mm
->data;

985 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

986 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
ns
, 
	`°æí
(Çs ) + 1 );

987 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
Êags
 );

988 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
c⁄d
->d©a, 
	`bs⁄_size
( cond ) );

989 
	`m⁄go_d©a_≠≥nd
–
d©a
, 
›
->d©a, 
	`bs⁄_size
( op ) );

991  
	`m⁄go_mesßge_£nd_™d_check_wrôe_c⁄˚∫
–
c⁄n
, 
ns
, 
mm
, 
wrôe_c⁄˚∫
 );

992 
	}
}

994 
MONGO_EXPORT
 
	$m⁄go_ªmove
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
c⁄d
,

995 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 ) {

997 *
d©a
;

998 
m⁄go_mesßge
 *
mm
;

999 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 = 
NULL
;

1004 if–
	`m⁄go_bs⁄_vÆid
–
c⁄n
, ( 
bs⁄
 * )
c⁄d
, 0 ) !
MONGO_OK
 ) {

1005  
MONGO_ERROR
;

1008 if–
	`m⁄go_choo£_wrôe_c⁄˚∫
–
c⁄n
, 
cu°om_wrôe_c⁄˚∫
,

1009 &
wrôe_c⁄˚∫
 ) =
MONGO_ERROR
 ) {

1010  
MONGO_ERROR
;

1013 
mm
 = 
	`m⁄go_mesßge_¸óã
( 16

1015 + 
	`°æí
–
ns
 ) + 1

1017 + 
	`bs⁄_size
–
c⁄d
 )

1018 , 0 , 0 , 
MONGO_OP_DELETE
 );

1019 if–
mm
 =
NULL
 ) {

1020 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

1021  
MONGO_ERROR
;

1024 
d©a
 = &
mm
->data;

1025 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

1026 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
ns
, 
	`°æí
(Çs ) + 1 );

1027 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

1028 
	`m⁄go_d©a_≠≥nd
–
d©a
, 
c⁄d
->d©a, 
	`bs⁄_size
( cond ) );

1030  
	`m⁄go_mesßge_£nd_™d_check_wrôe_c⁄˚∫
–
c⁄n
, 
ns
, 
mm
, 
wrôe_c⁄˚∫
 );

1031 
	}
}

1038 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_öô
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

1039 
	`mem£t
–
wrôe_c⁄˚∫
, 0, –
m⁄go_wrôe_c⁄˚∫
 ) );

1040 
	}
}

1042 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_föish
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

1043 
bs⁄
 *
comm™d
;

1046 if–
wrôe_c⁄˚∫
->
cmd
 ) {

1047 
	`bs⁄_de°roy
–
wrôe_c⁄˚∫
->
cmd
 );

1048 
comm™d
 = 
wrôe_c⁄˚∫
->
cmd
;

1051 
comm™d
 = 
	`bs⁄_Æloc
();

1053 if–!
comm™d
 ) {

1054  
MONGO_ERROR
;

1057 
	`bs⁄_öô
–
comm™d
 );

1059 
	`bs⁄_≠≥nd_öt
–
comm™d
, "getlasterror", 1 );

1061 if–
wrôe_c⁄˚∫
->
mode
 ) {

1062 
	`bs⁄_≠≥nd_°rög
–
comm™d
, "w", 
wrôe_c⁄˚∫
->
mode
 );

1065 if–
wrôe_c⁄˚∫
->
w
 && write_concern->w > 1 ) {

1066 
	`bs⁄_≠≥nd_öt
–
comm™d
, "w", 
wrôe_c⁄˚∫
->
w
 );

1069 if–
wrôe_c⁄˚∫
->
wtimeout
 ) {

1070 
	`bs⁄_≠≥nd_öt
–
comm™d
, "wtimeout", 
wrôe_c⁄˚∫
->
wtimeout
 );

1073 if–
wrôe_c⁄˚∫
->
j
 ) {

1074 
	`bs⁄_≠≥nd_öt
–
comm™d
, "j", 
wrôe_c⁄˚∫
->
j
 );

1077 if–
wrôe_c⁄˚∫
->
fsync
 ) {

1078 
	`bs⁄_≠≥nd_öt
–
comm™d
, "fsync", 
wrôe_c⁄˚∫
->
fsync
 );

1081 
	`bs⁄_föish
–
comm™d
 );

1085 
wrôe_c⁄˚∫
->
cmd
 = 
comm™d
;

1087  
MONGO_OK
;

1088 
	}
}

1093 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_de°roy
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

1094 if–!
wrôe_c⁄˚∫
 )

1097 if–
wrôe_c⁄˚∫
->
cmd
 ) {

1098 
	`bs⁄_de°roy
–
wrôe_c⁄˚∫
->
cmd
 );

1099 
	`bs⁄_dóŒoc
–
wrôe_c⁄˚∫
->
cmd
 );

1100 
wrôe_c⁄˚∫
->
cmd
 = 
NULL
;

1102 
	}
}

1104 
MONGO_EXPORT
 
	$m⁄go_£t_wrôe_c⁄˚∫
–
m⁄go
 *
c⁄n
,

1105 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ) {

1107 
c⁄n
->
wrôe_c⁄˚∫
 = write_concern;

1108 
	}
}

1110 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_gë_w
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1111  
wrôe_c⁄˚∫
->
w
;

1112 
	}
}

1114 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_gë_wtimeout
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1115  
wrôe_c⁄˚∫
->
wtimeout
;

1116 
	}
}

1118 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_gë_j
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1119  
wrôe_c⁄˚∫
->
j
;

1120 
	}
}

1122 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_gë_fsync
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1123  
wrôe_c⁄˚∫
->
fsync
;

1124 
	}
}

1126 
MONGO_EXPORT
 c⁄° * 
	$m⁄go_wrôe_c⁄˚∫_gë_mode
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1127  
wrôe_c⁄˚∫
->
mode
;

1128 
	}
}

1130 
MONGO_EXPORT
 
bs⁄
* 
	$m⁄go_wrôe_c⁄˚∫_gë_cmd
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 ){

1131  
wrôe_c⁄˚∫
->
cmd
;

1132 
	}
}

1134 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_£t_w
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
w
 ){

1135 
wrôe_c⁄˚∫
->
w
 = w;

1136 
	}
}

1138 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_£t_wtimeout
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
wtimeout
 ){

1139 
wrôe_c⁄˚∫
->
wtimeout
 = wtimeout;

1141 
	}
}

1143 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_£t_j
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
j
 ){

1144 
wrôe_c⁄˚∫
->
j
 = j;

1145 
	}
}

1147 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_£t_fsync
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
fsync
 ){

1148 
wrôe_c⁄˚∫
->
fsync
 = fsync;

1150 
	}
}

1152 
MONGO_EXPORT
 
	$m⁄go_wrôe_c⁄˚∫_£t_mode
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, c⁄° * 
mode
 ){

1153 
wrôe_c⁄˚∫
->
mode
 = mode;

1154 
	}
}

1156 
	$m⁄go_curs‹_›_quîy
–
m⁄go_curs‹
 *
curs‹
 ) {

1157 
ªs
;

1158 *
d©a
;

1159 
m⁄go_mesßge
 *
mm
;

1160 
bs⁄
 
ãmp
;

1161 
bs⁄_ôî©‹
 
ô
;

1164 
	`m⁄go_˛ór_îr‹s
–
curs‹
->
c⁄n
 );

1167 if–! 
curs‹
->
quîy
 )

1168 
curs‹
->
quîy
 = 
	`bs⁄_sh¨ed_em±y
( );

1169 if–
	`m⁄go_curs‹_bs⁄_vÆid
–
curs‹
, curs‹->
quîy
 ) !
MONGO_OK
 )

1170  
MONGO_ERROR
;

1172 if–! 
curs‹
->
fõlds
 )

1173 
curs‹
->
fõlds
 = 
	`bs⁄_sh¨ed_em±y
( );

1174 if–
	`m⁄go_curs‹_bs⁄_vÆid
–
curs‹
, curs‹->
fõlds
 ) !
MONGO_OK
 )

1175  
MONGO_ERROR
;

1177 
mm
 = 
	`m⁄go_mesßge_¸óã
( 16 +

1179 
	`°æí
–
curs‹
->
ns
 ) + 1 +

1181 
	`bs⁄_size
–
curs‹
->
quîy
 ) +

1182 
	`bs⁄_size
–
curs‹
->
fõlds
 ) ,

1183 0 , 0 , 
MONGO_OP_QUERY
 );

1184 if–
mm
 =
NULL
 ) {

1185  
MONGO_ERROR
;

1188 
d©a
 = &
mm
->data;

1189 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©®, &
curs‹
->
›ti⁄s
 );

1190 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©®, 
curs‹
->
ns
 , 
	`°æí
( cursor->ns ) + 1 );

1191 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©®, &
curs‹
->
skù
 );

1192 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©®, &
curs‹
->
limô
 );

1193 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©®, 
curs‹
->
quîy
->d©®, 
	`bs⁄_size
( cursor->query ) );

1194 i‡–
curs‹
->
fõlds
 )

1195 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©®, 
curs‹
->
fõlds
->d©®, 
	`bs⁄_size
( cursor->fields ) );

1197 
	`bs⁄_Áèl_msg
––
d©a
 =––* )
mm
 ) + mm->
hód
.
Àn
 ), "query building fail!" );

1199 
ªs
 = 
	`m⁄go_mesßge_£nd
–
curs‹
->
c⁄n
 , 
mm
 );

1200 if–
ªs
 !
MONGO_OK
 ) {

1201  
MONGO_ERROR
;

1204 
ªs
 = 
	`m⁄go_ªad_ª•⁄£
–
curs‹
->
c⁄n
, ( 
m⁄go_ª∂y
 ** )&–curs‹->
ª∂y
 ) );

1205 if–
ªs
 !
MONGO_OK
 ) {

1206  
MONGO_ERROR
;

1209 if–
curs‹
->
ª∂y
->
fõlds
.
num
 == 1 ) {

1210 
	`bs⁄_öô_föished_d©a
–&
ãmp
, &
curs‹
->
ª∂y
->
objs
, 0 );

1211 if–
	`bs⁄_föd
–&
ô
, &
ãmp
, "$err" ) ) {

1212 
	`m⁄go_£t_œ°_îr‹
–
curs‹
->
c⁄n
, &
ô
, &
ãmp
 );

1213 
curs‹
->
îr
 = 
MONGO_CURSOR_QUERY_FAIL
;

1214  
MONGO_ERROR
;

1218 
curs‹
->
£í
 +curs‹->
ª∂y
->
fõlds
.
num
;

1219 
curs‹
->
Êags
 |
MONGO_CURSOR_QUERY_SENT
;

1220  
MONGO_OK
;

1221 
	}
}

1223 
	$m⁄go_curs‹_gë_m‹e
–
m⁄go_curs‹
 *
curs‹
 ) {

1224 
ªs
;

1226 if–
curs‹
->
limô
 > 0 && curs‹->
£í
 >= cursor->limit ) {

1227 
curs‹
->
îr
 = 
MONGO_CURSOR_EXHAUSTED
;

1228  
MONGO_ERROR
;

1230 if–! 
curs‹
->
ª∂y
 ) {

1231 
curs‹
->
îr
 = 
MONGO_CURSOR_INVALID
;

1232  
MONGO_ERROR
;

1234 if–! 
curs‹
->
ª∂y
->
fõlds
.
curs‹ID
 ) {

1235 
curs‹
->
îr
 = 
MONGO_CURSOR_EXHAUSTED
;

1236  
MONGO_ERROR
;

1239 *
d©a
;

1240 
size_t
 
¶
 = 
	`°æí
–
curs‹
->
ns
 )+1;

1241 
limô
 = 0;

1242 
m⁄go_mesßge
 *
mm
;

1244 if–
curs‹
->
limô
 > 0 )

1245 
limô
 = 
curs‹
->limô - curs‹->
£í
;

1247 
mm
 = 
	`m⁄go_mesßge_¸óã
( 16

1249 +
¶


1252 , 0, 0, 
MONGO_OP_GET_MORE
 );

1253 if–
mm
 =
NULL
 ) {

1254  
MONGO_ERROR
;

1257 
d©a
 = &
mm
->data;

1258 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

1259 
d©a
 = 
	`m⁄go_d©a_≠≥nd
–d©a, 
curs‹
->
ns
, 
¶
 );

1260 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
limô
 );

1261 
	`m⁄go_d©a_≠≥nd64
–
d©a
, &
curs‹
->
ª∂y
->
fõlds
.
curs‹ID
 );

1263 
	`bs⁄_‰ì
–
curs‹
->
ª∂y
 );

1264 
ªs
 = 
	`m⁄go_mesßge_£nd
–
curs‹
->
c⁄n
, 
mm
 );

1265 if–
ªs
 !
MONGO_OK
 ) {

1266 
	`m⁄go_curs‹_de°roy
–
curs‹
 );

1267  
MONGO_ERROR
;

1270 
ªs
 = 
	`m⁄go_ªad_ª•⁄£
–
curs‹
->
c⁄n
, &–curs‹->
ª∂y
 ) );

1271 if–
ªs
 !
MONGO_OK
 ) {

1272 
	`m⁄go_curs‹_de°roy
–
curs‹
 );

1273  
MONGO_ERROR
;

1275 
curs‹
->
cuºít
.
d©a
 = 
NULL
;

1276 
curs‹
->
£í
 +curs‹->
ª∂y
->
fõlds
.
num
;

1278  
MONGO_OK
;

1280 
	}
}

1282 
MONGO_EXPORT
 
m⁄go_curs‹
 *
	$m⁄go_föd
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
quîy
,

1283 c⁄° 
bs⁄
 *
fõlds
, 
limô
, 
skù
, 
›ti⁄s
 ) {

1285 
m⁄go_curs‹
 *
curs‹
 = 
	`m⁄go_curs‹_Æloc
();

1286 
	`m⁄go_curs‹_öô
–
curs‹
, 
c⁄n
, 
ns
 );

1287 
curs‹
->
Êags
 |
MONGO_CURSOR_MUST_FREE
;

1289 
	`m⁄go_curs‹_£t_quîy
–
curs‹
, 
quîy
 );

1290 
	`m⁄go_curs‹_£t_fõlds
–
curs‹
, 
fõlds
 );

1291 
	`m⁄go_curs‹_£t_limô
–
curs‹
, 
limô
 );

1292 
	`m⁄go_curs‹_£t_skù
–
curs‹
, 
skù
 );

1293 
	`m⁄go_curs‹_£t_›ti⁄s
–
curs‹
, 
›ti⁄s
 );

1295 if–
	`m⁄go_curs‹_›_quîy
–
curs‹
 ) =
MONGO_OK
 )

1296  
curs‹
;

1298 
	`m⁄go_curs‹_de°roy
–
curs‹
 );

1299  
NULL
;

1301 
	}
}

1303 
MONGO_EXPORT
 
	$m⁄go_föd_⁄e
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
quîy
,

1304 c⁄° 
bs⁄
 *
fõlds
, bs⁄ *
out
 ) {

1305 
ªt
;

1306 
m⁄go_curs‹
 
curs‹
[1];

1307 
	`m⁄go_curs‹_öô
–
curs‹
, 
c⁄n
, 
ns
 );

1308 
	`m⁄go_curs‹_£t_quîy
–
curs‹
, 
quîy
 );

1309 
	`m⁄go_curs‹_£t_fõlds
–
curs‹
, 
fõlds
 );

1310 
	`m⁄go_curs‹_£t_limô
–
curs‹
, 1 );

1312 
ªt
 = 
	`m⁄go_curs‹_√xt
(
curs‹
);

1313 i‡(
ªt
 =
MONGO_OK
 && 
out
)

1314 
ªt
 = 
	`bs⁄_c›y
(
out
, &
curs‹
->
cuºít
);

1315 i‡(
ªt
 !
MONGO_OK
)

1316 
	`bs⁄_öô_zîo
(
out
);

1318 
	`m⁄go_curs‹_de°roy
–
curs‹
 );

1319  
ªt
;

1320 
	}
}

1322 
MONGO_EXPORT
 
	$m⁄go_curs‹_öô
–
m⁄go_curs‹
 *
curs‹
, 
m⁄go
 *
c⁄n
, c⁄° *
ns
 ) {

1323 
	`mem£t
–
curs‹
, 0, –
m⁄go_curs‹
 ) );

1324 
curs‹
->
c⁄n
 = conn;

1325 
curs‹
->
ns
 = ( c⁄° * )
	`bs⁄_mÆloc
–
	`°æí
(Çs ) + 1 );

1326 
	`°∫˝y
––* )
curs‹
->
ns
,Çs, 
	`°æí
(Çs ) + 1 );

1327 
curs‹
->
cuºít
.
d©a
 = 
NULL
;

1328 
	}
}

1330 
MONGO_EXPORT
 
	$m⁄go_curs‹_£t_quîy
–
m⁄go_curs‹
 *
curs‹
, c⁄° 
bs⁄
 *
quîy
 ) {

1331 
curs‹
->
quîy
 = query;

1332 
	}
}

1334 
MONGO_EXPORT
 
	$m⁄go_curs‹_£t_fõlds
–
m⁄go_curs‹
 *
curs‹
, c⁄° 
bs⁄
 *
fõlds
 ) {

1335 
curs‹
->
fõlds
 = fields;

1336 
	}
}

1338 
MONGO_EXPORT
 
	$m⁄go_curs‹_£t_skù
–
m⁄go_curs‹
 *
curs‹
, 
skù
 ) {

1339 
curs‹
->
skù
 = skip;

1340 
	}
}

1342 
MONGO_EXPORT
 
	$m⁄go_curs‹_£t_limô
–
m⁄go_curs‹
 *
curs‹
, 
limô
 ) {

1343 
curs‹
->
limô
 =Üimit;

1344 
	}
}

1346 
MONGO_EXPORT
 
	$m⁄go_curs‹_£t_›ti⁄s
–
m⁄go_curs‹
 *
curs‹
, 
›ti⁄s
 ) {

1347 
curs‹
->
›ti⁄s
 = options;

1348 
	}
}

1350 
MONGO_EXPORT
 c⁄° *
	$m⁄go_curs‹_d©a
–
m⁄go_curs‹
 *
curs‹
 ) {

1351  
curs‹
->
cuºít
.
d©a
;

1352 
	}
}

1354 
MONGO_EXPORT
 c⁄° 
bs⁄
 *
	$m⁄go_curs‹_bs⁄
–
m⁄go_curs‹
 *
curs‹
 ) {

1355  (c⁄° 
bs⁄
 *)&(
curs‹
->
cuºít
);

1356 
	}
}

1358 
MONGO_EXPORT
 
	$m⁄go_curs‹_√xt
–
m⁄go_curs‹
 *
curs‹
 ) {

1359 *
√xt_obje˘
;

1360 *
mesßge_íd
;

1362 if–
curs‹
 =
NULL
 )  
MONGO_ERROR
;

1364 if–! ( 
curs‹
->
Êags
 & 
MONGO_CURSOR_QUERY_SENT
 ) )

1365 if–
	`m⁄go_curs‹_›_quîy
–
curs‹
 ) !
MONGO_OK
 )

1366  
MONGO_ERROR
;

1368 if–!
curs‹
->
ª∂y
 )

1369  
MONGO_ERROR
;

1372 i‡–
curs‹
->
ª∂y
->
fõlds
.
num
 == 0 ) {

1375 if–
curs‹
->
ª∂y
->
fõlds
.
curs‹ID
 ) {

1376 if––
	`m⁄go_curs‹_gë_m‹e
–
curs‹
 ) !
MONGO_OK
 ) ||

1377 
curs‹
->
ª∂y
->
fõlds
.
num
 == 0 ) {

1378  
MONGO_ERROR
;

1383  
MONGO_ERROR
;

1387 i‡–
curs‹
->
cuºít
.
d©a
 =
NULL
 ) {

1388 
	`bs⁄_öô_föished_d©a
–&
curs‹
->
cuºít
, &curs‹->
ª∂y
->
objs
, 0 );

1389  
MONGO_OK
;

1392 
√xt_obje˘
 = 
curs‹
->
cuºít
.
d©a
 + 
	`bs⁄_size
( &cursor->current );

1393 
mesßge_íd
 = ( * )
curs‹
->
ª∂y
 + curs‹->ª∂y->
hód
.
Àn
;

1395 i‡–
√xt_obje˘
 >
mesßge_íd
 ) {

1396 if–
	`m⁄go_curs‹_gë_m‹e
–
curs‹
 ) !
MONGO_OK
 )

1397  
MONGO_ERROR
;

1399 i‡–
curs‹
->
ª∂y
->
fõlds
.
num
 == 0 ) {

1401 i‡–
curs‹
->
ª∂y
->
fõlds
.
curs‹ID
 ) {

1402 
curs‹
->
îr
 = 
MONGO_CURSOR_PENDING
;

1403  
MONGO_ERROR
;

1406  
MONGO_ERROR
;

1409 
	`bs⁄_öô_föished_d©a
–&
curs‹
->
cuºít
, &curs‹->
ª∂y
->
objs
, 0 );

1412 
	`bs⁄_öô_föished_d©a
–&
curs‹
->
cuºít
, 
√xt_obje˘
, 0 );

1415  
MONGO_OK
;

1416 
	}
}

1418 
MONGO_EXPORT
 
	$m⁄go_curs‹_de°roy
–
m⁄go_curs‹
 *
curs‹
 ) {

1419 
ªsu…
 = 
MONGO_OK
;

1420 *
d©a
;

1422 i‡–!
curs‹
 )  
ªsu…
;

1425 i‡–
curs‹
->
ª∂y
 && curs‹->ª∂y->
fõlds
.
curs‹ID
 ) {

1426 
m⁄go
 *
c⁄n
 = 
curs‹
->conn;

1427 
m⁄go_mesßge
 *
mm
 = 
	`m⁄go_mesßge_¸óã
( 16

1431 , 0, 0, 
MONGO_OP_KILL_CURSORS
 );

1432 if–
mm
 =
NULL
 ) {

1433  
MONGO_ERROR
;

1435 
d©a
 = &
mm
->data;

1436 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ZERO
 );

1437 
d©a
 = 
	`m⁄go_d©a_≠≥nd32
–d©a, &
ONE
 );

1438 
	`m⁄go_d©a_≠≥nd64
–
d©a
, &
curs‹
->
ª∂y
->
fõlds
.
curs‹ID
 );

1440 
ªsu…
 = 
	`m⁄go_mesßge_£nd
–
c⁄n
, 
mm
 );

1443 
	`bs⁄_‰ì
–
curs‹
->
ª∂y
 );

1444 
	`bs⁄_‰ì
––* )
curs‹
->
ns
 );

1446 if–
curs‹
->
Êags
 & 
MONGO_CURSOR_MUST_FREE
 )

1447 
	`bs⁄_‰ì
–
curs‹
 );

1449  
ªsu…
;

1450 
	}
}

1454 
	#INDEX_NAME_BUFFER_SIZE
 255

	)

1455 
	#INDEX_NAME_MAX_LENGTH
 (
INDEX_NAME_BUFFER_SIZE
 - 1)

	)

1457 
MONGO_EXPORT
 
	$m⁄go_¸óã_ödex
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
key
, c⁄° *
«me
, 
›ti⁄s
, bs⁄ *
out
 ) {

1458 
bs⁄
 
b
;

1459 
bs⁄_ôî©‹
 
ô
;

1460 
deÁu…_«me
[
INDEX_NAME_BUFFER_SIZE
] = {'\0'};

1461 
size_t
 
Àn
 = 0;

1462 
size_t
 
ªmaöög
;

1463 
idxns
[1024];

1465 i‡–!
«me
 ) {

1466 
	`bs⁄_ôî©‹_öô
–&
ô
, 
key
 );

1467  
Àn
 < 
INDEX_NAME_MAX_LENGTH
 && 
	`bs⁄_ôî©‹_√xt
–&
ô
 ) ) {

1468 
ªmaöög
 = 
INDEX_NAME_MAX_LENGTH
 - 
Àn
;

1469 
	`°∫ˇt
–
deÁu…_«me
, 
	`bs⁄_ôî©‹_key
–&
ô
 ), 
ªmaöög
 );

1470 
Àn
 = 
	`°æí
–
deÁu…_«me
 );

1471 
ªmaöög
 = 
INDEX_NAME_MAX_LENGTH
 - 
Àn
;

1472 
	`°∫ˇt
–
deÁu…_«me
, ( 
	`bs⁄_ôî©‹_öt
–&
ô
 ) < 0 ) ? "_-1" : "_1", 
ªmaöög
 );

1473 
Àn
 = 
	`°æí
–
deÁu…_«me
 );

1477 
	`bs⁄_öô
–&
b
 );

1478 
	`bs⁄_≠≥nd_bs⁄
–&
b
, "key", 
key
 );

1479 
	`bs⁄_≠≥nd_°rög
–&
b
, "ns", 
ns
 );

1480 
	`bs⁄_≠≥nd_°rög
–&
b
, "«me", 
«me
 ?Çamê: 
deÁu…_«me
 );

1481 i‡–
›ti⁄s
 & 
MONGO_INDEX_UNIQUE
 )

1482 
	`bs⁄_≠≥nd_boﬁ
–&
b
, "unique", 1 );

1483 i‡–
›ti⁄s
 & 
MONGO_INDEX_DROP_DUPS
 )

1484 
	`bs⁄_≠≥nd_boﬁ
–&
b
, "dropDups", 1 );

1485 i‡–
›ti⁄s
 & 
MONGO_INDEX_BACKGROUND
 )

1486 
	`bs⁄_≠≥nd_boﬁ
–&
b
, "background", 1 );

1487 i‡–
›ti⁄s
 & 
MONGO_INDEX_SPARSE
 )

1488 
	`bs⁄_≠≥nd_boﬁ
–&
b
, "sparse", 1 );

1489 
	`bs⁄_föish
–&
b
 );

1491 
	`°∫˝y
–
idxns
, 
ns
, 1024-16 );

1492 
	`°r˝y
–
	`°rchr
–
idxns
, '.' ), ".system.indexes" );

1493 
	`m⁄go_ö£π
–
c⁄n
, 
idxns
, &
b
, 
NULL
 );

1494 
	`bs⁄_de°roy
–&
b
 );

1496 *
	`°rchr
–
idxns
, '.' ) = '\0';

1497  
	`m⁄go_cmd_gë_œ°_îr‹
–
c⁄n
, 
idxns
, 
out
 );

1498 
	}
}

1500 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$m⁄go_¸óã_sim∂e_ödex
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° *
fõld
, 
›ti⁄s
, 
bs⁄
 *
out
 ) {

1501 
bs⁄
 
b
[1];

1502 
bs⁄_boﬁ_t
 
suc˚ss
;

1504 
	`bs⁄_öô
–
b
 );

1505 
	`bs⁄_≠≥nd_öt
–
b
, 
fõld
, 1 );

1506 
	`bs⁄_föish
–
b
 );

1508 
suc˚ss
 = 
	`m⁄go_¸óã_ödex
–
c⁄n
, 
ns
, 
b
, 
NULL
, 
›ti⁄s
, 
out
 );

1509 
	`bs⁄_de°roy
–
b
 );

1510  
suc˚ss
;

1511 
	}
}

1513 
MONGO_EXPORT
 
	$m⁄go_¸óã_ˇµed_cﬁÀ˘i⁄
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

1514 c⁄° *
cﬁÀ˘i⁄
, 
size
, 
max
, 
bs⁄
 *
out
 ) {

1516 
bs⁄
 
b
[1];

1517 
ªsu…
;

1519 
	`bs⁄_öô
–
b
 );

1520 
	`bs⁄_≠≥nd_°rög
–
b
, "¸óã", 
cﬁÀ˘i⁄
 );

1521 
	`bs⁄_≠≥nd_boﬁ
–
b
, "capped", 1 );

1522 
	`bs⁄_≠≥nd_öt
–
b
, "size", 
size
 );

1523 if–
max
 > 0 )

1524 
	`bs⁄_≠≥nd_öt
–
b
, "max", 
size
 );

1525 
	`bs⁄_föish
–
b
 );

1527 
ªsu…
 = 
	`m⁄go_run_comm™d
–
c⁄n
, 
db
, 
b
, 
out
 );

1529 
	`bs⁄_de°roy
–
b
 );

1531  
ªsu…
;

1532 
	}
}

1534 
MONGO_EXPORT
 
	$m⁄go_cou¡
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° *
cﬁl
, c⁄° 
bs⁄
 *
quîy
 ) {

1535 
bs⁄
 
cmd
[1];

1536 
bs⁄
 
out
[1];

1537 
cou¡
 = 
MONGO_ERROR
;

1539 
	`bs⁄_öô
–
cmd
 );

1540 
	`bs⁄_≠≥nd_°rög
–
cmd
, "cou¡", 
cﬁl
 );

1541 i‡–
quîy
 && 
	`bs⁄_size
( query ) > 5 )

1542 
	`bs⁄_≠≥nd_bs⁄
–
cmd
, "quîy", 
quîy
 );

1543 
	`bs⁄_föish
–
cmd
 );

1545 if–
	`m⁄go_run_comm™d
–
c⁄n
, 
db
, 
cmd
, 
out
 ) =
MONGO_OK
 ) {

1546 
bs⁄_ôî©‹
 
ô
[1];

1547 if–
	`bs⁄_föd
–
ô
, 
out
, "n" ) )

1548 
cou¡
 = 
	`bs⁄_ôî©‹_doubÀ
–
ô
 );

1550 
	`bs⁄_de°roy
–
out
 );

1551 
	`bs⁄_de°roy
–
cmd
 );

1552  
cou¡
;

1553 
	}
}

1555 
MONGO_EXPORT
 
	$m⁄go_run_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° 
bs⁄
 *
comm™d
,

1556 
bs⁄
 *
out
 ) {

1557 
bs⁄
 
ª•⁄£
[1];

1558 
bs⁄_ôî©‹
 
ô
[1];

1559 
size_t
 
¶
 = 
	`°æí
–
db
 );

1560 *
ns
 = (*Ë
	`bs⁄_mÆloc
–
¶
 + 5 + 1 );

1561 
ªs
 = 0;

1563 
	`°r˝y
–
ns
, 
db
 );

1564 
	`°r˝y
–
ns
+
¶
, ".$cmd" );

1566 
ªs
 = 
	`m⁄go_föd_⁄e
–
c⁄n
, 
ns
, 
comm™d
, 
	`bs⁄_sh¨ed_em±y
–), 
ª•⁄£
 );

1567 
	`bs⁄_‰ì
–
ns
 );

1569 i‡(
ªs
 =
MONGO_OK
 && (!
	`bs⁄_föd
–
ô
, 
ª•⁄£
, "ok" ) || !
	`bs⁄_ôî©‹_boﬁ
( it )) ) {

1570 
c⁄n
->
îr
 = 
MONGO_COMMAND_FAILED
;

1571 
	`bs⁄_de°roy
–
ª•⁄£
 );

1572 
ªs
 = 
MONGO_ERROR
;

1575 i‡(
out
)

1576 i‡(
ªs
 =
MONGO_OK
)

1577 *
out
 = *
ª•⁄£
;

1579 
	`bs⁄_öô_zîo
(
out
);

1580 i‡(
ªs
 =
MONGO_OK
)

1581 
	`bs⁄_de°roy
(
ª•⁄£
);

1583  
ªs
;

1584 
	}
}

1586 
MONGO_EXPORT
 
	$m⁄go_sim∂e_öt_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

1587 c⁄° *
cmd°r
, 
¨g
, 
bs⁄
 *
out
 ) {

1589 
bs⁄
 
cmd
[1];

1590 
ªsu…
;

1592 
	`bs⁄_öô
–
cmd
 );

1593 
	`bs⁄_≠≥nd_öt
–
cmd
, 
cmd°r
, 
¨g
 );

1594 
	`bs⁄_föish
–
cmd
 );

1596 
ªsu…
 = 
	`m⁄go_run_comm™d
–
c⁄n
, 
db
, 
cmd
, 
out
 );

1598 
	`bs⁄_de°roy
–
cmd
 );

1600  
ªsu…
;

1601 
	}
}

1603 
MONGO_EXPORT
 
	$m⁄go_sim∂e_°r_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

1604 c⁄° *
cmd°r
, c⁄° *
¨g
, 
bs⁄
 *
out
 ) {

1606 
ªsu…
;

1607 
bs⁄
 
cmd
;

1608 
	`bs⁄_öô
–&
cmd
 );

1609 
	`bs⁄_≠≥nd_°rög
–&
cmd
, 
cmd°r
, 
¨g
 );

1610 
	`bs⁄_föish
–&
cmd
 );

1612 
ªsu…
 = 
	`m⁄go_run_comm™d
–
c⁄n
, 
db
, &
cmd
, 
out
 );

1614 
	`bs⁄_de°roy
–&
cmd
 );

1616  
ªsu…
;

1617 
	}
}

1619 
MONGO_EXPORT
 
	$m⁄go_cmd_dr›_db
–
m⁄go
 *
c⁄n
, c⁄° *
db
 ) {

1620  
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, 
db
, "dr›D©aba£", 1, 
NULL
 );

1621 
	}
}

1623 
MONGO_EXPORT
 
	$m⁄go_cmd_dr›_cﬁÀ˘i⁄
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° *
cﬁÀ˘i⁄
, 
bs⁄
 *
out
 ) {

1624  
	`m⁄go_sim∂e_°r_comm™d
–
c⁄n
, 
db
, "dr›", 
cﬁÀ˘i⁄
, 
out
 );

1625 
	}
}

1627 
MONGO_EXPORT
 
	$m⁄go_cmd_ª£t_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
 ) {

1628 
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, 
db
, "ª£ãº‹", 1, 
NULL
 );

1629 
	}
}

1631 
	$m⁄go_cmd_gë_îr‹_hñ≥r
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

1632 
bs⁄
 *
ªÆout
, c⁄° *
cmdty≥
 ) {

1634 
bs⁄
 
out
[1];

1635 
bs⁄_boﬁ_t
 
ha£º‹
 = 0;

1638 
	`m⁄go_˛ór_îr‹s
–
c⁄n
 );

1639 
	`bs⁄_öô_zîo
(
out
);

1642 if–
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, 
db
, 
cmdty≥
, 1, 
out
 ) =
MONGO_OK
 ) {

1643 
bs⁄_ôî©‹
 
ô
[1];

1644 
ha£º‹
 = ( 
	`bs⁄_föd
–
ô
, 
out
, "îr" ) !
BSON_NULL
 );

1645 if–
ha£º‹
 ) 
	`m⁄go_£t_œ°_îr‹
–
c⁄n
, 
ô
, 
out
 );

1648 if–
ªÆout
 )

1649 *
ªÆout
 = *
out
;

1651 
	`bs⁄_de°roy
–
out
 );

1653 if–
ha£º‹
 )

1654  
MONGO_ERROR
;

1656  
MONGO_OK
;

1657 
	}
}

1659 
MONGO_EXPORT
 
	$m⁄go_cmd_gë_¥ev_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
, 
bs⁄
 *
out
 ) {

1660  
	`m⁄go_cmd_gë_îr‹_hñ≥r
–
c⁄n
, 
db
, 
out
, "getpreverror" );

1661 
	}
}

1663 
MONGO_EXPORT
 
	$m⁄go_cmd_gë_œ°_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
, 
bs⁄
 *
out
 ) {

1664  
	`m⁄go_cmd_gë_îr‹_hñ≥r
–
c⁄n
, 
db
, 
out
, "getlasterror" );

1665 
	}
}

1667 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$m⁄go_cmd_isma°î
–
m⁄go
 *
c⁄n
, 
bs⁄
 *
ªÆout
 ) {

1668 
bs⁄
 
out
[1];

1669 
bs⁄_boﬁ_t
 
isma°î
 = 0;

1671 
ªs
 = 
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, "admö", "isma°î", 1, 
out
 );

1672 i‡(
ªs
 =
MONGO_OK
) {

1673 
bs⁄_ôî©‹
 
ô
[1];

1674 
	`bs⁄_föd
–
ô
, 
out
, "ismaster" );

1675 
isma°î
 = 
	`bs⁄_ôî©‹_boﬁ
–
ô
 );

1676 i‡(
ªÆout
)

1677 *
ªÆout
 = *
out
;

1679 
	`bs⁄_de°roy
–
out
 );

1680 } i‡(
ªÆout
)

1681 
	`bs⁄_öô_zîo
(
ªÆout
);

1683  
isma°î
;

1684 
	}
}

1686 
	$dige°2hex
–
m⁄go_md5_byã_t
 
dige°
[16], 
hex_dige°
[33] ) {

1687 c⁄° 
hex
[16] = {'0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f'};

1688 
i
;

1689  
i
=0; i<16; i++ ) {

1690 
hex_dige°
[2*
i
] = 
hex
[–
dige°
[i] & 0xf0 ) >> 4];

1691 
hex_dige°
[2*
i
 + 1] = 
hex
[ 
dige°
[i] & 0x0f ];

1693 
hex_dige°
[32] = '\0';

1694 
	}
}

1696 
	$m⁄go_∑ss_dige°
–
m⁄go
 *
c⁄n
, c⁄° *
u£r
, c⁄° *
∑ss
, 
hex_dige°
[33] ) {

1697 
m⁄go_md5_°©e_t
 
°
;

1698 
m⁄go_md5_byã_t
 
dige°
[16];

1700 if–
	`°æí
–
u£r
 ) >
INT32_MAX
 || såÀn–
∑ss
 ) >= INT32_MAX ) {

1701 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

1702  
MONGO_ERROR
;

1704 
	`m⁄go_md5_öô
–&
°
 );

1705 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )
u£r
, ( )
	`°æí
( user ) );

1706 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )":mongo:", 7 );

1707 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )
∑ss
, ( )
	`°æí
(Öass ) );

1708 
	`m⁄go_md5_föish
–&
°
, 
dige°
 );

1709 
	`dige°2hex
–
dige°
, 
hex_dige°
 );

1711  
MONGO_OK
;

1712 
	}
}

1714 
MONGO_EXPORT
 
	$m⁄go_cmd_add_u£r
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° *
u£r
, c⁄° *
∑ss
 ) {

1715 
bs⁄
 
u£r_obj
;

1716 
bs⁄
 
∑ss_obj
;

1717 
hex_dige°
[33];

1718 *
ns
 = 
	`bs⁄_mÆloc
–
	`°æí
–
db
 ) + strlen( ".system.users" ) + 1 );

1719 
ªs
;

1721 
	`°r˝y
–
ns
, 
db
 );

1722 
	`°r˝y
–
ns
+
	`°æí
–
db
 ), ".system.users" );

1724 
ªs
 = 
	`m⁄go_∑ss_dige°
–
c⁄n
, 
u£r
, 
∑ss
, 
hex_dige°
 );

1725 i‡(
ªs
 !
MONGO_OK
) {

1726 
	`‰ì
(
ns
);

1727  
ªs
;

1730 
	`bs⁄_öô
–&
u£r_obj
 );

1731 
	`bs⁄_≠≥nd_°rög
–&
u£r_obj
, "u£r", 
u£r
 );

1732 
	`bs⁄_föish
–&
u£r_obj
 );

1734 
	`bs⁄_öô
–&
∑ss_obj
 );

1735 
	`bs⁄_≠≥nd_°¨t_obje˘
–&
∑ss_obj
, "$set" );

1736 
	`bs⁄_≠≥nd_°rög
–&
∑ss_obj
, "pwd", 
hex_dige°
 );

1737 
	`bs⁄_≠≥nd_föish_obje˘
–&
∑ss_obj
 );

1738 
	`bs⁄_föish
–&
∑ss_obj
 );

1740 
ªs
 = 
	`m⁄go_upd©e
–
c⁄n
, 
ns
, &
u£r_obj
, &
∑ss_obj
, 
MONGO_UPDATE_UPSERT
, 
NULL
 );

1742 
	`bs⁄_‰ì
–
ns
 );

1743 
	`bs⁄_de°roy
–&
u£r_obj
 );

1744 
	`bs⁄_de°roy
–&
∑ss_obj
 );

1746  
ªs
;

1747 
	}
}

1749 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
	$m⁄go_cmd_authítiˇã
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° *
u£r
, c⁄° *
∑ss
 ) {

1750 
bs⁄
 
‰om_db
;

1751 
bs⁄
 
cmd
;

1752 c⁄° *
n⁄˚
;

1753 
ªsu…
;

1754 
bs⁄_ôî©‹
 
ô
;

1756 
m⁄go_md5_°©e_t
 
°
;

1757 
m⁄go_md5_byã_t
 
dige°
[16];

1758 
hex_dige°
[33];

1760 if–
	`m⁄go_sim∂e_öt_comm™d
–
c⁄n
, 
db
, "gën⁄˚", 1, &
‰om_db
 ) !
MONGO_OK
 )

1761  
MONGO_ERROR
;

1763 
	`bs⁄_föd
–&
ô
, &
‰om_db
, "nonce" );

1764 
n⁄˚
 = 
	`bs⁄_ôî©‹_°rög
–&
ô
 );

1766 
ªsu…
 = 
	`m⁄go_∑ss_dige°
–
c⁄n
, 
u£r
, 
∑ss
, 
hex_dige°
 );

1767 if–
ªsu…
 !
MONGO_OK
 ) {

1768  
ªsu…
;

1771 if–
	`°æí
–
n⁄˚
 ) >
INT32_MAX
 || såÀn–
u£r
 ) >= INT32_MAX ) {

1772 
c⁄n
->
îr
 = 
MONGO_BSON_TOO_LARGE
;

1773  
MONGO_ERROR
;

1776 
	`m⁄go_md5_öô
–&
°
 );

1777 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )
n⁄˚
, ( )
	`°æí
(Çonce ) );

1778 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )
u£r
, ( )
	`°æí
( user ) );

1779 
	`m⁄go_md5_≠≥nd
–&
°
, ( c⁄° 
m⁄go_md5_byã_t
 * )
hex_dige°
, 32 );

1780 
	`m⁄go_md5_föish
–&
°
, 
dige°
 );

1781 
	`dige°2hex
–
dige°
, 
hex_dige°
 );

1783 
	`bs⁄_öô
–&
cmd
 );

1784 
	`bs⁄_≠≥nd_öt
–&
cmd
, "authenticate", 1 );

1785 
	`bs⁄_≠≥nd_°rög
–&
cmd
, "u£r", 
u£r
 );

1786 
	`bs⁄_≠≥nd_°rög
–&
cmd
, "n⁄˚", 
n⁄˚
 );

1787 
	`bs⁄_≠≥nd_°rög
–&
cmd
, "key", 
hex_dige°
 );

1788 
	`bs⁄_föish
–&
cmd
 );

1790 
ªsu…
 = 
	`m⁄go_run_comm™d
–
c⁄n
, 
db
, &
cmd
, 
NULL
 );

1792 
	`bs⁄_de°roy
–&
‰om_db
 );

1793 
	`bs⁄_de°roy
–&
cmd
 );

1795  
ªsu…
;

1796 
	}
}

	@mongo.h

21 #i‚de‡
MONGO_H_


22 
	#MONGO_H_


	)

24 
	~"bs⁄.h
"

26 
	gMONGO_EXTERN_C_START


28 #i‡!
deföed
(
MONGO_ENV_STANDARD
Ë&& (deföed(
__APPLE__
Ë|| deföed(
__löux
Ë|| deföed(
__unix
Ë|| deföed(
__posix
))

29 
	tSOCKET
;

31 
size_t
 
	tSOCKET
;

35 
	#MONGO_MAJOR
 0

	)

36 
	#MONGO_MINOR
 7

	)

37 
	#MONGO_PATCH
 0

	)

39 
	#MONGO_OK
 0

	)

40 
	#MONGO_ERROR
 -1

	)

42 
	#MONGO_DEFAULT_PORT
 27017

	)

44 
	#MONGO_DEFAULT_MAX_BSON_SIZE
 4 * 1024 * 1024

	)

46 
	#MONGO_ERR_LEN
 128

	)

48 
	em⁄go_îr‹_t
 {

49 
	mMONGO_CONN_SUCCESS
 = 0,

50 
	mMONGO_CONN_NO_SOCKET
,

51 
	mMONGO_CONN_FAIL
,

52 
	mMONGO_CONN_ADDR_FAIL
,

53 
	mMONGO_CONN_NOT_MASTER
,

54 
	mMONGO_CONN_BAD_SET_NAME
,

55 
	mMONGO_CONN_NO_PRIMARY
,

57 
	mMONGO_IO_ERROR
,

58 
	mMONGO_SOCKET_ERROR
,

59 
	mMONGO_READ_SIZE_ERROR
,

60 
	mMONGO_COMMAND_FAILED
,

61 
	mMONGO_WRITE_ERROR
,

62 
	mMONGO_NS_INVALID
,

63 
	mMONGO_BSON_INVALID
,

64 
	mMONGO_BSON_NOT_FINISHED
,

65 
	mMONGO_BSON_TOO_LARGE
,

66 
	mMONGO_WRITE_CONCERN_INVALID


67 } 
	tm⁄go_îr‹_t
;

69 
	em⁄go_curs‹_îr‹_t
 {

70 
	mMONGO_CURSOR_EXHAUSTED
,

71 
	mMONGO_CURSOR_INVALID
,

72 
	mMONGO_CURSOR_PENDING
,

73 
	mMONGO_CURSOR_QUERY_FAIL
,

75 
	mMONGO_CURSOR_BSON_ERROR


77 } 
	tm⁄go_curs‹_îr‹_t
;

79 
	em⁄go_curs‹_Êags
 {

80 
	mMONGO_CURSOR_MUST_FREE
 = 1,

81 
	mMONGO_CURSOR_QUERY_SENT
 = ( 1<<1 )

84 
	em⁄go_ödex_›ts
 {

85 
	mMONGO_INDEX_UNIQUE
 = ( 1<<0 ),

86 
	mMONGO_INDEX_DROP_DUPS
 = ( 1<<2 ),

87 
	mMONGO_INDEX_BACKGROUND
 = ( 1<<3 ),

88 
	mMONGO_INDEX_SPARSE
 = ( 1<<4 )

91 
	em⁄go_upd©e_›ts
 {

92 
	mMONGO_UPDATE_UPSERT
 = 0x1,

93 
	mMONGO_UPDATE_MULTI
 = 0x2,

94 
	mMONGO_UPDATE_BASIC
 = 0x4

97 
	em⁄go_ö£π_›ts
 {

98 
	mMONGO_CONTINUE_ON_ERROR
 = 0x1

101 
	em⁄go_curs‹_›ts
 {

102 
	mMONGO_TAILABLE
 = ( 1<<1 ),

103 
	mMONGO_SLAVE_OK
 = ( 1<<2 ),

104 
	mMONGO_NO_CURSOR_TIMEOUT
 = ( 1<<4 ),

105 
	mMONGO_AWAIT_DATA
 = ( 1<<5 ),

106 
	mMONGO_EXHAUST
 = ( 1<<6 ),

107 
	mMONGO_PARTIAL
 = ( 1<<7 )

110 
	em⁄go_›î©i⁄s
 {

111 
	mMONGO_OP_MSG
 = 1000,

112 
	mMONGO_OP_UPDATE
 = 2001,

113 
	mMONGO_OP_INSERT
 = 2002,

114 
	mMONGO_OP_QUERY
 = 2004,

115 
	mMONGO_OP_GET_MORE
 = 2005,

116 
	mMONGO_OP_DELETE
 = 2006,

117 
	mMONGO_OP_KILL_CURSORS
 = 2007

120 #¥agm®
∑ck
(1)

122 
	mÀn
;

123 
	mid
;

124 
	mª•⁄£To
;

125 
	m›
;

126 } 
	tm⁄go_hódî
;

129 
m⁄go_hódî
 
	mhód
;

130 
	md©a
;

131 } 
	tm⁄go_mesßge
;

134 
	mÊag
;

135 
öt64_t
 
	mcurs‹ID
;

136 
	m°¨t
;

137 
	mnum
;

138 } 
	tm⁄go_ª∂y_fõlds
;

141 
m⁄go_hódî
 
	mhód
;

142 
m⁄go_ª∂y_fõlds
 
	mfõlds
;

143 
	mobjs
;

144 } 
	tm⁄go_ª∂y
;

145 #¥agm®
∑ck
()

147 
	sm⁄go_ho°_p‹t
 {

148 
	mho°
[255];

149 
	mp‹t
;

150 
m⁄go_ho°_p‹t
 *
	m√xt
;

151 } 
	tm⁄go_ho°_p‹t
;

153 
	sm⁄go_wrôe_c⁄˚∫
 {

154 
	mw
;

155 
	mwtimeout
;

156 
	mj
;

157 
	mfsync
;

158 c⁄° *
	mmode
;

160 
bs⁄
 *
	mcmd
;

161 } 
	tm⁄go_wrôe_c⁄˚∫
;

164 
m⁄go_ho°_p‹t
 *
	m£eds
;

165 
m⁄go_ho°_p‹t
 *
	mho°s
;

166 *
	m«me
;

167 
bs⁄_boﬁ_t
 
	m¥im¨y_c⁄√˘ed
;

168 } 
	tm⁄go_ª∂iˇ_£t
;

170 
	sm⁄go
 {

171 
m⁄go_ho°_p‹t
 *
	m¥im¨y
;

172 
m⁄go_ª∂iˇ_£t
 *
	mª∂iˇ_£t
;

173 
SOCKET
 
	msock
;

174 
	mÊags
;

175 
	mc⁄n_timeout_ms
;

176 
	m›_timeout_ms
;

177 
	mmax_bs⁄_size
;

178 
bs⁄_boﬁ_t
 
	mc⁄√˘ed
;

179 
m⁄go_wrôe_c⁄˚∫
 *
	mwrôe_c⁄˚∫
;

181 
m⁄go_îr‹_t
 
	mîr
;

182 
	mîrcode
;

183 
	mîr°r
[
MONGO_ERR_LEN
];

184 
	mœ°îrcode
;

185 
	mœ°îr°r
[
MONGO_ERR_LEN
];

186 } 
	tm⁄go
;

189 
m⁄go_ª∂y
 *
	mª∂y
;

190 
m⁄go
 *
	mc⁄n
;

191 c⁄° *
	mns
;

192 
	mÊags
;

193 
	m£í
;

194 
bs⁄
 
	mcuºít
;

195 
m⁄go_curs‹_îr‹_t
 
	mîr
;

196 c⁄° 
bs⁄
 *
	mquîy
;

197 c⁄° 
bs⁄
 *
	mfõlds
;

198 
	m›ti⁄s
;

199 
	mlimô
;

200 
	mskù
;

201 } 
	tm⁄go_curs‹
;

209 
MONGO_EXPORT
 
m⁄go_öô_sockës
( );

221 
MONGO_EXPORT
 
m⁄go_öô
–
m⁄go
 *
c⁄n
 );

233 
MONGO_EXPORT
 
m⁄go_˛õ¡
–
m⁄go
 *
c⁄n
 , c⁄° *
ho°
, 
p‹t
 );

246 
MONGO_EXPORT
 
m⁄go_c⁄√˘
–
m⁄go
 *
c⁄n
 , c⁄° *
ho°
, 
p‹t
 );

255 
MONGO_EXPORT
 
m⁄go_ª∂iˇ_£t_öô
–
m⁄go
 *
c⁄n
, c⁄° *
«me
 );

265 
MONGO_EXPORT
 
m⁄go_ª∂£t_öô
–
m⁄go
 *
c⁄n
, c⁄° *
«me
 );

276 
MONGO_EXPORT
 
m⁄go_ª∂iˇ_£t_add_£ed
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 );

288 
MONGO_EXPORT
 
m⁄go_ª∂£t_add_£ed
–
m⁄go
 *
c⁄n
, c⁄° *
ho°
, 
p‹t
 );

297 
m⁄go_∑r£_ho°
–c⁄° *
ho°_°rög
, 
m⁄go_ho°_p‹t
 *
ho°_p‹t
 );

308 
MONGO_EXPORT
 
m⁄go_vÆid©e_ns
–
m⁄go
 *
c⁄n
, c⁄° *
ns
 );

321 
MONGO_EXPORT
 
m⁄go_ª∂iˇ_£t_˛õ¡
–
m⁄go
 *
c⁄n
 );

335 
MONGO_EXPORT
 
m⁄go_ª∂£t_c⁄√˘
–
m⁄go
 *
c⁄n
 );

347 
MONGO_EXPORT
 
m⁄go_£t_›_timeout
–
m⁄go
 *
c⁄n
, 
mûlis
 );

357 
MONGO_EXPORT
 
m⁄go_check_c⁄√˘i⁄
–
m⁄go
 *
c⁄n
 );

370 
MONGO_EXPORT
 
m⁄go_ªc⁄√˘
–
m⁄go
 *
c⁄n
 );

379 
MONGO_EXPORT
 
m⁄go_disc⁄√˘
–
m⁄go
 *
c⁄n
 );

389 
MONGO_EXPORT
 
m⁄go_de°roy
–
m⁄go
 *
c⁄n
 );

400 
MONGO_EXPORT
 
m⁄go_£t_wrôe_c⁄˚∫
–
m⁄go
 *
c⁄n
,

401 
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

407 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_gë_w
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

408 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_gë_wtimeout
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

409 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_gë_j
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

410 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_gë_fsync
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

411 
MONGO_EXPORT
 c⁄° * 
m⁄go_wrôe_c⁄˚∫_gë_mode
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

412 
MONGO_EXPORT
 
bs⁄
* 
m⁄go_wrôe_c⁄˚∫_gë_cmd
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

418 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_£t_w
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
w
 );

419 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_£t_wtimeout
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
wtimeout
 );

420 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_£t_j
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
j
 );

421 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_£t_fsync
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, 
fsync
 );

422 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_£t_mode
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
, c⁄° * 
mode
 );

445 
MONGO_EXPORT
 
m⁄go_ö£π
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
d©a
,

446 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 );

467 
MONGO_EXPORT
 
m⁄go_ö£π_b©ch
–
m⁄go
 *
c⁄n
, c⁄° *
ns
,

468 c⁄° 
bs⁄
 **
d©a
, 
num
, 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
,

469 
Êags
 );

487 
MONGO_EXPORT
 
m⁄go_upd©e
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
c⁄d
,

488 c⁄° 
bs⁄
 *
›
, 
Êags
, 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 );

503 
MONGO_EXPORT
 
m⁄go_ªmove
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
c⁄d
,

504 
m⁄go_wrôe_c⁄˚∫
 *
cu°om_wrôe_c⁄˚∫
 );

515 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_öô
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

524 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_föish
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

530 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_de°roy
–
m⁄go_wrôe_c⁄˚∫
 *
wrôe_c⁄˚∫
 );

551 
MONGO_EXPORT
 
m⁄go_curs‹
 *
m⁄go_föd
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
quîy
,

552 c⁄° 
bs⁄
 *
fõlds
, 
limô
, 
skù
, 
›ti⁄s
 );

561 
MONGO_EXPORT
 
m⁄go_curs‹_öô
–
m⁄go_curs‹
 *
curs‹
, 
m⁄go
 *
c⁄n
, c⁄° *
ns
 );

574 
MONGO_EXPORT
 
m⁄go_curs‹_£t_quîy
–
m⁄go_curs‹
 *
curs‹
, c⁄° 
bs⁄
 *
quîy
 );

584 
MONGO_EXPORT
 
m⁄go_curs‹_£t_fõlds
–
m⁄go_curs‹
 *
curs‹
, c⁄° 
bs⁄
 *
fõlds
 );

592 
MONGO_EXPORT
 
m⁄go_curs‹_£t_skù
–
m⁄go_curs‹
 *
curs‹
, 
skù
 );

600 
MONGO_EXPORT
 
m⁄go_curs‹_£t_limô
–
m⁄go_curs‹
 *
curs‹
, 
limô
 );

609 
MONGO_EXPORT
 
m⁄go_curs‹_£t_›ti⁄s
–
m⁄go_curs‹
 *
curs‹
, 
›ti⁄s
 );

617 
MONGO_EXPORT
 c⁄° *
m⁄go_curs‹_d©a
–
m⁄go_curs‹
 *
curs‹
 );

625 
MONGO_EXPORT
 c⁄° 
bs⁄
 *
m⁄go_curs‹_bs⁄
–
m⁄go_curs‹
 *
curs‹
 );

636 
MONGO_EXPORT
 
m⁄go_curs‹_√xt
–
m⁄go_curs‹
 *
curs‹
 );

647 
MONGO_EXPORT
 
m⁄go_curs‹_de°roy
–
m⁄go_curs‹
 *
curs‹
 );

660 
MONGO_EXPORT
 
m⁄go_föd_⁄e
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
quîy
,

661 c⁄° 
bs⁄
 *
fõlds
, bs⁄ *
out
 );

679 
MONGO_EXPORT
 
m⁄go_cou¡
–
m⁄go
 *
c⁄n
, c⁄° *
db
, c⁄° *
cﬁl
,

680 c⁄° 
bs⁄
 *
quîy
 );

699 
MONGO_EXPORT
 
m⁄go_¸óã_ödex
–
m⁄go
 *
c⁄n
, c⁄° *
ns
, c⁄° 
bs⁄
 *
key
,

700 c⁄° *
«me
, 
›ti⁄s
, 
bs⁄
 *
out
 );

716 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
m⁄go_¸óã_sim∂e_ödex
–
m⁄go
 *
c⁄n
, c⁄° *
ns
,

717 c⁄° *
fõld
, 
›ti⁄s
, 
bs⁄
 *
out
 );

731 
MONGO_EXPORT
 
m⁄go_¸óã_ˇµed_cﬁÀ˘i⁄
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

732 c⁄° *
cﬁÀ˘i⁄
, 
size
, 
max
, 
bs⁄
 *
out
 );

744 
MONGO_EXPORT
 
m⁄go_run_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

745 c⁄° 
bs⁄
 *
comm™d
, bs⁄ *
out
 );

759 
MONGO_EXPORT
 
m⁄go_sim∂e_öt_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

760 c⁄° *
cmd
, 
¨g
, 
bs⁄
 *
out
 );

774 
MONGO_EXPORT
 
m⁄go_sim∂e_°r_comm™d
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

775 c⁄° *
cmd
, c⁄° *
¨g
, 
bs⁄
 *
out
 );

785 
MONGO_EXPORT
 
m⁄go_cmd_dr›_db
–
m⁄go
 *
c⁄n
, c⁄° *
db
 );

797 
MONGO_EXPORT
 
m⁄go_cmd_dr›_cﬁÀ˘i⁄
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

798 c⁄° *
cﬁÀ˘i⁄
, 
bs⁄
 *
out
 );

810 
MONGO_EXPORT
 
m⁄go_cmd_add_u£r
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

811 c⁄° *
u£r
, c⁄° *
∑ss
 );

823 
MONGO_EXPORT
 
m⁄go_cmd_authítiˇã
–
m⁄go
 *
c⁄n
, c⁄° *
db
,

824 c⁄° *
u£r
, c⁄° *
∑ss
 );

835 
MONGO_EXPORT
 
bs⁄_boﬁ_t
 
m⁄go_cmd_isma°î
–
m⁄go
 *
c⁄n
, 
bs⁄
 *
out
 );

850 
MONGO_EXPORT
 
m⁄go_cmd_gë_œ°_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
, 
bs⁄
 *
out
 );

865 
MONGO_EXPORT
 
m⁄go_cmd_gë_¥ev_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
, 
bs⁄
 *
out
 );

873 
MONGO_EXPORT
 
m⁄go_cmd_ª£t_îr‹
–
m⁄go
 *
c⁄n
, c⁄° *
db
 );

880 
MONGO_EXPORT
 
m⁄go
* 
m⁄go_Æloc
( );

881 
MONGO_EXPORT
 
m⁄go_dóŒoc
(
m⁄go
* 
c⁄n
);

882 
MONGO_EXPORT
 
m⁄go_gë_îr
(
m⁄go
* 
c⁄n
);

883 
MONGO_EXPORT
 
m⁄go_is_c⁄√˘ed
(
m⁄go
* 
c⁄n
);

884 
MONGO_EXPORT
 
m⁄go_gë_›_timeout
(
m⁄go
* 
c⁄n
);

885 
MONGO_EXPORT
 c⁄° * 
m⁄go_gë_¥im¨y
(
m⁄go
* 
c⁄n
);

886 
MONGO_EXPORT
 
SOCKET
 
m⁄go_gë_sockë
(
m⁄go
* 
c⁄n
) ;

887 
MONGO_EXPORT
 
m⁄go_gë_ho°_cou¡
(
m⁄go
* 
c⁄n
);

888 
MONGO_EXPORT
 c⁄° * 
m⁄go_gë_ho°
(
m⁄go
* 
c⁄n
, 
i
);

889 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫
* 
m⁄go_wrôe_c⁄˚∫_Æloc
( );

890 
MONGO_EXPORT
 
m⁄go_wrôe_c⁄˚∫_dóŒoc
(
m⁄go_wrôe_c⁄˚∫
* 
wrôe_c⁄˚∫
);

891 
MONGO_EXPORT
 
m⁄go_curs‹
* 
m⁄go_curs‹_Æloc
( );

892 
MONGO_EXPORT
 
m⁄go_curs‹_dóŒoc
(
m⁄go_curs‹
* 
curs‹
);

893 
MONGO_EXPORT
 
m⁄go_gë_£rvî_îr
(
m⁄go
* 
c⁄n
);

894 
MONGO_EXPORT
 c⁄° * 
m⁄go_gë_£rvî_îr_°rög
(
m⁄go
* 
c⁄n
);

904 
MONGO_EXPORT
 
__m⁄go_£t_îr‹
–
m⁄go
 *
c⁄n
, 
m⁄go_îr‹_t
 
îr
,

905 c⁄° *
îr°r
, 
îr‹code
 );

911 
MONGO_EXPORT
 
m⁄go_˛ór_îr‹s
–
m⁄go
 *
c⁄n
 );

913 
	gMONGO_EXTERN_C_END


	@mongo_except.h

30 #ifde‡
MONGO_CODE_EXAMPLE


31 
m⁄go_c⁄√˘i⁄
 
	gc⁄n
[1];

33 
	gMONGO_TRY
{

34 
m⁄go_föd_⁄e
(...);

35 
MONGO_THROW
(
c⁄n
, 
MONGO_EXCEPT_NETWORK
);

36 }
	gMONGO_CATCH
{

37 
	gc⁄n
->
	gex˚±i⁄
->
	gty≥
){

38 
	gMONGO_EXCEPT_NETWORK
:

39 
do_somëhög
();

40 
	gMONGO_EXCEPT_FIND_ERR
:

41 
do_somëhög
();

43 
MONGO_RETHROW
();

66 #i‚de‡
_MONGO_EXCEPT_H_


67 
	#_MONGO_EXCEPT_H_


	)

69 
	~<£tjmp.h
>

73 
	mMONGO_EXCEPT_NETWORK
=1,

74 
	mMONGO_EXCEPT_FIND_ERR


75 }
	tm⁄go_ex˚±i⁄_ty≥
;

79 
jmp_buf
 
	mba£_h™dÀr
;

80 
jmp_buf
 *
	m≥nv
;

81 
	mˇught
;

82 vﬁ©ûê
m⁄go_ex˚±i⁄_ty≥
 
	mty≥
;

83 }
	tm⁄go_ex˚±i⁄_c⁄ãxt
;

85 
	#MONGO_TRY
 
	`MONGO_TRY_GENERIC
(
c⁄n
)

	)

86 
	#MONGO_CATCH
 
	`MONGO_CATCH_GENERIC
(
c⁄n
)

	)

87 
	#MONGO_THROW
(
e
Ë
	`MONGO_THROW_GENERIC
(
c⁄n
,É)

	)

88 
	#MONGO_RETHROW
(Ë
	`MONGO_RETHROW_GENERIC
(
c⁄n
)

	)

93 
	#MONGO_INIT_EXCEPTION
(
ex˚±i⁄_±r
) \

95 
m⁄go_ex˚±i⁄_ty≥
 
t
; \

96 (
ex˚±i⁄_±r
)->
≥nv
 = &”x˚±i⁄_±r)->
ba£_h™dÀr
; \

97 i‡((
t
 = 
	`£tjmp
((
ex˚±i⁄_±r
)->
ba£_h™dÀr
))) { \

98 
t
){ \

99 
MONGO_EXCEPT_NETWORK
: 
	`bs⁄_Áèl_msg
(0, "networkÉrror"); \

100 
MONGO_EXCEPT_FIND_ERR
: 
	`bs⁄_Áèl_msg
(0, "error in find"); \

101 : 
	`bs⁄_Áèl_msg
(0, "unknownÉxception"); \

104 }0)

	)

106 
	#MONGO_TRY_GENERIC
(
c⁄√˘i⁄
) \

108 
jmp_buf
 *
ex˚±i⁄__¥ev
, 
ex˚±i⁄__ív
; \

109 
ex˚±i⁄__¥ev
 = (
c⁄√˘i⁄
)->
ex˚±i⁄
.
≥nv
; \

110 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
≥nv
 = &
ex˚±i⁄__ív
; \

111 i‡(
	`£tjmp
(
ex˚±i⁄__ív
) == 0) { \

112 do

	)

114 
	#MONGO_CATCH_GENERIC
(
c⁄√˘i⁄
) \

115 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
ˇught
 = 0, \

116 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
ˇught
); \

119 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
ˇught
 = 1; \

121 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
≥nv
 = 
ex˚±i⁄__¥ev
; \

123 i‡(!(
c⁄√˘i⁄
)->
ex˚±i⁄
.
ˇught
 ) { } \

124 

	)

135 
	#MONGO_THROW_GENERIC
(
c⁄√˘i⁄
, 
ty≥_ö
) \

136 ;; 
	`l⁄gjmp
(*(
c⁄√˘i⁄
)->
ex˚±i⁄
.
≥nv
, 
ty≥_ö
)) \

137 (
c⁄√˘i⁄
)->
ex˚±i⁄
.
ty≥
 = 
ty≥_ö


	)

139 
	#MONGO_RETHROW_GENERIC
(
c⁄√˘i⁄
) \

140 
	`MONGO_THROW_GENERIC
(
c⁄√˘i⁄
, (c⁄√˘i⁄)->
ex˚±i⁄
.
ty≥
)

	)

	@netGet.c

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<°rög.h
>

4 
	~<cuæ/cuæ.h
>

6 
	~<sys/ty≥s.h
>

7 
	~<sys/°©.h
>

8 
	~<uni°d.h
>

9 
	~<îr‹.h
>

10 
	~<î∫o.h
>

11 
	~<dúít.h
>

13 
	~<R.h
>

14 
	~<Röã∫Æs.h
>

16 
	~<R_ext/Arôh.h
>

17 
	~<R_ext/Eº‹.h
>

18 
	~<Rdeföes.h
>

19 
	~"R_ext/Rdy∆ﬂd.h
"

21 
	#MAX_QUERY_LEN
 1024*64

	)

23 
size_t
 
	$wrôe_d©a
(*
buf„r
, 
size_t
 
size
, size_à
nmemb
, *
u£Ω
)

26 
ªtv
 = 0;

28 
	`¢¥ötf
(
u£Ω
, 
MAX_QUERY_LEN
, "%s", (*)
buf„r
);

30  (
ªtv
);

31 
	}
}

33 
SEXP
 
	$√tGë
(
SEXP
 
°k
, SEXP 
uæ
)

36 
CURL
 *
cuæ
;

37 
CURLcode
 
ªs
;

39 *
buf„r
, *
ubuff
;

41 
SEXP
 
ªsu…
, 
dim
;

42 
xmax
, 
i
, 
p
 = 0;

44 
buf„r
 = 
	`CÆloc
(
MAX_QUERY_LEN
, );

45 
ubuff
 = 
	`CÆloc
(
MAX_QUERY_LEN
, );

47 
xmax
 = 
	`LENGTH
(
°k
);

49 
	`PROTECT
(
ªsu…
 = 
	`ÆlocVe˘‹
(
STRSXP
, 
xmax
 * 2));

50 
p
++;

52 
cuæ
 = 
	`cuæ_ósy_öô
();

53 i‡(
cuæ
) {

55 
i
 = 0; i < 
xmax
; i++) {

56 
	`mem£t
(
ubuff
,0x0,()*
MAX_QUERY_LEN
);

57 
	`¢¥ötf
(
ubuff
, 
MAX_QUERY_LEN
, 
	`CHAR
(
	`STRING_ELT
(
uæ
, 0)), CHAR(STRING_ELT(
°k
, 
i
)));

59 
	`cuæ_ósy_£t›t
(
cuæ
, 
CURLOPT_URL
, 
ubuff
);

61 
	`cuæ_ósy_£t›t
(
cuæ
, 
CURLOPT_WRITEDATA
, 
buf„r
);

62 
	`cuæ_ósy_£t›t
(
cuæ
, 
CURLOPT_WRITEFUNCTION
, 
wrôe_d©a
);

64 i‡((
ªs
 = 
	`cuæ_ósy_≥rf‹m
(
cuæ
)) == 0) {

66 
	`SET_STRING_ELT
(
ªsu…
, 
i
, 
	`mkCh¨
(
	`CHAR
(
	`STRING_ELT
(
°k
, i))));

67 
	`SET_STRING_ELT
(
ªsu…
, 
xmax
 + 
i
, 
	`mkCh¨
(
buf„r
));

69 
	`SET_STRING_ELT
(
ªsu…
, 
i
, 
NA_STRING
);

70 
	`SET_STRING_ELT
(
ªsu…
, 
xmax
 + 
i
, 
	`mkCh¨
(
buf„r
));

76 
	`cuæ_ósy_˛ónup
(
cuæ
);

77 
	`‰ì
(
buf„r
);

78 
	`‰ì
(
ubuff
);

82 
	`PROTECT
(
dim
 = 
	`ÆlocVe˘‹
(
INTSXP
, 2));

83 
p
++;

84 
	`INTEGER
(
dim
)[0] = 
xmax
;

85 
	`INTEGER
(
dim
)[1] = 2;

86 
	`£tAârib
(
ªsu…
, 
R_DimSymbﬁ
, 
dim
);

88 
	`UNPROTECT
(
p
);

90  (
ªsu…
);

91 
	}
}

	@numbers.c

17 c⁄° 
	gbs⁄_num°rs
[1000][4] = {

	@optionParse.c

9 
	~<îr.h
>

10 
	~<î∫o.h
>

11 
	~<gë›t.h
>

12 
	~<°dlib.h
>

13 
	~<°rög.h
>

15 #ifde‡
REPLACE_GETOPT


16 
	g›ãº
 = 1;

17 
	g›töd
 = 1;

18 
	g›t›t
 = '?';

19 *
	g›èrg
 = 
NULL
;

21 
	g›åe£t
 = 0;

23 
	#PRINT_ERROR
 ((
›ãº
Ë&& (*
›ti⁄s
 !':'))

	)

25 
	#FLAG_PERMUTE
 0x01

	)

26 
	#FLAG_ALLARGS
 0x02

	)

27 
	#FLAG_LONGONLY
 0x04

	)

30 
	#BADCH
 ()'?'

	)

31 
	#BADARG
 ((*
›ti⁄s
 =':'Ë? ()':' : ()'?')

	)

32 
	#INORDER
 ()1

	)

34 
	#EMSG
 ""

	)

36 
gë›t_öã∫Æ
(, *c⁄° *, c⁄° *, c⁄° 
›ti⁄
 *, *, );

37 
∑r£_l⁄g_›ti⁄s
(*c⁄° *, c⁄° *, c⁄° 
›ti⁄
 *, *, );

38 
gcd
(, );

39 
≥rmuã_¨gs
(, , , *const *);

41 *
	g∂a˚
 = 
EMSG
;

44 
	gn⁄›t_°¨t
 = -1;

45 
	gn⁄›t_íd
 = -1;

48 c⁄° 
	gªˇrgch¨
[] = "optionÑequiresánárgument -- %c";

49 c⁄° 
	gªˇrg°rög
[] = "optionÑequiresánárgument -- %s";

50 c⁄° 
	gambig
[] = "ambiguous option -- %.*s";

51 c⁄° 
	gnﬂrg
[] = "option doesn'tÅakeánárgument -- %.*s";

52 c⁄° 
	gûl›tch¨
[] = "unknown option -- %c";

53 c⁄° 
	gûl›t°rög
[] = "unknown option -- %s";

58 
	$gcd
(
a
, 
b
)

60 
c
;

62 
c
 = 
a
 % 
b
;

63 
c
 != 0) {

64 
a
 = 
b
;

65 
b
 = 
c
;

66 
c
 = 
a
 % 
b
;

69  (
b
);

70 
	}
}

77 
	$≥rmuã_¨gs
(
∑n⁄›t_°¨t
, 
∑n⁄›t_íd
, 
›t_íd
, *c⁄° *
«rgv
)

79 
c°¨t
, 
cy˛ñí
, 
i
, 
j
, 
ncy˛e
, 
¬⁄›ts
, 
n›ts
, 
pos
;

80 *
sw≠
;

85 
¬⁄›ts
 = 
∑n⁄›t_íd
 - 
∑n⁄›t_°¨t
;

86 
n›ts
 = 
›t_íd
 - 
∑n⁄›t_íd
;

87 
ncy˛e
 = 
	`gcd
(
¬⁄›ts
, 
n›ts
);

88 
cy˛ñí
 = (
›t_íd
 - 
∑n⁄›t_°¨t
Ë/ 
ncy˛e
;

90 
i
 = 0; i < 
ncy˛e
; i++) {

91 
c°¨t
 = 
∑n⁄›t_íd
 + 
i
;

92 
pos
 = 
c°¨t
;

93 
j
 = 0; j < 
cy˛ñí
; j++) {

94 i‡(
pos
 >
∑n⁄›t_íd
)

95 
pos
 -
¬⁄›ts
;

97 
pos
 +
n›ts
;

98 
sw≠
 = 
«rgv
[
pos
];

100 ((**)
«rgv
)[
pos
] =Ç¨gv[
c°¨t
];

102 ((**)
«rgv
)[
c°¨t
] = 
sw≠
;

105 
	}
}

113 
	$∑r£_l⁄g_›ti⁄s
(*c⁄° *
«rgv
, c⁄° *
›ti⁄s
, c⁄° 
›ti⁄
 *
l⁄g_›ti⁄s
, *
idx
, 
sh‹t_too
)

115 *
cuºít_¨gv
, *
has_equÆ
;

116 
size_t
 
cuºít_¨gv_Àn
;

117 
i
, 
m©ch
;

119 
cuºít_¨gv
 = 
∂a˚
;

120 
m©ch
 = -1;

122 
›töd
++;

124 i‡((
has_equÆ
 = 
	`°rchr
(
cuºít_¨gv
, '=')Ë!
NULL
) {

126 
cuºít_¨gv_Àn
 = 
has_equÆ
 - 
cuºít_¨gv
;

127 
has_equÆ
++;

129 
cuºít_¨gv_Àn
 = 
	`°æí
(
cuºít_¨gv
);

131 
i
 = 0; 
l⁄g_›ti⁄s
[i].
«me
; i++) {

133 i‡(
	`°∫cmp
(
cuºít_¨gv
, 
l⁄g_›ti⁄s
[
i
].
«me
, 
cuºít_¨gv_Àn
))

136 i‡(
	`°æí
(
l⁄g_›ti⁄s
[
i
].
«me
Ë=
cuºít_¨gv_Àn
) {

138 
m©ch
 = 
i
;

145 i‡(
sh‹t_too
 && 
cuºít_¨gv_Àn
 == 1)

148 i‡(
m©ch
 == -1)

149 
m©ch
 = 
i
;

152 i‡(
PRINT_ERROR
)

153 
	`w¨nx
(
ambig
, ()
cuºít_¨gv_Àn
, 
cuºít_¨gv
);

154 
›t›t
 = 0;

155  (
BADCH
);

158 i‡(
m©ch
 != -1) {

159 i‡(
l⁄g_›ti⁄s
[
m©ch
].
has_¨g
 =
no_¨gumít
 && 
has_equÆ
) {

160 i‡(
PRINT_ERROR
)

161 
	`w¨nx
(
nﬂrg
, ()
cuºít_¨gv_Àn
, 
cuºít_¨gv
);

165 i‡(
l⁄g_›ti⁄s
[
m©ch
].
Êag
 =
NULL
)

166 
›t›t
 = 
l⁄g_›ti⁄s
[
m©ch
].
vÆ
;

168 
›t›t
 = 0;

169  (
BADARG
);

171 i‡(
l⁄g_›ti⁄s
[
m©ch
].
has_¨g
 =
ªquúed_¨gumít
 ||Ü⁄g_›ti⁄s[m©ch].has_¨g =
›ti⁄Æ_¨gumít
) {

172 i‡(
has_equÆ
)

173 
›èrg
 = 
has_equÆ
;

174 i‡(
l⁄g_›ti⁄s
[
m©ch
].
has_¨g
 =
ªquúed_¨gumít
) {

178 
›èrg
 = 
«rgv
[
›töd
++];

181 i‡((
l⁄g_›ti⁄s
[
m©ch
].
has_¨g
 =
ªquúed_¨gumít
)

182 && (
›èrg
 =
NULL
)) {

187 i‡(
PRINT_ERROR
)

188 
	`w¨nx
(
ªˇrg°rög
, 
cuºít_¨gv
);

192 i‡(
l⁄g_›ti⁄s
[
m©ch
].
Êag
 =
NULL
)

193 
›t›t
 = 
l⁄g_›ti⁄s
[
m©ch
].
vÆ
;

195 
›t›t
 = 0;

196 --
›töd
;

197  (
BADARG
);

200 i‡(
sh‹t_too
) {

201 --
›töd
;

204 i‡(
PRINT_ERROR
)

205 
	`w¨nx
(
ûl›t°rög
, 
cuºít_¨gv
);

206 
›t›t
 = 0;

207  (
BADCH
);

209 i‡(
idx
)

210 *
idx
 = 
m©ch
;

211 i‡(
l⁄g_›ti⁄s
[
m©ch
].
Êag
) {

212 *
l⁄g_›ti⁄s
[
m©ch
].
Êag
 =Ü⁄g_›ti⁄s[m©ch].
vÆ
;

215  (
l⁄g_›ti⁄s
[
m©ch
].
vÆ
);

216 
	}
}

223 
	$gë›t_öã∫Æ
(
«rgc
, *c⁄° *
«rgv
, c⁄° *
›ti⁄s
,

224 c⁄° 
›ti⁄
 *
l⁄g_›ti⁄s
, *
idx
, 
Êags
)

226 *
ﬁi
;

227 
›tch¨
, 
sh‹t_too
;

228 
posixly_c‹ª˘
 = -1;

230 i‡(
›ti⁄s
 =
NULL
)

237 i‡(
posixly_c‹ª˘
 == -1)

238 
posixly_c‹ª˘
 = (
	`gëív
("POSIXLY_CORRECT"Ë!
NULL
);

239 i‡(
posixly_c‹ª˘
 || *
›ti⁄s
 == '+')

240 
Êags
 &~
FLAG_PERMUTE
;

241 i‡(*
›ti⁄s
 == '-')

242 
Êags
 |
FLAG_ALLARGS
;

243 i‡(*
›ti⁄s
 == '+' || *options == '-')

244 
›ti⁄s
++;

250 i‡(
›töd
 == 0)

251 
›töd
 = 
›åe£t
 = 1;

253 
›èrg
 = 
NULL
;

254 i‡(
›åe£t
)

255 
n⁄›t_°¨t
 = 
n⁄›t_íd
 = -1;

256 
°¨t
:

257 i‡(
›åe£t
 || !*
∂a˚
) {

258 
›åe£t
 = 0;

259 i‡(
›töd
 >
«rgc
) {

260 
∂a˚
 = 
EMSG
;

261 i‡(
n⁄›t_íd
 != -1) {

263 
	`≥rmuã_¨gs
(
n⁄›t_°¨t
, 
n⁄›t_íd
, 
›töd
, 
«rgv
);

264 
›töd
 -
n⁄›t_íd
 - 
n⁄›t_°¨t
;

265 } i‡(
n⁄›t_°¨t
 != -1) {

270 
›töd
 = 
n⁄›t_°¨t
;

272 
n⁄›t_°¨t
 = 
n⁄›t_íd
 = -1;

275 i‡(*(
∂a˚
 = 
«rgv
[
›töd
]Ë!'-' || (∂a˚[1] ='\0' && 
	`°rchr
(
›ti⁄s
, '-'Ë=
NULL
)) {

276 
∂a˚
 = 
EMSG
;

277 i‡(
Êags
 & 
FLAG_ALLARGS
) {

282 
›èrg
 = 
«rgv
[
›töd
++];

283  (
INORDER
);

285 i‡(!(
Êags
 & 
FLAG_PERMUTE
)) {

293 i‡(
n⁄›t_°¨t
 == -1)

294 
n⁄›t_°¨t
 = 
›töd
;

295 i‡(
n⁄›t_íd
 != -1) {

296 
	`≥rmuã_¨gs
(
n⁄›t_°¨t
, 
n⁄›t_íd
, 
›töd
, 
«rgv
);

297 
n⁄›t_°¨t
 = 
›töd
 - (
n⁄›t_íd
 -Çonopt_start);

298 
n⁄›t_íd
 = -1;

300 
›töd
++;

302 
°¨t
;

304 i‡(
n⁄›t_°¨t
 !-1 && 
n⁄›t_íd
 == -1)

305 
n⁄›t_íd
 = 
›töd
;

311 i‡(
∂a˚
[1] !'\0' && *++∂a˚ ='-' && (∂a˚[1] ='\0' || 
l⁄g_›ti⁄s
 =
NULL
)) {

312 
›töd
++;

313 
∂a˚
 = 
EMSG
;

318 i‡(
n⁄›t_íd
 != -1) {

319 
	`≥rmuã_¨gs
(
n⁄›t_°¨t
, 
n⁄›t_íd
, 
›töd
, 
«rgv
);

320 
›töd
 -
n⁄›t_íd
 - 
n⁄›t_°¨t
;

322 
n⁄›t_°¨t
 = 
n⁄›t_íd
 = -1;

333 i‡(
l⁄g_›ti⁄s
 !
NULL
 && 
∂a˚
 !
«rgv
[
›töd
] && (*∂a˚ ='-' || (
Êags
 & 
FLAG_LONGONLY
))) {

334 
sh‹t_too
 = 0;

335 i‡(*
∂a˚
 == '-')

336 
∂a˚
++;

337 i‡(*
∂a˚
 !':' && 
	`°rchr
(
›ti⁄s
, *∂a˚Ë!
NULL
)

338 
sh‹t_too
 = 1;

340 
›tch¨
 = 
	`∑r£_l⁄g_›ti⁄s
(
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
, 
sh‹t_too
);

341 i‡(
›tch¨
 != -1) {

342 
∂a˚
 = 
EMSG
;

343  (
›tch¨
);

347 i‡((
›tch¨
 = ()*
∂a˚
++Ë=()':' || (
ﬁi
 = 
	`°rchr
(
›ti⁄s
, o±ch¨)Ë=
NULL
) {

352 i‡(
›tch¨
 == ()'-')

355 i‡(!*
∂a˚
)

356 ++
›töd
;

357 i‡(
PRINT_ERROR
)

358 
	`w¨nx
(
ûl›tch¨
, 
›tch¨
);

359 
›t›t
 = 
›tch¨
;

360  (
BADCH
);

362 i‡(
l⁄g_›ti⁄s
 !
NULL
 && 
›tch¨
 ='W' && 
ﬁi
[1] == ';') {

364 i‡(*
∂a˚
)

368 i‡(++
›töd
 >
«rgc
) {

369 
∂a˚
 = 
EMSG
;

370 i‡(
PRINT_ERROR
)

371 
	`w¨nx
(
ªˇrgch¨
, 
›tch¨
);

372 
›t›t
 = 
›tch¨
;

373  (
BADARG
);

375 
∂a˚
 = 
«rgv
[
›töd
];

376 
›tch¨
 = 
	`∑r£_l⁄g_›ti⁄s
(
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
, 0);

377 
∂a˚
 = 
EMSG
;

378  (
›tch¨
);

380 i‡(*++
ﬁi
 != ':') {

381 i‡(!*
∂a˚
)

382 ++
›töd
;

384 
›èrg
 = 
NULL
;

385 i‡(*
∂a˚
)

386 
›èrg
 = 
∂a˚
;

388 i‡(
ﬁi
[1] != ':') {

389 i‡(++
›töd
 >
«rgc
) {

390 
∂a˚
 = 
EMSG
;

391 i‡(
PRINT_ERROR
)

392 
	`w¨nx
(
ªˇrgch¨
, 
›tch¨
);

393 
›t›t
 = 
›tch¨
;

394  (
BADARG
);

396 
›èrg
 = 
«rgv
[
›töd
];

398 
∂a˚
 = 
EMSG
;

399 ++
›töd
;

402  (
›tch¨
);

403 
	}
}

405 #ifde‡
REPLACE_GETOPT


412 
	$gë›t
(
«rgc
, *c⁄° *
«rgv
, c⁄° *
›ti⁄s
)

423  (
	`gë›t_öã∫Æ
(
«rgc
, 
«rgv
, 
›ti⁄s
, 
NULL
, NULL, 0));

424 
	}
}

431 
	$mgë›t_l⁄g
(
«rgc
, 
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
)

432 
«rgc
;

433 *c⁄° *
«rgv
;

434 c⁄° *
›ti⁄s
;

435 c⁄° 
›ti⁄
 *
l⁄g_›ti⁄s
;

436 *
idx
;

439  (
	`gë›t_öã∫Æ
(
«rgc
, 
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
, 
FLAG_PERMUTE
));

440 
	}
}

446 
	$mgë›t_l⁄g_⁄ly
(
«rgc
, 
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
)

447 
«rgc
;

448 *c⁄° *
«rgv
;

449 c⁄° *
›ti⁄s
;

450 c⁄° 
›ti⁄
 *
l⁄g_›ti⁄s
;

451 *
idx
;

454  (
	`gë›t_öã∫Æ
(
«rgc
, 
«rgv
, 
›ti⁄s
, 
l⁄g_›ti⁄s
, 
idx
, 
FLAG_PERMUTE
 | 
FLAG_LONGONLY
));

455 
	}
}

	@platform_hacks.h

20 #i‚de‡
_PLATFORM_HACKS_H_


21 
	#_PLATFORM_HACKS_H_


	)

23 #ifde‡
__GNUC__


24 
	#MONGO_INLINE
 
__ölöe__


	)

26 
	#MONGO_INLINE
 

	)

29 #ifde‡
__˝lu•lus


30 
	#MONGO_EXTERN_C_START
 "C" {

	)

31 
	#MONGO_EXTERN_C_END
 }

	)

33 
	#MONGO_EXTERN_C_START


	)

34 
	#MONGO_EXTERN_C_END


	)

38 #i‡
deföed
(
MONGO_HAVE_STDINT
Ë|| 
__STDC_VERSION__
 >= 199901L

39 
	~<°döt.h
>

40 #ñi‡
deföed
(
MONGO_HAVE_UNISTD
)

41 
	~<uni°d.h
>

42 #ñi‡
deföed
(
MONGO_USE__INT64
)

43 
__öt64
 
	töt64_t
;

44 
	t__öt64
 
	tuöt64_t
;

45 #ñi‡
deföed
(
MONGO_USE_LONG_LONG_INT
)

46 
	töt64_t
;

47 
	tuöt64_t
;

49 #îr‹ 
mu°
 
have
 
a
 64b
ô
 
ty≥


53 #ifde‡
MONGO_BIG_ENDIAN


54 
	#bs⁄_lôée_ídün64
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün64
(out, inË)

	)

55 
	#bs⁄_lôée_ídün32
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün32
(out, inË)

	)

56 
	#bs⁄_big_ídün64
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 8Ë)

	)

57 
	#bs⁄_big_ídün32
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 4Ë)

	)

59 
	#bs⁄_lôée_ídün64
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 8Ë)

	)

60 
	#bs⁄_lôée_ídün32
(
out
, 
ö
Ë–
	`mem˝y
(out, in, 4Ë)

	)

61 
	#bs⁄_big_ídün64
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün64
(out, inË)

	)

62 
	#bs⁄_big_ídün32
(
out
, 
ö
Ë–
	`bs⁄_sw≠_ídün32
(out, inË)

	)

65 
MONGO_EXTERN_C_START


67 
MONGO_INLINE
 
	$bs⁄_sw≠_ídün64
(* 
ouç
, c⁄° * 
öp
){

68 c⁄° *
ö
 = (c⁄° *)
öp
;

69 *
out
 = (*)
ouç
;

71 
out
[0] = 
ö
[7];

72 
out
[1] = 
ö
[6];

73 
out
[2] = 
ö
[5];

74 
out
[3] = 
ö
[4];

75 
out
[4] = 
ö
[3];

76 
out
[5] = 
ö
[2];

77 
out
[6] = 
ö
[1];

78 
out
[7] = 
ö
[0];

80 
	}
}

81 
MONGO_INLINE
 
	$bs⁄_sw≠_ídün32
(* 
ouç
, c⁄° * 
öp
){

82 c⁄° *
ö
 = (c⁄° *)
öp
;

83 *
out
 = (*)
ouç
;

85 
out
[0] = 
ö
[3];

86 
out
[1] = 
ö
[2];

87 
out
[2] = 
ö
[1];

88 
out
[3] = 
ö
[0];

89 
	}
}

91 
	gMONGO_EXTERN_C_END


	@test.h

1 
	~<°dlib.h
>

3 
	#ASSERT
(
x
Ë\

	)

5 if(!(
	gx
)){ \

6 
¥ötf
("Áûedás£π (%d): %s\n", 
__LINE__
, #x); \

7 
exô
(1); \

11 #ifde‡
_WIN32


12 
	#INIT_SOCKETS_FOR_WINDOWS
 \

	)

14 
WSADATA
 
out
; \

15 
	`WSASèπup
(
	`MAKEWORD
(2,2), &
out
); \

16 
	}
} 0)

18 
	#INIT_SOCKETS_FOR_WINDOWS
 dÿ{
	}
} 0)

	)

	@utils.c

1 
	~"utûs.h
"

3 
	$L‰ód
(*
±r
, 
cur
, 
cmp
, 
FILE
 * 
gp
)

5 
tmpbuf
;

6 
ªtvÆ
 = 0;

8 
cur
) {

10 i‡(
cmp
 == 4)

11 
ªtvÆ
 = 
	`‰ód
(
±r
, 4, 1, 
gp
);

12 i‡(
cmp
 == 8) {

13 
ªtvÆ
 = 
	`‰ód
(
±r
, 4, 1, 
gp
);

14 
ªtvÆ
 = 
	`‰ód
(&
tmpbuf
, 4, 1, 
gp
);

18 i‡(
cmp
 == 4)

19 
ªtvÆ
 = 
	`‰ód
(
±r
, 4, 1, 
gp
);

20 i‡(
cmp
 == 8) {

21 
ªtvÆ
 = 
	`‰ód
(
±r
, 8, 1, 
gp
);

25 
ªtvÆ
 = -1;

29  (
ªtvÆ
);

31 
	}
}

33 
	$ndebug
(*
fmt
, ...)

35 
ªtvÆ
 = 
TRUE
;

36 
FILE
 *
Â
;

38 
va_li°
 
¨gs
;

40 i‡((
Â
 = 
	`f›í
("/v¨/log/TTRãmpFûe.log", "a+")Ë!
NULL
) {

42 
	`va_°¨t
(
¨gs
, 
fmt
);

43 
	`vÂrötf
(
Â
, 
fmt
, 
¨gs
);

44 
	`va_íd
(
¨gs
);

46 
	`f˛o£
(
Â
);

48 
ªtvÆ
 = 
FALSE
;

50  (
ªtvÆ
);

51 
	}
}

53 
	$«me2num
(*
«me
)

55 
ªtvÆ
 = 
STKSPACE
 - 1;

57 i‡(
	`°∫cmp
(
«me
, "sz00", 4) == 0) {

58 
ªtvÆ
 = (
	`©oi
(
«me
 + 2));

59 } i‡(
	`°∫cmp
(
«me
, "sz30", 4) == 0) {

60 
ªtvÆ
 = (
	`©oi
(
«me
 + 3Ë+ 
SZRSV
);

62 } i‡(
	`°∫cmp
(
«me
, "sh60", 4) == 0) {

63 
ªtvÆ
 = (
	`©oi
(
«me
 + 3Ë+ 
SZRSV
 + 
INNRSV
);

67  (
ªtvÆ
);

69 
	}
}

71 
	$time2num
(*
«me
)

74 
H
, 
M
, 
S
;

75 
ªtvÆ
 = 0;

77 
	`ssˇnf
(
«me
, "%02d:%02d:%02d", &
H
, &
M
, &
S
);

81 i‡((
H
 < 9) || (H >= 16)) {

82 
ªtvÆ
 = 0;

85 i‡(
H
 == 9) {

86 
M
 -= 29;

87 i‡(
M
 < 0) {

88 
ªtvÆ
 = 0;

91 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

94 i‡(
H
 == 10) {

95 
ªtvÆ
 = 30 * 10 + 10;

96 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

99 i‡(
H
 == 11) {

100 
ªtvÆ
 = 90 * 10 + 10;

101 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

105 i‡(
H
 == 13) {

106 
ªtvÆ
 = 120 * 10 + 20;

107 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

111 i‡(
H
 == 14) {

112 
ªtvÆ
 = 180 * 10 + 20;

113 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

117 i‡(
H
 == 15) {

118 
ªtvÆ
 = 240 * 10 + 30;

119 
ªtvÆ
 +
M
 * 10 + ()
S
 / 10;

127  ((
ªtvÆ
 < (240 * 10 + 40)) ?Ñetval : (240 * 10 + 40 - 1));

129 
	}
}

131 
	$˙tComma1
(*
°r
)

133 
ªtvÆ
 = 0;

134 
¶í
;

136 *
±r
 = 
°r
;

137 
¶í
 = 
	`°æí
(
±r
);

141 *
±r
) {

142 i‡(*
±r
 == ',')

143 
ªtvÆ
++;

144 
±r
++;

147  (
ªtvÆ
);

149 
	}
}

151 
	$˙tCommaX
(*
°r
)

153 
ªtvÆ
 = 0;

154 *
v
 = 
	`CÆloc
(29, );

156 *
±r
 = 
°r
;

158 *
±r
) {

159 i‡(*
±r
 == ',') {

160 
ªtvÆ
++;

163 
±r
++;

166 i‡(
ªtvÆ
 == 0)

167  (
ªtvÆ
);

169 
	`ssˇnf
(++
±r
,

171 &
v
[0], &v[1], &v[2], &v[3], &v[4], &v[5], &v[6], &v[7], &v[8], &v[9], &v[10], &v[11], &v[12], &v[13], &v[14],

172 &
v
[15], &v[16], &v[17], &v[18], &v[19], &v[20], &v[21], &v[22], &v[23], &v[24], &v[25], &v[26], &v[27],

173 &
v
[28]);

175 *
±r
) {

176 i‡(*
±r
 == ',')

177 
ªtvÆ
++;

178 
±r
++;

181 
	`‰ì
(
v
);

182  (
ªtvÆ
);

184 
	}
}

186 
	$˙tComma2
(*
°r
)

188 
ªtvÆ
 = 0;

189 
i
;

190 *
v
;

192 *
±r
 = 
°r
;

194 *
±r
) {

195 i‡(*
±r
 == ',') {

196 
ªtvÆ
++;

199 
±r
++;

202 i‡(
ªtvÆ
 == 0)

203  (
ªtvÆ
);

205 
v
 = 
	`CÆloc
(31, );

207 
i
 = 0;

208 
i
 < 29) {

209 
	`ssˇnf
(++
±r
, "%f", &
v
[
i
]);

211 *
±r
) {

212 i‡(*
±r
 == ',') {

213 
ªtvÆ
++;

216 
±r
++;

218 
i
++;

221 *
±r
) {

222 i‡(*
±r
 == ',')

223 
ªtvÆ
++;

224 
±r
++;

227 
	`‰ì
(
v
);

229  (
ªtvÆ
);

231 
	}
}

233 
	$summComma
(*
°r
)

235 
ªtvÆ
 = 0;

236 
i
;

237 *
±r
;

238 *
v
;

240 
±r
 = 
°r
;

242 
v
 = 
	`CÆloc
(31, );

244 *
±r
 != ',')

245 
±r
++;

246 
i
 = 0;

247 
i
 < 29) {

248 
	`ssˇnf
(++
±r
, "%f", &
v
[
i
]);

249 
i
++;

250 *
±r
 != ',')

251 
±r
++;

254 
	`‰ì
(
v
);

256  (
ªtvÆ
);

258 
	}
}

263 
	$timevÆ_subåa˘
 (
timevÆ
 *
ªsu…
, timevÆ *
t2
, timevÆ *
t1
)

265 
diff
 = (
t2
->
tv_u£c
 + 100000 *Å2->
tv_£c
) -

266 (
t1
->
tv_u£c
 + 100000 *Å1->
tv_£c
);

267 
ªsu…
->
tv_£c
 = 
diff
 / 100000;

268 
ªsu…
->
tv_u£c
 = 
diff
 % 100000;

270  (
diff
 < 0);

271 
	}
}

275 
	$tic
 (
timevÆ
 *
timî
) {

276 
	`gëtimeofday
 (
timî
, 
NULL
);

277 
	}
}

281 
	$toc
 (
timevÆ
 *
timî
) {

282 
timevÆ
 
tv_íd
, 
tv_diff
;

284 
	`gëtimeofday
 (&
tv_íd
, 
NULL
);

285 
	`timevÆ_subåa˘
 (&
tv_diff
, &
tv_íd
, 
timî
);

286 
	`ndebug
("ru¬ögÅimêi†%ld.%06ld\n", 
tv_diff
.
tv_£c
,Åv_diff.
tv_u£c
);

288 
	}
}

290 
	$Ti°øde
(
v
)

292 
ªtvÆ
 = 
TRUE
;

294 
H
 = 
	`åunc
(
v
 / 10000);

295 
M
 = 
	`åunc
((
v
 - (
H
 * 10000)) / 100);

296 
S
 = 
	`åunc
(
v
 -Årunc(v / 100) * 100);

299 i‡((
H
 >= 13) && (H < 15))

301 i‡((
H
 >= 10) && (H < 11))

303 i‡((
H
 =9Ë&& (
M
 >= 30))

305 i‡((
H
 =11Ë&& (
M
 < 30))

307 
ªtvÆ
 = 
FALSE
;

311  (
ªtvÆ
);

312 
	}
}

	@utils.h

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<sys/time.h
>

4 
	~<√tdb.h
>

5 
	~<î∫o.h
>

6 
	~<sy¶og.h
>

7 
	~<sig«l.h
>

8 
	~<£m≠h‹e.h
>

10 
	~<uni°d.h
>

11 
	~<°d¨g.h
>

13 
	~<°dboﬁ.h
>

14 
	~<cuæ/cuæ.h
>

15 
	~<uni°d.h
>

16 
	~<°rög.h
>

18 
	~<dúít.h
>

20 
	~"ödex¥oc.h
"

22 #i‚de‡
__INDP_CFG_H


23 
	#__INDP_CFG_H


	)

25 
ndebug
(*
fmt
,...);

27 
time2num
(*);

28 
«me2num
(*);

30 
˙tComma1
(*);

31 
˙tComma2
(*);

32 
˙tCommaX
(*);

33 
˙tSTK
();

34 
‹dSTK
(*);

35 
L‰ód
(*,,,
FILE
 *);

36 
Ti°øde
();

	@
1
.
0
39
365
GetttRc.c
HftTrans.c
MongoQuery.c
MongoQuery.h
Rmongo.c
Rmongo.h
adjRatios.c
bcon.c
bcon.h
bson.c
bson.h
cfg.h
common.h
diffSelect.c
encoding.c
encoding.h
env.c
env.h
export2mongo.h
gridfs.c
gridfs.h
indexproc.h
lz4.c
lz4.h
lz4hc.c
lz4hc.h
matrix.c
md5.c
md5.h
mongo.c
mongo.h
mongo_except.h
netGet.c
numbers.c
optionParse.c
platform_hacks.h
test.h
utils.c
utils.h
